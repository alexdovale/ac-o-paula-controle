<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pauta - SIGAP</title>
    <link rel="icon" type="image/png" href="https://alexdovale.github.io/ponto.codoc/imagem.png">
    <meta name="theme-color" content="#16a34a"/>
    <link rel="apple-touch-icon" href="https://alexdovale.github.io/ponto.codoc/imagem.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://browser.sentry-cdn.com/7.114.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
      if (window.Sentry) {
        Sentry.init({
          dsn: "https://7d95a89ba62ab6b3f7a64540c8e693cb@o4510647821795328.ingest.us.sentry.io/4510647932223488", 
          tracesSampleRate: 1.0,
          environment: "production",
          release: "sigap@1.0.0",
          beforeSend(event, hint) {
            if (event.exception) Sentry.showReportDialog({ eventId: event.event_id });
            return event;
          }
        });
      }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .priority-urgente { border-left: 5px solid #ef4444; }
        .priority-maxima { border-left: 5px solid #22c55e; }
        .priority-media { border-left: 5px solid #f97316; }
        .priority-minima { border-left: 5px solid #6b7280; }
        .column-content::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .column-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .tab-active { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; font-weight: 600; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .confirm-btn-style { display: inline-flex; items-center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; border: 1px solid currentColor; transition: all 0.2s; flex-shrink: 0; margin-left: 8px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="offline-indicator" class="fixed top-0 left-0 w-full bg-red-600 text-white text-center py-1 text-sm font-bold hidden z-[100]">
        ‚ö†Ô∏è Sem conex√£o. Trabalhando em Modo Offline.
    </div>

    <div id="loading-container" class="loading-container"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-700 font-semibold text-center">Conectando com Seguran√ßa...</p></div>

    <!-- TELA DE LOGIN -->
    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <img src="https://alexdovale.github.io/ponto.codoc/imagem.png" alt="Logo SIGAP" class="mx-auto h-24 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Sistema de Gerenciamento de Pauta</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden"></div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 text-center font-semibold text-green-600 border-b-2 border-green-600">Login</button>
                <button id="register-tab-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">Cadastrar</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="text-right"><a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a></div>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Entrar</button>
            </form>
            <form id="register-form" class="hidden space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">Senha (min 6)</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-green-600 hover:bg-green-700">Criar Conta</button>
            </form>
            <a href="#" id="privacy-policy-link" class="block mt-4 text-center text-sm text-gray-500 hover:underline">Pol√≠tica de Privacidade</a>
        </div>
    </div>

    <!-- SELE√á√ÉO DE PAUTA -->
    <div id="pauta-selection-container" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">Minhas Pautas</h2>
              <div class="space-x-2">
                  <button id="admin-panel-btn" class="hidden bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Painel do Admin</button>
                  <button id="logout-btn-main" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Sair</button>
              </div>
        </div>
        <div id="pautas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6"><button id="create-pauta-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Criar Nova Pauta</button></div>
    </div>

    <!-- MODAL ADMIN -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Painel do Administrador</h2>
                <button id="close-admin-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <div class="mb-4">
                    <h3 class="font-semibold text-red-600 mb-2 uppercase text-sm">Manuten√ß√£o (LGPD)</h3>
                    <button id="cleanup-old-data-btn" class="w-full bg-red-100 text-red-700 font-bold py-2 rounded-lg border border-red-300">Executar Limpeza de 7 Dias</button>
                </div>
                <div class="mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Usu√°rios Pendentes</h3>
                    <div id="pending-users-list" class="space-y-2"></div>
                </div>
                <div id="audit-logs-container" class="mt-4">
                    <button id="view-audit-logs-btn" class="bg-purple-600 text-white px-4 py-2 rounded text-sm mb-2">Ver Logs</button>
                    <div class="max-h-40 overflow-y-auto border rounded bg-gray-50 p-2"><table class="w-full text-xs"><tbody id="audit-logs-table-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- APLICATIVO PRINCIPAL -->
    <div id="app-container" class="max-w-full mx-auto hidden">
        <header class="mb-6 bg-white p-4 rounded-lg shadow-sm">
            <div class="flex justify-between items-center">
                 <h1 id="pauta-title" class="text-2xl font-bold text-gray-800"></h1>
                 <button id="logout-btn-app" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700">Sair</button>
            </div>
            <div class="flex flex-wrap gap-2 mt-4">
                <button id="back-to-pautas-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg">Voltar</button>
                <button id="actions-toggle" class="bg-green-600 text-white py-2 px-6 rounded-lg font-bold">A√ß√µes ‚ñº</button>
                <div id="actions-panel" class="hidden absolute mt-12 bg-white border shadow-xl rounded-lg z-20 p-2 space-y-1">
                    <button id="share-pauta-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Compartilhar Externo</button>
                    <button id="view-stats-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Estat√≠sticas</button>
                    <button id="edit-pauta-name-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Editar Nome</button>
                    <button id="manage-members-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Membros</button>
                    <button id="manage-collaborators-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Colaboradores</button>
                    <button id="notes-btn" class="w-full text-left p-2 hover:bg-gray-100 rounded">Anota√ß√µes</button>
                    <hr>
                    <button id="close-pauta-btn" class="w-full text-left p-2 text-orange-600 hover:bg-orange-50">Fechar Pauta</button>
                    <button id="reset-all-btn" class="w-full text-left p-2 text-red-600 hover:bg-red-50">Zerar Pauta</button>
                </div>
            </div>
        </header>

        <div id="app-content">
            <div class="border-b mb-6">
                <nav class="flex space-x-6">
                    <button id="tab-agendamento" class="tab-active py-3 px-4 border-b-2 font-medium">Agendado</button>
                    <button id="tab-avulso" class="text-gray-500 py-3 px-4 border-b-2 font-medium">Avulso</button>
                </nav>
            </div>

            <form id="form-agendamento" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="text" id="assisted-name" placeholder="Nome do Assistido" class="p-3 border rounded-lg">
                    <input type="text" id="assisted-cpf" placeholder="CPF (Opcional)" class="p-3 border rounded-lg">
                    <input list="subjects-list" id="assisted-subject" placeholder="Assunto" class="p-3 border rounded-lg lg:col-span-2">
                    <datalist id="subjects-list"></datalist>
                </div>
                <div class="flex items-center gap-4 mt-4">
                    <div id="scheduled-time-wrapper" class="hidden"><input type="time" id="scheduled-time" class="p-3 border rounded-lg"></div>
                    <button type="button" id="add-assisted-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg">Adicionar</button>
                </div>
            </form>

            <main id="main-content" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-lg shadow h-fit"><h3 class="p-4 border-b font-bold bg-gray-50">üìã Pauta <span id="pauta-count" class="text-xs bg-gray-200 px-2 rounded-full"></span></h3><div id="pauta-list" class="p-2 column-content overflow-y-auto max-h-[60vh]"></div><input type="search" id="pauta-search" placeholder="Pesquisar..." class="w-full p-2 text-sm border-t"></div>
                <div class="bg-white rounded-lg shadow h-fit"><h3 class="p-4 border-b font-bold bg-gray-50">‚è≥ Aguardando <span id="aguardando-count" class="text-xs bg-gray-200 px-2 rounded-full"></span></h3><div id="aguardando-list" class="p-2 column-content overflow-y-auto max-h-[60vh]"></div><input type="search" id="aguardando-search" placeholder="Pesquisar..." class="w-full p-2 text-sm border-t"></div>
                <div id="em-atendimento-column" class="bg-white rounded-lg shadow h-fit hidden"><h3 class="p-4 border-b font-bold bg-purple-50">üë©‚Äçüíª Em Atendimento <span id="em-atendimento-count" class="text-xs bg-gray-200 px-2 rounded-full"></span></h3><div id="em-atendimento-list" class="p-2 column-content overflow-y-auto max-h-[60vh]"></div></div>
                <div class="bg-white rounded-lg shadow h-fit"><h3 class="p-4 border-b font-bold bg-green-50">‚úÖ Atendidos <span id="atendidos-count" class="text-xs bg-gray-200 px-2 rounded-full"></span></h3><div id="atendidos-list" class="p-2 column-content overflow-y-auto max-h-[60vh]"></div><input type="search" id="atendidos-search" placeholder="Pesquisar..." class="w-full p-2 text-sm border-t"></div>
            </main>
        </div>
    </div>

    <!-- MODAL DE ATENDENTE (UNIFICADO) -->
    <div id="attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="attendant-modal-title" class="text-2xl font-bold mb-4">Finalizar Atendimento</h2>
            <p class="mb-4 text-gray-600">Insira o nome do profissional (opcional).</p>
            <input list="collaborators-list" type="text" id="attendant-name" class="w-full p-3 border rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-attendant-btn" class="bg-gray-300 py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-attendant-btn" class="bg-green-600 text-white py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE ANOTA√á√ïES -->
    <div id="notes-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
      <div class="bg-white rounded-xl p-6 w-96 shadow-lg">
        <h2 class="text-lg font-semibold mb-3">Minhas Anota√ß√µes</h2>
        <textarea id="notes-text" class="w-full h-40 border rounded-lg p-3"></textarea>
        <div class="mt-4 flex justify-end gap-2">
          <button id="save-notes-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Salvar</button>
          <button id="close-notes-btn" class="bg-gray-300 px-4 py-2 rounded-lg">Fechar</button>
        </div>
      </div>
    </div>

    <!-- MODAL CONFIRMA√á√ÉO GEN√âRICO -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Confirma√ß√£o</h2>
            <p id="modal-text" class="mb-6 text-gray-600"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-action" class="bg-gray-300 py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirm-action" class="bg-red-600 text-white py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    <script type="module">

        // imports
        import { firebaseConfig, emailJsConfig } from './js/config.js';
        import { escapeHTML, showNotification, formatTime, normalizeText, copyToClipboard } from './js/utils.js';
        import { subjectTree, flatSubjects } from './js/assuntos.js';
        import { getChecklistHTML } from './js/checklist.js';
        import { setupDetailsModal, openDetailsModal } from './detalhes.js';
        import { parsePautaCSV } from './js/csvHandler.js';
        import { generateAtendidosPDF, generateCollaboratorsPDF } from './js/pdfService.js';
        import { sendDelegationEmail, sendNotesByEmail } from './js/emailService.js';
        import { logAction as logActionDB, loadUsersList, cleanupOldData } from './js/admin.js';
        import { 
            setupAttendancesListener, 
            updateAttendanceStatus, 
            deleteAttendance, 
            moveInQueueLogic, 
            saveImportedPauta 
        } from './js/pauta.js';
        
        // Inicializa√ß√£o do EmailJS usando o novo arquivo de config
        emailjs.init(emailJsConfig.publicKey);
        // --- L√ìGICA DO PAINEL DE ADMIN ---
        
        // --- LIGA√á√ïES DO PAINEL ADMIN ---
        
        // Abrir o Painel (ID: admin-panel-btn)
        const btnAdmin = document.getElementById('admin-panel-btn');
        if (btnAdmin) {
            btnAdmin.onclick = () => {
                document.getElementById('admin-modal').classList.remove('hidden');
                loadUsersList(db); // Chama a fun√ß√£o que voc√™ importou
            };
        }
        
        // Bot√£o de Limpeza LGPD (ID: cleanup-old-data-btn)
        const btnCleanup = document.getElementById('cleanup-old-data-btn');
        if (btnCleanup) {
            btnCleanup.onclick = () => {
                cleanupOldData(db); // Chama a fun√ß√£o que voc√™ importou
            };
        }
        
        // Fun√ß√µes para os bot√µes "Aprovar" e "Excluir" que ficam dentro da lista
        window.approveUserWithRole = async (id) => {
            const role = document.getElementById(`role-select-${id}`).value;
            // Importa o m√≥dulo na hora e executa a aprova√ß√£o
            import('./js/admin.js').then(m => m.approveUser(db, id, role));
        };
        
        window.deleteUser = async (id) => {
            if(confirm("Deseja excluir permanentemente este usu√°rio?")) {
                import('./js/admin.js').then(m => m.deleteUser(db, id));
            }
        };

        // Ponte simplificada para a Auditoria (M√≥dulo js/admin.js)
        const logAction = (type, details, targetId = null) => {
            // Chama a fun√ß√£o do arquivo usando o "apelido" logActionDB
            logActionDB(db, auth, currentUserName, currentPautaId, type, details, targetId);
        };
        
        const adminModal = document.getElementById('admin-modal');
        
        // 1. Mostrar o bot√£o apenas se for Admin
        // Vers√£o corrigida da fun√ß√£o
        const checkAdminStatus = (userData) => {
            // Pegamos o bot√£o diretamente pelo ID para n√£o depender de vari√°veis globais
            const btn = document.getElementById('admin-panel-btn');
            if (btn && (userData.role === 'admin' || userData.role === 'superadmin')) {
                btn.classList.remove('hidden');
            }
};
        
        document.addEventListener('DOMContentLoaded', () => {
            // ... outros c√≥digos de inicializa√ß√£o que voc√™ j√° tem ...
        
        });
        const logsContainer = document.getElementById('audit-logs-container');
        const logsTableBody = document.getElementById('audit-logs-table-body');
        const noLogsMsg = document.getElementById('no-logs-msg');
        
        
        // Importando as fun√ß√µes do novo m√≥dulo de detalhes
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        //import { setupDetailsModal, openDetailsModal } from './detalhes.js';
        import { renderStatisticsModal } from './estatisticas.js'
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, orderBy, limit, getDoc, serverTimestamp, writeBatch, arrayUnion, arrayRemove, setDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    

        // Vari√°veis Globais
        let db, auth, allAssisted = [], currentPautaId = null, unsubscribeFromAttendances = () => {}, currentUserName = '', currentPautaOwnerId = null, isPautaClosed = false;
        let currentPautaData = null; // Para armazenar todos os dados da pauta atual
        let assistedIdToHandle = null;
        let assistedNameToHandle = null; // Adicionado para passar o nome para o modal de sele√ß√£o de colaborador
        
        let customRoomsList = []; // Array para guardar os nomes das salas

        // Vari√°veis para o novo modal de delega√ß√£o de e-mail
        let assistedIdForDelegation = null;
        let assistedNameForDelegation = null;
        let collaboratorNameForDelegation = null; // Nome do colaborador j√° atribu√≠do ao assistido, se houver.

        // Vari√°veis para a l√≥gica de Colaboradores (lista de presen√ßa)
        let colaboradores = []; // Esta √© a lista de colaboradores (da lista de presen√ßa)
        let editCollaboratorId = null; // ID do colaborador sendo editado na lista de presen√ßa
        let unsubscribeFromCollaborators = () => {};

        
        // --- L√ìGICA DE MOVIMENTA√á√ÉO MANUAL (Setas e Topo) ---
        // Definimos no objeto 'window' para que o HTML consiga enxergar a fun√ß√£o
        window.moveInQueue = async (id, direction) => {
            if (isPautaClosed) {
                showNotification("A pauta est√° fechada.", "error");
                return;
            }
        
            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
            
            // 1. Pegamos a lista atual de quem est√° aguardando, j√° ordenada corretamente
            let list = allAssisted
                .filter(a => a.status === 'aguardando' && a.type === currentMode)
                .sort((a, b) => {
                    if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                    if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;
                    const orderA = a.manualIndex !== undefined ? a.manualIndex : (a.createdAt || 0);
                    const orderB = b.manualIndex !== undefined ? b.manualIndex : (b.createdAt || 0);
                    return orderA - orderB;
                });
        
            const currentIndex = list.findIndex(item => item.id === id);
            if (currentIndex === -1) return;
        
            // 2. Criamos uma c√≥pia para manipular
            let newList = [...list];
        
            if (direction === 'up' && currentIndex > 0) {
                // Troca com o de cima
                [newList[currentIndex - 1], newList[currentIndex]] = [newList[currentIndex], newList[currentIndex - 1]];
            } else if (direction === 'down' && currentIndex < newList.length - 1) {
                // Troca com o de baixo
                [newList[currentIndex], newList[currentIndex + 1]] = [newList[currentIndex + 1], newList[currentIndex]];
            } else if (direction === 'top') {
                // Remove da posi√ß√£o atual e coloca no √≠ndice 0
                const [movedItem] = newList.splice(currentIndex, 1);
                newList.unshift(movedItem);
            }
        
            // 3. Salvamos a nova ordem no Firebase usando Batch (Lote)
            const batch = writeBatch(db); // writeBatch deve estar importado do firestore
            newList.forEach((item, index) => {
                const docRef = doc(db, "pautas", currentPautaId, "attendances", item.id);
                batch.update(docRef, { 
                    manualIndex: index,
                    lastActionBy: currentUserName,
                    lastActionTimestamp: new Date().toISOString()
                });
            });
        
            try {
                await batch.commit();
                // O onSnapshot cuidar√° de atualizar a tela automaticamente
            } catch (error) {
                console.error("Erro ao reordenar fila:", error);
                showNotification("Erro ao atualizar ordem.", "error");
            }
        };

        
        const loadingContainer = document.getElementById('loading-container');
        const loginContainer = document.getElementById('login-container');
        const pautaSelectionContainer = document.getElementById('pauta-selection-container');
        const appContainer = document.getElementById('app-container');
        const loadingText = document.getElementById('loading-text');
        
        // FUN√á√ÉO DE PESQUISA MELHORADA
       const searchFilter = (assisted, term) => {
            if (!term) return true;
            
            // Formata a data de chegada para HH:MM para permitir a pesquisa
            const arrivalTimeFormatted = assisted.arrivalTime ? new Date(assisted.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
        
            const normalizedTerm = normalizeText(term);
        
            // Converte o campo attendant para string, caso seja um objeto com nome.
            // O campo attendant pode ser uma string (padr√£o) ou, em fluxos complexos, um objeto.
            const attendantName = (typeof assisted.attendant === 'object' && assisted.attendant !== null) 
                                  ? assisted.attendant.name || assisted.attendant.nome || '' 
                                  : assisted.attendant || '';
        
            return normalizeText(assisted.name).includes(normalizedTerm) ||
                   (assisted.cpf && normalizeText(assisted.cpf).includes(normalizedTerm)) ||
                   normalizeText(assisted.subject).includes(normalizedTerm) ||
                   (assisted.scheduledTime && assisted.scheduledTime.includes(normalizedTerm)) ||
                   (arrivalTimeFormatted && arrivalTimeFormatted.includes(normalizedTerm)) ||
                   // NOVO: Usa a vari√°vel attendantName (que garante que o campo √© string)
                   (attendantName && normalizeText(attendantName).includes(normalizedTerm)) ||
                   // Campo Colaborador Atribu√≠do
                   (assisted.assignedCollaborator?.name && normalizeText(assisted.assignedCollaborator.name).includes(normalizedTerm));
        };

        const getPriorityClass = (priority) => ({'URGENTE':'priority-urgente','M√°xima':'priority-maxima','M√©dia':'priority-media','M√≠nima':'priority-minima'}[priority]||'');

        const getUpdatePayload = (data) => {
            return {
                ...data,
                lastActionBy: currentUserName,
                lastActionTimestamp: new Date().toISOString()
            };
        };



        // --- COLOQUE ESTA FUN√á√ÉO NO ESCOPO GLOBAL DO SEU SCRIPT ---
     let sortableAguardando = null;
        
     const setupManualSort = () => {
        const el = document.getElementById('aguardando-list');
        const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
    
        if (pautaOrder === 'manual' && !isPautaClosed) {
            if (sortableAguardando) sortableAguardando.destroy();
    
            sortableAguardando = new Sortable(el, {
                animation: 300, // Movimento mais lento e fluido
                ghostClass: 'opacity-20', // Card fantasma quase transparente
                chosenClass: 'ring-2', // Borda azul ao segurar
                dragClass: 'scale-95', // Diminui o card enquanto arrasta
                handle: '.relative', // Permite arrastar clicando em qualquer lugar do card...
                filter: 'button, svg, p, span', // ...mas ignora se o clique for nos textos ou bot√µes
                preventOnFilter: false,
                
                onEnd: async function () {
                    const items = el.querySelectorAll('[data-id]');
                    const batch = writeBatch(db);
                    
                    items.forEach((item, index) => {
                        const docId = item.getAttribute('data-id');
                        const docRef = doc(db, "pautas", currentPautaId, "attendances", docId);
                        batch.update(docRef, { manualIndex: index });
                    });
    
                    try {
                        await batch.commit();
                        showNotification("Fila Reordenada!");
                    } catch (e) {
                        console.error(e);
                    }
                },
            });
        } else if (sortableAguardando) {
            sortableAguardando.destroy();
            sortableAguardando = null;
        }
    };

        

        
        const getPriorityLevel = (assisted) => {
            if (!assisted || assisted.status !== 'aguardando') return 'N/A';
            if (assisted.priority === 'URGENTE') return 'URGENTE';

            if (assisted.type === 'avulso') return 'M√©dia';

            if (!assisted.scheduledTime || !assisted.arrivalTime) return 'M√©dia';

            const scheduled = new Date(`1970-01-01T${assisted.scheduledTime}`);
            const arrival = new Date(assisted.arrivalTime);
            const arrivalTime = new Date(`1970-01-01T${arrival.toTimeString().slice(0, 5)}`);

            const diffMinutes = (arrivalTime - scheduled) / (1000 * 60);

            if (diffMinutes <= 0) return 'M√°xima';
            if (diffMinutes <= 20) return 'M√©dia';
            return 'M√≠nima';
        };
            /**
             * Garante a formata√ß√£o segura de strings de data ISO ou Timestamp.
             * No fluxo de delega√ß√£o, attendedTime pode ser uma string ISO ou um objeto Timestamp.
             * @param {string | object} timeStamp - A string de data (ISO) ou objeto Timestamp do Firebase.
             * @returns {string} O hor√°rio formatado (HH:mm) ou 'N/A'.
             */
        const togglePautaLock = (isClosed) => {
            const isOwner = auth.currentUser?.uid === currentPautaOwnerId;
            isPautaClosed = isClosed;

            const buttonsToDisable = [
                'form-agendamento', 'file-upload', 'add-assisted-btn',
                'download-pdf-btn', 'toggle-faltosos-btn', 'tab-avulso', 'tab-agendamento'
            ];

            buttonsToDisable.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (isClosed) {
                        element.classList.add('pointer-events-none', 'opacity-50');
                        element.querySelectorAll('input, button, a, textarea').forEach(el => el.disabled = true);
                    } else {
                        element.classList.remove('pointer-events-none', 'opacity-50');
                        element.querySelectorAll('input, button, a, textarea').forEach(el => el.disabled = false);
                    }
                }
            });

            // Trecho corrigido na fun√ß√£o togglePautaLock:

            // Dentro da fun√ß√£o togglePautaLock, ap√≥s o bloco buttonsToDisable:

            const actionPanelButtons = document.querySelectorAll('#actions-panel button');
            
            actionPanelButtons.forEach(btn => {
                if (btn.id === 'reopen-pauta-btn') {
                    // Se a pauta est√° fechada, o REABRIR √© o √∫nico que deve estar ativo
                    btn.disabled = false;
                } else {
                    // Todos os outros bot√µes do menu A√ß√µes (Zerar, Fechar, Editar) ficam desativados
                    btn.disabled = isClosed; 
                }
            });
            const actionButtons = document.querySelectorAll('.check-in-btn, .delegate-finalization-btn, .attend-directly-btn, .faltou-btn, .return-to-pauta-btn, .delete-btn, .priority-btn, .edit-assisted-btn, .edit-attendant-btn, .return-to-aguardando-btn, .manage-demands-btn, .toggle-confirmed-atendido, .toggle-confirmed-faltoso'); // Adicionado
            actionButtons.forEach(btn => {
                btn.disabled = isClosed;
            });

            if (isClosed) {
                document.getElementById('closed-pauta-alert').classList.remove('hidden');
                document.getElementById('close-pauta-btn').classList.add('hidden');
                document.getElementById('reopen-pauta-btn').classList.remove('hidden');
            } else {
                document.getElementById('closed-pauta-alert').classList.add('hidden');
                document.getElementById('close-pauta-btn').classList.remove('hidden');
                document.getElementById('reopen-pauta-btn').classList.add('hidden');
            }

            if (!isOwner) {
                document.getElementById('close-pauta-btn').classList.add('hidden');
                document.getElementById('reopen-pauta-btn').classList.add('hidden');
            }
        };

      const createAguardandoCard = (a, index) => {
        const card = document.createElement('div');
        // Adicionado 'group' para controlar o aparecimento dos bot√µes e 'transition-all'
        card.className = `relative bg-white p-4 rounded-lg shadow-sm ${getPriorityClass(a.priority)} mb-2 group transition-all duration-200`;
        card.setAttribute('data-id', a.id);
    
        const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
        const isManual = pautaOrder === 'manual' && !isPautaClosed;
    
        // Indicador de Posi√ß√£o (Rank) e Bot√µes de Comando
        const rankAndControls = isManual ? `
            <!-- Indicador de Rank -->
            <div class="absolute -top-2 -left-2 bg-blue-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md z-20 border-2 border-white">
                ${index + 1}¬∫
            </div>
            
            <!-- Bot√µes de Movimenta√ß√£o Lateral (Aparecem no Hover) -->
            <div class="absolute -left-4 top-1/2 -translate-y-1/2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:translate-x-1 z-30">
                <button onclick="moveInQueue('${a.id}', 'top')" title="Mover para o Topo" class="bg-white text-blue-600 shadow-lg border border-blue-100 rounded-full p-1.5 hover:bg-blue-600 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 11l7-7 7 7M5 19l7-7 7 7" /></svg>
                </button>
                <button onclick="moveInQueue('${a.id}', 'up')" title="Subir uma posi√ß√£o" class="bg-white text-gray-700 shadow-lg border border-gray-100 rounded-full p-1.5 hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 15l7-7 7 7" /></svg>
                </button>
                <button onclick="moveInQueue('${a.id}', 'down')" title="Descer uma posi√ß√£o" class="bg-white text-gray-700 shadow-lg border border-gray-100 rounded-full p-1.5 hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
        ` : '';
    
        const arrival = a.type === 'agendamento' && a.scheduledTime 
            ? `Agendado: ${escapeHTML(a.scheduledTime)} | Chegou: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` 
            : `Chegada: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
    
        // APLICA√á√ÉO DE SEGURAN√áA: escapeHTML
        let atenderButton = currentPautaData?.useDelegationFlow
            ? `<button data-id="${a.id}" data-name="${escapeHTML(a.name)}" class="select-collaborator-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>`
            : `<button data-id="${a.id}" data-name="${escapeHTML(a.name)}" class="attend-directly-from-aguardando-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>`;
    
        card.innerHTML = `
            ${rankAndControls}
            <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-300 hover:text-red-600 p-1 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
            <div class="flex flex-col h-full ${isManual ? 'pl-3' : ''}">
                <p class="font-bold text-lg text-gray-800 leading-tight mb-1">${escapeHTML(a.name)}</p>
                <p class="text-xs text-gray-600 mb-2">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                <div class="flex flex-wrap gap-2 mb-3">
                    <span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded font-medium">${arrival}</span>
                    ${a.room ? `<span class="bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold border border-blue-100">${escapeHTML(a.room)}</span>` : ''}
                </div>
                <div class="mt-auto grid grid-cols-2 gap-2">
                    ${atenderButton}
                    <button data-id="${a.id}" class="priority-btn ${a.priority === 'URGENTE' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-red-500 hover:bg-red-600'} text-white font-semibold py-2 rounded-lg text-xs transition-colors">
                        ${a.priority === 'URGENTE' ? 'Urgente Ativado' : 'Prioridade'}
                    </button>
                </div>
                <button data-id="${a.id}" class="view-details-btn text-indigo-500 hover:text-indigo-700 text-[11px] font-bold mt-2 text-center underline">Ver Detalhes</button>
            </div>
        `;
        return card;
    };

        // --- FUN√á√ÉO PARA RENOMEAR SALA ---
        const renamePautaRoom = async (oldName, newName) => {
            if (!currentPautaId || !oldName || !newName || oldName === newName) return;

            // 1. Atualizar a lista de salas no documento da Pauta
            const pautaRef = doc(db, "pautas", currentPautaId);
            const pautaSnap = await getDoc(pautaRef);
            
            if (!pautaSnap.exists()) return;

            const pautaData = pautaSnap.data();
            let updatedRooms = pautaData.rooms || [];
            
            // Verifica se o novo nome j√° existe (para evitar duplicatas)
            if (updatedRooms.includes(newName)) {
                showNotification("J√° existe uma sala com esse nome.", "error");
                return;
            }

            // Substitui o nome antigo pelo novo mantendo a posi√ß√£o
            const roomIndex = updatedRooms.indexOf(oldName);
            if (roomIndex !== -1) {
                updatedRooms[roomIndex] = newName;
            }

            try {
                // Inicia um Batch (lote) para fazer tudo de uma vez
                const batch = writeBatch(db);

                // A. Atualiza a lista de salas na pauta
                batch.update(pautaRef, { rooms: updatedRooms });

                // B. Busca todos os assistidos que est√£o na sala antiga
                const attendancesRef = collection(db, "pautas", currentPautaId, "attendances");
                const q = query(attendancesRef, where("room", "==", oldName));
                const querySnapshot = await getDocs(q);

                // C. Atualiza cada assistido para a sala nova
                querySnapshot.forEach((docSnap) => {
                    batch.update(docSnap.ref, { 
                        room: newName,
                        lastActionBy: currentUserName,
                        lastActionTimestamp: new Date().toISOString()
                    });
                });

                await batch.commit();
                showNotification(`Sala renomeada para "${newName}" com sucesso!`);
            } catch (error) {
                console.error("Erro ao renomear sala:", error);
                showNotification("Erro ao renomear a sala.", "error");
            }
        };

        const renderAssistedList = () => {
            allAssisted.forEach(a => {
                if (a.status === 'aguardando' && a.priority !== 'URGENTE') {
                    a.priority = getPriorityLevel(a);
                }
            });

            const pautaList = document.getElementById('pauta-list');
            const aguardandoList = document.getElementById('aguardando-list');
            const emAtendimentoList = document.getElementById('em-atendimento-list');
            const atendidosList = document.getElementById('atendidos-list');
            const faltososList = document.getElementById('faltosos-list');
            [pautaList, aguardandoList, emAtendimentoList, atendidosList, faltososList].forEach(el => el.innerHTML = '');

            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';

            const pautaSearchTerm = normalizeText(document.getElementById('pauta-search').value);
            const aguardandoSearchTerm = normalizeText(document.getElementById('aguardando-search').value);
            const emAtendimentoSearchTerm = normalizeText(document.getElementById('em-atendimento-search').value);
            const atendidosSearchTerm = normalizeText(document.getElementById('atendidos-search').value);
            const faltososSearchTerm = normalizeText(document.getElementById('faltosos-search').value);

            const pauta = allAssisted.filter(a => a.status === 'pauta' && a.type === 'agendamento' && searchFilter(a, pautaSearchTerm));
            const aguardando = allAssisted.filter(a => a.status === 'aguardando' && a.type === currentMode && searchFilter(a, aguardandoSearchTerm));
            const emAtendimento = allAssisted.filter(a => a.status === 'emAtendimento' && a.type === currentMode && searchFilter(a, emAtendimentoSearchTerm));
            const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === currentMode && searchFilter(a, atendidosSearchTerm));
            const faltosos = allAssisted.filter(a => a.status === 'faltoso' && a.type === 'agendamento' && searchFilter(a, faltososSearchTerm));

            pauta.sort((a, b) => (a.scheduledTime || '23:59').localeCompare(b.scheduledTime || '23:59'));
            atendidos.sort((a, b) => new Date(b.attendedTime) - new Date(a.attendedTime));
            faltosos.sort((a, b) => (a.scheduledTime || '00:00').localeCompare(b.scheduledTime || '00:00'));

      // Ordena√ß√£o da coluna Aguardando
            aguardando.sort((a, b) => {
                const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
            
                // Se for Manual, prioriza o √≠ndice que definimos arrastando
                if (pautaOrder === 'manual') {
                    // Casos URGENTES continuam sempre no topo, mesmo no manual (opcional)
                    if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                    if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;
            
                    // Se ambos forem urgentes ou ambos comuns, usa o √≠ndice manual
                    const indexA = a.manualIndex !== undefined ? a.manualIndex : 999;
                    const indexB = b.manualIndex !== undefined ? b.manualIndex : 999;
                    return indexA - indexB;
                }         
                
                if (pautaOrder === 'chegada') {
                    const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                    const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                    if (arrivalA !== arrivalB) return arrivalA - arrivalB;
                    return (a.createdAt || 0) - (b.createdAt || 0);
                } else { // 'padrao'
                    const order = { 'M√°xima': 1, 'M√©dia': 2, 'M√≠nima': 3 };
                    const priorityDiff = order[a.priority] - order[b.priority];
                    if (priorityDiff !== 0) return priorityDiff;

                    if (a.priority === 'M√°xima' && a.type === 'agendamento') {
                        const scheduledA = a.scheduledTime || '23:59';
                        const scheduledB = b.scheduledTime || '23:59';
                        if (scheduledA.localeCompare(scheduledB) !== 0) return scheduledA.localeCompare(scheduledB);
                    }

                    const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                    const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                    if (arrivalA !== arrivalB) return arrivalA - arrivalB;

                    return (a.createdAt || 0) - (b.createdAt || 0);
                }
            });
            // Ordena√ß√£o para "Em Atendimento" - mais recente primeiro, ou por colaborador
            emAtendimento.sort((a, b) => new Date(b.inAttendanceTime) - new Date(a.inAttendanceTime));


            document.getElementById('pauta-count').textContent = pauta.length;
            document.getElementById('aguardando-count').textContent = aguardando.length;
            document.getElementById('em-atendimento-count').textContent = emAtendimento.length;
            document.getElementById('faltosos-count').textContent = faltosos.length;
            document.getElementById('atendidos-count').textContent = atendidos.length;

            const render = (el, data, generator) => {
                // Ajustado o espa√ßamento entre os cards
                if(data.length === 0) el.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
                else data.forEach((item, index) => el.appendChild(generator(item, index)));
            };

            render(pautaList, pauta, a => {
                const card = document.createElement('div');
                card.className = 'relative bg-gray-50 p-4 rounded-lg shadow-sm border';
                // USO DO escapeHTML AQUI:
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <p class="font-bold text-lg">${escapeHTML(a.name)}</p>
                    ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                    <p>Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                    <p>Agendado: <strong>${a.scheduledTime}</strong></p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <button data-id="${a.id}" class="check-in-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Marcar Chegada</button>
                        <button data-id="${a.id}" class="faltou-btn bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600">Faltou</button>
                        <button data-id="${a.id}" class="edit-assisted-btn col-span-2 bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600">Editar Dados</button>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });

            // --- L√ìGICA NOVA PARA RENDERIZAR AGUARDANDO (MULTI-SALA) ---
            aguardandoList.innerHTML = ''; // Limpa a lista

            // Verifica se √© multisala e se temos salas definidas
            if (currentPautaData?.type === 'multisala' && currentPautaData.rooms && currentPautaData.rooms.length > 0) {
                
                // Para cada sala, cria uma se√ß√£o
                currentPautaData.rooms.forEach(roomName => {
                    // Filtra pessoas desta sala
                    const peopleInRoom = aguardando.filter(a => a.room === roomName);
                    
                    // Cria cabe√ßalho da sala (COM BOT√ÉO DE EDITAR)
                    const roomHeader = document.createElement('div');
                    roomHeader.className = "bg-blue-100 text-blue-800 font-bold px-3 py-2 rounded-md mt-4 mb-2 text-sm uppercase flex justify-between items-center group";
                    
                    roomHeader.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>üè¢ ${escapeHTML(roomName)}</span>
                            <button class="edit-room-name-btn text-blue-400 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity" data-room="${escapeHTML(roomName)}" title="Renomear Sala">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                        </div>
                        <span class="bg-white text-blue-800 px-2 rounded-full text-xs">${peopleInRoom.length}</span>
                    `;
                    aguardandoList.appendChild(roomHeader);

                    if (peopleInRoom.length === 0) {
                        const emptyMsg = document.createElement('div');
                        emptyMsg.className = "text-gray-400 text-xs text-center italic mb-2";
                        emptyMsg.textContent = "Vazio";
                        aguardandoList.appendChild(emptyMsg);
                    } else {
                        peopleInRoom.forEach((item, index) => {
                            const card = createAguardandoCard(item, index);
                            aguardandoList.appendChild(card);
                        });
                    }
                });

                // Renderiza quem est√° "Aguardando" mas sem sala definida (fallback)
                const noRoom = aguardando.filter(a => !a.room);
                if (noRoom.length > 0) {
                    const header = document.createElement('div');
                    header.className = "bg-gray-200 text-gray-700 font-bold px-3 py-2 rounded-md mt-4 mb-2 text-sm uppercase";
                    header.textContent = "‚ö†Ô∏è Sem Sala Definida";
                    aguardandoList.appendChild(header);
                    noRoom.forEach((item, index) => aguardandoList.appendChild(createAguardandoCard(item, index)));
                }

            } else {
                // --- COMPORTAMENTO PADR√ÉO (C√ìDIGO ORIGINAL) ---
                if(aguardando.length === 0) aguardandoList.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
                else aguardando.forEach((item, index) => aguardandoList.appendChild(createAguardandoCard(item, index)));
            }
            
            // Renderizar a nova coluna "Em Atendimento"
            render(emAtendimentoList, emAtendimento, (a, index) => {
                const card = document.createElement('div');
                card.className = `relative bg-purple-50 p-4 rounded-lg shadow-sm border-purple-200`;
                const inAttendanceTime = new Date(a.inAttendanceTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                // Note o escapeHTML aqui tamb√©m
                const assignedCollabText = a.assignedCollaborator?.name ? `Colaborador: <strong>${escapeHTML(a.assignedCollaborator.name)}</strong>` : 'Colaborador: N√£o atribu√≠do';
                
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <p class="font-bold text-lg">${index + 1}. ${escapeHTML(a.name)}</p>
                    ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                    <p class="text-sm">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                    <p class="text-sm">${assignedCollabText}</p>
                    <p class="text-sm text-gray-500">In√≠cio: ${inAttendanceTime}</p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <button data-id="${a.id}" data-name="${escapeHTML(a.name)}" data-collaborator-name="${escapeHTML(a.assignedCollaborator?.name || 'N√£o informado')}" data-collaborator-id="${a.assignedCollaborator?.id || ''}" class="delegate-finalization-btn bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-600">Delegar Finaliza√ß√£o</button>
                        <button data-id="${a.id}" data-name="${escapeHTML(a.name)}" data-collaborator-name="${escapeHTML(a.assignedCollaborator?.name || 'N√£o informado')}" class="attend-directly-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Finalizar Diretamente</button>
                        <button data-id="${a.id}" class="return-to-aguardando-from-emAtendimento-btn col-span-2 bg-gray-400 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-500">Voltar p/ Aguardando</button>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });
render(atendidosList, atendidos, a => {
                const card = document.createElement('div');
                const confirmedBtnBgClass = a.isConfirmed ? 'bg-green-500' : 'bg-gray-400';
                const confirmedBtnHoverClass = a.isConfirmed ? 'hover:bg-green-600' : 'hover:bg-gray-500';
                const confirmationInfo = a.isConfirmed && a.confirmationDetails ? 
                    `<span class="text-xs opacity-75 block">Por: ${escapeHTML(a.confirmationDetails.confirmedBy)} em ${new Date(a.confirmationDetails.confirmedAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'})}</span>` : '';

                card.className = 'relative bg-green-50 p-4 rounded-lg shadow-sm border-green-200';
                const totalAssuntos = 1 + (a.demandas?.quantidade ? Number(a.demandas.quantidade) : 0);
                
                // Sanitiza√ß√£o das Demandas Adicionais
                const demandasInfo = a.demandas?.descricoes?.length > 0 ? 
                    `<div class="mt-2 text-xs bg-gray-100 p-2 rounded"><strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong><ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${escapeHTML(d)}</li>`).join('')}</ul></div>` : '';
                
                // Sanitiza√ß√£o do nome do atendente
                let attendantNameDisplay = 'N√£o informado';
                if (a.attendant) {
                    if (typeof a.attendant === 'object' && a.attendant !== null) {
                        attendantNameDisplay = a.attendant.nome || a.attendant.name || 'Sem nome';
                    } else {
                        attendantNameDisplay = a.attendant;
                    }
                }
                attendantNameDisplay = escapeHTML(attendantNameDisplay);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="font-bold text-lg inline-flex items-center">
                            ${escapeHTML(a.name)} ${totalAssuntos > 1 ? `<span class="text-sm font-medium text-green-600 ml-1">(${totalAssuntos} assuntos)</span>` : ''}
                        </p>
                        <button data-id="${a.id}" class="toggle-confirmed-atendido confirm-btn-style ${confirmedBtnBgClass} ${confirmedBtnHoverClass} text-white">
                            <svg class="confirm-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01.105L7.882 12.5a.733.733 0 0 1-1.065.04L3.257 8.375a.733.733 0 0 1 1.064-.04l2.254 2.255Z"/></svg>
                        </button>
                    </div>
                    <div class="card-details mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                        <p class="text-sm">Assunto Principal: <strong>${escapeHTML(a.subject)}</strong></p>
                        <div class="text-xs text-gray-600 grid grid-cols-3 gap-2 text-center border-y py-2">
                            <div><strong>Agendado:</strong><br>${a.scheduledTime || 'N/A'}</div>
                            <div><strong>Chegou:</strong><br>${a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                            <div><strong>Finalizado:</strong><br>${formatTime(a.attendedTime)}</div>
                        </div>
                        ${demandasInfo}
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm">Por: <strong>${attendantNameDisplay}</strong></p>
                            <div class="flex items-center gap-1 flex-wrap">
                                <button data-id="${a.id}" class="manage-demands-btn text-blue-600 hover:text-blue-800 font-semibold text-xs py-1 px-2 rounded hover:bg-blue-100">Demandas</button>
                                <button data-id="${a.id}" class="edit-assisted-btn text-gray-600 hover:text-gray-800 font-semibold text-xs py-1 px-2 rounded hover:bg-gray-100">Dados</button>
                                <button data-id="${a.id}" class="edit-attendant-btn text-green-600 hover:text-green-800 font-semibold text-xs py-1 px-2 rounded hover:bg-green-100">Atendente</button>
                                <button data-id="${a.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold text-xs py-1 px-2 rounded hover:bg-red-100">Deletar</button>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t flex justify-between items-center">
                            ${a.lastActionBy ? `<p class="text-xs text-gray-500">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></p>` : '<div></div>'}
                            <button data-id="${a.id}" data-assigned-collaborator='${JSON.stringify(a.assignedCollaborator || null)}' class="return-from-atendido-btn ${currentPautaData?.useDelegationFlow ? 'bg-orange-500 hover:bg-orange-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white font-semibold py-1 px-3 rounded-lg text-xs">
                                ${currentPautaData?.useDelegationFlow ? 'Voltar p/ Em Atendimento' : 'Voltar p/ Aguardando'}
                            </button>
                        </div>
                        ${confirmationInfo}
                    </div>
                    <div class="text-right mt-1">
                         <button class="toggle-details-btn text-gray-500 hover:text-gray-800 p-1">
                             <svg class="pointer-events-none" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                         </button>
                    </div>`;
                return card;
            });

            render(faltososList, faltosos, a => {
                const card = document.createElement('div');
                // ... (l√≥gica de confirma√ß√£o mant√©m igual) ...

                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg ...></svg></button>
                    <div class="flex items-center justify-between">
                        <p class="font-bold text-lg inline-flex items-center">
                            ${escapeHTML(a.name)}
                        </p>
                        <button data-id="${a.id}" class="toggle-confirmed-faltoso confirm-btn-style ${confirmedBtnBgClass} ${confirmedBtnHoverClass} text-white">
                            <svg class="confirm-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01.105L7.882 12.5a.733.733 0 0 1-1.065.04L3.257 8.375a.733.733 0 0 1 1.064-.04l2.254 2.255Z"/></svg>
                        </button>
                    </div>
                    <div class="mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                        <p class="text-sm">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                        <p class="text-sm">Agendado: <strong>${a.scheduledTime}</strong></p>
                        <div class="mt-3">
                            <button data-id="${a.id}" class="return-to-pauta-from-faltoso-btn w-full bg-gray-500 text-white font-semibold py-1 rounded-lg hover:bg-gray-600 text-xs">Revertido para Pauta</button>
                        </div>
                        ${confirmationInfo}
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });

            togglePautaLock(isPautaClosed);

            // ADICIONE ESTA LINHA AQUI:
            setupManualSort()
        };


        const setupRealtimeListener = (pautaId) => {
            if (unsubscribeFromAttendances) unsubscribeFromAttendances();
            const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
            unsubscribeFromAttendances = onSnapshot(attendanceCollectionRef, (snapshot) => {
                allAssisted = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssistedList();
            }, (error) => console.error("Erro no listener do Firestore: ", error));
        };

        // --- IN√çCIO DA L√ìGICA DE GERENCIAR MEMBROS DA PAUTA (COMPARTILHAR) ---
        const membersModal = document.getElementById('members-modal');
        const inviteEmailInput = document.getElementById('invite-email-input');
        const inviteMemberBtn = document.getElementById('invite-member-btn');
        const inviteStatus = document.getElementById('invite-status');
        const membersListContainer = document.getElementById('members-list-container'); // Onde os membros s√£o listados

        const showMembersModal = async () => {
            if (!currentPautaId) return;
            membersModal.classList.remove('hidden');
            inviteStatus.textContent = ''; // Limpar status de convite anterior

            const pautaRef = doc(db, "pautas", currentPautaId);
            const pautaSnap = await getDoc(pautaRef);
            if (pautaSnap.exists()) {
                const pautaData = pautaSnap.data();
                currentPautaOwnerId = pautaData.owner;
                membersListContainer.innerHTML = ''; // Limpar lista antes de popular

                if (pautaData.memberEmails && pautaData.memberEmails.length > 0) {
                    pautaData.memberEmails.forEach(email => {
                        const isOwner = pautaData.ownerEmail === email;
                        const memberEl = document.createElement('div');
                        memberEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                        memberEl.innerHTML = `
                            <span>${email} ${isOwner ? '<span class="text-xs text-yellow-600 font-bold">(dono)</span>' : ''}</span>
                            ${!isOwner ? `<button data-email="${email}" class="remove-member-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remover</button>` : ''}
                        `;
                        membersListContainer.appendChild(memberEl);
                    });
                } else {
                    membersListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum membro na pauta. Convide algu√©m!</p>';
                }
            }
        };

        inviteMemberBtn.addEventListener('click', async () => {
            const email = inviteEmailInput.value.trim().toLowerCase();
            if (!email) {
                inviteStatus.textContent = 'Por favor, insira um email.';
                return;
            }
            inviteStatus.textContent = 'Verificando...';

            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                inviteStatus.textContent = 'Usu√°rio n√£o encontrado em nosso sistema.';
                return;
            }
            
            const userDoc = querySnapshot.docs[0];
            const pautaRef = doc(db, "pautas", currentPautaId);

            try {
                await updateDoc(pautaRef, {
                    members: arrayUnion(userDoc.id),
                    memberEmails: arrayUnion(email)
                });
                inviteStatus.textContent = `Usu√°rio ${email} convidado com sucesso!`;
                inviteEmailInput.value = '';
                showMembersModal(); // Atualiza a lista no modal
            } catch (error) {
                console.error("Erro ao convidar membro:", error);
                inviteStatus.textContent = 'Erro ao convidar usu√°rio.';
            }
        });

        document.body.addEventListener('click', async (e) => { // Este listener j√° existe, vou apenas adicionar a parte de remover membro
            if (e.target.classList.contains('remove-member-btn')) {
                const email = e.target.dataset.email;
                if (confirm(`Tem certeza que deseja remover ${email} desta pauta?`)) {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userIdToRemove = querySnapshot.docs[0].id;
                        const pautaRef = doc(db, "pautas", currentPautaId);
                        try {
                            await updateDoc(pautaRef, {
                                members: arrayRemove(userIdToRemove),
                                memberEmails: arrayRemove(email)
                            });
                            showNotification(`Membro ${email} removido da pauta.`);
                            showMembersModal(); // Atualiza a lista no modal
                        } catch (error) {
                            console.error("Erro ao remover membro:", error);
                            showNotification("Erro ao remover membro.", "error");
                        }
                    }
                }
            }
        });
        // --- FIM DA L√ìGICA DE GERENCIAR MEMBROS DA PAUTA ---


        // --- IN√çCIO DA L√ìGICA DE GERENCIAR COLABORADORES (LISTA DE PRESEN√áA) ---
        // Refer√™ncias aos elementos do modal de colaboradores
        const collaboratorsModal = document.getElementById('collaborators-modal');
        const collaboratorFormModal = document.getElementById('collaborator-form-modal');
        const collaboratorNameModal = document.getElementById('collaborator-name-modal');
        const collaboratorEmailModal = document.getElementById('collaborator-email-modal'); // NOVO CAMPO
        const collaboratorPhoneModal = document.getElementById('collaborator-phone-modal');
        const transporteOptionsModal = document.querySelectorAll('input[name="transporte-colaborador"]');
        const localEncontroGroupModal = document.getElementById('local-encontro-group-modal');
        const observacaoGroupModal = document.getElementById('observacao-group-modal');
        const collaboratorObsModal = document.getElementById('collaborator-obs-modal');
        const addCollaboratorBtnModal = document.getElementById('add-collaborator-btn-modal');
        const collaboratorListTableBodyModal = document.querySelector('#collaborators-list-table-modal tbody');
        const downloadCollaboratorsPdfBtnModal = document.getElementById('download-collaborators-pdf-modal');
        const clearCollaboratorsListBtnModal = document.getElementById('clear-collaborators-list-modal');
        
        // Stats
        const totalParticipantsCount = document.getElementById('total-participants-count');
        const selfTransportCount = document.getElementById('self-transport-count');
        const companyTransportCount = document.getElementById('company-transport-count');


        function setupCollaboratorsListener(pautaId) {
            if (!auth.currentUser) {
                console.error("Tentativa de iniciar o listener de colaboradores sem usu√°rio autenticado.");
                showNotification("Erro de autentica√ß√£o. Por favor, recarregue a p√°gina.", "error");
                return;
            }
            if (unsubscribeFromCollaborators) {
                unsubscribeFromCollaborators();
            }
            const collaboratorsCollectionRef = collection(db, "pautas", pautaId, "collaborators");
            unsubscribeFromCollaborators = onSnapshot(collaboratorsCollectionRef, (snapshot) => {
                colaboradores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)); 
                renderColaboradores();
            }, (error) => {
                console.error("Erro no listener de colaboradores: ", error);
                collaboratorListTableBodyModal.innerHTML = '<tr><td colspan="7" class="text-center py-4">Erro ao carregar colaboradores.</td></tr>'; // Ajustado colspan
            });
        }

function renderColaboradores() {
            collaboratorListTableBodyModal.innerHTML = '';

            let selfTransport = 0;
            let companyTransport = 0;
            
            if (colaboradores.length === 0) {
                // Ajustei o colspan para 9 para cobrir todas as colunas
                collaboratorListTableBodyModal.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Nenhum colaborador adicionado.</td></tr>'; 
                totalParticipantsCount.textContent = 0;
                selfTransportCount.textContent = 0;
                companyTransportCount.textContent = 0;
                return;
            }
            
            colaboradores.forEach((colaborador) => {
                const newRow = document.createElement('tr');
                newRow.className = "bg-white border-b";

                let deslocamentoTexto = colaborador.transporte || 'N√£o Confirmado';
                if (colaborador.transporte === 'Com a Empresa' && colaborador.localEncontro) {
                    deslocamentoTexto += ` (${colaborador.localEncontro})`;
                }
                if (colaborador.transporte === 'Meios Pr√≥prios') selfTransport++;
                if (colaborador.transporte === 'Com a Empresa') companyTransport++;

                // --- CORRE√á√ÉO: Apenas UMA declara√ß√£o de nomeElement ---
                let nomeElement = escapeHTML(colaborador.nome); 
                if (colaborador.transporte === 'Com a Empresa' && colaborador.localEncontro === 'Sede') {
                     nomeElement = `<strong>${escapeHTML(colaborador.nome)}</strong>`;
                }
                // -----------------------------------------------------

                newRow.innerHTML = `
                    <td class="py-4 px-6 font-medium text-gray-900">${nomeElement}</td>
                    <td class="py-4 px-6">${escapeHTML(colaborador.cargo || 'N/A')}</td>     
                    <td class="py-4 px-6">${escapeHTML(colaborador.equipe || 'N/A')}</td>     
                    <td class="py-4 px-6"><input type="checkbox" class="checkin-checkbox" data-id="${colaborador.id}" ${colaborador.presente ? 'checked' : ''} ${isPautaClosed ? 'disabled' : ''}></td> 
                    <td class="py-4 px-6">${colaborador.horario || '--:--'}</td> 
                    <td class="py-4 px-6">${escapeHTML(colaborador.email || 'N/A')}</td>       
                    <td class="py-4 px-6">${escapeHTML(deslocamentoTexto)}</td>
                    <td class="py-4 px-6">
                        <a href="https://wa.me/55${colaborador.telefone.replace(/\D/g, '')}?text=${encodeURIComponent(`Bom dia! Poderia, por gentileza, informar se j√° est√° chegando? Estamos quase saindo.`)}" 
                            class="text-blue-600 hover:underline" target="_blank">
                            Mensagem
                        </a>
                    </td>
                    <td class="py-4 px-6 space-x-2">
                        <button class="edit-collaborator-btn text-gray-500 hover:text-gray-900" data-id="${colaborador.id}" title="Editar" ${isPautaClosed ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="delete-collaborator-btn text-red-500 hover:text-red-700" data-id="${colaborador.id}" title="Excluir" ${isPautaClosed ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
                collaboratorListTableBodyModal.appendChild(newRow);
            });
            
            totalParticipantsCount.textContent = colaboradores.length;
            selfTransportCount.textContent = selfTransport;
            companyTransportCount.textContent = companyTransport;

            addEventListenersToModalListActions(); 
        }

        function resetCollaboratorFormModal() {
            collaboratorFormModal.reset();
            document.querySelector('input[name="transporte-colaborador"][value="N√£o Confirmado"]').checked = true;
            editCollaboratorId = null;
            collaboratorsModal.querySelector('h2').textContent = "Lista de Presen√ßa de Colaboradores"; // Reset modal title
            addCollaboratorBtnModal.textContent = "Adicionar Colaborador";
            localEncontroGroupModal.classList.add('hidden');
            observacaoGroupModal.classList.add('hidden');
        }

        transporteOptionsModal.forEach(option => {
            option.addEventListener('change', (event) => {
                localEncontroGroupModal.classList.toggle('hidden', event.target.value !== 'Com a Empresa');
                observacaoGroupModal.add('hidden'); 
                if (event.target.value !== 'Com a Empresa') {
                    document.querySelectorAll('input[name="localEncontro-colaborador"]').forEach(localOption => localOption.checked = false);
                }
            });
        });

        document.querySelectorAll('input[name="localEncontro-colaborador"]').forEach(option => {
            option.addEventListener('change', (event) => {
                observacaoGroupModal.classList.toggle('hidden', event.target.value !== 'Meio do Caminho');
            });
        });

       collaboratorFormModal.addEventListener('submit', async (event) => {
            event.preventDefault();
            const nome = collaboratorNameModal.value;
            
            // --- IN√çCIO DA CORRE√á√ÉO: CAPTURANDO CARGO E EQUIPE ---
            const cargo = document.getElementById('collaborator-role-modal').value;
            const equipe = document.getElementById('collaborator-team-modal').value;
            // --- FIM DA CORRE√á√ÉO ---

            const email = collaboratorEmailModal.value.trim() || null;
            const telefone = collaboratorPhoneModal.value;
            const transporte = collaboratorFormModal.querySelector('input[name="transporte-colaborador"]:checked').value;
            const localEncontro = collaboratorFormModal.querySelector('input[name="localEncontro-colaborador"]:checked')?.value || '';
            const observacao = collaboratorObsModal.value;

            // Incluindo Cargo e Equipe no objeto de dados
            const collaboratorData = { nome, cargo, equipe, email, telefone, transporte, localEncontro, observacao }; 

            try {
                const collaboratorsCollectionRef = collection(db, "pautas", currentPautaId, "collaborators");
                if (editCollaboratorId) {
                    const collaboratorRef = doc(collaboratorsCollectionRef, editCollaboratorId);
                    await updateDoc(collaboratorRef, collaboratorData);
                    showNotification("Colaborador atualizado com sucesso!");
                } else {
                    // Adiciona o novo colaborador com todos os dados
                    await addDoc(collaboratorsCollectionRef, { ...collaboratorData, presente: false, horario: '--:--' });
                    showNotification("Colaborador adicionado com sucesso!");
                }
                resetCollaboratorFormModal();
            } catch (error) {
                console.error("Erro ao salvar colaborador: ", error);
                showNotification("Erro ao salvar colaborador.", "error");
            }
        });
        function addEventListenersToModalListActions() {
            document.querySelectorAll('#collaborators-modal .checkin-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const docId = e.target.dataset.id;
                    const presente = e.target.checked;
                    const horario = presente ? new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                    const collaboratorRef = doc(db, "pautas", currentPautaId, "collaborators", docId);
                    await updateDoc(collaboratorRef, { presente, horario });
                });
            });

            document.querySelectorAll('#collaborators-modal .edit-collaborator-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const collaboratorRef = doc(db, "pautas", currentPautaId, "collaborators", docId);
                    const docSnap = await getDoc(collaboratorRef);
                    if (docSnap.exists()) {
                       const colaborador = docSnap.data();
                        editCollaboratorId = docId;
                        collaboratorNameModal.value = colaborador.nome;
                        collaboratorEmailModal.value = colaborador.email || ''; // Preenche o campo de email
                        collaboratorPhoneModal.value = colaborador.telefone;
                        collaboratorObsModal.value = colaborador.observacao || '';
                        
                        // --- IN√çCIO DA CORRE√á√ÉO: PREENCHE CARGO E EQUIPE AO EDITAR ---
                        const roleSelect = document.getElementById('collaborator-role-modal');
                        if(roleSelect) roleSelect.value = colaborador.cargo || ''; 
                        
                        const teamSelect = document.getElementById('collaborator-team-modal');
                        if(teamSelect) teamSelect.value = colaborador.equipe || '';
                        // --- FIM DA CORRE√á√ÉO ---
                        
                        const transporteRadio = document.querySelector(`input[name="transporte-colaborador"][value="${colaborador.transporte}"]`);
                        if (transporteRadio) {
                            transporteRadio.checked = true;
                            transporteRadio.dispatchEvent(new Event('change'));
                        }

                        const localEncontroRadio = document.querySelector(`input[name="localEncontro-colaborador"][value="${colaborador.localEncontro}"]`);
                        if (localEncontroRadio) {
                            localEncontroRadio.checked = true;
                            localEncontroRadio.dispatchEvent(new Event('change'));
                        }

                        collaboratorsModal.querySelector('h2').textContent = "Editar Colaborador"; // Update modal title if needed
                        addCollaboratorBtnModal.textContent = "Salvar Altera√ß√µes";
                        collaboratorsModal.querySelector('.flex-grow.overflow-y-auto.pr-2').scrollTop = 0; // Scroll to top of form
                    }
                });
            });

            document.querySelectorAll('#collaborators-modal .delete-collaborator-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    // Usando o modal de confirma√ß√£o existente no index.html
                    showConfirmModal(() => {
                        const collaboratorRef = doc(db, "pautas", currentPautaId, "collaborators", docId);
                        deleteDoc(collaboratorRef);
                    }, `Tem certeza que deseja excluir este colaborador?`);
                });
            });
        }
        
        // PDF Download for modal's lis
        // Relat√≥rio de Assistidos
        document.getElementById('download-pdf-btn').addEventListener('click', () => {
            const atendidos = allAssisted.filter(a => a.status === 'atendido');
            generateAtendidosPDF(document.getElementById('pauta-title').textContent, atendidos);
        });
        
        // PDF da Equipe
        downloadCollaboratorsPdfBtnModal.addEventListener('click', () => {
            generateCollaboratorsPDF(document.getElementById('pauta-title').textContent, colaboradores);
        });

        
        // Clear list for modal's list
        clearCollaboratorsListBtnModal.addEventListener('click', () => {
            // Usando o modal de confirma√ß√£o existente no index.html
            showConfirmModal(async () => {
                const collaboratorsCollectionRef = collection(db, "pautas", currentPautaId, "collaborators");
                const snapshot = await getDocs(collaboratorsCollectionRef);
                if (snapshot.empty) {
                    showNotification("A lista j√° est√° limpa.", "info");
                    return;
                }
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                resetCollaboratorFormModal();
                showNotification("Lista de colaboradores limpa.", "success");
            }, 'Tem certeza que deseja limpar toda a lista?<br>Esta a√ß√£o n√£o pode ser desfeita.');
        });
        // --- FIM DA L√ìGICA DE COLABORADORES ---

        const loadPauta = async (pautaId, pautaName, pautaType) => {
            currentPautaId = pautaId;
            document.getElementById('pauta-title').textContent = pautaName;

            // Salva a pauta atual no localStorage
            localStorage.setItem('lastPautaId', pautaId);
            localStorage.setItem('lastPautaType', pautaType);

            const tabAgendamento = document.getElementById('tab-agendamento');
            const tabAvulso = document.getElementById('tab-avulso');
            const pautaColumn = document.getElementById('pauta-column');
            const emAtendimentoColumn = document.getElementById('em-atendimento-column');
            const mainContent = document.getElementById('main-content');

            const pautaDoc = await getDoc(doc(db, "pautas", pautaId));
            if (pautaDoc.exists()) {
                const pautaData = pautaDoc.data();

                const creationDate = pautaData.createdAt ? new Date(pautaData.createdAt) : new Date();
                const expirationDate = new Date(creationDate);
                expirationDate.setDate(creationDate.getDate() + 7);
                if (new Date() > expirationDate) {
                    showNotification("Pauta inacess√≠vel pois cumpriu seu prazo.", "error");
                    return;
                }

                currentPautaData = pautaData;
                currentPautaOwnerId = pautaData.owner;
                isPautaClosed = pautaData.isClosed || false;
                
                const ordem = currentPautaData.ordemAtendimento || 'padrao';
                document.getElementById('logic-explanation-padrao').classList.toggle('hidden', ordem !== 'padrao');
                document.getElementById('logic-explanation-chegada').classList.toggle('hidden', ordem !== 'chegada');
                document.getElementById('order-explanation-title').textContent = ordem === 'padrao' ? 'Entenda a Ordem de Atendimento Padr√£o' : 'Entenda a Ordem de Chegada';
                document.getElementById('toggle-logic-btn-padrao').addEventListener('click', (e) => {
                    const explanationDiv = document.getElementById('logic-explanation-padrao-content');
                    const isHidden = explanationDiv.classList.toggle('hidden');
                    e.target.textContent = isHidden ? 'Por que esta ordem √© justa? (Clique para expandir)' : 'Ocultar explica√ß√£o';
                });

                togglePautaLock(isPautaClosed);

                if (pautaData.owner === auth.currentUser.uid) {
                    document.getElementById('edit-pauta-name-btn').classList.remove('hidden');
                } else {
                    document.getElementById('edit-pauta-name-btn').classList.add('hidden');
                }

                // L√ìGICA DE LAYOUT DIN√ÇMICO DOS CARDS
                if (pautaData.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                    mainContent.classList.remove('lg:grid-cols-3');
                    mainContent.classList.add('lg:grid-cols-4');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                    mainContent.classList.remove('lg:grid-cols-4');
                    mainContent.classList.add('lg:grid-cols-3');
                }

            }
             if (pautaType === 'agendado') {
                 tabAgendamento.classList.remove('hidden');
                 tabAvulso.classList.add('hidden');
                 pautaColumn.classList.remove('hidden');
                 switchTab('agendamento');
            } else if (pautaType === 'avulso') {
                 tabAvulso.classList.remove('hidden');
                 tabAgendamento.classList.add('hidden');
                 pautaColumn.classList.add('hidden');
                 switchTab('avulso');
            } else {
                tabAgendamento.classList.remove('hidden');
                tabAvulso.classList.remove('hidden');
                pautaColumn.classList.remove('hidden');
                switchTab('agendamento');
            }

            setupRealtimeListener(pautaId);
            setupCollaboratorsListener(pautaId); // Inicia o listener para colaboradores
            showScreen('app');
        };

        const deletePauta = async (pautaId) => {
            try {
                await deleteDoc(doc(db, "pautas", pautaId));
            } catch (error) {
                console.error("Erro ao excluir a pauta:", error);
                showNotification("Erro ao excluir a pauta.", "error");
            }
        };

        const createPautaCard = (docSnap, isExpired) => {
            const pauta = docSnap.data();
            const card = document.createElement('div');
            card.className = "relative bg-white p-6 rounded-lg shadow-md flex flex-col justify-between h-full";
            
            if (isExpired) {
                card.classList.add('opacity-60', 'bg-gray-100', 'cursor-not-allowed');
            } else {
                card.classList.add('hover:shadow-xl', 'transition-shadow', 'cursor-pointer');
            }

            const deleteButton = document.createElement('button');
            deleteButton.className = "absolute top-3 right-3 p-1 rounded-full text-gray-400 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500";
            deleteButton.setAttribute('aria-label', 'Excluir pauta');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                if (confirm(`Tem certeza que deseja apagar a pauta "${pauta.name}"?`)) {
                    logAction('DELETE_PAUTA', `Apagou a pauta "${pauta.name}"`, docSnap.id); //LOG de Deletar
                    deletePauta(docSnap.id);
                }
            });

            card.appendChild(deleteButton);

            const creationDate = pauta.createdAt ? new Date(pauta.createdAt) : new Date();
            const expirationDate = new Date(creationDate);
            expirationDate.setDate(creationDate.getDate() + 7);

            const formattedCreationDate = creationDate.toLocaleDateString('pt-BR');
            const formattedExpirationDate = expirationDate.toLocaleDateString('pt-BR');

            const contentDiv = document.createElement('div');
            const title = document.createElement('h3');
            title.className = "font-bold text-xl mb-2";
            title.textContent = pauta.name;

            const members = document.createElement('p');
            members.className = "text-gray-600";
            members.textContent = `Membros: ${pauta.memberEmails?.length || 1}`;

            contentDiv.appendChild(title);
            contentDiv.appendChild(members);

            const footerDiv = document.createElement('div');
            footerDiv.className = "mt-4 pt-2 border-t border-gray-200";
            const createdP = document.createElement('p');
            createdP.className = "text-xs text-gray-500";
            createdP.innerHTML = `Criada em: <strong>${formattedCreationDate}</strong>`;

            const expiresP = document.createElement('p');
            if (isExpired) {
                expiresP.className = "text-xs text-gray-500 font-semibold";
                expiresP.innerHTML = `Prazo de acesso expirou em: <strong>${formattedExpirationDate}</strong>`;
            } else {
                expiresP.className = "text-xs text-red-600";
                expiresP.innerHTML = `Ser√° eliminada em: <strong>${formattedExpirationDate}</strong>`;
            }

            footerDiv.appendChild(createdP);
            footerDiv.appendChild(expiresP);
            card.appendChild(contentDiv);
            card.appendChild(footerDiv);
            
            card.addEventListener('click', (event) => {
                if (event.target.closest('button')) return;

                if (isExpired) {
                    showNotification("Pauta inacess√≠vel pois cumpriu seu prazo.", "error");
                } else {
                    loadPauta(docSnap.id, pauta.name, pauta.type);
                }
            });
            return card;
        };


        const showPautaSelectionScreen = (userId) => {
            // Limpa o localStorage para a √∫ltima pauta quando volta para a sele√ß√£o
            localStorage.removeItem('lastPautaId');
            localStorage.removeItem('lastPautaType');

            const pautasList = document.getElementById('pautas-list');
            pautasList.innerHTML = '<p class="col-span-full text-center">Carregando pautas...</p>';

            const q = query(collection(db, "pautas"), where("members", "array-contains", userId));

            onSnapshot(q, (snapshot) => {
                pautasList.innerHTML = ''; 
                const fragment = document.createDocumentFragment();
                const now = new Date();
                
                if (snapshot.empty) {
                    pautasList.innerHTML = '<p class="col-span-full text-center text-gray-500">Nenhuma pauta encontrada. Crie uma para come√ßar.</p>';
                    return;
                }

                snapshot.docs.forEach((docSnap) => {
                    const pauta = docSnap.data();
                    let isExpired = false;
                    if (pauta.createdAt) {
                        const creationDate = new Date(pauta.createdAt);
                        const expirationDate = new Date(creationDate);
                        expirationDate.setDate(creationDate.getDate() + 7);
                        if (now > expirationDate) {
                            isExpired = true;
                        }
                    }
                    const card = createPautaCard(docSnap, isExpired);
                    fragment.appendChild(card);
                });
                pautasList.appendChild(fragment);

            }, (error) => {
                console.error("Erro ao buscar pautas:", error);
                pautasList.innerHTML = '<p class="col-span-full text-center text-red-500">Ocorreu um erro ao carregar as pautas.</p>';
            });

            showScreen('pautaSelection');
        };

        const setupModalClosers = () => {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        };

        const handleAuthState = () => {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // 1. Busca os dados do usu√°rio no Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserName = userData.name || user.email;

                    // 2. Verifica se o usu√°rio √© Admin/Superadmin para mostrar o bot√£o
                    checkAdminStatus(userData);

                    // 3. Verifica o Status de Aprova√ß√£o
                    if (userData.status === 'approved') {
                        // USU√ÅRIO APROVADO: Prosseguir para o sistema
                        const lastPautaId = localStorage.getItem('lastPautaId');
                        const lastPautaType = localStorage.getItem('lastPautaType');

                        if (lastPautaId && lastPautaType) {
                            // Verifica se ele ainda √© membro dessa pauta antes de carregar
                            const pautaRef = doc(db, "pautas", lastPautaId);
                            const pautaSnap = await getDoc(pautaRef);
                            
                            if (pautaSnap.exists() && pautaSnap.data().members.includes(user.uid)) {
                                loadPauta(lastPautaId, pautaSnap.data().name, lastPautaType);
                            } else {
                                showPautaSelectionScreen(user.uid);
                            }
                        } else {
                            showPautaSelectionScreen(user.uid);
                        }
                    } else {
                        // USU√ÅRIO PENDENTE: Mostrar tela de aviso
                        showScreen('loading');
                        loadingText.innerHTML = `
                            <div class="text-center">
                                <p class="text-xl font-bold text-orange-600">Acesso Pendente</p>
                                <p class="mt-2 text-gray-600">Ol√°, <b>${currentUserName}</b>!</p>
                                <p class="text-sm text-gray-500">Sua conta foi criada, mas um administrador precisa aprov√°-la para voc√™ acessar o sistema.</p>
                                <button onclick="signOut(auth)" class="mt-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Sair / Trocar de Conta</button>
                            </div>
                        `;
                        // Esconde o spinner de carregamento para n√£o confundir
                        document.querySelector('.loader').style.display = 'none';
                    }
                } else {
                    // Caso o documento do usu√°rio n√£o exista (erro raro de cria√ß√£o)
                    showNotification("Erro ao localizar seu perfil. Tente cadastrar novamente.", "error");
                    signOut(auth);
                }
            } catch (error) {
                console.error("Erro ao verificar estado do usu√°rio:", error);
                showNotification("Erro de conex√£o com o servidor.", "error");
            }
        } else {
            // USU√ÅRIO DESLOGADO: Mostrar tela de login
            showScreen('login');
            // Resetar estados do Admin caso estivessem vis√≠veis
            // No lugar de adminPanelBtn.classList.toggle(...)
            const btnAdmin = document.getElementById('admin-panel-btn');
            if (btnAdmin) {
                btnAdmin.classList.toggle('hidden', userData.role !== 'admin' && userData.role !== 'superadmin');
            };
        }
    });
};

        const showScreen = (screenName) => {
            loadingContainer.classList.toggle('hidden', screenName !== 'loading');
            loginContainer.classList.toggle('hidden', screenName !== 'login');
            pautaSelectionContainer.classList.toggle('hidden', screenName !== 'pautaSelection');
            appContainer.classList.toggle('hidden', screenName !== 'app');
        };

        const switchTab = (tabName) => {
            const tabAgendamento = document.getElementById('tab-agendamento');
            const tabAvulso = document.getElementById('tab-avulso');
            const isScheduledContainer = document.getElementById('is-scheduled-container');
            const formTitle = document.getElementById('form-title');
            const pautaColumn = document.getElementById('pauta-column');
            const emAtendimentoColumn = document.getElementById('em-atendimento-column');
            const formContainer = document.getElementById('form-agendamento');

            formContainer.classList.remove('hidden');

            if (tabName === 'agendamento') {
                tabAgendamento.classList.add('tab-active');
                tabAvulso.classList.remove('tab-active', 'text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.remove('hidden');
                pautaColumn.classList.remove('hidden');
                if (currentPautaData?.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                }
                formTitle.textContent = "Adicionar Novo Agendamento";
                document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
                document.querySelector('input[name="has-arrived"][value="no"]').checked = true;
                document.getElementById('scheduled-time-wrapper').classList.add('hidden');
                document.getElementById('arrival-time-wrapper').classList.add('hidden');
                document.getElementById('manual-room-wrapper').classList.add('hidden'); // Ocultar sele√ß√£o de sala manual
            } else { // avulso
                tabAvulso.classList.add('tab-active');
                tabAgendamento.classList.remove('tab-active');
                tabAgendamento.classList.add('text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.add('hidden');
                pautaColumn.classList.add('hidden');
                 if (currentPautaData?.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                }
                formTitle.textContent = "Adicionar Atendimento Avulso";

                document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
                document.querySelector('input[name="has-arrived"][value="yes"]').checked = true;
                document.getElementById('scheduled-time-wrapper').classList.add('hidden');
                document.getElementById('arrival-time-wrapper').classList.remove('hidden');
                document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);

                // L√≥gica para mostrar/esconder o seletor de sala manual
                const manualRoomWrapper = document.getElementById('manual-room-wrapper');
                const manualRoomSelect = document.getElementById('manual-room-select');
                
                if (currentPautaData?.type === 'multisala' && currentPautaData.rooms) {
                    manualRoomWrapper.classList.remove('hidden');
                    manualRoomSelect.innerHTML = '';
                    currentPautaData.rooms.forEach(room => {
                        const opt = document.createElement('option');
                        opt.value = room;
                        opt.textContent = room;
                        manualRoomSelect.appendChild(opt);
                    });
                } else {
                    manualRoomWrapper.classList.add('hidden');
                }
            }
            renderAssistedList();
        };


        let sortableInstance = null;

        const initSortable = () => {
            const el = document.getElementById('aguardando-list');
            const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
        
            // S√≥ habilita o "arrastar" se a pauta estiver em modo manual e n√£o estiver fechada
            if (pautaOrder === 'manual' && !isPautaClosed) {
                if (sortableInstance) sortableInstance.destroy(); // Limpa inst√¢ncia anterior
        
                sortableInstance = new Sortable(el, {
                    animation: 150,
                    ghostClass: 'bg-green-100', // Cor de fundo enquanto arrasta
                    onEnd: async function () {
                        const items = el.querySelectorAll('[data-id]');
                        const batch = writeBatch(db);
                        
                        // Percorre a lista na nova ordem visual e atualiza o banco
                        items.forEach((item, index) => {
                            const docId = item.getAttribute('data-id');
                            const docRef = doc(db, "pautas", currentPautaId, "attendances", docId);
                            batch.update(docRef, { indexManual: index });
                        });
        
                        try {
                            await batch.commit();
                            showNotification("Ordem atualizada!");
                        } catch (e) {
                            console.error("Erro ao salvar ordem:", e);
                        }
                    },
                });
            } else {
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
            }
        };
        
        const main = () => {
            try {
                const app = initializeApp(firebaseConfig);
                
                // Inicializa√ß√£o do App Check para seguran√ßa
                const appCheck = initializeAppCheck(app, {
                  provider: new ReCaptchaV3Provider('6LeWfTgsAAAAAHy1y3TFZ1EH-L3btwHsult6Rgy4'),
                  isTokenAutoRefreshEnabled: true
                });

                db = getFirestore(app);

                // --- IN√çCIO DO C√ìDIGO OFFLINE ---
                try {
                    enableIndexedDbPersistence(db).catch((err) => {
                        if (err.code == 'failed-precondition') {
                            console.warn('Persist√™ncia falhou: M√∫ltiplas abas abertas.');
                        } else if (err.code == 'unimplemented') {
                            console.warn('Persist√™ncia falhou: Navegador n√£o suportado.');
                        }
                    });
                    console.log("Persist√™ncia Offline Ativada!");
                } catch (e) {
                    console.log("Erro ao ativar persist√™ncia:", e);
                }

                // Monitores de Conex√£o (Para mostrar a barra vermelha)
                window.addEventListener('offline', () => {
                    const indicator = document.getElementById('offline-indicator');
                    if(indicator) indicator.classList.remove('hidden');
                });

                window.addEventListener('online', () => {
                    const indicator = document.getElementById('offline-indicator');
                    if(indicator) indicator.classList.add('hidden');
                    // Tenta exibir notifica√ß√£o se a fun√ß√£o existir
                    if (typeof showNotification === 'function') {
                        showNotification("Conex√£o restabelecida! Sincronizando...", "success");
                    }
                });
                // --- FIM DO C√ìDIGO OFFLINE ---

                auth = getAuth(app);
                handleAuthState();
            } catch (error) {
                console.error("Erro ao inicializar o Firebase: ", error);
                if(loadingText) loadingText.textContent = 'Erro na configura√ß√£o do Firebase.';
            }
        };
        
        // --- CONFIGURA√á√ÉO DE LOGOUT POR INATIVIDADE ---
        const INACTIVITY_TIME = 30 * 60 * 1000; // 30 minutos em milissegundos
        let inactivityTimer;
        
        const resetInactivityTimer = () => {
            // Se o timer j√° estiver rodando, cancela e come√ßa de novo
            if (inactivityTimer) clearTimeout(inactivityTimer);
        
            inactivityTimer = setTimeout(() => {
                if (auth.currentUser) {
                    console.log("Sess√£o expirada por inatividade.");
                    signOut(auth).then(() => {
                        showNotification("Sess√£o encerrada por inatividade para sua seguran√ßa.", "info");
                    });
                }
            }, INACTIVITY_TIME);
        };
        
        // Eventos que indicam que o usu√°rio est√° ativo
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        
        // Inicia o monitoramento
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });
        
        // Come√ßa a contar assim que a p√°gina carrega
        resetInactivityTimer();
        
        // FUN√á√ÉO PARA MOSTRAR ESTAT√çSTICAS (AGORA CHAMA O SCRIPT EXTERNO)
        const showStatisticsModal = () => {
            // Chama a fun√ß√£o do arquivo estatisticas.js
            renderStatisticsModal(
                allAssisted,
                currentPautaData?.useDelegationFlow,
                document.getElementById('pauta-title').textContent
            );
        };
        document.addEventListener('DOMContentLoaded', () => {
            main();
            setupModalClosers();
            setupDetailsModal({ db,getChecklistHTML, getUpdatePayload, showNotification }); // <--- ADICIONE AQUI

            const actionsToggle = document.getElementById('actions-toggle');
            const actionsPanel = document.getElementById('actions-panel');
            const actionsArrow = document.getElementById('actions-arrow');
            // Refer√™ncias
            const shareModal = document.getElementById('share-modal');
            const shareToggle = document.getElementById('share-toggle');
            const shareStatusText = document.getElementById('share-status-text');
            const shareLinkContainer = document.getElementById('share-link-container');
            const shareLinkInput = document.getElementById('share-link-input');
            const maskNamesCheck = document.getElementById('mask-names-check');
            
            // 1. Abrir Modal
            document.getElementById('share-pauta-btn').addEventListener('click', () => {
                if (!currentPautaData) return;
                
                shareModal.classList.remove('hidden');
                
                // Carregar estado atual
                const isPublic = currentPautaData.isPublic || false;
                const maskNames = currentPautaData.maskNames || false;
                
                shareToggle.checked = isPublic;
                maskNamesCheck.checked = maskNames;
                updateShareUI(isPublic);
            });
            
            // 2. Fun√ß√£o Visual
            function updateShareUI(isPublic) {
                shareStatusText.textContent = isPublic ? "P√∫blico" : "Privado";
                if (isPublic) {
                    shareLinkContainer.classList.remove('hidden');
                    // Gera o link para o arquivo acompanhamento.html
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                    const link = `${baseUrl}/acompanhamento.html?id=${currentPautaId}`;
                    shareLinkInput.value = link;
                    document.getElementById('open-external-btn').href = link;
                } else {
                    shareLinkContainer.classList.add('hidden');
                }
            }
            
            // 3. Alternar P√∫blico/Privado
            shareToggle.addEventListener('change', async (e) => {
                const isPublic = e.target.checked;
                updateShareUI(isPublic);
                
                try {
                    const pautaRef = doc(db, "pautas", currentPautaId);
                    await updateDoc(pautaRef, { isPublic: isPublic });
                    
                    // Atualiza a vari√°vel local
                    currentPautaData.isPublic = isPublic;
                    
                    showNotification(isPublic ? "Link p√∫blico ativado." : "Link p√∫blico desativado.");
                } catch (error) {
                    console.error(error);
                    showNotification("Erro ao atualizar status.", "error");
                    // Reverte visualmente se der erro
                    e.target.checked = !isPublic;
                    updateShareUI(!isPublic);
                }
            });
            
            // 4. Alternar Mascara de Nomes (LGPD)
            maskNamesCheck.addEventListener('change', async (e) => {
                const mask = e.target.checked;
                try {
                    const pautaRef = doc(db, "pautas", currentPautaId);
                    await updateDoc(pautaRef, { maskNames: mask });
                    currentPautaData.maskNames = mask;
                    showNotification("Configura√ß√£o de privacidade atualizada.");
                } catch (error) {
                    showNotification("Erro ao salvar configura√ß√£o.", "error");
                }
            });
            
            // 5. Copiar Link
            document.getElementById('copy-share-link-btn').addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                showNotification("Link copiado!", "info");
            });
            
            document.getElementById('close-share-modal-btn').addEventListener('click', () => {
                shareModal.classList.add('hidden');
            });
            
            function showPanel() {
                if(actionsPanel && actionsArrow) {
                    actionsPanel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                    actionsArrow.classList.add('rotate-180');
                }
            }

            function hidePanel() {
                if(actionsPanel && actionsArrow) {
                    actionsPanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                    actionsArrow.classList.remove('rotate-180');
                }
            }

            if(actionsToggle) {
                actionsToggle.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (actionsPanel && actionsPanel.classList.contains('opacity-0')) {
                        showPanel();
                    } else {
                        hidePanel();
                    }
                });
            }

            window.addEventListener('click', (event) => {
                if (actionsPanel && !actionsPanel.contains(event.target) && actionsToggle && !actionsToggle.contains(event.target)) {
                    hidePanel();
                }
            });
            
            const datalist = document.getElementById('subjects-list');
            flatSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.value;
                datalist.appendChild(option);
            });

            const subjectInput = document.getElementById('assisted-subject');
            const descriptionBox = document.getElementById('subject-description');
            const infoButton = document.getElementById('subject-info-btn');

            const updateDatalist = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                const filteredSubjects = flatSubjects.filter(item =>
                    item.value.toLowerCase().includes(lowerCaseQuery) ||
                    item.description.toLowerCase().includes(lowerCaseQuery)
                );

                while (datalist.firstChild) {
                    datalist.removeChild(datalist.firstChild);
                }
                filteredSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.value;
                    datalist.appendChild(option);
                });
            };

            const findSubjectByInputValue = (inputValue) => {
                return flatSubjects.find(subject => {
                    const lastPart = subject.value.split(' > ').pop();
                    return lastPart === inputValue || subject.value === inputValue;
                });
            };

            subjectInput.addEventListener('input', (e) => {
                updateDatalist(e.target.value);
            });

            subjectInput.addEventListener('change', () => {
                const originalValue = subjectInput.value;
                let selectedText = originalValue;

                if (selectedText.includes(' > ')) {
                    const parts = selectedText.split(' > ');
                    selectedText = parts[parts.length - 1];
                }

                subjectInput.value = selectedText;

                const foundSubject = findSubjectByInputValue(selectedText);
                if (foundSubject && foundSubject.description) {
                    descriptionBox.textContent = foundSubject.description;
                    descriptionBox.classList.remove('hidden');
                } else {
                    descriptionBox.textContent = '';
                    descriptionBox.classList.add('hidden');
                }
            });

            infoButton.addEventListener('click', () => {
                const currentValue = subjectInput.value;
                const foundSubject = findSubjectByInputValue(currentValue);

                if (foundSubject && foundSubject.description) {
                    descriptionBox.textContent = foundSubject.description;
                    descriptionBox.classList.toggle('hidden');
                } else {
                    descriptionBox.textContent = 'Por favor, selecione um assunto v√°lido para ver a descri√ß√£o.';
                    descriptionBox.classList.remove('hidden');
                }
            });

            // --- L√ìGICA DE LOGIN/CADASTRO ---
            // --- L√ìGICA DE LOGIN/CADASTRO ---
            const loginTabBtn = document.getElementById('login-tab-btn');
            const registerTabBtn = document.getElementById('register-tab-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            loginTabBtn.addEventListener('click', () => {
                loginTabBtn.classList.add('border-green-600', 'text-green-600');
                loginTabBtn.classList.remove('text-gray-500');
                registerTabBtn.classList.remove('border-green-600', 'text-green-600');
                registerTabBtn.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            });

            registerTabBtn.addEventListener('click', () => {
                registerTabBtn.classList.add('border-green-600', 'text-green-600');
                registerTabBtn.classList.remove('text-gray-500');
                loginTabBtn.classList.remove('border-green-600', 'text-green-600');
                loginTabBtn.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('auth-error');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    errorDiv.classList.add('hidden');
                } catch (error) {
                    console.error("Login failed:", error);
                    errorDiv.textContent = 'Email ou senha inv√°lidos.';
                    errorDiv.classList.remove('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('auth-error');

                if (password.length < 6) {
                    errorDiv.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: email,
                        uid: user.uid,
                        status: 'pending',
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    });

                    errorDiv.classList.add('hidden');
                    showNotification('Conta criada com sucesso! Agora voc√™ pode fazer o login.', 'success');
                    loginTabBtn.click();

                } catch (error) {
                    console.error("Registration failed:", error);
                    errorDiv.textContent = error.code === 'auth/email-already-in-use' ? 'Este email j√° est√° em uso.' : 'Ocorreu um erro ao criar a conta.';
                    errorDiv.classList.remove('hidden');
                }
            });

            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                const email = prompt("Por favor, digite seu email para redefinir a senha:");
                if (email) {
                    sendPasswordResetEmail(auth, email)
                        .then(() => showNotification("Email de redefini√ß√£o de senha enviado!", "success"))
                        .catch((error) => {
                            console.error("Password reset error:", error);
                            showNotification("Erro ao enviar email. Verifique se o email est√° correto.", "error");
                        });
                }
            });

            // --- L√ìGICA DE SALAS PERSONALIZADAS ---
            const customRoomInput = document.getElementById('custom-room-input');
            const customRoomsListEl = document.getElementById('custom-rooms-list');
            const noRoomsMsg = document.getElementById('no-rooms-msg');

            // Fun√ß√£o para desenhar a lista de salas
            const renderCustomRooms = () => {
                customRoomsListEl.innerHTML = '';
                if (customRoomsList.length === 0) {
                    noRoomsMsg.classList.remove('hidden');
                } else {
                    noRoomsMsg.classList.add('hidden');
                    customRoomsList.forEach((roomName, index) => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between items-center bg-white border border-gray-200 p-2 rounded shadow-sm";
                        li.innerHTML = `
                            <span class="font-medium text-gray-700">üè¢ ${escapeHTML(roomName)}</span>
                            <button type="button" class="remove-room-btn text-red-500 hover:text-red-700 text-sm font-bold px-2" data-index="${index}">Remover</button>
                        `;
                        customRoomsListEl.appendChild(li);
                    });
                }
            };
            
            // Bot√£o Adicionar Sala
            document.getElementById('add-custom-room-btn').addEventListener('click', (e) => {
                e.preventDefault(); // Evita recarregar a p√°gina
                const name = customRoomInput.value.trim();
                if (name) {
                    // Evita duplicatas
                    if (!customRoomsList.includes(name)) {
                        customRoomsList.push(name);
                        renderCustomRooms();
                        customRoomInput.value = '';
                        customRoomInput.focus();
                    } else {
                        showNotification("Este local j√° foi adicionado.", "error");
                    }
                }
            });

            // Bot√£o Remover Sala (Delega√ß√£o de evento)
            customRoomsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-room-btn')) {
                    const index = e.target.dataset.index;
                    customRoomsList.splice(index, 1);
                    renderCustomRooms();
                }
            });

            // --- NOVO FLUXO DE CRIA√á√ÉO DE PAUTA COM ORDEM DE ATENDIMENTO E DELEGA√á√ÉO ---
            document.getElementById('create-pauta-btn').addEventListener('click', () => {
                document.getElementById('pauta-type-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-pauta-type-btn').addEventListener('click', () => {
                document.getElementById('pauta-type-modal').classList.add('hidden');
            });

            document.querySelectorAll('.pauta-type-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    document.getElementById('pauta-type-modal').classList.add('hidden');
                    
                    const createModal = document.getElementById('create-pauta-modal');
                    createModal.dataset.pautaType = type;
                    
                    const roomConfig = document.getElementById('room-config-container');
                    if (type === 'multisala') {
                        roomConfig.classList.remove('hidden');
                        customRoomsList = []; // Zera a lista
                        renderCustomRooms(); // Atualiza visualmente
                        document.getElementById('custom-room-input').value = '';
                    } else {
                        roomConfig.classList.add('hidden');
                    }
                    
                    createModal.classList.remove('hidden');
                });
            });

            document.getElementById('cancel-create-pauta-btn').addEventListener('click', () => {
                document.getElementById('create-pauta-modal').classList.add('hidden');
            });
            
            document.getElementById('next-to-ordem-btn').addEventListener('click', () => {
                const pautaName = document.getElementById('create-pauta-name-input').value.trim();
                if (!pautaName) {
                    showNotification("O nome da pauta n√£o pode ser vazio.", "error");
                    return;
                }
                document.getElementById('create-pauta-modal').classList.add('hidden');
                document.getElementById('ordem-atendimento-modal').classList.remove('hidden');
            });
            
            document.getElementById('cancel-ordem-btn').addEventListener('click', () => {
                document.getElementById('ordem-atendimento-modal').classList.add('hidden');
                document.getElementById('create-pauta-modal').classList.remove('hidden');
            });

            // Adicionado: Bot√£o para ir para o modal de delega√ß√£o
            document.getElementById('next-to-delegation-btn').addEventListener('click', () => {
                document.getElementById('ordem-atendimento-modal').classList.add('hidden');
                document.getElementById('delegation-flow-modal').classList.remove('hidden');
            });

            // Adicionado: Bot√£o de voltar do modal de delega√ß√£o
            document.getElementById('cancel-delegation-flow-btn').addEventListener('click', () => {
                document.getElementById('delegation-flow-modal').classList.add('hidden');
                document.getElementById('ordem-atendimento-modal').classList.remove('hidden');
            });
            
            // L√≥gica final de cria√ß√£o da pauta, agora no modal de delega√ß√£o
            document.getElementById('confirm-create-pauta-final-btn').addEventListener('click', async () => {
                const pautaName = document.getElementById('create-pauta-name-input').value.trim();
                const pautaType = document.getElementById('create-pauta-modal').dataset.pautaType;
                const ordemAtendimento = document.querySelector('input[name="ordemAtendimento"]:checked').value;
                const useDelegationFlow = document.querySelector('input[name="useDelegationFlow"]:checked').value === 'true'; // Novo campo
                const user = auth.currentUser;
                
                if (!user) {
                    showNotification("Voc√™ precisa estar logado para criar uma pauta.", "error");
                    return;
                }
                
                // L√≥gica para salas
                let pautaRooms = [];
                if (pautaType === 'multisala') {
                    if (customRoomsList.length === 0) {
                        showNotification("Por favor, adicione pelo menos um local/sala.", "error");
                        return;
                    }
                    pautaRooms = [...customRoomsList];
                }

                try {
                    await addDoc(collection(db, "pautas"), {
                        name: pautaName,
                        type: pautaType,
                        ordemAtendimento: ordemAtendimento,
                        useDelegationFlow: useDelegationFlow, // Salva a escolha
                        owner: user.uid,
                        ownerEmail: user.email,
                        members: [user.uid],
                        memberEmails: [user.email],
                        isClosed: false,
                        createdAt: new Date().toISOString(),
                        rooms: pautaRooms // Salva as salas
                    });
                    logAction('CREATE_PAUTA', `Criou a pauta "${pautaName}" do tipo ${pautaType}`); //Logs de cria√ß√£o
                    showNotification("Pauta criada com sucesso!");
                    document.getElementById('create-pauta-name-input').value = '';
                    document.getElementById('delegation-flow-modal').classList.add('hidden'); // Fecha o modal final
                } catch (error) {
                    console.error("Error creating pauta:", error);
                    showNotification("Erro ao criar pauta.", "error");
                }
            });

            // --- L√ìGICA DE EVENTOS GERAIS E MODAIS ---
            document.getElementById('privacy-policy-link').addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('privacy-policy-modal').classList.remove('hidden');
            });

            const privacyModal = document.getElementById('privacy-policy-modal');
            if (privacyModal) {
                const closePolicyModal = () => privacyModal.classList.add('hidden');
                privacyModal.querySelector('#close-policy-modal-btn-x')?.addEventListener('click', closePolicyModal);
                privacyModal.querySelector('#close-policy-modal-btn')?.addEventListener('click', closePolicyModal);
            }

            document.getElementById('format-help-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('format-help-modal').classList.remove('hidden');
            });

            document.getElementById('format-help-modal').addEventListener('click', e => {
                const buttonId = e.target.id;
                if (buttonId === 'copy-csv-format-btn') {
                    const text = document.getElementById('csv-format-code').innerText;
                    copyToClipboard(text, 'Formato copiado!');
                } else if (buttonId === 'copy-csv-example-btn') {
                    const text = document.getElementById('csv-example-code').innerText;
                    copyToClipboard(text, 'Exemplo copiado!');
                } else if (buttonId === 'copy-ai-prompt-btn') {
                    const text = document.getElementById('ai-prompt-code').innerText;
                    copyToClipboard(text, 'Prompt para IA copiado!');
                }
            });

            document.getElementById('tab-agendamento').addEventListener('click', () => switchTab('agendamento'));
            document.getElementById('tab-avulso').addEventListener('click', () => switchTab('avulso'));

            const handleLogout = () => {
                signOut(auth).catch(error => {
                    console.error("Logout error", error);
                    showNotification("Erro ao tentar sair.", "error");
                });
            };
            document.getElementById('logout-btn-main').addEventListener('click', handleLogout);
            document.getElementById('logout-btn-app').addEventListener('click', handleLogout);

            ['pauta-search', 'aguardando-search', 'em-atendimento-search', 'atendidos-search', 'faltosos-search'].forEach(id => {
                document.getElementById(id).addEventListener('input', renderAssistedList);
            });

            document.getElementById('file-upload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
                if (!file) return;
            
                try {
                    // 1. Processa o arquivo usando o m√≥dulo externo
                    const assistidosValidados = await parsePautaCSV(file);
                    
                    // 2. Salva no banco de dados (usando a fun√ß√£o do pauta.js que criamos antes)
                    await saveImportedPauta(db, currentPautaId, assistidosValidados, currentUserName);
                    
                    showNotification(`${assistidosValidados.length} registros importados com sucesso!`);
                } catch (error) {
                    showNotification(error, "error");
                } finally {
                    event.target.value = ''; // Limpa o campo
                }
        });
            
             });
            document.getElementById('toggle-faltosos-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const pautaColumn = document.getElementById('pauta-column');
                const faltososColumn = document.getElementById('faltosos-column');

                pautaColumn.classList.toggle('hidden');
                faltososColumn.classList.toggle('hidden');

                if (faltososColumn.classList.contains('hidden')) {
                    btn.textContent = 'Ver Faltosos';
                    btn.classList.replace('bg-blue-600', 'bg-purple-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-purple-700');
                } else {
                    btn.textContent = 'Ver Pauta';
                    btn.classList.replace('bg-purple-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-purple-700', 'hover:bg-blue-700');
                }
            });

            document.querySelectorAll('input[name="is-scheduled"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('scheduled-time-wrapper').classList.toggle('hidden', e.target.value === 'no');
                });
            });
             document.querySelectorAll('input[name="has-arrived"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const wrapper = document.getElementById('arrival-time-wrapper');
                    wrapper.classList.toggle('hidden', e.target.value === 'no');
                    if (e.target.value === 'yes') {
                         document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);
                    }
                });
            });

            const showDemandsModal = (assistedId) => {
                const modal = document.getElementById('demands-modal');
                const assisted = allAssisted.find(a => a.id === assistedId);
                if (!assisted) return;

                document.getElementById('demands-assisted-name-modal').textContent = assisted.name;
                const demandsListContainer = document.getElementById('demands-modal-list-container');
                demandsListContainer.innerHTML = '';

                const demands = assisted.demandas?.descricoes || [];
                if (demands.length === 0) {
                    demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
                } else {
                    demands.forEach(demandText => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 bg-white rounded-md';
                        li.textContent = demandText;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs';
                        removeBtn.textContent = 'Remover';
                        li.appendChild(removeBtn);
                        demandsListContainer.appendChild(li);
                    });
                }
                modal.classList.remove('hidden');
            };

            document.body.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                
                // --- NOVO: Bot√£o de Renomear Sala ---
                const editRoomBtn = e.target.closest('.edit-room-name-btn');
                if (editRoomBtn) {
                    if (isPautaClosed) {
                        showNotification("A pauta est√° fechada.", "error");
                        return;
                    }
                    const oldName = editRoomBtn.dataset.room;
                    const newName = prompt(`Renomear "${oldName}" para:`, oldName);
                    
                    if (newName && newName.trim() !== "" && newName !== oldName) {
                        await renamePautaRoom(oldName, newName.trim());
                    }
                    return; // Para n√£o processar outros cliques
                }
                // ------------------------------------

                if (!button) return;

                // Adiciona o listener para o bot√£o de estat√≠sticas
                if (button.id === 'view-stats-btn') {
                    showStatisticsModal();
                    return; // Retorna para n√£o processar outros cliques
                }
                
                const id = button.dataset.id;
                const collectionRef = currentPautaId ? collection(db, "pautas", currentPautaId, "attendances") : null;

                if (id && collectionRef) {
                    const docRef = doc(collectionRef, id);

                    if(isPautaClosed) {
                        showNotification("Esta pauta est√° fechada. A√ß√µes n√£o podem ser realizadas.", "error");
                        return;
                    }

                    if (button.classList.contains('check-in-btn')) { 
                        assistedIdToHandle = id; 
                        document.getElementById('arrival-modal').classList.remove('hidden'); 
                        document.getElementById('arrival-time-input').value = new Date().toTimeString().slice(0,5); 
                        
                        // L√≥gica NOVA: Salas
                        const roomContainer = document.getElementById('arrival-room-container');
                        const roomSelect = document.getElementById('arrival-room-select');
                        
                        if (currentPautaData?.type === 'multisala' && currentPautaData.rooms) {
                            roomContainer.classList.remove('hidden');
                            roomSelect.innerHTML = '';
                            currentPautaData.rooms.forEach(room => {
                                const opt = document.createElement('option');
                                opt.value = room;
                                opt.textContent = room;
                                roomSelect.appendChild(opt);
                            });
                        } else {
                            roomContainer.classList.add('hidden');
                        }
                    }
                    
                    // L√≥gica para o bot√£o "Atender" na coluna "Aguardando"
                    if (button.classList.contains('select-collaborator-btn')) { // Fluxo de delega√ß√£o ativado
                        assistedIdToHandle = id;
                        assistedNameToHandle = button.dataset.name;
                        document.getElementById('assisted-to-attend-name').textContent = assistedNameToHandle;
                        
                        const collaboratorSelectionList = document.getElementById('collaborator-selection-list');
                        collaboratorSelectionList.innerHTML = '';
                        // Adiciona uma op√ß√£o "N√£o atribuir"
                        const noAssignLabel = document.createElement('label');
                        noAssignLabel.className = 'flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                        noAssignLabel.innerHTML = `
                            <input type="radio" name="selectedCollaborator" value="null" data-name="N√£o atribu√≠do" class="h-5 w-5 text-gray-600 focus:ring-gray-500" checked>
                            <span class="ml-3 font-semibold text-gray-800">N√£o atribuir colaborador</span>
                        `;
                        collaboratorSelectionList.appendChild(noAssignLabel);

                        if (colaboradores.length === 0) {
                            const noCollabMessage = document.createElement('p');
                            noCollabMessage.className = 'text-gray-500 text-center mt-2';
                            noCollabMessage.textContent = 'Nenhum colaborador registrado. Adicione um na se√ß√£o "Colaboradores" para atribuir.';
                            collaboratorSelectionList.appendChild(noCollabMessage);
                        } else {
                            colaboradores.forEach(collab => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                                label.innerHTML = `
                                    <input type="radio" name="selectedCollaborator" value="${collab.id}" data-name="${collab.nome}" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 font-semibold text-gray-800">${collab.nome}</span>
                                `;
                                collaboratorSelectionList.appendChild(label);
                            });
                        }
                        document.getElementById('select-collaborator-modal').classList.remove('hidden');
                    }

                    // Bot√£o "Atender" para o fluxo antigo (sem delega√ß√£o)
                    if (button.classList.contains('attend-directly-from-aguardando-btn')) { // Fluxo de delega√ß√£o desativado
                        assistedIdToHandle = id;
                        const attendantInput = document.getElementById('attendant-name');
                        attendantInput.value = ''; // Limpar o campo para nova atribui√ß√£o
                        const datalist = document.getElementById('collaborators-list');
                        datalist.innerHTML = '';
                        colaboradores.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.nome;
                            datalist.appendChild(option);
                        });
                        document.getElementById('attendant-modal').classList.remove('hidden');
                    }
                    
                    // L√≥gica para o bot√£o 'Delegar Finaliza√ß√£o' na coluna 'Em Atendimento'
                    if (button.classList.contains('delegate-finalization-btn')) {
                        assistedIdForDelegation = id;
                        assistedNameForDelegation = button.dataset.name;
                        collaboratorNameForDelegation = button.dataset.collaboratorName; // Get collaborator name
                        document.getElementById('delegate-assisted-name').textContent = assistedNameForDelegation;
                        
                        // Tenta preencher o e-mail do colaborador atribu√≠do
                        const assignedCollabId = button.dataset.collaboratorId;
                        const assignedCollab = colaboradores.find(c => c.id === assignedCollabId);
                        document.getElementById('collaborator-email-input').value = assignedCollab?.email || ''; // Preenche se encontrar, sen√£o vazio

                        document.getElementById('delegate-email-modal').classList.remove('hidden');
                    }

                    // L√≥gica para o bot√£o 'Finalizar Diretamente' na coluna 'Em Atendimento'
                    if (button.classList.contains('attend-directly-btn')) {
                        const attendantInput = document.getElementById('attendant-name');
                        attendantInput.value = button.dataset.collaboratorName || ''; // Preenche com o nome do colaborador j√° atribu√≠do
                        const datalist = document.getElementById('collaborators-list');
                        datalist.innerHTML = '';
                        colaboradores.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.nome;
                            datalist.appendChild(option);
                        });
                        assistedIdToHandle = id;
                        document.getElementById('attendant-modal').classList.remove('hidden');
                    }

                    if (button.classList.contains('faltou-btn')) { const assisted = allAssisted.find(a => a.id === id); logAction('MARK_FALTOSO', `Marcou ${assisted.name} como faltoso`, id); await updateDoc(docRef, getUpdatePayload({ status: 'faltoso' })); showNotification("Marcado como faltoso."); }
                    if (button.classList.contains('return-to-pauta-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta', arrivalTime: null, priority: null, assignedCollaborator: null, inAttendanceTime: null, room: null })); showNotification("Retornado para a pauta."); }
                    if (button.classList.contains('return-to-pauta-from-faltoso-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta' })); showNotification("Revertido para a pauta."); }
                    if (button.classList.contains('return-to-aguardando-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'aguardando', attendant: null, attendedTime: null, assignedCollaborator: null, inAttendanceTime: null })); showNotification("Retornado para aguardando."); }
                    if (button.classList.contains('return-to-aguardando-from-emAtendimento-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'aguardando', assignedCollaborator: null, inAttendanceTime: null })); showNotification("Retornado para aguardando."); }
                    if (button.classList.contains('delete-btn')) { if(confirm("Tem certeza que deseja apagar este registro permanentemente?")) { const assisted = allAssisted.find(a => a.id === id); const name = assisted ? assisted.name : 'Desconhecido'; logAction('DELETE_ASSISTED', `Apagou o assistido: ${name}`, id); await deleteDoc(docRef); showNotification("Registro apagado."); }}
                    if (button.classList.contains('priority-btn')) { assistedIdToHandle = id; document.getElementById('priority-reason-modal').classList.remove('hidden'); }
                    if (button.classList.contains('unpriority-btn')) { 
                        if(confirm("Tem certeza que deseja remover o status de Prioridade Urgente? A prioridade ser√° recalculada.")) {
                            await updateDoc(docRef, getUpdatePayload({ priority: null, priorityReason: null })); 
                            showNotification("Prioridade Urgente removida. Recalculando prioridade."); 
                        }
                    }
                    if (button.classList.contains('edit-assisted-btn')) { 
                        assistedIdToHandle = id; 
                        const assisted = allAssisted.find(a => a.id === id); 
                        if(assisted){ 
                            document.getElementById('edit-assisted-name').value = assisted.name; 
                            document.getElementById('edit-assisted-cpf').value = assisted.cpf || ''; 
                            document.getElementById('edit-assisted-subject').value = assisted.subject; 
                            document.getElementById('edit-scheduled-time').value = assisted.scheduledTime || '';
                            document.getElementById('edit-assisted-modal').classList.remove('hidden');
                        } 
                    }
                    if (button.classList.contains('edit-attendant-btn')) {
                        assistedIdToHandle = id;
                        const assisted = allAssisted.find(a => a.id === id);
                        if (assisted) {
                            document.getElementById('edit-attendant-name').value = assisted.attendant || '';
                            document.getElementById('edit-attendant-modal').classList.remove('hidden');
                        }
                    }
                   // NOVO C√ìDIGO
                    if (button.classList.contains('view-details-btn')) {
                        openDetailsModal({
                            assistedId: id,
                            pautaId: currentPautaId,
                            allAssisted: allAssisted
                        });
                    }
                    if (button.classList.contains('manage-demands-btn')) {
                        assistedIdToHandle = id;
                        showDemandsModal(id);
                    }

                    // L√≥gica para os novos bot√µes de "Confirmado"
                    if (button.classList.contains('toggle-confirmed-atendido') || button.classList.contains('toggle-confirmed-faltoso')) {
                        const currentAssisted = allAssisted.find(a => a.id === id);
                        const newConfirmedState = !(currentAssisted.isConfirmed || false); // Inverte o estado

                        await updateDoc(docRef, getUpdatePayload({
                            isConfirmed: newConfirmedState,
                            confirmationDetails: newConfirmedState ? { confirmedBy: currentUserName, confirmedAt: new Date().toISOString() } : null
                        }));
                        showNotification(`Status de Marcado Presen√ßa no Verde atualizado para ${newConfirmedState ? 'Confirmado' : 'N√£o Confirmado'}.`, 'info');
                    }

                    // NOVO: L√≥gica para "Voltar p/ Em Atendimento" de "Atendidos"
                    if (button.classList.contains('return-from-atendido-btn')) {
                        const currentAssisted = allAssisted.find(a => a.id === id);
                        let updateData = {
                            status: 'aguardando', // Padr√£o se n√£o for fluxo de delega√ß√£o
                            attendant: null,
                            attendedTime: null,
                            finalizadoPeloColaborador: false,
                            isConfirmed: false,
                            confirmationDetails: null
                        };

                        if (currentPautaData?.useDelegationFlow) {
                            // Se o fluxo de delega√ß√£o est√° ativo, volta para "Em Atendimento"
                            updateData.status = 'emAtendimento';
                            // Mant√©m o assignedCollaborator e inAttendanceTime que j√° estavam
                            updateData.attendant = currentAssisted.attendant; // Mant√©m o atendente que finalizou
                        }
                        
                        await updateDoc(docRef, getUpdatePayload(updateData));
                        showNotification(`Atendimento de ${currentAssisted.name} revertido para ${currentPautaData?.useDelegationFlow ? 'Em Atendimento' : 'Aguardando'}.`, 'info');
                    }

                }

                if (button.id === 'back-to-pautas-btn') {
                    if (unsubscribeFromAttendances) unsubscribeFromAttendances();
                    if (unsubscribeFromCollaborators) unsubscribeFromCollaborators();
                    currentPautaId = null;
                    allAssisted = [];
                    colaboradores = [];
                    showPautaSelectionScreen(auth.currentUser.uid);
                }
                if (button.id === 'reset-all-btn') {
                    document.getElementById('reset-confirm-modal').classList.remove('hidden');
                }
                if (button.id === 'edit-pauta-name-btn') {
                    const currentName = document.getElementById('pauta-title').textContent;
                    document.getElementById('edit-pauta-name-input').value = currentName;
                    document.getElementById('edit-pauta-modal').classList.remove('hidden');
                }
                if (button.id === 'manage-members-btn') {
                    await showMembersModal(); // Abre o modal de "Gerenciar Membros da Pauta"
                }

                // L√≥gica para abrir o modal de "Lista de Presen√ßa de Colaboradores"
                if (button.id === 'manage-collaborators-btn') {
                    setupCollaboratorsListener(currentPautaId); // Inicia o listener espec√≠fico para este modal
                    resetCollaboratorFormModal(); // Limpa o formul√°rio do modal de colaboradores
                    collaboratorsModal.classList.remove('hidden'); // Abre o modal
                }

              if (button.id === 'add-assisted-btn') {
    const name = document.getElementById('assisted-name').value.trim();
    if (!name) {
        showNotification("O nome √© obrigat√≥rio.", "error");
        return;
    }
    
    const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
    let isScheduled, hasArrived, scheduledTimeValue;

    if (currentMode === 'agendamento') {
        isScheduled = document.querySelector('input[name="is-scheduled"]:checked').value === 'yes';
        hasArrived = document.querySelector('input[name="has-arrived"]:checked').value === 'yes';
        scheduledTimeValue = isScheduled ? document.getElementById('scheduled-time').value : null;

        // Adicionada valida√ß√£o para o hor√°rio agendado.
        if (isScheduled && !scheduledTimeValue && !hasArrived) { // S√≥ √© obrigat√≥rio se for agendado e AINDA n√£o chegou
            showNotification("Por favor, informe o hor√°rio agendado.", "error");
            return;
        }
    } else { 
        isScheduled = false;
        hasArrived = true;
        scheduledTimeValue = null;
    }

    let arrivalDate = null;
    if (hasArrived) {
        const timeInput = document.getElementById('arrival-time').value;
        const [hours, minutes] = timeInput.split(':');
        arrivalDate = new Date();
        arrivalDate.setHours(hours, minutes);
    }
    
    // Captura a sala se for avulso e multi-sala
    let assignedRoom = null;
    if (currentMode !== 'agendamento' && currentPautaData?.type === 'multisala') {
        assignedRoom = document.getElementById('manual-room-select').value;
    }

    const newAssisted = getUpdatePayload({
        name,
        cpf: document.getElementById('assisted-cpf').value.trim(),
        subject: document.getElementById('assisted-subject').value.trim(),
        type: currentMode,
        status: hasArrived ? 'aguardando' : 'pauta',
        scheduledTime: scheduledTimeValue,
        arrivalTime: hasArrived ? arrivalDate.toISOString() : null,
        assignedCollaborator: null, // Novo campo
        inAttendanceTime: null, // Novo campo
        finalizadoPeloColaborador: false, // Novo campo
        isConfirmed: false, // Novo campo
        confirmationDetails: null, // Novo campo
        room: assignedRoom, // Salva a sala se for avulso
        indexManual: allAssisted.length, // Coloca no final da fila por padr√£o
        createdAt: new Date().toISOString()
    });

    await addDoc(collectionRef, newAssisted);
    showNotification("Assistido adicionado com sucesso!");
    document.getElementById('form-agendamento').reset();
    document.getElementById('scheduled-time-wrapper').classList.add('hidden');
    document.getElementById('arrival-time-wrapper').classList.add('hidden');
}

                if (button.id === 'confirm-arrival-btn') {
                    const arrivalTimeInput = document.getElementById('arrival-time-input').value;
                    if (!arrivalTimeInput) { showNotification("Por favor, informe o hor√°rio.", "error"); return; }
                    const [hours, minutes] = arrivalTimeInput.split(':');
                    const arrivalDate = new Date();
                    arrivalDate.setHours(hours, minutes, 0, 0);

                    // --- IN√çCIO DA CORRE√á√ÉO ---
                    let roomData = null;
                    // Se for pauta multi-salas, pega o valor do select
                    if (currentPautaData?.type === 'multisala') {
                        roomData = document.getElementById('arrival-room-select').value;
                    }

                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        status: 'aguardando', 
                        arrivalTime: arrivalDate.toISOString(),
                        room: roomData // <--- ADICIONADO: Agora salva a sala no banco
                    }));
                    // --- FIM DA CORRE√á√ÉO ---

                    button.closest('.fixed').classList.add('hidden');
                }
                
                // L√≥gica do novo modal de sele√ß√£o de colaborador
                if (button.id === 'confirm-select-collaborator-btn') {
                    const selectedCollaboratorRadio = document.querySelector('#collaborator-selection-list input[name="selectedCollaborator"]:checked');
                    let collaboratorData = null; // Default to null

                    if (selectedCollaboratorRadio && selectedCollaboratorRadio.value !== 'null') {
                        const collaboratorId = selectedCollaboratorRadio.value;
                        const collaboratorName = selectedCollaboratorRadio.dataset.name;
                        collaboratorData = { id: collaboratorId, name: collaboratorName };
                        showNotification(`${assistedNameToHandle} atribu√≠do a ${collaboratorName}.`);
                    } else {
                        showNotification(`${assistedNameToHandle} movido para 'Em Atendimento' sem colaborador atribu√≠do.`);
                    }

                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({
                        status: 'emAtendimento',
                        assignedCollaborator: collaboratorData, // Assign null or the selected collaborator
                        inAttendanceTime: new Date().toISOString()
                    }));
                    document.getElementById('select-collaborator-modal').classList.add('hidden');
                }

                // A√ß√£o de confirmar atendimento (antiga, agora para "Finalizar Diretamente")
                // NOVO C√ìDIGO SUGERIDO (Linha 1845)
                if (button.id === 'confirm-attendant-btn') {
                    const attendantName = document.getElementById('attendant-name').value.trim();
                    
                    // 1. Tenta encontrar o colaborador completo na lista (incluindo cargo e equipe)
                    const selectedCollab = colaboradores.find(c => c.nome === attendantName);
                    
                    let attendantData;
                
                    if (selectedCollab) {
                        // Se encontrado, usa o objeto completo
                        attendantData = { nome: selectedCollab.nome, cargo: selectedCollab.cargo, equipe: selectedCollab.equipe };
                    } else {
                        // Se n√£o encontrado, usa o nome como string (cair√° em 'Sem Grupo' se for o caso)
                        attendantData = attendantName;
                    }
                
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        status: 'atendido', 
                        // ATUALIZA√á√ÉO: Salva o objeto completo se encontrado, sen√£o salva o nome string.
                        attendant: attendantData, 
                        attendedTime: new Date().toISOString() 
                    }));
                    
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-priority-reason-btn') {
                    const reason = document.getElementById('priority-reason-input').value.trim();
                    if (!reason) { showNotification("O motivo √© obrigat√≥rio.", "error"); return; }
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ priority: 'URGENTE', priorityReason: reason }));
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-edit-assisted-btn') {
                    const name = document.getElementById('edit-assisted-name').value.trim();
                    if (!name) { showNotification("O nome n√£o pode ficar em branco.", "error"); return; }
                    const updatedData = {
                        name,
                        cpf: document.getElementById('edit-assisted-cpf').value.trim(),
                        subject: document.getElementById('edit-assisted-subject').value.trim(),
                        scheduledTime: document.getElementById('edit-scheduled-time').value || null,
                    };
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload(updatedData));
                    button.closest('.fixed').classList.add('hidden');
                }
                // NOVO C√ìDIGO SUGERIDO (Linha 1897)
                if (button.id === 'confirm-edit-attendant-btn') {
                    const attendantName = document.getElementById('edit-attendant-name').value.trim();
                    
                    // 1. Tenta encontrar o colaborador completo na lista
                    const selectedCollab = colaboradores.find(c => c.nome === attendantName);
                    
                    let attendantData;
                
                    if (selectedCollab) {
                        attendantData = { nome: selectedCollab.nome, cargo: selectedCollab.cargo, equipe: selectedCollab.equipe };
                    } else {
                        attendantData = attendantName;
                    }
                
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        // ATUALIZA√á√ÉO: Salva o objeto completo se encontrado
                        attendant: attendantData 
                    }));
                    
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-reset-btn') {
                    const attendanceCollectionRef = collection(db, "pautas", currentPautaId, "attendances");
                    const snapshot = await getDocs(attendanceCollectionRef);
                    if(snapshot.empty) {
                        showNotification("A pauta j√° est√° vazia.", "info");
                        button.closest('.fixed').classList.add('hidden');
                        return;
                    }
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showNotification("Pauta zerada com sucesso.", "success");
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-edit-pauta-btn') {
                    const newName = document.getElementById('edit-pauta-name-input').value.trim();
                    if (newName && currentPautaId) {
                        await updateDoc(doc(db, "pautas", currentPautaId), { name: newName });
                        document.getElementById('pauta-title').textContent = newName;
                        showNotification("Nome da pauta atualizado.");
                        button.closest('.fixed').classList.add('hidden');
                    } else {
                        showNotification("O nome n√£o pode ser vazio.", "error");
                    }
                }
                if(button.id === 'invite-member-btn') {
                    const email = document.getElementById('invite-email-input').value.trim().toLowerCase();
                    const statusDiv = document.getElementById('invite-status');
                    if (!email) { statusDiv.textContent = 'Por favor, insira um email.'; return; }
                    
                    statusDiv.textContent = 'Verificando...';
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        inviteStatus.textContent = 'Usu√°rio n√£o encontrado.';
                        return;
                    }
                    
                    const userDoc = querySnapshot.docs[0];
                    const pautaRef = doc(db, "pautas", currentPautaId);

                    await updateDoc(pautaRef, {
                        members: arrayUnion(userDoc.id),
                        memberEmails: arrayUnion(email)
                    });
                    
                    inviteStatus.textContent = `Usu√°rio ${email} convidado!`;
                    document.getElementById('invite-email-input').value = '';
                    showMembersModal(); // Atualiza a lista no modal
                }
                if(button.classList.contains('remove-member-btn')) {
                    const email = button.dataset.email;
                    if (confirm(`Tem certeza que deseja remover ${email} desta pauta?`)) {
                        const usersRef = collection(db, "users");
                        const q = query(usersRef, where("email", "==", email));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            const userIdToRemove = querySnapshot.docs[0].id;
                            const pautaRef = doc(db, "pautas", currentPautaId);
                            try {
                                await updateDoc(pautaRef, {
                                    members: arrayRemove(userIdToRemove),
                                    memberEmails: arrayRemove(email)
                                });
                                showNotification(`Membro ${email} removido da pauta.`);
                                showMembersModal(); // Atualiza a lista no modal
                            } catch (error) {
                                console.error("Erro ao remover membro:", error);
                                showNotification("Erro ao remover membro.", "error");
                            }
                        }
                    }
                }
                
                // Usar os IDs atualizados para o modal de demandas
                if (button.id === 'demands-modal-add-demand-btn') {
                    const input = document.getElementById('demands-modal-new-demand-input');
                    const text = input.value.trim();
                    if(text) {
                        const demandsListContainer = document.getElementById('demands-modal-list-container');
                        if(demandsListContainer.querySelector('p.text-gray-500')) { // Verifica se √© a mensagem de "Nenhuma demanda"
                            demandsListContainer.innerHTML = '';
                        }
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 bg-white rounded-md text-sm';
                        li.textContent = text;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs font-semibold ml-2';
                        removeBtn.textContent = 'Remover';
                        li.appendChild(removeBtn);
                        demandsListContainer.appendChild(li);
                        input.value = '';
                    }
                }
                if (button.classList.contains('remove-demand-item-btn')) {
                    const li = button.parentElement;
                    li.remove();
                    const demandsListContainer = document.getElementById('demands-modal-list-container'); // Usar ID atualizado
                    if (demandsListContainer.children.length === 0) {
                         demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
                    }
                }
                if (button.id === 'save-demands-btn') {
                    const demandsListContainer = document.getElementById('demands-modal-list-container'); // Usar ID atualizado
                    const items = demandsListContainer.querySelectorAll('li');
                    const descricoes = Array.from(items).map(li => li.firstChild.textContent);
                    const demandsData = {
                        quantidade: descricoes.length,
                        descricoes: descricoes
                    };
                    const docRef = doc(collectionRef, assistedIdToHandle);
                    await updateDoc(docRef, getUpdatePayload({ demandas: demandsData }));
                    showNotification("Demandas salvas com sucesso!", "success");
                    document.getElementById('demands-modal').classList.add('hidden');
                }

                if (button.id.startsWith('cancel-') || button.id.startsWith('close-')) {
                    const modal = button.closest('.fixed');
                    if (modal) {
                       modal.classList.add('hidden');
                    }
                }
                if (button.id === 'close-documents-modal-btn' || button.id === 'cancel-checklist-btn') {
                     document.getElementById('documents-modal').classList.add('hidden');
                }
                // Adicionado: Bot√µes de cancelamento para o novo modal de sele√ß√£o de colaborador
                if (button.id === 'cancel-select-collaborator-btn') {
                    document.getElementById('select-collaborator-modal').classList.add('hidden');
                }
                // Adicionado: Bot√µes de cancelamento para o novo modal de delega√ß√£o por e-mail
                if (button.id === 'cancel-delegate-email-btn') {
                    document.getElementById('delegate-email-modal').classList.add('hidden');
                }


                if (button.classList.contains('toggle-details-btn')) {
                    const card = button.closest('div.p-4');
                    const details = card.querySelector('.card-details');
                    const icon = button.querySelector('svg');
                    details.classList.toggle('hidden');
                    icon.style.transform = details.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                }
                
                if (button.id === 'close-pauta-btn') {
                    document.getElementById('close-modal-title').textContent = 'Fechar Pauta';
                    document.getElementById('close-modal-message').textContent = 'Para fechar esta pauta, confirme sua senha. Nenhum membro poder√° fazer altera√ß√µes at√© que voc√™ a reabra.';
                    document.getElementById('close-pauta-password').value = '';
                    document.getElementById('confirm-close-pauta-btn').textContent = 'Confirmar';
                    document.getElementById('close-pauta-modal').classList.remove('hidden');
                }

                if (button.id === 'reopen-pauta-btn') {
                    document.getElementById('close-modal-title').textContent = 'Reabrir Pauta';
                    document.getElementById('close-modal-message').textContent = 'Para reabrir esta pauta, confirme sua senha.';
                    document.getElementById('close-pauta-password').value = '';
                    document.getElementById('confirm-close-pauta-btn').textContent = 'Reabrir';
                    document.getElementById('close-pauta-modal').classList.remove('hidden');
                }

                if (button.id === 'confirm-close-pauta-btn') {
                    const password = document.getElementById('close-pauta-password').value;
                    const errorDiv = document.getElementById('close-auth-error');
                    errorDiv.classList.add('hidden');

                    const isReopen = button.textContent.includes('Reabrir');
                    const user = auth.currentUser;
                    if (!user || user.uid !== currentPautaOwnerId) {
                         showNotification("Voc√™ n√£o tem permiss√£o para esta a√ß√£o.", "error");
                         document.getElementById('close-pauta-modal').classList.add('hidden');
                         return;
                    }

                    try {
                        const credential = EmailAuthProvider.credential(user.email, password);
                        await reauthenticateWithCredential(user, credential);
                        
                        const pautaRef = doc(db, "pautas", currentPautaId);
                        await updateDoc(pautaRef, { isClosed: !isReopen });
                        isPautaClosed = !isReopen;
                        togglePautaLock(isPautaClosed);

                        const action = isReopen ? 'REOPEN_PAUTA' : 'CLOSE_PAUTA'; //LOG DE VERIFICA√á√ÉO PT1
                        logAction(action, `${isReopen ? 'Reabriu' : 'Fechou'} a pauta ${currentPautaId}`, currentPautaId); //LOG DE VERIFICA√á√ÉO PT2
                        
                        showNotification(`Pauta ${isReopen ? 'reaberta' : 'fechada'} com sucesso.`);
                        document.getElementById('close-pauta-modal').classList.add('hidden');
                    } catch (error) {
                         console.error("Authentication failed:", error);
                         errorDiv.textContent = 'Senha incorreta. Tente novamente.';
                         errorDiv.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('checklist-search').addEventListener('input', (e) => {
                const searchTerm = normalizeText(e.target.value);
                const allDocs = checklistContainer.querySelectorAll('li');
                allDocs.forEach(li => {
                    const labelText = normalizeText(li.textContent);
                    if (labelText.includes(searchTerm)) {
                        li.style.display = 'block';
                    } else {
                        li.style.display = 'none';
                    }
                });
            });

            // Adiciona a l√≥gica de autocompletar e formata√ß√£o ao campo de assunto na modal de edi√ß√£o
            const editSubjectInput = document.getElementById('edit-assisted-subject');
            editSubjectInput.addEventListener('change', () => {
                const originalValue = editSubjectInput.value;
                let selectedText = originalValue;
                
                if (selectedText.includes(' > ')) {
                    const parts = selectedText.split(' > ');
                    selectedText = parts[parts.length - 1];
                }
                
                editSubjectInput.value = selectedText;
            });
    </script>

<!-- Modal de Anota√ß√µes -->
<div id="notes-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
  <div class="bg-white rounded-xl p-6 w-96 shadow-lg">
    <h2 class="text-lg font-semibold text-gray-700 mb-3">Minhas Anota√ß√µes</h2>
    <textarea id="notes-text" class="w-full h-40 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500"></textarea>
    <div class="mt-4 flex justify-end gap-2">
      <button id="save-notes-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Salvar</button>
      <button id="close-notes-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirma√ß√£o (necess√°rio para as novas funcionalidades) -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Confirma√ß√£o</h2>
        <p id="modal-text" class="mb-6 text-gray-600">Tem certeza que deseja realizar esta a√ß√£o?</p>
        <div class="flex justify-end space-x-4">
            <button id="cancel-action" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
            <button id="confirm-action" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>

  const notesBtn = document.getElementById("notes-btn");
  const notesModal = document.getElementById("notes-modal");
  const closeNotesBtn = document.getElementById("close-notes-btn");
  const saveNotesBtn = document.getElementById("save-notes-btn");
  const notesText = document.getElementById("notes-text");

  const confirmModal = document.getElementById('confirm-modal');
  const modalText = document.getElementById('modal-text');
  const confirmActionBtn = document.getElementById('confirm-action');
  const cancelActionBtn = document.getElementById('cancel-action');
  let actionToConfirm = null;

  function showConfirmModal(callback, message) {
    modalText.innerHTML = message;
    confirmModal.classList.remove('hidden'); // Use classList.remove para Tailwind CSS
    actionToConfirm = callback;
  }

  if (confirmActionBtn) {
    confirmActionBtn.addEventListener('click', () => {
        if (actionToConfirm) {
            actionToConfirm();
        }
        confirmModal.classList.add('hidden');
        actionToConfirm = null;
    });
  }

  if (cancelActionBtn) {
    cancelActionBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        actionToConfirm = null;
    });
  }


  notesBtn.addEventListener("click", () => {
    const saved = localStorage.getItem("pauta_notes") || "";
    notesText.value = saved;
    notesModal.classList.remove("hidden");
  });

  closeNotesBtn.addEventListener("click", () => {
    notesModal.classList.add("hidden");
  });

  saveNotesBtn.addEventListener("click", () => {
    localStorage.setItem("pauta_notes", notesText.value);
    alert("Anota√ß√£o salva!");
    notesModal.classList.add("hidden");
  });

// Envio de E-mail de Delega√ß√£o (Modular)
document.getElementById('send-delegate-email-btn').addEventListener('click', async () => {
    const collaboratorEmail = document.getElementById('collaborator-email-input').value.trim();
    if (!collaboratorEmail) return showNotification("Insira o e-mail.", "error");

    try {
        await sendDelegationEmail({
            toEmail: collaboratorEmail,
            assistedName: assistedNameForDelegation,
            collaboratorName: collaboratorNameForDelegation,
            pautaId: currentPautaId,
            assistedId: assistedIdForDelegation,
            senderName: currentUserName,
            senderEmail: auth.currentUser?.email
        });
        showNotification("Link enviado por e-mail!");
        document.getElementById('delegate-email-modal').classList.add('hidden');
    } catch (error) {
        showNotification("Erro ao enviar e-mail.", "error");
    }
});

  // C. Envio autom√°tico de anota√ß√µes ao fechar a pauta (Modular)
const closePautaBtn = document.getElementById("close-pauta-btn");
if (closePautaBtn) {
    closePautaBtn.addEventListener("click", async () => {
        // Aguarda um tempo para verificar se o modal de senha fechou (sucesso no fechamento)
        setTimeout(async () => {
            const isPasswordModalHidden = document.getElementById('close-pauta-modal').classList.contains('hidden');
            
            if (isPasswordModalHidden) { 
                // Busca as anota√ß√µes do localStorage (chave original: pauta_notes)
                const notes = localStorage.getItem("pauta_notes") || "";
                
                if (notes.trim() !== "") {
                    try {
                        // Chama a fun√ß√£o do arquivo js/emailService.js
                        await sendNotesByEmail(notes, currentUserName, auth.currentUser?.email);
                        showNotification("Anota√ß√µes enviadas para seu e-mail por seguran√ßa!", "info");
                    } catch (err) {
                        console.error("Falha ao enviar backup das notas:", err);
                    }
                }
            }
        }, 1000); // 1 segundo de delay para garantir que o banco atualizou antes
    });
}
</script>
</html>

