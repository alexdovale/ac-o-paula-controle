<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pauta - SIGAP</title>

    <link rel="icon" type="image/png" href="https://alexdovale.github.io/ponto.codoc/imagem.png">

    <meta name="theme-color" content="#16a34a"/>
    <link rel="apple-touch-icon" href="https://alexdovale.github.io/ponto.codoc/imagem.png">
    <link rel="manifest" href="manifest.json">

    <!-- ======================================================= -->
    <!-- MONITORAMENTO DE ERROS (SENTRY) -->
    <!-- Cole este bloco no in√≠cio do <head> do index.html -->
    <!-- ======================================================= -->
    
    <script
      src="https://browser.sentry-cdn.com/7.114.0/bundle.min.js"
      crossorigin="anonymous"
    ></script>
    
    <script>
      if (window.Sentry) {
        Sentry.init({
          dsn: "https://7d95a89ba62ab6b3f7a64540c8e693cb@o4510647821795328.ingest.us.sentry.io/4510647932223488", 
          tracesSampleRate: 1.0,
          replaysSessionSampleRate: 0.1, 
          replaysOnErrorSampleRate: 1.0, 
          environment: "production",
          release: "sigap@1.0.0",
          
          // --- ADICIONE ESTA PARTE PARA O FEEDBACK VISUAL ---
          beforeSend(event, hint) {
            // Verifica se √© um erro (exception) e se n√£o foi tratado
            if (event.exception) {
              Sentry.showReportDialog({ eventId: event.event_id });
            }
            return event;
          }
          // --------------------------------------------------
        });
      }
    </script>
    <!-- Para os gr√°ficos -->    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS para Arrastar e Soltar -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Para o PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .priority-urgente { border-left: 5px solid #ef4444; }
        .priority-maxima { border-left: 5px solid #22c55e; }
        .priority-media { border-left: 5px solid #f97316; }
        .priority-minima { border-left: 5px solid #6b7280; }
        .column-content::-webkit-scrollbar, .scrollable-content::-webkit-scrollbar, #policy-content::-webkit-scrollbar, #checklist-container::-webkit-scrollbar, #members-list-container::-webkit-scrollbar, #statistics-content::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-track, .scrollable-content::-webkit-scrollbar-track, #policy-content::-webkit-scrollbar-track, #checklist-container::-webkit-scrollbar-track, #members-list-container::-webkit-scrollbar-track, #statistics-content::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .column-content::-webkit-scrollbar-thumb, .scrollable-content::-webkit-scrollbar-thumb, #policy-content::-webkit-scrollbar-thumb, #checklist-container::-webkit-scrollbar-thumb, #members-list-container::-webkit-scrollbar-thumb, #statistics-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; }
        .tab-active { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; font-weight: 600; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos para o bot√£o de confirmado */
        .confirm-btn-style {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px; 
            height: 28px; 
            border-radius: 50%;
            border: 1px solid currentColor;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            flex-shrink: 0; 
            margin-left: 8px; 
        }
        .confirm-btn-icon {
            width: 18px; 
            height: 18px; 
            color: white; 
        }
        .grid.gap-2 > div {
            padding: 0.5rem; 
        }
        .space-y-2 > * + * {
            margin-top: 0.25rem; 
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ADICIONE ESTE BLOCO AQUI: -->
    <div id="offline-indicator" class="fixed top-0 left-0 w-full bg-red-600 text-white text-center py-1 text-sm font-bold hidden z-[100] transition-all duration-300">
        ‚ö†Ô∏è Sem conex√£o. Trabalhando em Modo Offline.
    </div>
    <!-- FIM DO BLOCO ADICIONADO -->

    <div id="loading-container" class="loading-container"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-700 font-semibold text-center">Conectando com Seguran√ßa...</p></div>

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <img src="https://alexdovale.github.io/ponto.codoc/imagem.png" alt="Logo SIGAP" class="mx-auto h-24 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Sistema de Gerenciamento de Pauta</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 text-center font-semibold text-green-600 border-b-2 border-green-600">Login</button>
                <button id="register-tab-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">Cadastrar</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div class="text-right">
                    <a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Entrar</button>
            </form>
            <form id="register-form" class="hidden space-y-4">
                <div><label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-password" class="block text-sm font-medium text-gray-700">Senha (m√≠nimo 6 caracteres)</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Criar Conta</button>
            </form>
            <a href="#" id="privacy-policy-link" class="block mt-4 text-center text-sm text-gray-500 hover:underline">
                    Pol√≠tica de Privacidade
            </a>
        </div>
    </div>

    <div id="pauta-selection-container" class="hidden max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Gerenciamento de Pauta - SIGAP</h1>
        </div>
        <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">Minhas Pautas</h2>
              <div>
                  <button id="admin-btn-main" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Painel do Admin</button>
                  <button id="logout-btn-main" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Sair</button>
              </div>
        </div>
        <div id="install-container" class="hidden my-4 p-3 bg-green-100 border border-green-200 rounded-lg text-center">
            <p class="text-sm text-green-800">Leve o gerenciador de pautas com voc√™!</p>
            <button id="install-button" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 text-sm rounded-lg shadow-md hover:shadow-lg transition-all">
                Instalar App
            </button>
        </div>

        <!-- No pauta-selection-container, perto do bot√£o de logout -->
        <!-- Bot√£o Painel do Administrador (Centralizado e com Margem) -->
        <div class="flex justify-center w-full mb-6"> <!-- Flex para centralizar, mb-6 para margem embaixo -->
            <button id="admin-panel-btn" class="hidden bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition shadow-md">
                Painel do Administrador
            </button>
        </div>
        
        <!-- Modal do Painel de Admin -->
        <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Painel do Administrador</h2>
                    <button id="close-admin-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                
                <div class="mt-8 border-t pt-4">
                    <h3 class="font-semibold text-red-600 mb-2 uppercase text-sm">Manuten√ß√£o do Sistema (LGPD)</h3>
                    <p class="text-xs text-gray-500 mb-4">Apaga permanentemente atendimentos com mais de 7 dias de todas as pautas.</p>
                    <button id="cleanup-old-data-btn" class="w-full bg-red-100 text-red-700 font-bold py-2 rounded-lg hover:bg-red-200 transition border border-red-300">
                        Executar Limpeza de 7 Dias
                    </button>
                </div>


            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 border-l-4 border-purple-500 pl-2">Auditoria e Seguran√ßa</h3>
                
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="font-bold text-gray-700">Logs de Atividade</h4>
                            <p class="text-xs text-gray-600">Visualize o hist√≥rico de a√ß√µes cr√≠ticas realizadas no sistema.</p>
                        </div>
                        <button id="view-audit-logs-btn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm font-bold">
                            Carregar Logs
                        </button>
                    </div>
            
                    <!-- √Årea onde os logs ser√£o listados -->
                    <div id="audit-logs-container" class="hidden mt-4">
                        <div class="overflow-x-auto max-h-60 overflow-y-auto border rounded bg-white">
                            <table class="w-full text-xs text-left text-gray-500">
                                <thead class="text-gray-700 uppercase bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2">Data/Hora</th>
                                        <th class="px-3 py-2">Usu√°rio</th>
                                        <th class="px-3 py-2">A√ß√£o</th>
                                        <th class="px-3 py-2">Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-logs-table-body">
                                    <!-- Logs inseridos via JS -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-logs-msg" class="text-center text-gray-400 text-xs py-2 hidden">Nenhum registro encontrado.</p>
                    </div>
                </div>
            </div>
                            
                <div class="overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Usu√°rios Pendentes</h3>
                    <div id="pending-users-list" class="space-y-3 mb-6">
                        <!-- Usu√°rios pendentes aparecer√£o aqui -->
                    </div>
        
                    <h3 class="font-semibold text-gray-700 mb-2">Usu√°rios Aprovados</h3>
                    <div id="approved-users-list" class="space-y-3">
                        <!-- Usu√°rios aprovados aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>
        
        <div id="invitations-container" class="hidden mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Convites Pendentes</h2>
            <div id="pending-invitations-list" class="space-y-4"></div>
        </div>
        <div id="pautas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6"><button id="create-pauta-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Criar Nova Pauta</button></div>
    </div>

    <div id="app-container" class="max-w-full mx-auto hidden">
        <header class="mb-6 space-y-4">
            <div class="flex justify-center items-center w-full relative">
                 <h1 class="text-xl font-semibold text-gray-600 text-center">Sistema de Gerenciamento de Pauta - SIGAP</h1>
                 <button id="logout-btn-app" title="Sair" class="absolute top-0 right-0 bg-gray-600 text-white font-bold p-2 rounded-lg hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                            <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                 </button>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                <div class="text-center border-b pb-4">
                    <h2 id="pauta-title" class="text-2xl md:text-3xl font-bold text-gray-800 truncate px-4"></h2>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center w-full gap-4 pt-4">
                    <div class="flex-shrink-0">
                        <button id="back-to-pautas-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                    </div>

                    <div class="relative flex items-center">
                        <!-- MENU DE A√á√ïES ATUALIZADO -->
                        <div id="actions-panel" class="absolute top-full right-0 mt-2 w-64 p-2 bg-white rounded-lg shadow-xl border border-gray-200 transition-all duration-200 ease-out transform origin-top-right opacity-0 scale-95 pointer-events-none z-20 space-y-1">

                            <button id="share-pauta-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-pink-700 bg-pink-100 rounded-lg hover:bg-pink-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                <span>Compartilhamento Externo</span>
                            </button>

                            
                            <button id="view-stats-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-cyan-700 bg-cyan-100 rounded-lg hover:bg-cyan-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-cyan-500"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-8.4 0L3 15.6V21h5.4l7.3-7.3Z"/></svg>
                                <span>Ver Estat√≠sticas</span>
                            </button>
                            
                            <button id="edit-pauta-name-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-slate-500"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                <span>Editar Nome</span>
                            </button>

                            <button id="manage-members-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-slate-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                <span>Compartilhar</span>
                            </button>

                            <div class="w-full h-px bg-gray-300 my-1"></div>

                            <button id="close-pauta-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-orange-700 bg-orange-100 rounded-lg hover:bg-orange-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-orange-500"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                <span>Fechar Pauta</span>
                            </button>

                            <button id="reopen-pauta-btn" class="hidden flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-teal-700 bg-teal-100 rounded-lg hover:bg-teal-200 transition-colors whitespace-nowrap">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-teal-500"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
                               <span>Reabrir Pauta</span>
                            </button>

                            <button id="reset-all-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-red-700 bg-red-100 rounded-lg hover:bg-red-200 transition-colors whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-red-500"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                <span>Zerar Pauta</span>
                            </button>
                            
                            <button id="manage-collaborators-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-violet-700 bg-violet-100 rounded-lg hover:bg-violet-200 transition-colors whitespace-nowrap">
                                <svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5 text-violet-500' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
                                    <path d='M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2'/><circle cx='9' cy='7' r='4'/><polyline points='16 11 18 13 22 9'/>
                                </svg>
                                <span>Colaboradores</span>
                            </button>
                            
                            <button id="notes-btn" class="flex items-center gap-2 w-full px-3 py-2 text-sm font-medium text-indigo-700 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition-colors whitespace-nowrap">
                                <svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5 text-indigo-500' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
                                    <path d='M9 12h6M9 16h6M12 20h.01M19 3h-4a2 2 0 0 0-2-2H11a2 2 0 0 0-2 2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z'/>
                                </svg>
                                <span>Anota√ß√µes</span>
                            </button>
                        </div>

                        <button id="actions-toggle" class="z-10 flex items-center justify-center gap-2 px-5 py-2.5 text-white bg-green-600 hover:bg-green-700 font-semibold rounded-lg transition-colors duration-200">
                            <span>A√ß√µes</span>
                            <svg id="actions-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 transition-transform duration-200"><path d="m6 9 6 6 6-6"/></svg>
                        </button>

                    </div>
                </div>
            </div>

            <div id="closed-pauta-alert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-4" role="alert">
                <p class="font-bold">Pauta Fechada</p>
                <p>Esta pauta est√° fechada para novas edi√ß√µes. Apenas o criador pode reabri-la.</p>
            </div>
        </header>

        <div id="app-content" class="w-full">
              <div class="mb-6">
                  <div class="border-b border-gray-200">
                      <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                          <button id="tab-agendamento" class="tab-active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Agendado</button>
                          <button id="tab-avulso" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Avulso</button>
                      </nav>
                  </div>
              </div>
            <form id="form-agendamento" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 id="form-title" class="text-xl font-semibold text-gray-700">Adicionar Novo Agendamento</h2>
                    <div id="agendamento-actions" class="flex items-center gap-4">
                        <a href="#" id="format-help-link" class="text-sm text-green-600 hover:text-green-800 hover:underline transition-colors duration-300 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.95-11.05a.9.9 0 0 1 .023 1.272l-.2.204a.9.9 0 0 1-1.273-.226L6.451 4.95a.9.9 0 0 1 1.273-.023l.204.2zM8 8.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                            <span>Como converter minha pauta?</span>
                        </a>
                        <label for="file-upload" class="cursor-pointer bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition text-sm inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Carregar Pauta (CSV)
                        </label>
                        <input type="file" id="file-upload" class="hidden" accept=".csv">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col lg:col-span-2">
                            <label for="assisted-name" class="mb-1 font-medium text-gray-600">Nome do Assistido</label>
                            <input type="text" id="assisted-name" placeholder="Ex: Jo√£o da Silva" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                        </div>
                        <div class="flex flex-col"><label for="assisted-cpf" class="mb-1 font-medium text-gray-600">CPF (Opcional)</label><input type="text" id="assisted-cpf" placeholder="___.___.___-__" maxlength="14" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                        <div class="flex flex-col lg:col-span-4">
                            <div class="flex items-center gap-2 mb-1">
                                <label for="assisted-subject" class="font-medium text-gray-600">Mat√©ria - Assunto</label>
                                <button type="button" id="subject-info-btn" class="font-bold text-lg text-blue-500 cursor-help rounded-full disabled:text-gray-300 disabled:cursor-not-allowed">!</button>
                            </div>

                            <input list="subjects-list" id="assisted-subject" name="assisted-subject" placeholder="Digite ou selecione um assunto" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition w-full">
                            <datalist id="subjects-list"></datalist>

                            <div id="subject-description" class="hidden mt-2 p-4 bg-blue-50 border border-blue-200 text-gray-800 rounded-lg text-sm transition-all duration-300">
                                </div>
                        </div>
                    </div>

                    <div id="form-options-container" class="border-t mt-4 pt-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div id="is-scheduled-container">
                            <label class="font-medium text-gray-700">Possui hor√°rio agendado?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="is-scheduled" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="is-scheduled" value="no" class="mr-1" checked> N√£o</label>
                            </div>
                            <div id="scheduled-time-wrapper" class="hidden mt-2">
                                <label for="scheduled-time" class="block mb-1 font-medium text-gray-600">Hor√°rio Agendado</label>
                                <input type="time" id="scheduled-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Assistido j√° chegou?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="has-arrived" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="has-arrived" value="no" class="mr-1" checked> N√£o</label>
                            </div>
                            <div id="arrival-time-wrapper" class="hidden mt-2">
                                <label for="arrival-time" class="block mb-1 font-medium text-gray-600">Hor√°rio de Chegada</label>
                                <input type="time" id="arrival-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                            <!-- SELE√á√ÉO DE SALA PARA AVULSO -->
                            <div id="manual-room-wrapper" class="hidden mt-2">
                                <label for="manual-room-select" class="block mb-1 font-medium text-gray-600">Sala de Destino</label>
                                <select id="manual-room-select" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                                </select>
                            </div>
                        </div>
                    </div>
                     <button type="button" id="add-assisted-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md w-full lg:w-auto">Adicionar</button>
                </div>
            </form>
            <main id="main-content" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 w-full">
                <div id="pauta-column" class="bg-white rounded-lg shadow-md flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>üìã Pauta</span>
                            <span id="pauta-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="pauta-search" placeholder="Pesquisar por nome, CPF, hor√°rio..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="pauta-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
               <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                           <span>‚è≥ Aguardando Atendimento</span>
                           <span id="aguardando-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="aguardando-search" placeholder="Pesquisar por nome, CPF, hor√°rio..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="aguardando-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <!-- Nova Coluna: Em Atendimento -->
                <div id="em-atendimento-column" class="bg-white rounded-lg shadow-md flex flex-col hidden"> <!-- Inicialmente escondida, visibilidade controlada pelo JS -->
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>üë©‚Äçüíª Em Atendimento</span>
                            <span id="em-atendimento-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="em-atendimento-search" placeholder="Pesquisar por nome, colaborador..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="em-atendimento-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <!-- Fim da Nova Coluna: Em Atendimento -->

                <!-- NOVA COLUNA: AGUARDANDO DISTRIBUI√á√ÉO -->
                <div id="distribuicao-column" class="bg-white rounded-lg shadow-md flex flex-col hidden">
                    <div class="p-4 border-b border-gray-200 bg-cyan-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>‚öñÔ∏è Aguardando Distribui√ß√£o</span>
                            <span id="distribuicao-count" class="text-base font-normal bg-white text-gray-700 px-2 rounded-full border">0</span>
                        </h3>
                        <input type="search" id="distribuicao-search" placeholder="Pesquisar..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500">
                    </div>
                    <div id="distribuicao-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <!-- Fim da Nova Coluna -->

                <div id="atendidos-column" class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                             <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center w-full">
                                 <span>‚úÖ Atendidos</span>
                                 <span id="atendidos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                             </h3>
                            <button id="download-pdf-btn" class="ml-4 flex-shrink-0 bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm">PDF</button>
                        </div>
                        <input type="search" id="atendidos-search" placeholder="Pesquisar por nome, CPF, hor√°rio..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="atendidos-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                 <div id="faltosos-column" class="bg-white rounded-lg shadow-md flex flex-col hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                üö´ Faltosos
                                <span id="faltosos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                        </div>
                        <input type="search" id="faltosos-search" placeholder="Pesquisar..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="faltosos-list" class="p-2 space-y-2 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
            </main>
            <div class="mt-8 flex justify-center">
                <button id="toggle-faltosos-btn" class="w-full sm:w-auto bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Ver Faltosos</button>
            </div>
              <footer class="mt-12 bg-white p-6 rounded-lg shadow-md">
                  <h3 id="order-explanation-title" class="text-xl font-semibold text-gray-800 mb-2 text-center">Entenda a Ordem de Atendimento</h3>
                  <div id="order-explanation-content">
                      <div id="logic-explanation-padrao">
                          <div class="text-center mb-4">
                              <button id="toggle-logic-btn-padrao" class="text-green-600 hover:text-green-800 text-sm hover:underline transition-colors duration-300">Por que esta ordem √© justa? (Clique para expandir)</button>
                          </div>
                          <div id="logic-explanation-padrao-content" class="hidden mt-4 text-left p-4 bg-gray-50 rounded-lg border space-y-3">
                              <p>A l√≥gica foi pensada para balancear a <strong>pontualidade</strong> com a <strong>realidade</strong> do dia a dia, criando um sistema justo para todos.</p>
                              <ul class="list-disc list-inside space-y-2 text-gray-700">
                                  <li><strong>Recompensa a Pontualidade:</strong> Valoriza quem chega no hor√°rio, atendendo-os primeiro. Para assistidos que chegam adiantados, a ordem de atendimento respeita o hor√°rio original do agendamento.</li>
                                  <li><strong>Oferece Toler√¢ncia:</strong> Reconhece que imprevistos acontecem, com uma janela de 20 minutos para pequenos atrasos.</li>
                                  <li><strong>Gerencia Atrasos Maiores:</strong> Coloca quem se atrasou muito no fim da fila para n√£o prejudicar os outros.</li>
                                  <li><strong>Permite Flexibilidade:</strong> O bot√£o "Prioridade" garante que casos graves sejam atendidos imediatamente.</li>
                                  <li><strong>Crit√©rio de Desempate:</strong> Para assistidos com a mesma prioridade, a ordem √© definida pelo <strong>hor√°rio de chegada informado</strong> (quem chegou mais cedo √© atendido primeiro). Se dois ou mais assistidos chegarem exatamente no mesmo hor√°rio, a prefer√™ncia √© de quem teve a chegada <strong>registrada primeiro</strong> no sistema.</li>
                              </ul>
                              <p class="font-semibold text-gray-800 pt-2">O resultado √© uma fila transparente, previs√≠vel e justa tanto para os assistidos quanto para a equipe.</p>
                          </div>
                          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center mt-4">
                              <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500"><p class="font-bold text-red-700">Prioridade Urgente</p><p class="text-sm text-gray-600 mt-1">Definida manualmente para casos que necessitam de atendimento imediato.</p></div>
                              <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"><p class="font-bold text-green-700">Prioridade M√°xima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram no hor√°rio agendado ou adiantados.</p></div>
                              <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500"><p class="font-bold text-orange-700">Prioridade M√©dia</p><p class="text-sm text-gray-600 mt-1">Assistidos agendados com at√© 20 min de atraso ou atendimentos avulsos.</p></div>
                              <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500"><p class="font-bold text-gray-700">Prioridade M√≠nima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram com 30 minutos ou mais de atraso.</p></div>
                          </div>
                      </div>
                      <div id="logic-explanation-chegada" class="hidden text-center">
                          <p class="text-gray-700 p-4 bg-gray-50 rounded-lg border">
                              Neste modo, a fila de "Aguardando Atendimento" √© organizada <strong>estritamente pela ordem de chegada</strong>. O primeiro assistido a ter sua chegada registrada no sistema ser√° o primeiro a ser atendido, independentemente de ter hor√°rio agendado ou ser um atendimento avulso. A √∫nica exce√ß√£o √© o uso do bot√£o <strong>"Prioridade"</strong>, que move o assistido para o topo da fila.
                          </p>
                      </div>
                  </div>
                  <p class="text-center text-sm text-gray-500 mt-8">Desenvolvido por Alex do Vale</p>
              </footer>
        </div>
    </div>

    <!-- Rodap√© do Sistema -->
        <footer class="bg-white border-t border-gray-200 mt-8 pt-6 pb-6 text-center">
    <!-- Links de Navega√ß√£o -->
        <div class="flex justify-center space-x-6 mb-4 text-xs text-gray-500 font-medium">
            <button id="manual-btn-footer" class="hover:text-green-600 transition-colors focus:outline-none">
                Manual do Utilizador
            </button>
            <button id="privacy-btn-footer" class="hover:text-green-600 transition-colors focus:outline-none">Privacidade</button>
            <button id="terms-btn-footer" class="hover:text-green-600 transition-colors focus:outline-none">Termos</button>
        </div>
    
        <!-- Selos de Seguran√ßa -->
        <div class="flex justify-center items-center gap-4 mb-2 opacity-60">
            <!-- Selo SSL -->
            <span class="flex items-center gap-1 text-[10px] text-gray-500 border border-gray-200 px-2 py-0.5 rounded-full" title="Conex√£o Criptografada">
                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="green" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>
                Ambiente Seguro
            </span>
            
            <!-- Selo Sentry -->
            <span class="flex items-center gap-1 text-[10px] text-gray-500 border border-gray-200 px-2 py-0.5 rounded-full" title="Monitoramento de Erros Ativo">
                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="blue" viewBox="0 0 16 16"><path d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.775 11.775 0 0 0 2.517 2.453c.386.262.794.5 1.218.697.12.056.242.107.366.153l.232.083.232-.083c.124-.046.246-.097.366-.153.424-.197.832-.435 1.218-.697a11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.54 1.54 0 0 0-1.044-1.262 62.456 62.456 0 0 0-2.887-.87C9.843.265 8.69 0 8 0zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>
                Sentry Monitored
            </span>
    
            <!-- Selo LGPD (Adicionado) -->
            <span class="flex items-center gap-1 text-[10px] text-gray-500 border border-gray-200 px-2 py-0.5 rounded-full" title="Conformidade com Prote√ß√£o de Dados">
                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="purple" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                </svg>
                LGPD Ready
            </span>
        </div>
    
        <!-- Copyright -->
        <p class="text-xs text-gray-400">
            &copy; 2026 SIGEP - Sistema de Gest√£o. Vers√£o 2.1 (Segura)
        </p>
    </footer>
    
<script>
    // Fun√ß√£o para gerenciar modais
    function bindModal(btnId, modalId, closeIds) {
        const btn = document.getElementById(btnId);
        const modal = document.getElementById(modalId);
        
        if (btn && modal) {
            btn.onclick = () => modal.classList.remove('hidden');
            
            closeIds.forEach(id => {
                const closeBtn = document.getElementById(id);
                if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
            });

            // Fecha ao clicar fora
            modal.onclick = (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            };
        }
    }

    // Inicializa os modais assim que a p√°gina carrega
    window.addEventListener('load', () => {
        bindModal('privacy-btn-footer', 'privacy-policy-modal', ['close-policy-modal-btn-x', 'close-policy-modal-btn']);
        bindModal('manual-btn-footer', 'manual-modal', ['close-manual-modal-x', 'close-manual-modal-btn']);
        bindModal('terms-btn-footer', 'terms-modal', ['close-terms-modal-x', 'close-terms-modal-btn']);
    });
</script>
</body>
</html>

    <div id="pauta-type-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-center">Tipo de Pauta</h2>
            <p class="text-gray-600 text-center mb-6">Selecione o tipo de atendimento para sua nova pauta:</p>
            <div class="space-y-4">
                <button data-type="agendado" class="pauta-type-btn w-full flex items-center justify-center gap-2 p-4 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h8m-11 0h11a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2z" />
                    </svg>
                    Pauta de Atendimento Agendado
                </button>
                <button data-type="avulso" class="pauta-type-btn w-full flex items-center justify-center gap-2 p-4 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                    Pauta de Atendimento Avulso
                </button>
                <!-- NOVA OP√á√ÉO: MULTI-SALAS -->
                <button data-type="multisala" class="pauta-type-btn w-full flex items-center justify-center gap-2 p-4 bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    Pauta Multi-Salas (Sala 1, Sala 2...)
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button id="cancel-pauta-type-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="create-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Criar Nova Pauta</h2>
            <label for="create-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nome da Pauta</label>
            <input type="text" id="create-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            
            <!-- CONFIGURA√á√ÉO DE SALAS PERSONALIZADAS -->
            <div id="room-config-container" class="hidden mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Defina as Salas ou Locais</label>
                
                <div class="flex gap-2 mb-3">
                    <input type="text" id="custom-room-input" placeholder="Ex: Vara de Fam√≠lia, 2¬∫ Andar..." class="flex-1 p-3 border border-gray-300 rounded-lg" />
                    <button id="add-custom-room-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Adicionar
                    </button>
                </div>

                <!-- Lista onde aparecer√£o as salas adicionadas -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3" style="min-height: 100px;">
                    <p id="no-rooms-msg" class="text-gray-400 text-sm text-center mt-4">Nenhum local adicionado ainda.</p>
                    <ul id="custom-rooms-list" class="space-y-2">
                        <!-- Itens ser√£o inseridos aqui via JavaScript -->
                    </ul>
                </div>
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancel-create-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="next-to-ordem-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Avan√ßar</button>
            </div>
        </div>
    </div>
    
    <div id="ordem-atendimento-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Ordem de Atendimento</h2>
            <p class="text-gray-600 mb-6">Como a fila de "Aguardando Atendimento" ser√° organizada?</p>
            <div id="ordem-atendimento-options" class="space-y-3">
                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="ordemAtendimento" value="padrao" class="h-5 w-5 text-green-600 focus:ring-green-500" checked>
                    <span class="ml-3">
                        <span class="font-semibold text-gray-800">Padr√£o do Sistema (Recomendado)</span>
                        <span class="block text-sm text-gray-500">Prioriza por pontualidade e urg√™ncia. Justo e flex√≠vel.</span>
                    </span>
                </label>
                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="ordemAtendimento" value="chegada" class="h-5 w-5 text-green-600 focus:ring-green-500">
                    <span class="ml-3">
                        <span class="font-semibold text-gray-800">Ordem de Chegada</span>
                        <span class="block text-sm text-gray-500">Atende estritamente na ordem em que a chegada foi marcada.</span>
                    </span>
                </label>
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="ordemAtendimento" value="manual" class="h-5 w-5 text-green-600 focus:ring-green-500">
                    <span class="ml-3">
                        <span class="font-semibold text-gray-800">Ordem Manual</span>
                        <span class="block text-sm text-gray-500">Permite arrastar e reordenar a fila livremente.</span>
                    </span>
                </label>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-ordem-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Voltar</button>
                <button id="next-to-delegation-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Avan√ßar</button>
            </div>
        </div>
    </div>

<!-- Modal de Compartilhamento Externo -->
<div id="share-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Compartilhamento Externo</h2>
        <p class="text-gray-600 mb-6 text-sm">Gere um link p√∫blico para que assistidos e colaboradores vejam a fila em tempo real (apenas leitura).</p>
        
        <div class="flex items-center justify-between mb-6 bg-gray-50 p-4 rounded-lg border">
            <span class="font-medium text-gray-700">Status do Link:</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="share-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                <span id="share-status-text" class="ml-3 text-sm font-medium text-gray-900">Privado</span>
            </label>
        </div>

        <div id="share-link-container" class="hidden space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Link P√∫blico</label>
                <div class="flex mt-1">
                    <input type="text" id="share-link-input" readonly class="w-full p-2 border border-gray-300 rounded-l-lg bg-gray-100 text-sm text-gray-600">
                    <button id="copy-share-link-btn" class="bg-blue-600 text-white px-4 rounded-r-lg hover:bg-blue-700 font-bold text-sm">Copiar</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <input type="checkbox" id="mask-names-check" class="h-4 w-4 text-pink-600 border-gray-300 rounded">
                <label for="mask-names-check" class="text-sm text-gray-700">Ocultar Sobrenomes (Privacidade/LGPD)</label>
            </div>
            
            <a id="open-external-btn" href="#" target="_blank" class="block w-full text-center py-2 border border-pink-600 text-pink-600 rounded-lg hover:bg-pink-50 font-bold mt-2">
                Abrir Visualiza√ß√£o
            </a>
        </div>

        <div class="flex justify-end mt-6">
            <button id="close-share-modal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
        </div>
    </div>
</div>


    
    <!-- NOVO MODAL: Fluxo de Delega√ß√£o -->
    <div id="delegation-flow-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Fluxo de Atendimento</h2>
            <p class="text-gray-600 mb-6">Deseja utilizar a coluna "Em Atendimento" para delegar a finaliza√ß√£o a um colaborador?</p>
            <div class="space-y-3">
                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="useDelegationFlow" value="true" class="h-5 w-5 text-green-600 focus:ring-green-500" checked>
                    <span class="ml-3">
                        <span class="font-semibold text-gray-800">Sim, usar fluxo de delega√ß√£o</span>
                        <span class="block text-sm text-gray-500">Permite atribuir e delegar a finaliza√ß√£o para outro colaborador.</span>
                    </span>
                </label>
                
                <!-- SUB-OP√á√ÉO: Distribui√ß√£o (S√≥ aparece se Delega√ß√£o estiver marcada) -->
                <div id="distribution-option-container" class="p-4 border-x border-b rounded-b-lg bg-white ml-8 border-t-0">
                    <label class="flex items-start space-x-3 cursor-pointer">
                        <input type="checkbox" id="check-use-distribution" class="h-5 w-5 text-cyan-600 focus:ring-cyan-500 rounded mt-1">
                        <div class="flex-1">
                            <span class="font-semibold text-gray-700 block">Habilitar Fila de Distribui√ß√£o?</span>
                            <span class="text-xs text-gray-500">Adiciona a coluna "Aguardando Distribui√ß√£o" para processos que precisam de assinatura/protocolo antes de finalizar.</span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="mt-4">
                <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="radio" name="useDelegationFlow" value="false" class="h-5 w-5 text-red-600 focus:ring-red-500">
                    <span class="ml-3">
                        <span class="font-semibold text-gray-800">N√£o, finalizar diretamente</span>
                        <span class="block text-sm text-gray-500">Pular a coluna "Em Atendimento", indo direto para "Atendidos".</span>
                    </span>
                </label>
            </div>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-delegation-flow-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Voltar</button>
                <button id="confirm-create-pauta-final-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Criar Pauta</button>
            </div>
        </div>
    </div>
    <!-- FIM NOVO MODAL -->

    <!-- Modal de Conclus√£o de Distribui√ß√£o -->
    <div id="distribution-finish-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-cyan-800">Concluir Distribui√ß√£o</h2>
            <p class="mb-4 text-gray-600">O processo foi distribu√≠do. Por favor, insira o n√∫mero (opcional).</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">N√∫mero do Processo</label>
                <input type="text" id="dist-process-number" placeholder="0000.00.00.0000" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500">
            </div>

            <div class="flex justify-end space-x-4">
                <button id="cancel-dist-finish-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-dist-finish-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Salvar e Finalizar</button>
            </div>
        </div>
    </div>

    <div id="members-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Membros da Pauta</h2>
                <button id="close-members-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700">Convidar Novo Membro (Usu√°rio do Sistema)</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="invite-email-input" placeholder="email@exemplo.com" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="invite-member-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex-shrink-0">Convidar</button>
                    </div>
                    <div id="invite-status" class="text-sm h-4"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Membros Atuais da Pauta</h3>
                    <div id="members-list-container" class="space-y-2 max-h-64 overflow-y-auto">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE GERENCIAR COLABORADORES (LISTA DE PRESEN√áA) - INTEGRADO -->
   <!-- MODAL DE GERENCIAR COLABORADORES (LISTA DE PRESEN√áA) - ATUALIZADO -->
<div id="collaborators-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-6xl flex flex-col" style="max-height: 90vh;">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h2 class="text-2xl font-bold text-gray-800">Lista de Presen√ßa de Colaboradores</h2>
            <button id="close-collaborators-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
        </div>

        <div class="flex-grow overflow-y-auto pr-2">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Adicionar/Editar Colaborador (Equipe de Campo)</h3>
                    <form id="collaborator-form-modal">
                        <div class="space-y-4">
                            <div>
                                <label for="collaborator-name-modal" class="block text-sm font-medium text-gray-700">Nome do Colaborador:</label>
                                <input type="text" id="collaborator-name-modal" name="nome-colaborador" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>

                            <!-- CAMPO CARGO ADICIONADO -->
                            <div>
                                <label for="collaborator-role-modal" class="block text-sm font-medium text-gray-700">Cargo:</label>
                                <select id="collaborator-role-modal" name="cargo-colaborador" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="" disabled selected>Selecione o cargo</option>
                                    <option value="Defensor(a)">Defensor(a)</option>
                                    <option value="Servidor(a)">Servidor(a)</option>
                                    <option value="CRC">CRC</option>
                                </select>
                            </div>

                            <!-- CAMPO EQUIPE ATUALIZADO PARA SELECT -->
                            <div>
                                <label for="collaborator-team-modal" class="block text-sm font-medium text-gray-700">Equipe:</label>
                                <select id="collaborator-team-modal" name="equipe-colaborador" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option value="" disabled selected>Selecione a equipe</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>

                            <div>
                                <label for="collaborator-email-modal" class="block text-sm font-medium text-gray-700">Email do Colaborador (opcional):</label>
                                <input type="email" id="collaborator-email-modal" name="email-colaborador" placeholder="email@exemplo.com" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>

                            <div>
                                <label for="collaborator-phone-modal" class="block text-sm font-medium text-gray-700">Telefone (com DDD):</label>
                                <input type="tel" id="collaborator-phone-modal" name="telefone-colaborador" placeholder="Ex: 21999998888" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Como vai se deslocar?</label>
                                <div class="mt-1 flex flex-wrap items-center gap-x-4 gap-y-2">
                                    <label><input type="radio" id="transporte-nao-confirmado-modal" name="transporte-colaborador" value="N√£o Confirmado" checked required> N√£o Confirmado</label>
                                    <label><input type="radio" id="transporte-meios-proprios-modal" name="transporte-colaborador" value="Meios Pr√≥prios"> Meios Pr√≥prios</label>
                                    <label><input type="radio" id="transporte-com-empresa-modal" name="transporte-colaborador" value="Com a Empresa"> Com a Empresa</label>
                                </div>
                            </div>
                            <div id="local-encontro-group-modal" class="hidden">
                                <label class="block text-sm font-medium text-gray-700">Ponto de Encontro:</label>
                                <div class="mt-1 flex items-center space-x-4">
                                    <label><input type="radio" id="local-sede-modal" name="localEncontro-colaborador" value="Sede"> Sede</label>
                                    <label><input type="radio" id="local-meio-caminho-modal" name="localEncontro-colaborador" value="Meio do Caminho"> No meio do caminho</label>
                                </div>
                            </div>
                            <div id="observacao-group-modal" class="hidden">
                                <label for="collaborator-obs-modal" class="block text-sm font-medium text-gray-700">Observa√ß√£o:</label>
                                <textarea id="collaborator-obs-modal" name="observacao-colaborador" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                            <button type="submit" id="add-collaborator-btn-modal" class="w-full bg-green-600 text-white font-bold py-2 rounded-md hover:bg-green-700 transition">Adicionar Colaborador</button>
                        </div>
                    </form>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Estat√≠sticas e Lista</h3>
                    <div id="presence-stats" class="mb-4 text-sm text-gray-700 space-y-1">
                        <p>Total de Participantes: <strong id="total-participants-count">0</strong></p>
                        <p>Meios Pr√≥prios: <strong id="self-transport-count">0</strong></p>
                        <p>Com a Empresa: <strong id="company-transport-count">0</strong></p>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="collaborators-list-table-modal" class="w-full text-sm text-left text-gray-500">
                          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="py-3 px-6">Nome</th>
                                        <th scope="col" class="py-3 px-6">Cargo</th>
                                        <th scope="col" class="py-3 px-6">Equipe</th>
                                        <th scope="col" class="py-3 px-6">Presen√ßa</th>       <th scope="col" class="py-3 px-6">Hor√°rio</th>
                                        <th scope="col" class="py-3 px-6">Email</th>          <th scope="col" class="py-3 px-6">Deslocamento</th>
                                        <th scope="col" class="py-3 px-6">WhatsApp</th>
                                        <th scope="col" class="py-3 px-6">A√ß√µes</th>
                                    </tr>
                                </thead>
                            <tbody>
                                <!-- As linhas da tabela ser√£o preenchidas via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button id="download-collaborators-pdf-modal" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">PDF</button>
                        <button id="clear-collaborators-list-modal" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 text-sm">Limpar Lista</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- FIM MODAL DE GERENCIAR COLABORADORES -->
    
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="arrival-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Confirmar Hor√°rio de Chegada</h2>
            <p class="mb-4 text-gray-600">Por favor, informe o hor√°rio de chegada do assistido.</p>
            
            <!-- SELE√á√ÉO DE SALA PARA CHECKIN -->
            <div id="arrival-room-container" class="hidden mb-4">
                <label for="arrival-room-select" class="block text-sm font-medium text-gray-700 mb-1">Selecionar Sala de Espera</label>
                <select id="arrival-room-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                    <!-- Op√ß√µes preenchidas via JS -->
                </select>
            </div>

            <input type="time" id="arrival-time-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-arrival-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-arrival-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Finaliza√ß√£o de Atendimento (Antigo) - Mantido para 'Finalizar Diretamente' ou 'Editar Atendente' -->
    <div id="attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Finalizar Atendimento</h2>
            <p class="mb-4 text-gray-600">Insira o nome do profissional que realizou o atendimento (opcional).</p>
            <input list="collaborators-list" type="text" id="attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <datalist id="collaborators-list"></datalist>
            <div class="flex justify-end space-x-4">
                <button id="cancel-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: Selecionar Colaborador -->
    <div id="select-collaborator-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Atender Assistido</h2>
            <p class="mb-4 text-gray-600">Selecione o colaborador que ir√° atender <strong id="assisted-to-attend-name"></strong> (opcional):</p>
            <div id="collaborator-selection-list" class="space-y-3 mb-6 max-h-60 overflow-y-auto">
                <p class="text-gray-500 text-center">Carregando colaboradores...</p>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-select-collaborator-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-select-collaborator-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Confirmar Sele√ß√£o</button>
            </div>
        </div>
    </div>
    <!-- FIM NOVO MODAL -->

    <!-- NOVO MODAL: Delegar Finaliza√ß√£o por Email -->
    <div id="delegate-email-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Delegar Finaliza√ß√£o de Atendimento</h2>
            <p class="mb-4 text-gray-600">Enviar link de finaliza√ß√£o para <strong id="delegate-assisted-name"></strong>.</p>
            <div class="mb-4">
                <label for="collaborator-email-input" class="block text-sm font-medium text-gray-700">Email do Colaborador:</label>
                <input type="email" id="collaborator-email-input" placeholder="email@exemplo.com" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <p class="text-sm text-gray-500 mb-6">O colaborador receber√° um link por e-mail para finalizar o atendimento.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delegate-email-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="send-delegate-email-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enviar Link por E-mail</button>
            </div>
        </div>
    </div>
    <!-- FIM NOVO MODAL -->

    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">Zerar Pauta</h2>
            <p class="text-gray-600">Tem certeza de que deseja apagar permanentemente todos os dados desta pauta?</p>
            <div id="reset-auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div>
                <label for="reset-pauta-password" class="block text-sm font-medium text-gray-700">Confirme sua senha:</label>
                <input type="password" id="reset-pauta-password" class="w-full p-3 border border-gray-300 rounded-lg mt-1" required>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-reset-btn" class="bg-red-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-800">Zerar Pauta</button>
            </div>
        </div>
    </div>
    <div id="edit-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Nome da Pauta</h2>
            <label for="edit-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Novo nome</label>
            <input type="text" id="edit-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="close-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4" id="close-modal-title">Fechar Pauta</h2>
            <p class="mb-4 text-gray-600" id="close-modal-message">Para fechar esta pauta, confirme sua senha. Nenhum membro poder√° fazer altera√ß√µes at√© que voc√™ a reabra.</p>
            <input type="password" id="close-pauta-password" placeholder="Sua senha de login" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div id="close-auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-close-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-close-pauta-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>


    <div id="format-help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl relative flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0">
                <button id="close-format-help-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                <h2 class="text-2xl font-bold mb-4">Como Preparar sua Pauta para Importa√ß√£o</h2>
            </div>
            <div class="flex-grow overflow-y-auto scrollable-content pr-4">
                <p class="mb-4 text-gray-600">Para importar seus agendamentos de uma vez, crie um arquivo <strong>.csv</strong> (Valores Separados por V√≠rgula). Voc√™ pode criar este arquivo usando o Bloco de Notas, Excel, Google Sheets ou similar.</p>

                <div class="flex justify-between items-center mb-2">
                     <p class="font-semibold">O arquivo deve seguir o formato abaixo, com 4 colunas, nesta ordem:</p>
                     <button id="copy-csv-format-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Formato</button>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg text-sm mb-4">
                    <code id="csv-format-code">Nome Completo do Assistido;HH:MM;Mat√©ria do Assunto;CPF(opcional)</code>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">Exemplo:</h3>
                    <button id="copy-csv-example-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Exemplo</button>
                </div>
                <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="csv-example-code">Maria Joaquina de Amaral Pereira;09:00;Div√≥rcio Consensual;111.222.333-44
Jo√£o da Silva;09:30;A√ß√£o de Alimentos;
Fulano de Tal;10:00;Curatela;444.555.666-77</code></pre>
                <ul class="list-disc list-inside mt-4 space-y-2 text-gray-700">
                    <li>A primeira linha (cabe√ßalho) √© <strong>opcional</strong>. O sistema a ignorar√° se presente.</li>
                    <li>O campo <strong>CPF</strong> √© opcional. Se n√£o houver CPF, deixe o espa√ßo em branco (ou n√£o coloque nada ap√≥s o √∫ltimo ponto e v√≠rgula).</li>
                    <li>O <strong>hor√°rio</strong> deve estar no formato <strong>HH:MM</strong> (Ex: 09:00, 14:30).</li>
                    <li>Salve o arquivo com a extens√£o <strong>.csv</strong>.</li>
                </ul>

                <div class="mt-6 pt-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Prompt para IA (Ex: ChatGPT, Gemini):</h3>
                        <button id="copy-ai-prompt-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Prompt</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">Se sua pauta est√° em um PDF, copie o texto abaixo e cole junto com o conte√∫do do seu PDF em uma IA para format√°-lo corretamente.</p>
                    <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="ai-prompt-code">Ol√°! Por favor, converta o conte√∫do do arquivo PDF que estou enviando para o formato CSV, usando ponto e v√≠rgula (;) como separador. O resultado deve seguir este padr√£o:

Nome Completo do Assistido;HH:MM;Mat√©ria do Assunto;CPF(opcional)

Por favor, me entregue o texto pronto para que eu possa salvar em um arquivo .csv.</code></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Atendente</h2>
            <p class="mb-4 text-gray-600">Insira o nome do profissional que realizou o atendimento (opcional).</p>
            <input list="collaborators-list" type="text" id="edit-attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <datalist id="collaborators-list"></datalist>
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="demands-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Demandas Adicionais</h2>
                <button id="close-demands-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <p class="mb-4">Assistido: <strong id="demands-assisted-name-modal" class="text-green-600"></strong></p>
                <div class="space-y-2">
                    <label for="demands-modal-new-demand-input" class="block text-sm font-medium text-gray-700">Adicionar nova demanda:</label>
                    <div class="flex gap-2">
                        <input type="text" id="demands-modal-new-demand-input" placeholder="Ex: A√ß√£o de Partilha de Bens" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="demands-modal-add-demand-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex-shrink-0">Adicionar</button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Demandas Adicionais Registradas:</h3>
                    <div id="demands-modal-list-container" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6 flex-shrink-0 border-t pt-4">
                <button id="cancel-demands-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                <button id="save-demands-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <div id="edit-assisted-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
         <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Editar Dados do Assistido</h2>
            <div class="space-y-4">
                <div><label for="edit-assisted-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit-assisted-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-cpf" class="block text-sm font-medium text-gray-700">CPF</label><input type="text" id="edit-assisted-cpf" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-subject" class="block text-sm font-medium text-gray-700">Assunto</label><input list="subjects-list" type="text" id="edit-assisted-subject" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-scheduled-time" class="block text-sm font-medium text-gray-700">Hor√°rio Agendado</label><input type="time" id="edit-scheduled-time" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-edit-assisted-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-assisted-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <div id="priority-reason-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Atendimento Priorit√°rio</h2>
            <p class="mb-4 text-gray-600">Por favor, informe o motivo da prioridade.</p>
            <textarea id="priority-reason-input" placeholder="Motivo..." class="w-full p-3 border border-gray-300 rounded-lg mb-6 h-24"></textarea>
            <div class="flex justify-end space-x-4">
                <button id="cancel-priority-reason-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-priority-reason-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar Prioridade</button>
            </div>
        </div>
    </div>
     <div id="privacy-policy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 80vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Pol√≠tica de Privacidade</h2>
                <button id="close-policy-modal-btn-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="policy-content" class="text-gray-700 space-y-4 overflow-y-auto pr-2">
                <p><strong>1. Natureza do Sistema e Ciclo de Vida dos Dados</strong></p>
                <p>O Sistema de Gerenciamento de Pauta (SIGAP) √© uma interface de controle para a gest√£o de atendimentos. Ele coleta e armazena os dados pessoais de assistidos, como nome, CPF (opcional), assunto e demanda, por um per√≠odo de sete dias ap√≥s a finaliza√ß√£o da a√ß√£o. Ap√≥s esse prazo, os dados s√£o permanentemente exclu√≠dos do SIGAP.</p>
                <p>Para o armazenamento permanente, todos os dados s√£o enviados e salvos no sistema Verde, que √© de responsabilidade da Defensoria P√∫blica do Estado do Rio de Janeiro (DPERJ) e est√° em total conformidade com a LGPD.</p>

                <p><strong>2. Dados Coletados pelo SIGAP</strong></p>
                <p>Para permitir o uso da interface, o SIGAP coleta apenas os dados de autentica√ß√£o dos usu√°rios (profissionais): e-mail e senha.</p>

                <p><strong>3. Tratamento e Prote√ß√£o de Dados (dentro do SIGAP)</strong></p>
                <p>Os dados de autentica√ß√£o s√£o utilizados para garantir o acesso restrito e seguro ao sistema. Os dados de assistidos s√£o armazenados por apenas sete dias, tempo necess√°rio para a conclus√£o da a√ß√£o, e s√£o protegidos por medidas de seguran√ßa para evitar acesso n√£o autorizado.</p>

                <p><strong>4. Direitos dos Titulares dos Dados</strong></p>
                <p>Os direitos dos assistidos, como acesso, corre√ß√£o e exclus√£o de dados, s√£o garantidos e exercidos diretamente por meio do sistema Verde, que √© o respons√°vel pelo armazenamento final. Os usu√°rios do SIGAP podem gerenciar a pauta e solicitar altera√ß√µes no sistema Verde conforme as normas da DPERJ.</p>

                <p><strong>5. Origem e Transfer√™ncia de Dados dos Assistidos</strong></p>
                <p>Os dados dos assistidos gerenciados no SIGAP podem ter duas origens:</p>
                <p><strong>Importa√ß√£o do Sistema Verde:</strong> A maior parte dos dados (nome, hor√°rio, assunto) √© transferida manualmente do sistema oficial Verde (DPERJ) atrav√©s de um processo de exporta√ß√£o e importa√ß√£o. Neste fluxo, o CPF do assistido n√£o √© transferido.</p>
                <p><strong>Cadastro Direto no SIGAP:</strong> Novos atendimentos, como os avulsos, podem ser registrados diretamente na plataforma. Nesses casos, o campo CPF √© opcional e pode ser preenchido pelo profissional respons√°vel pelo cadastro (criador ou membro da pauta).</p>
                <p>O processo de transfer√™ncia manual consiste na exporta√ß√£o da pauta do sistema Verde, quando houver pauta previamente cadastrada, sua convers√£o para um formato compat√≠vel e a importa√ß√£o do arquivo final no SIGAP. Cabe ao usu√°rio respons√°vel pela transfer√™ncia garantir a seguran√ßa dos dados durante este processo, incluindo a exclus√£o segura dos arquivos intermedi√°rios (como PDFs e CSVs) de seus dispositivos locais ap√≥s a importa√ß√£o bem-sucedida. O SIGAP n√£o se responsabiliza pelo manuseio dos dados fora de sua plataforma, mas orienta todos os usu√°rios a seguirem as melhores pr√°ticas de seguran√ßa para proteger a privacidade dos assistidos.</p>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button id="close-policy-modal-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Manual do Utilizador -->
    <div id="manual-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 80vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Manual do Utilizador</h2>
                <button id="close-manual-modal-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="text-gray-700 space-y-4 overflow-y-auto pr-2">
                <p><strong>Bem-vindo ao SIGAP!</strong></p>
                <p>Este sistema foi desenvolvido para facilitar a gest√£o de pautas de atendimento jur√≠dico.</p>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>Criar Pauta:</strong> Use o bot√£o verde na tela inicial para come√ßar.</li>
                    <li><strong>Importar Dados:</strong> Voc√™ pode carregar arquivos CSV para agilizar o preenchimento.</li>
                    <li><strong>Gest√£o de Status:</strong> Mova os assistidos entre "Pauta", "Aguardando" e "Atendido".</li>
                    <li><strong>Delega√ß√£o:</strong> Use a coluna "Em Atendimento" para enviar links de finaliza√ß√£o por e-mail.</li>
                    <li><strong>Privacidade:</strong> O sistema limpa dados sens√≠veis periodicamente para sua seguran√ßa.</li>
                </ul>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button id="close-manual-modal-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Termos de Uso -->
    <div id="terms-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 80vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Termos de Uso</h2>
                <button id="close-terms-modal-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div class="text-gray-700 space-y-4 overflow-y-auto pr-2">
                <p><strong>1. Uso do Sistema</strong></p>
                <p>O SIGAP √© uma ferramenta de apoio √† gest√£o. O usu√°rio √© respons√°vel pela veracidade dos dados inseridos.</p>
                <p><strong>2. Seguran√ßa</strong></p>
                <p>O acesso √© pessoal e intransfer√≠vel. N√£o compartilhe sua senha de acesso.</p>
                <p><strong>3. Dados Sens√≠veis</strong></p>
                <p>O usu√°rio compromete-se a utilizar os dados dos assistidos apenas para fins profissionais, respeitando o sigilo funcional.</p>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button id="close-terms-modal-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Fechar</button>
            </div>
        </div>
    </div>

    <!-- ***** IN√çCIO DO HTML DO MODAL DE DETALHES ***** -->
    <div id="documents-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">
                    Detalhes para <span id="documents-assisted-name" class="text-green-600"></span>
                </h2>
                <button id="close-documents-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div id="document-action-selection" class="flex-grow overflow-y-auto scrollable-content pr-2">
                <!-- O conte√∫do ser√° inserido aqui pelo detalhes.js -->
            </div>

            <div id="document-checklist-view" class="hidden flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <button id="back-to-action-selection-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                        <h3 id="checklist-title" class="text-xl font-bold text-gray-800"></h3>
                    </div>
                    <div class="flex space-x-4">
                        <button id="cancel-checklist-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                        <button id="print-checklist-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">PDF</button>
                        <button id="save-checklist-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </div>
                 <div class="mb-4 flex-shrink-0">
                    <input type="search" id="checklist-search" placeholder="Pesquisar documento..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                </div>
                <div id="checklist-container" class="space-y-4 overflow-y-auto pr-2 flex-grow border rounded-lg p-4 bg-gray-50" style="max-height: 55vh;">
                </div>
            </div>
        </div>
    </div>
    <div id="address-editor-container" class="mt-8 p-4 bg-gray-50 rounded-lg border hidden">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Endere√ßo da Parte Contr√°ria (R√©u)</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-1">
            <label for="cep-reu" class="block text-sm font-medium text-gray-700">CEP</label>
            <input type="text" id="cep-reu" placeholder="Digite o CEP" maxlength="9" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
        </div>
        <div class="md:col-span-2">
            <label for="rua-reu" class="block text-sm font-medium text-gray-700">Rua/Avenida</label>
            <input type="text" id="rua-reu" placeholder="Rua ser√° preenchida" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
        </div>
        <div class="md:col-span-1">
            <label for="numero-reu" class="block text-sm font-medium text-gray-700">N√∫mero</label>
            <input type="text" id="numero-reu" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
        </div>
        <div class="md:col-span-1">
            <label for="bairro-reu" class="block text-sm font-medium text-gray-700">Bairro</label>
            <input type="text" id="bairro-reu" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
        </div>
        <div class="md:col-span-1">
            <label for="cidade-reu" class="block text-sm font-medium text-gray-700">Cidade/UF</label>
            <div class="flex gap-2">
                <input type="text" id="cidade-reu" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                <input type="text" id="estado-reu" maxlength="2" class="mt-1 block w-1/3 p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
            </div>
        </div>
    </div>
</div>
    <!-- ***** FIM DO HTML DO MODAL DE DETALHES ***** -->
    
 <!-- Modal de Estat√≠sticas (Container) -->
    <div id="statistics-modal" class="hidden z-50">
        <!-- O conte√∫do, incluindo cabe√ßalho e bot√µes, ser√° gerado dinamicamente pelo script 'estatisticas.js' -->
    </div>
    

    <script type="module">

        // imports
        import { firebaseConfig, emailJsConfig } from './js/config.js';
        import { escapeHTML, showNotification, formatTime, normalizeText, copyToClipboard } from './js/utils.js';
        import { subjectTree, flatSubjects } from './js/assuntos.js';
        import { getChecklistHTML } from './js/checklist.js';
        import { setupDetailsModal, openDetailsModal } from './detalhes.js';
        import { parsePautaCSV } from './js/csvHandler.js';
        import { generateAtendidosPDF, generateCollaboratorsPDF } from './js/pdfService.js';
        import { sendDelegationEmail, sendNotesByEmail } from './js/emailService.js';
        import { logAction, loadUsersList, cleanupOldData } from './js/admin.js';
        import { setupAttendancesListener } from './js/pauta.js';
        import { setupCollaboratorsListener, saveCollaboratorData, deleteCollaborator, clearCollaborators } from './js/colaboradores.js';



        // Ponte para o sistema de Auditoria (M√≥dulo js/admin.js)
       // const logAction = (type, details, targetId = null) => {
            // Chama a fun√ß√£o exportada do admin.js passando as vari√°veis globais do index
       //     import('./js/admin.js').then(m => {
       //         m.logAction(db, auth, currentUserName, currentPautaId, type, details, targetId);
      //      });
      //    };


        
        // Inicializa√ß√£o do EmailJS usando o novo arquivo de config
        emailjs.init(emailJsConfig.publicKey);
        // --- L√ìGICA DO PAINEL DE ADMIN ---

        // Painel do Administrador (Modularizado)
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        if (adminPanelBtn) {
            adminPanelBtn.onclick = () => {
                document.getElementById('admin-modal').classList.remove('hidden');
                loadUsersList(db); // Fun√ß√£o do admin.js
            };
        }
        
        // Limpeza LGPD
        const btnCleanup = document.getElementById('cleanup-old-data-btn');
        if (btnCleanup) {
            btnCleanup.onclick = () => cleanupOldData(db); // Fun√ß√£o do admin.js
        }
        
        // Expondo fun√ß√µes globais necess√°rias para os bot√µes do Admin
        window.approveUserWithRole = async (id) => {
            const roleSelect = document.getElementById(`role-select-${id}`);
            const selectedRole = roleSelect.value;
            await updateDoc(doc(db, "users", id), { status: 'approved', role: selectedRole });
            showNotification("Usu√°rio aprovado!");
            loadUsersList(db);
        };
        
        window.deleteUser = async (id) => {
            if(confirm("Deseja excluir permanentemente?")) {
                await deleteDoc(doc(db, "users", id));
                showNotification("Usu√°rio removido.", "error");
                loadUsersList(db);
            }
        };
        
        const adminModal = document.getElementById('admin-modal');
        
        // 1. Mostrar o bot√£o apenas se for Admin
        const checkAdminStatus = (userData) => {
            if (userData.role === 'admin' || userData.role === 'superadmin') {
                adminPanelBtn.classList.remove('hidden');
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            // ... outros c√≥digos de inicializa√ß√£o que voc√™ j√° tem ...
        
        });
        const logsContainer = document.getElementById('audit-logs-container');
        const logsTableBody = document.getElementById('audit-logs-table-body');
        const noLogsMsg = document.getElementById('no-logs-msg');
        
        
        // Importando as fun√ß√µes do novo m√≥dulo de detalhes
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        //import { setupDetailsModal, openDetailsModal } from './detalhes.js';
        import { renderStatisticsModal } from './estatisticas.js'
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, orderBy, limit, getDoc, serverTimestamp, writeBatch, arrayUnion, arrayRemove, setDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    

        // Vari√°veis Globais
        let db, auth, allAssisted = [], currentPautaId = null, unsubscribeFromAttendances = () => {}, currentUserName = '', currentPautaOwnerId = null, isPautaClosed = false;
        let currentPautaData = null; // Para armazenar todos os dados da pauta atual
        let assistedIdToHandle = null;
        let assistedNameToHandle = null; // Adicionado para passar o nome para o modal de sele√ß√£o de colaborador
        
        let customRoomsList = []; // Array para guardar os nomes das salas

        // Vari√°veis para o novo modal de delega√ß√£o de e-mail
        let assistedIdForDelegation = null;
        let assistedNameForDelegation = null;
        let collaboratorNameForDelegation = null; // Nome do colaborador j√° atribu√≠do ao assistido, se houver.

        // Vari√°veis para a l√≥gica de Colaboradores (lista de presen√ßa)
        let colaboradores = []; // Esta √© a lista de colaboradores (da lista de presen√ßa)
        let editCollaboratorId = null; // ID do colaborador sendo editado na lista de presen√ßa
        let unsubscribeFromCollaborators = () => {};

        
        // --- L√ìGICA DE MOVIMENTA√á√ÉO MANUAL (Setas e Topo) ---
        // Definimos no objeto 'window' para que o HTML consiga enxergar a fun√ß√£o
        window.moveInQueue = async (id, direction) => {
            if (isPautaClosed) {
                showNotification("A pauta est√° fechada.", "error");
                return;
            }
        
            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
            
            // 1. Pegamos a lista atual de quem est√° aguardando, j√° ordenada corretamente
            let list = allAssisted
                .filter(a => a.status === 'aguardando' && a.type === currentMode)
                .sort((a, b) => {
                    if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                    if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;
                    const orderA = a.manualIndex !== undefined ? a.manualIndex : (a.createdAt || 0);
                    const orderB = b.manualIndex !== undefined ? b.manualIndex : (b.createdAt || 0);
                    return orderA - orderB;
                });
        
            const currentIndex = list.findIndex(item => item.id === id);
            if (currentIndex === -1) return;
        
            // 2. Criamos uma c√≥pia para manipular
            let newList = [...list];
        
            if (direction === 'up' && currentIndex > 0) {
                // Troca com o de cima
                [newList[currentIndex - 1], newList[currentIndex]] = [newList[currentIndex], newList[currentIndex - 1]];
            } else if (direction === 'down' && currentIndex < newList.length - 1) {
                // Troca com o de baixo
                [newList[currentIndex], newList[currentIndex + 1]] = [newList[currentIndex + 1], newList[currentIndex]];
            } else if (direction === 'top') {
                // Remove da posi√ß√£o atual e coloca no √≠ndice 0
                const [movedItem] = newList.splice(currentIndex, 1);
                newList.unshift(movedItem);
            }
        
            // 3. Salvamos a nova ordem no Firebase usando Batch (Lote)
            const batch = writeBatch(db); // writeBatch deve estar importado do firestore
            newList.forEach((item, index) => {
                const docRef = doc(db, "pautas", currentPautaId, "attendances", item.id);
                batch.update(docRef, { 
                    manualIndex: index,
                    lastActionBy: currentUserName,
                    lastActionTimestamp: new Date().toISOString()
                });
            });
        
            try {
                await batch.commit();
                // O onSnapshot cuidar√° de atualizar a tela automaticamente
            } catch (error) {
                console.error("Erro ao reordenar fila:", error);
                showNotification("Erro ao atualizar ordem.", "error");
            }
        };

        
        const loadingContainer = document.getElementById('loading-container');
        const loginContainer = document.getElementById('login-container');
        const pautaSelectionContainer = document.getElementById('pauta-selection-container');
        const appContainer = document.getElementById('app-container');
        const loadingText = document.getElementById('loading-text');
        
        // FUN√á√ÉO DE PESQUISA MELHORADA
       const searchFilter = (assisted, term) => {
            if (!term) return true;
            
            // Formata a data de chegada para HH:MM para permitir a pesquisa
            const arrivalTimeFormatted = assisted.arrivalTime ? new Date(assisted.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
        
            const normalizedTerm = normalizeText(term);
        
            // Converte o campo attendant para string, caso seja um objeto com nome.
            // O campo attendant pode ser uma string (padr√£o) ou, em fluxos complexos, um objeto.
            const attendantName = (typeof assisted.attendant === 'object' && assisted.attendant !== null) 
                                  ? assisted.attendant.name || assisted.attendant.nome || '' 
                                  : assisted.attendant || '';
        
            return normalizeText(assisted.name).includes(normalizedTerm) ||
                   (assisted.cpf && normalizeText(assisted.cpf).includes(normalizedTerm)) ||
                   normalizeText(assisted.subject).includes(normalizedTerm) ||
                   (assisted.scheduledTime && assisted.scheduledTime.includes(normalizedTerm)) ||
                   (arrivalTimeFormatted && arrivalTimeFormatted.includes(normalizedTerm)) ||
                   // NOVO: Usa a vari√°vel attendantName (que garante que o campo √© string)
                   (attendantName && normalizeText(attendantName).includes(normalizedTerm)) ||
                   // Campo Colaborador Atribu√≠do
                   (assisted.assignedCollaborator?.name && normalizeText(assisted.assignedCollaborator.name).includes(normalizedTerm));
        };

        const getPriorityClass = (priority) => ({'URGENTE':'priority-urgente','M√°xima':'priority-maxima','M√©dia':'priority-media','M√≠nima':'priority-minima'}[priority]||'');

        const getUpdatePayload = (data) => {
            return {
                ...data,
                lastActionBy: currentUserName,
                lastActionTimestamp: new Date().toISOString()
            };
        };



        // --- COLOQUE ESTA FUN√á√ÉO NO ESCOPO GLOBAL DO SEU SCRIPT ---
     let sortableAguardando = null;
        
     const setupManualSort = () => {
        const el = document.getElementById('aguardando-list');
        const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
    
        if (pautaOrder === 'manual' && !isPautaClosed) {
            if (sortableAguardando) sortableAguardando.destroy();
    
            sortableAguardando = new Sortable(el, {
                animation: 300, // Movimento mais lento e fluido
                ghostClass: 'opacity-20', // Card fantasma quase transparente
                chosenClass: 'ring-2', // Borda azul ao segurar
                dragClass: 'scale-95', // Diminui o card enquanto arrasta
                handle: '.relative', // Permite arrastar clicando em qualquer lugar do card...
                filter: 'button, svg, p, span', // ...mas ignora se o clique for nos textos ou bot√µes
                preventOnFilter: false,
                
                onEnd: async function () {
                    const items = el.querySelectorAll('[data-id]');
                    const batch = writeBatch(db);
                    
                    items.forEach((item, index) => {
                        const docId = item.getAttribute('data-id');
                        const docRef = doc(db, "pautas", currentPautaId, "attendances", docId);
                        batch.update(docRef, { manualIndex: index });
                    });
    
                    try {
                        await batch.commit();
                        showNotification("Fila Reordenada!");
                    } catch (e) {
                        console.error(e);
                    }
                },
            });
        } else if (sortableAguardando) {
            sortableAguardando.destroy();
            sortableAguardando = null;
        }
    };

        

        
        const getPriorityLevel = (assisted) => {
            if (!assisted || assisted.status !== 'aguardando') return 'N/A';
            if (assisted.priority === 'URGENTE') return 'URGENTE';

            if (assisted.type === 'avulso') return 'M√©dia';

            if (!assisted.scheduledTime || !assisted.arrivalTime) return 'M√©dia';

            const scheduled = new Date(`1970-01-01T${assisted.scheduledTime}`);
            const arrival = new Date(assisted.arrivalTime);
            const arrivalTime = new Date(`1970-01-01T${arrival.toTimeString().slice(0, 5)}`);

            const diffMinutes = (arrivalTime - scheduled) / (1000 * 60);

            if (diffMinutes <= 0) return 'M√°xima';
            if (diffMinutes <= 20) return 'M√©dia';
            return 'M√≠nima';
        };
            /**
             * Garante a formata√ß√£o segura de strings de data ISO ou Timestamp.
             * No fluxo de delega√ß√£o, attendedTime pode ser uma string ISO ou um objeto Timestamp.
             * @param {string | object} timeStamp - A string de data (ISO) ou objeto Timestamp do Firebase.
             * @returns {string} O hor√°rio formatado (HH:mm) ou 'N/A'.
             */
        const togglePautaLock = (isClosed) => {
            const isOwner = auth.currentUser?.uid === currentPautaOwnerId;
            isPautaClosed = isClosed;

            const buttonsToDisable = [
                'form-agendamento', 'file-upload', 'add-assisted-btn',
                'download-pdf-btn', 'toggle-faltosos-btn', 'tab-avulso', 'tab-agendamento'
            ];

            buttonsToDisable.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (isClosed) {
                        element.classList.add('pointer-events-none', 'opacity-50');
                        element.querySelectorAll('input, button, a, textarea').forEach(el => el.disabled = true);
                    } else {
                        element.classList.remove('pointer-events-none', 'opacity-50');
                        element.querySelectorAll('input, button, a, textarea').forEach(el => el.disabled = false);
                    }
                }
            });

            // Trecho corrigido na fun√ß√£o togglePautaLock:

            // Dentro da fun√ß√£o togglePautaLock, ap√≥s o bloco buttonsToDisable:

            const actionPanelButtons = document.querySelectorAll('#actions-panel button');
            
            actionPanelButtons.forEach(btn => {
                if (btn.id === 'reopen-pauta-btn') {
                    // Se a pauta est√° fechada, o REABRIR √© o √∫nico que deve estar ativo
                    btn.disabled = false;
                } else {
                    // Todos os outros bot√µes do menu A√ß√µes (Zerar, Fechar, Editar) ficam desativados
                    btn.disabled = isClosed; 
                }
            });
            const actionButtons = document.querySelectorAll('.check-in-btn, .delegate-finalization-btn, .attend-directly-btn, .faltou-btn, .return-to-pauta-btn, .delete-btn, .priority-btn, .edit-assisted-btn, .edit-attendant-btn, .return-to-aguardando-btn, .manage-demands-btn, .toggle-confirmed-atendido, .toggle-confirmed-faltoso'); // Adicionado
            actionButtons.forEach(btn => {
                btn.disabled = isClosed;
            });

            if (isClosed) {
                document.getElementById('closed-pauta-alert').classList.remove('hidden');
                document.getElementById('close-pauta-btn').classList.add('hidden');
                document.getElementById('reopen-pauta-btn').classList.remove('hidden');
            } else {
                document.getElementById('closed-pauta-alert').classList.add('hidden');
                document.getElementById('close-pauta-btn').classList.remove('hidden');
                document.getElementById('reopen-pauta-btn').classList.add('hidden');
            }

            if (!isOwner) {
                document.getElementById('close-pauta-btn').classList.add('hidden');
                document.getElementById('reopen-pauta-btn').classList.add('hidden');
            }
        };

      const createAguardandoCard = (a, index) => {
        const card = document.createElement('div');
        // Adicionado 'group' para controlar o aparecimento dos bot√µes e 'transition-all'
        card.className = `relative bg-white p-4 rounded-lg shadow-sm ${getPriorityClass(a.priority)} mb-2 group transition-all duration-200`;
        card.setAttribute('data-id', a.id);
    
        const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
        const isManual = pautaOrder === 'manual' && !isPautaClosed;
    
        // Indicador de Posi√ß√£o (Rank) e Bot√µes de Comando
        const rankAndControls = isManual ? `
            <!-- Indicador de Rank -->
            <div class="absolute -top-2 -left-2 bg-blue-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md z-20 border-2 border-white">
                ${index + 1}¬∫
            </div>
            
            <!-- Bot√µes de Movimenta√ß√£o Lateral (Aparecem no Hover) -->
            <div class="absolute -left-4 top-1/2 -translate-y-1/2 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:translate-x-1 z-30">
                <button onclick="moveInQueue('${a.id}', 'top')" title="Mover para o Topo" class="bg-white text-blue-600 shadow-lg border border-blue-100 rounded-full p-1.5 hover:bg-blue-600 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 11l7-7 7 7M5 19l7-7 7 7" /></svg>
                </button>
                <button onclick="moveInQueue('${a.id}', 'up')" title="Subir uma posi√ß√£o" class="bg-white text-gray-700 shadow-lg border border-gray-100 rounded-full p-1.5 hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 15l7-7 7 7" /></svg>
                </button>
                <button onclick="moveInQueue('${a.id}', 'down')" title="Descer uma posi√ß√£o" class="bg-white text-gray-700 shadow-lg border border-gray-100 rounded-full p-1.5 hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
        ` : '';
    
        const arrival = a.type === 'agendamento' && a.scheduledTime 
            ? `Agendado: ${escapeHTML(a.scheduledTime)} | Chegou: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` 
            : `Chegada: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
    
        // APLICA√á√ÉO DE SEGURAN√áA: escapeHTML
        let atenderButton = currentPautaData?.useDelegationFlow
            ? `<button data-id="${a.id}" data-name="${escapeHTML(a.name)}" class="select-collaborator-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>`
            : `<button data-id="${a.id}" data-name="${escapeHTML(a.name)}" class="attend-directly-from-aguardando-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>`;
    
        card.innerHTML = `
            ${rankAndControls}
            <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-300 hover:text-red-600 p-1 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
            <div class="flex flex-col h-full ${isManual ? 'pl-3' : ''}">
                <p class="font-bold text-lg text-gray-800 leading-tight mb-1">${escapeHTML(a.name)}</p>
                <p class="text-xs text-gray-600 mb-2">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                <div class="flex flex-wrap gap-2 mb-3">
                    <span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded font-medium">${arrival}</span>
                    ${a.room ? `<span class="bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold border border-blue-100">${escapeHTML(a.room)}</span>` : ''}
                </div>
                <div class="mt-auto grid grid-cols-2 gap-2">
                    ${atenderButton}
                    <button data-id="${a.id}" class="priority-btn ${a.priority === 'URGENTE' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-red-500 hover:bg-red-600'} text-white font-semibold py-2 rounded-lg text-xs transition-colors">
                        ${a.priority === 'URGENTE' ? 'Urgente Ativado' : 'Prioridade'}
                    </button>
                </div>
                <button data-id="${a.id}" class="view-details-btn text-indigo-500 hover:text-indigo-700 text-[11px] font-bold mt-2 text-center underline">Ver Detalhes</button>
            </div>
        `;
        return card;
    };

        // --- FUN√á√ÉO PARA RENOMEAR SALA ---
        const renamePautaRoom = async (oldName, newName) => {
            if (!currentPautaId || !oldName || !newName || oldName === newName) return;

            // 1. Atualizar a lista de salas no documento da Pauta
            const pautaRef = doc(db, "pautas", currentPautaId);
            const pautaSnap = await getDoc(pautaRef);
            
            if (!pautaSnap.exists()) return;

            const pautaData = pautaSnap.data();
            let updatedRooms = pautaData.rooms || [];
            
            // Verifica se o novo nome j√° existe (para evitar duplicatas)
            if (updatedRooms.includes(newName)) {
                showNotification("J√° existe uma sala com esse nome.", "error");
                return;
            }

            // Substitui o nome antigo pelo novo mantendo a posi√ß√£o
            const roomIndex = updatedRooms.indexOf(oldName);
            if (roomIndex !== -1) {
                updatedRooms[roomIndex] = newName;
            }

            try {
                // Inicia um Batch (lote) para fazer tudo de uma vez
                const batch = writeBatch(db);

                // A. Atualiza a lista de salas na pauta
                batch.update(pautaRef, { rooms: updatedRooms });

                // B. Busca todos os assistidos que est√£o na sala antiga
                const attendancesRef = collection(db, "pautas", currentPautaId, "attendances");
                const q = query(attendancesRef, where("room", "==", oldName));
                const querySnapshot = await getDocs(q);

                // C. Atualiza cada assistido para a sala nova
                querySnapshot.forEach((docSnap) => {
                    batch.update(docSnap.ref, { 
                        room: newName,
                        lastActionBy: currentUserName,
                        lastActionTimestamp: new Date().toISOString()
                    });
                });

                await batch.commit();
                showNotification(`Sala renomeada para "${newName}" com sucesso!`);
            } catch (error) {
                console.error("Erro ao renomear sala:", error);
                showNotification("Erro ao renomear a sala.", "error");
            }
        };

        const renderAssistedList = () => {
            allAssisted.forEach(a => {
                if (a.status === 'aguardando' && a.priority !== 'URGENTE') {
                    a.priority = getPriorityLevel(a);
                }
            });

            const pautaList = document.getElementById('pauta-list');
            const aguardandoList = document.getElementById('aguardando-list');
            const emAtendimentoList = document.getElementById('em-atendimento-list');
            const atendidosList = document.getElementById('atendidos-list');
            const faltososList = document.getElementById('faltosos-list');
            [pautaList, aguardandoList, emAtendimentoList, atendidosList, faltososList].forEach(el => el.innerHTML = '');

            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';

            const pautaSearchTerm = normalizeText(document.getElementById('pauta-search').value);
            const aguardandoSearchTerm = normalizeText(document.getElementById('aguardando-search').value);
            const emAtendimentoSearchTerm = normalizeText(document.getElementById('em-atendimento-search').value);
            const atendidosSearchTerm = normalizeText(document.getElementById('atendidos-search').value);
            const faltososSearchTerm = normalizeText(document.getElementById('faltosos-search').value);

            const pauta = allAssisted.filter(a => a.status === 'pauta' && a.type === 'agendamento' && searchFilter(a, pautaSearchTerm));
            const aguardando = allAssisted.filter(a => a.status === 'aguardando' && a.type === currentMode && searchFilter(a, aguardandoSearchTerm));
            const emAtendimento = allAssisted.filter(a => a.status === 'emAtendimento' && a.type === currentMode && searchFilter(a, emAtendimentoSearchTerm));
            const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === currentMode && searchFilter(a, atendidosSearchTerm));
            const faltosos = allAssisted.filter(a => a.status === 'faltoso' && a.type === 'agendamento' && searchFilter(a, faltososSearchTerm));

            pauta.sort((a, b) => (a.scheduledTime || '23:59').localeCompare(b.scheduledTime || '23:59'));
            atendidos.sort((a, b) => new Date(b.attendedTime) - new Date(a.attendedTime));
            faltosos.sort((a, b) => (a.scheduledTime || '00:00').localeCompare(b.scheduledTime || '00:00'));

      // Ordena√ß√£o da coluna Aguardando
            aguardando.sort((a, b) => {
                const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
            
                // Se for Manual, prioriza o √≠ndice que definimos arrastando
                if (pautaOrder === 'manual') {
                    // Casos URGENTES continuam sempre no topo, mesmo no manual (opcional)
                    if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                    if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;
            
                    // Se ambos forem urgentes ou ambos comuns, usa o √≠ndice manual
                    const indexA = a.manualIndex !== undefined ? a.manualIndex : 999;
                    const indexB = b.manualIndex !== undefined ? b.manualIndex : 999;
                    return indexA - indexB;
                }         
                
                if (pautaOrder === 'chegada') {
                    const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                    const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                    if (arrivalA !== arrivalB) return arrivalA - arrivalB;
                    return (a.createdAt || 0) - (b.createdAt || 0);
                } else { // 'padrao'
                    const order = { 'M√°xima': 1, 'M√©dia': 2, 'M√≠nima': 3 };
                    const priorityDiff = order[a.priority] - order[b.priority];
                    if (priorityDiff !== 0) return priorityDiff;

                    if (a.priority === 'M√°xima' && a.type === 'agendamento') {
                        const scheduledA = a.scheduledTime || '23:59';
                        const scheduledB = b.scheduledTime || '23:59';
                        if (scheduledA.localeCompare(scheduledB) !== 0) return scheduledA.localeCompare(scheduledB);
                    }

                    const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                    const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                    if (arrivalA !== arrivalB) return arrivalA - arrivalB;

                    return (a.createdAt || 0) - (b.createdAt || 0);
                }
            });
            // Ordena√ß√£o para "Em Atendimento" - mais recente primeiro, ou por colaborador
            emAtendimento.sort((a, b) => new Date(b.inAttendanceTime) - new Date(a.inAttendanceTime));


            document.getElementById('pauta-count').textContent = pauta.length;
            document.getElementById('aguardando-count').textContent = aguardando.length;
            document.getElementById('em-atendimento-count').textContent = emAtendimento.length;
            document.getElementById('faltosos-count').textContent = faltosos.length;
            document.getElementById('atendidos-count').textContent = atendidos.length;

            const render = (el, data, generator) => {
                // Ajustado o espa√ßamento entre os cards
                if(data.length === 0) el.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
                else data.forEach((item, index) => el.appendChild(generator(item, index)));
            };

            render(pautaList, pauta, a => {
                const card = document.createElement('div');
                card.className = 'relative bg-gray-50 p-4 rounded-lg shadow-sm border';
                // USO DO escapeHTML AQUI:
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <p class="font-bold text-lg">${escapeHTML(a.name)}</p>
                    ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                    <p>Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                    <p>Agendado: <strong>${a.scheduledTime}</strong></p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <button data-id="${a.id}" class="check-in-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Marcar Chegada</button>
                        <button data-id="${a.id}" class="faltou-btn bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600">Faltou</button>
                        <button data-id="${a.id}" class="edit-assisted-btn col-span-2 bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600">Editar Dados</button>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });

            // --- L√ìGICA NOVA PARA RENDERIZAR AGUARDANDO (MULTI-SALA) ---
            aguardandoList.innerHTML = ''; // Limpa a lista

            // Verifica se √© multisala e se temos salas definidas
            if (currentPautaData?.type === 'multisala' && currentPautaData.rooms && currentPautaData.rooms.length > 0) {
                
                // Para cada sala, cria uma se√ß√£o
                currentPautaData.rooms.forEach(roomName => {
                    // Filtra pessoas desta sala
                    const peopleInRoom = aguardando.filter(a => a.room === roomName);
                    
                    // Cria cabe√ßalho da sala (COM BOT√ÉO DE EDITAR)
                    const roomHeader = document.createElement('div');
                    roomHeader.className = "bg-blue-100 text-blue-800 font-bold px-3 py-2 rounded-md mt-4 mb-2 text-sm uppercase flex justify-between items-center group";
                    
                    roomHeader.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>üè¢ ${escapeHTML(roomName)}</span>
                            <button class="edit-room-name-btn text-blue-400 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity" data-room="${escapeHTML(roomName)}" title="Renomear Sala">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                        </div>
                        <span class="bg-white text-blue-800 px-2 rounded-full text-xs">${peopleInRoom.length}</span>
                    `;
                    aguardandoList.appendChild(roomHeader);

                    if (peopleInRoom.length === 0) {
                        const emptyMsg = document.createElement('div');
                        emptyMsg.className = "text-gray-400 text-xs text-center italic mb-2";
                        emptyMsg.textContent = "Vazio";
                        aguardandoList.appendChild(emptyMsg);
                    } else {
                        peopleInRoom.forEach((item, index) => {
                            const card = createAguardandoCard(item, index);
                            aguardandoList.appendChild(card);
                        });
                    }
                });

                // Renderiza quem est√° "Aguardando" mas sem sala definida (fallback)
                const noRoom = aguardando.filter(a => !a.room);
                if (noRoom.length > 0) {
                    const header = document.createElement('div');
                    header.className = "bg-gray-200 text-gray-700 font-bold px-3 py-2 rounded-md mt-4 mb-2 text-sm uppercase";
                    header.textContent = "‚ö†Ô∏è Sem Sala Definida";
                    aguardandoList.appendChild(header);
                    noRoom.forEach((item, index) => aguardandoList.appendChild(createAguardandoCard(item, index)));
                }

            } else {
                // --- COMPORTAMENTO PADR√ÉO (C√ìDIGO ORIGINAL) ---
                if(aguardando.length === 0) aguardandoList.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
                else aguardando.forEach((item, index) => aguardandoList.appendChild(createAguardandoCard(item, index)));
            }
            
            // Renderizar a nova coluna "Em Atendimento"
            render(emAtendimentoList, emAtendimento, (a, index) => {
                const card = document.createElement('div');
                card.className = `relative bg-purple-50 p-4 rounded-lg shadow-sm border-purple-200`;
                const inAttendanceTime = new Date(a.inAttendanceTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                // Note o escapeHTML aqui tamb√©m
                const assignedCollabText = a.assignedCollaborator?.name ? `Colaborador: <strong>${escapeHTML(a.assignedCollaborator.name)}</strong>` : 'Colaborador: N√£o atribu√≠do';
                
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <p class="font-bold text-lg">${index + 1}. ${escapeHTML(a.name)}</p>
                    ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                    <p class="text-sm">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                    <p class="text-sm">${assignedCollabText}</p>
                    <p class="text-sm text-gray-500">In√≠cio: ${inAttendanceTime}</p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <button data-id="${a.id}" data-name="${escapeHTML(a.name)}" data-collaborator-name="${escapeHTML(a.assignedCollaborator?.name || 'N√£o informado')}" data-collaborator-id="${a.assignedCollaborator?.id || ''}" class="delegate-finalization-btn bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-600">Delegar Finaliza√ß√£o</button>
                        <button data-id="${a.id}" data-name="${escapeHTML(a.name)}" data-collaborator-name="${escapeHTML(a.assignedCollaborator?.name || 'N√£o informado')}" class="attend-directly-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Finalizar Diretamente</button>
                        <button data-id="${a.id}" class="return-to-aguardando-from-emAtendimento-btn col-span-2 bg-gray-400 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-500">Voltar p/ Aguardando</button>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });
render(atendidosList, atendidos, a => {
                const card = document.createElement('div');
                const confirmedBtnBgClass = a.isConfirmed ? 'bg-green-500' : 'bg-gray-400';
                const confirmedBtnHoverClass = a.isConfirmed ? 'hover:bg-green-600' : 'hover:bg-gray-500';
                const confirmationInfo = a.isConfirmed && a.confirmationDetails ? 
                    `<span class="text-xs opacity-75 block">Por: ${escapeHTML(a.confirmationDetails.confirmedBy)} em ${new Date(a.confirmationDetails.confirmedAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'})}</span>` : '';

                card.className = 'relative bg-green-50 p-4 rounded-lg shadow-sm border-green-200';
                const totalAssuntos = 1 + (a.demandas?.quantidade ? Number(a.demandas.quantidade) : 0);
                
                // Sanitiza√ß√£o das Demandas Adicionais
                const demandasInfo = a.demandas?.descricoes?.length > 0 ? 
                    `<div class="mt-2 text-xs bg-gray-100 p-2 rounded"><strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong><ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${escapeHTML(d)}</li>`).join('')}</ul></div>` : '';
                
                // Sanitiza√ß√£o do nome do atendente
                let attendantNameDisplay = 'N√£o informado';
                if (a.attendant) {
                    if (typeof a.attendant === 'object' && a.attendant !== null) {
                        attendantNameDisplay = a.attendant.nome || a.attendant.name || 'Sem nome';
                    } else {
                        attendantNameDisplay = a.attendant;
                    }
                }
                attendantNameDisplay = escapeHTML(attendantNameDisplay);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <p class="font-bold text-lg inline-flex items-center">
                            ${escapeHTML(a.name)} ${totalAssuntos > 1 ? `<span class="text-sm font-medium text-green-600 ml-1">(${totalAssuntos} assuntos)</span>` : ''}
                        </p>
                        <button data-id="${a.id}" class="toggle-confirmed-atendido confirm-btn-style ${confirmedBtnBgClass} ${confirmedBtnHoverClass} text-white">
                            <svg class="confirm-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01.105L7.882 12.5a.733.733 0 0 1-1.065.04L3.257 8.375a.733.733 0 0 1 1.064-.04l2.254 2.255Z"/></svg>
                        </button>
                    </div>
                    <div class="card-details mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                        <p class="text-sm">Assunto Principal: <strong>${escapeHTML(a.subject)}</strong></p>
                        <div class="text-xs text-gray-600 grid grid-cols-3 gap-2 text-center border-y py-2">
                            <div><strong>Agendado:</strong><br>${a.scheduledTime || 'N/A'}</div>
                            <div><strong>Chegou:</strong><br>${a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                            <div><strong>Finalizado:</strong><br>${formatTime(a.attendedTime)}</div>
                        </div>
                        ${demandasInfo}
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm">Por: <strong>${attendantNameDisplay}</strong></p>
                            <div class="flex items-center gap-1 flex-wrap">
                                <button data-id="${a.id}" class="manage-demands-btn text-blue-600 hover:text-blue-800 font-semibold text-xs py-1 px-2 rounded hover:bg-blue-100">Demandas</button>
                                <button data-id="${a.id}" class="edit-assisted-btn text-gray-600 hover:text-gray-800 font-semibold text-xs py-1 px-2 rounded hover:bg-gray-100">Dados</button>
                                <button data-id="${a.id}" class="edit-attendant-btn text-green-600 hover:text-green-800 font-semibold text-xs py-1 px-2 rounded hover:bg-green-100">Atendente</button>
                                <button data-id="${a.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold text-xs py-1 px-2 rounded hover:bg-red-100">Deletar</button>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t flex justify-between items-center">
                            ${a.lastActionBy ? `<p class="text-xs text-gray-500">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></p>` : '<div></div>'}
                            <button data-id="${a.id}" data-assigned-collaborator='${JSON.stringify(a.assignedCollaborator || null)}' class="return-from-atendido-btn ${currentPautaData?.useDelegationFlow ? 'bg-orange-500 hover:bg-orange-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white font-semibold py-1 px-3 rounded-lg text-xs">
                                ${currentPautaData?.useDelegationFlow ? 'Voltar p/ Em Atendimento' : 'Voltar p/ Aguardando'}
                            </button>
                        </div>
                        ${confirmationInfo}
                    </div>
                    <div class="text-right mt-1">
                         <button class="toggle-details-btn text-gray-500 hover:text-gray-800 p-1">
                             <svg class="pointer-events-none" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                         </button>
                    </div>`;
                return card;
            });

            render(faltososList, faltosos, a => {
                const card = document.createElement('div');
                // ... (l√≥gica de confirma√ß√£o mant√©m igual) ...

                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg ...></svg></button>
                    <div class="flex items-center justify-between">
                        <p class="font-bold text-lg inline-flex items-center">
                            ${escapeHTML(a.name)}
                        </p>
                        <button data-id="${a.id}" class="toggle-confirmed-faltoso confirm-btn-style ${confirmedBtnBgClass} ${confirmedBtnHoverClass} text-white">
                            <svg class="confirm-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01.105L7.882 12.5a.733.733 0 0 1-1.065.04L3.257 8.375a.733.733 0 0 1 1.064-.04l2.254 2.255Z"/></svg>
                        </button>
                    </div>
                    <div class="mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${escapeHTML(a.cpf)}</strong></p>` : ''}
                        <p class="text-sm">Assunto: <strong>${escapeHTML(a.subject)}</strong></p>
                        <p class="text-sm">Agendado: <strong>${a.scheduledTime}</strong></p>
                        <div class="mt-3">
                            <button data-id="${a.id}" class="return-to-pauta-from-faltoso-btn w-full bg-gray-500 text-white font-semibold py-1 rounded-lg hover:bg-gray-600 text-xs">Revertido para Pauta</button>
                        </div>
                        ${confirmationInfo}
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${escapeHTML(a.lastActionBy)}</strong></div>` : ''}
                `;
                return card;
            });

            togglePautaLock(isPautaClosed);

            // ADICIONE ESTA LINHA AQUI:
            setupManualSort()
        };

        const setupRealtimeListener = (pautaId) => {
            if (unsubscribeFromAttendances) unsubscribeFromAttendances();
            const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
            unsubscribeFromAttendances = onSnapshot(attendanceCollectionRef, (snapshot) => {
                allAssisted = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssistedList();
            }, (error) => console.error("Erro no listener do Firestore: ", error));
        };

        // --- IN√çCIO DA L√ìGICA DE GERENCIAR MEMBROS DA PAUTA (COMPARTILHAR) ---
        const membersModal = document.getElementById('members-modal');
        const inviteEmailInput = document.getElementById('invite-email-input');
        const inviteMemberBtn = document.getElementById('invite-member-btn');
        const inviteStatus = document.getElementById('invite-status');
        const membersListContainer = document.getElementById('members-list-container'); // Onde os membros s√£o listados

        const showMembersModal = async () => {
            if (!currentPautaId) return;
            membersModal.classList.remove('hidden');
            inviteStatus.textContent = ''; // Limpar status de convite anterior

            const pautaRef = doc(db, "pautas", currentPautaId);
            const pautaSnap = await getDoc(pautaRef);
            if (pautaSnap.exists()) {
                const pautaData = pautaSnap.data();
                currentPautaOwnerId = pautaData.owner;
                membersListContainer.innerHTML = ''; // Limpar lista antes de popular

                if (pautaData.memberEmails && pautaData.memberEmails.length > 0) {
                    pautaData.memberEmails.forEach(email => {
                        const isOwner = pautaData.ownerEmail === email;
                        const memberEl = document.createElement('div');
                        memberEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                        memberEl.innerHTML = `
                            <span>${email} ${isOwner ? '<span class="text-xs text-yellow-600 font-bold">(dono)</span>' : ''}</span>
                            ${!isOwner ? `<button data-email="${email}" class="remove-member-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remover</button>` : ''}
                        `;
                        membersListContainer.appendChild(memberEl);
                    });
                } else {
                    membersListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum membro na pauta. Convide algu√©m!</p>';
                }
            }
        };

        inviteMemberBtn.addEventListener('click', async () => {
            const email = inviteEmailInput.value.trim().toLowerCase();
            if (!email) {
                inviteStatus.textContent = 'Por favor, insira um email.';
                return;
            }
            inviteStatus.textContent = 'Verificando...';

            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                inviteStatus.textContent = 'Usu√°rio n√£o encontrado em nosso sistema.';
                return;
            }
            
            const userDoc = querySnapshot.docs[0];
            const pautaRef = doc(db, "pautas", currentPautaId);

            try {
                await updateDoc(pautaRef, {
                    members: arrayUnion(userDoc.id),
                    memberEmails: arrayUnion(email)
                });
                inviteStatus.textContent = `Usu√°rio ${email} convidado com sucesso!`;
                inviteEmailInput.value = '';
                showMembersModal(); // Atualiza a lista no modal
            } catch (error) {
                console.error("Erro ao convidar membro:", error);
                inviteStatus.textContent = 'Erro ao convidar usu√°rio.';
            }
        });

        document.body.addEventListener('click', async (e) => { // Este listener j√° existe, vou apenas adicionar a parte de remover membro
            if (e.target.classList.contains('remove-member-btn')) {
                const email = e.target.dataset.email;
                if (confirm(`Tem certeza que deseja remover ${email} desta pauta?`)) {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userIdToRemove = querySnapshot.docs[0].id;
                        const pautaRef = doc(db, "pautas", currentPautaId);
                        try {
                            await updateDoc(pautaRef, {
                                members: arrayRemove(userIdToRemove),
                                memberEmails: arrayRemove(email)
                            });
                            showNotification(`Membro ${email} removido da pauta.`);
                            showMembersModal(); // Atualiza a lista no modal
                        } catch (error) {
                            console.error("Erro ao remover membro:", error);
                            showNotification("Erro ao remover membro.", "error");
                        }
                    }
                }
            }
        });
        // --- FIM DA L√ìGICA DE GERENCIAR MEMBROS DA PAUTA ---

        // =======================================================
        // LIGA√á√ÉO DE COLABORADORES (M√≥dulo js/colaboradores.js)
        // =======================================================
        
        // 1. Importa√ß√£o (Certifique-se de que est√° no topo do seu script)
        
        // 2. Fun√ß√£o para desenhar a tabela (Mantida aqui para acessar IDs do HTML)
        function renderColaboradores() {
            const tableBody = document.querySelector('#collaborators-list-table-modal tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
        
            let selfTransport = 0, companyTransport = 0;
        
            if (colaboradores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Nenhum colaborador.</td></tr>';
            } else {
                colaboradores.forEach((c) => {
                    if (c.transporte === 'Meios Pr√≥prios') selfTransport++;
                    if (c.transporte === 'Com a Empresa') companyTransport++;
        
                    const row = document.createElement('tr');
                    row.className = "bg-white border-b text-xs";
                    row.innerHTML = `
                        <td class="py-3 px-4 font-bold">${escapeHTML(c.nome)}</td>
                        <td class="py-3 px-4">${escapeHTML(c.cargo || 'N/A')}</td>
                        <td class="py-3 px-4">${escapeHTML(c.equipe || 'N/A')}</td>
                        <td class="py-3 px-4"><input type="checkbox" class="checkin-checkbox" data-id="${c.id}" ${c.presente ? 'checked' : ''}></td>
                        <td class="py-3 px-4">${c.horario || '--:--'}</td>
                        <td class="py-3 px-4">${escapeHTML(c.email || 'N/A')}</td>
                        <td class="py-3 px-4">${escapeHTML(c.transporte)}</td>
                        <td class="py-3 px-4"><a href="https://wa.me/55${c.telefone.replace(/\D/g, '')}" target="_blank" class="text-blue-600 underline">Zap</a></td>
                        <td class="py-3 px-4 flex gap-2">
                            <button class="edit-collab-btn text-blue-500" data-id="${c.id}">‚úèÔ∏è</button>
                            <button class="del-collab-btn text-red-500" data-id="${c.id}">üóëÔ∏è</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // Atualiza os contadores de estat√≠sticas
            document.getElementById('total-participants-count').textContent = colaboradores.length;
            document.getElementById('self-transport-count').textContent = selfTransport;
            document.getElementById('company-transport-count').textContent = companyTransport;
        }
        
        // 3. Listener do Formul√°rio (Salvar)
        const collabForm = document.getElementById('collaborator-form-modal');
        if (collabForm) {
            collabForm.onsubmit = async (e) => {
                e.preventDefault();
                const formData = {
                    nome: document.getElementById('collaborator-name-modal').value,
                    cargo: document.getElementById('collaborator-role-modal').value,
                    equipe: document.getElementById('collaborator-team-modal').value,
                    email: document.getElementById('collaborator-email-modal').value || null,
                    telefone: document.getElementById('collaborator-phone-modal').value,
                    transporte: document.querySelector('input[name="transporte-colaborador"]:checked').value,
                    localEncontro: document.querySelector('input[name="localEncontro-colaborador"]:checked')?.value || '',
                    observacao: document.getElementById('collaborator-obs-modal').value
                };
        
                await saveCollaboratorData(db, currentPautaId, formData, editCollaboratorId);
                showNotification("Equipe atualizada!");
                collabForm.reset();
                editCollaboratorId = null;
            };
        }

        // Fun√ß√£o para limpar o formul√°rio de colaboradores (Necess√°ria para o modal abrir limpo)
        const resetCollaboratorFormModal = () => {
            const form = document.getElementById('collaborator-form-modal');
            if (form) {
                form.reset();
                // Volta o r√°dio para o padr√£o
                const radioDefault = document.getElementById('transporte-nao-confirmado-modal');
                if (radioDefault) radioDefault.checked = true;
                
                // Esconde campos condicionais
                const localEncontro = document.getElementById('local-encontro-group-modal');
                const obs = document.getElementById('observacao-group-modal');
                if (localEncontro) localEncontro.classList.add('hidden');
                if (obs) obs.classList.add('hidden');
                
                // Reseta o ID de edi√ß√£o
                editCollaboratorId = null; 
                
                // Reseta o texto do bot√£o
                const btn = document.getElementById('add-collaborator-btn-modal');
                if (btn) btn.textContent = "Adicionar Colaborador";
            }
        };

        
        // 4. Delega√ß√£o de cliques (Presen√ßa e Excluir)
        document.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
        
            if (e.target.classList.contains('checkin-checkbox')) {
                await toggleCollaboratorPresence(db, currentPautaId, id, e.target.checked);
            }
            if (e.target.classList.contains('del-collab-btn')) {
                if (confirm("Remover colaborador?")) await deleteCollaborator(db, currentPautaId, id);
            }
            if (e.target.id === 'clear-collaborators-list-modal') {
                if (confirm("Limpar toda a lista?")) await clearCollaborators(db, currentPautaId);
            }
        });
        

        const loadPauta = async (pautaId, pautaName, pautaType) => {
            currentPautaId = pautaId;
            document.getElementById('pauta-title').textContent = pautaName;

            // Salva a pauta atual no localStorage
            localStorage.setItem('lastPautaId', pautaId);
            localStorage.setItem('lastPautaType', pautaType);

            const tabAgendamento = document.getElementById('tab-agendamento');
            const tabAvulso = document.getElementById('tab-avulso');
            const pautaColumn = document.getElementById('pauta-column');
            const emAtendimentoColumn = document.getElementById('em-atendimento-column');
            const mainContent = document.getElementById('main-content');

            const pautaDoc = await getDoc(doc(db, "pautas", pautaId));
            if (pautaDoc.exists()) {
                const pautaData = pautaDoc.data();

                const creationDate = pautaData.createdAt ? new Date(pautaData.createdAt) : new Date();
                const expirationDate = new Date(creationDate);
                expirationDate.setDate(creationDate.getDate() + 7);
                if (new Date() > expirationDate) {
                    showNotification("Pauta inacess√≠vel pois cumpriu seu prazo.", "error");
                    return;
                }

                currentPautaData = pautaData;
                currentPautaOwnerId = pautaData.owner;
                isPautaClosed = pautaData.isClosed || false;
                
                const ordem = currentPautaData.ordemAtendimento || 'padrao';
                document.getElementById('logic-explanation-padrao').classList.toggle('hidden', ordem !== 'padrao');
                document.getElementById('logic-explanation-chegada').classList.toggle('hidden', ordem !== 'chegada');
                document.getElementById('order-explanation-title').textContent = ordem === 'padrao' ? 'Entenda a Ordem de Atendimento Padr√£o' : 'Entenda a Ordem de Chegada';
                document.getElementById('toggle-logic-btn-padrao').addEventListener('click', (e) => {
                    const explanationDiv = document.getElementById('logic-explanation-padrao-content');
                    const isHidden = explanationDiv.classList.toggle('hidden');
                    e.target.textContent = isHidden ? 'Por que esta ordem √© justa? (Clique para expandir)' : 'Ocultar explica√ß√£o';
                });

                togglePautaLock(isPautaClosed);

                if (pautaData.owner === auth.currentUser.uid) {
                    document.getElementById('edit-pauta-name-btn').classList.remove('hidden');
                } else {
                    document.getElementById('edit-pauta-name-btn').classList.add('hidden');
                }

                // L√ìGICA DE LAYOUT DIN√ÇMICO DOS CARDS
                if (pautaData.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                    mainContent.classList.remove('lg:grid-cols-3');
                    mainContent.classList.add('lg:grid-cols-4');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                    mainContent.classList.remove('lg:grid-cols-4');
                    mainContent.classList.add('lg:grid-cols-3');
                }

            }
             if (pautaType === 'agendado') {
                 tabAgendamento.classList.remove('hidden');
                 tabAvulso.classList.add('hidden');
                 pautaColumn.classList.remove('hidden');
                 switchTab('agendamento');
            } else if (pautaType === 'avulso') {
                 tabAvulso.classList.remove('hidden');
                 tabAgendamento.classList.add('hidden');
                 pautaColumn.classList.add('hidden');
                 switchTab('avulso');
            } else {
                tabAgendamento.classList.remove('hidden');
                tabAvulso.classList.remove('hidden');
                pautaColumn.classList.remove('hidden');
                switchTab('agendamento');
            }

                    // 1. Liga o motor dos Assistidos (M√≥dulo js/pauta.js)
                    setupAttendancesListener(db, pautaId, (dados) => {
                        allAssisted = dados;
                        renderAssistedList(); // Redesenha os cards na tela
                    });
        
                    // 2. Liga o motor da Equipe (M√≥dulo js/colaboradores.js)
                    setupCollaboratorsListener(db, pautaId, (dados) => {
                        colaboradores = dados;
                        renderColaboradores(); // Redesenha a tabela da equipe
                    });
        
                    // 3. Muda para a tela principal (M√≥dulo js/ui.js)
                    showScreen('app');
                };

        const deletePauta = async (pautaId) => {
            try {
                await deleteDoc(doc(db, "pautas", pautaId));
            } catch (error) {
                console.error("Erro ao excluir a pauta:", error);
                showNotification("Erro ao excluir a pauta.", "error");
            }
        };

        const createPautaCard = (docSnap, isExpired) => {
            const pauta = docSnap.data();
            const card = document.createElement('div');
            card.className = "relative bg-white p-6 rounded-lg shadow-md flex flex-col justify-between h-full";
            
            if (isExpired) {
                card.classList.add('opacity-60', 'bg-gray-100', 'cursor-not-allowed');
            } else {
                card.classList.add('hover:shadow-xl', 'transition-shadow', 'cursor-pointer');
            }

            const deleteButton = document.createElement('button');
            deleteButton.className = "absolute top-3 right-3 p-1 rounded-full text-gray-400 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500";
            deleteButton.setAttribute('aria-label', 'Excluir pauta');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                if (confirm(`Tem certeza que deseja apagar a pauta "${pauta.name}"?`)) {
                    logAction('DELETE_PAUTA', `Apagou a pauta "${pauta.name}"`, docSnap.id); //LOG de Deletar
                    deletePauta(docSnap.id);
                }
            });

            card.appendChild(deleteButton);

            const creationDate = pauta.createdAt ? new Date(pauta.createdAt) : new Date();
            const expirationDate = new Date(creationDate);
            expirationDate.setDate(creationDate.getDate() + 7);

            const formattedCreationDate = creationDate.toLocaleDateString('pt-BR');
            const formattedExpirationDate = expirationDate.toLocaleDateString('pt-BR');

            const contentDiv = document.createElement('div');
            const title = document.createElement('h3');
            title.className = "font-bold text-xl mb-2";
            title.textContent = pauta.name;

            const members = document.createElement('p');
            members.className = "text-gray-600";
            members.textContent = `Membros: ${pauta.memberEmails?.length || 1}`;

            contentDiv.appendChild(title);
            contentDiv.appendChild(members);

            const footerDiv = document.createElement('div');
            footerDiv.className = "mt-4 pt-2 border-t border-gray-200";
            const createdP = document.createElement('p');
            createdP.className = "text-xs text-gray-500";
            createdP.innerHTML = `Criada em: <strong>${formattedCreationDate}</strong>`;

            const expiresP = document.createElement('p');
            if (isExpired) {
                expiresP.className = "text-xs text-gray-500 font-semibold";
                expiresP.innerHTML = `Prazo de acesso expirou em: <strong>${formattedExpirationDate}</strong>`;
            } else {
                expiresP.className = "text-xs text-red-600";
                expiresP.innerHTML = `Ser√° eliminada em: <strong>${formattedExpirationDate}</strong>`;
            }

            footerDiv.appendChild(createdP);
            footerDiv.appendChild(expiresP);
            card.appendChild(contentDiv);
            card.appendChild(footerDiv);
            
            card.addEventListener('click', (event) => {
                if (event.target.closest('button')) return;

                if (isExpired) {
                    showNotification("Pauta inacess√≠vel pois cumpriu seu prazo.", "error");
                } else {
                    loadPauta(docSnap.id, pauta.name, pauta.type);
                }
            });
            return card;
        };


        const showPautaSelectionScreen = (userId) => {
            // Limpa o localStorage para a √∫ltima pauta quando volta para a sele√ß√£o
            localStorage.removeItem('lastPautaId');
            localStorage.removeItem('lastPautaType');

            const pautasList = document.getElementById('pautas-list');
            pautasList.innerHTML = '<p class="col-span-full text-center">Carregando pautas...</p>';

            const q = query(collection(db, "pautas"), where("members", "array-contains", userId));

            onSnapshot(q, (snapshot) => {
                pautasList.innerHTML = ''; 
                const fragment = document.createDocumentFragment();
                const now = new Date();
                
                if (snapshot.empty) {
                    pautasList.innerHTML = '<p class="col-span-full text-center text-gray-500">Nenhuma pauta encontrada. Crie uma para come√ßar.</p>';
                    return;
                }

                snapshot.docs.forEach((docSnap) => {
                    const pauta = docSnap.data();
                    let isExpired = false;
                    if (pauta.createdAt) {
                        const creationDate = new Date(pauta.createdAt);
                        const expirationDate = new Date(creationDate);
                        expirationDate.setDate(creationDate.getDate() + 7);
                        if (now > expirationDate) {
                            isExpired = true;
                        }
                    }
                    const card = createPautaCard(docSnap, isExpired);
                    fragment.appendChild(card);
                });
                pautasList.appendChild(fragment);

            }, (error) => {
                console.error("Erro ao buscar pautas:", error);
                pautasList.innerHTML = '<p class="col-span-full text-center text-red-500">Ocorreu um erro ao carregar as pautas.</p>';
            });

            showScreen('pautaSelection');
        };

        const setupModalClosers = () => {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        };

        const handleAuthState = () => {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                // 1. Busca os dados do usu√°rio no Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserName = userData.name || user.email;

                    // 2. Verifica se o usu√°rio √© Admin/Superadmin para mostrar o bot√£o
                    checkAdminStatus(userData);

                    // 3. Verifica o Status de Aprova√ß√£o
                    if (userData.status === 'approved') {
                        // USU√ÅRIO APROVADO: Prosseguir para o sistema
                        const lastPautaId = localStorage.getItem('lastPautaId');
                        const lastPautaType = localStorage.getItem('lastPautaType');

                        if (lastPautaId && lastPautaType) {
                            // Verifica se ele ainda √© membro dessa pauta antes de carregar
                            const pautaRef = doc(db, "pautas", lastPautaId);
                            const pautaSnap = await getDoc(pautaRef);
                            
                            if (pautaSnap.exists() && pautaSnap.data().members.includes(user.uid)) {
                                loadPauta(lastPautaId, pautaSnap.data().name, lastPautaType);
                            } else {
                                showPautaSelectionScreen(user.uid);
                            }
                        } else {
                            showPautaSelectionScreen(user.uid);
                        }
                    } else {
                        // USU√ÅRIO PENDENTE: Mostrar tela de aviso
                        showScreen('loading');
                        loadingText.innerHTML = `
                            <div class="text-center">
                                <p class="text-xl font-bold text-orange-600">Acesso Pendente</p>
                                <p class="mt-2 text-gray-600">Ol√°, <b>${currentUserName}</b>!</p>
                                <p class="text-sm text-gray-500">Sua conta foi criada, mas um administrador precisa aprov√°-la para voc√™ acessar o sistema.</p>
                                <button onclick="signOut(auth)" class="mt-6 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Sair / Trocar de Conta</button>
                            </div>
                        `;
                        // Esconde o spinner de carregamento para n√£o confundir
                        document.querySelector('.loader').style.display = 'none';
                    }
                } else {
                    // Caso o documento do usu√°rio n√£o exista (erro raro de cria√ß√£o)
                    showNotification("Erro ao localizar seu perfil. Tente cadastrar novamente.", "error");
                    signOut(auth);
                }
            } catch (error) {
                console.error("Erro ao verificar estado do usu√°rio:", error);
                showNotification("Erro de conex√£o com o servidor.", "error");
            }
        } else {
            // USU√ÅRIO DESLOGADO: Mostrar tela de login
            showScreen('login');
            // Resetar estados do Admin caso estivessem vis√≠veis
            adminPanelBtn.classList.add('hidden');
        }
    });
};

        const showScreen = (screenName) => {
            loadingContainer.classList.toggle('hidden', screenName !== 'loading');
            loginContainer.classList.toggle('hidden', screenName !== 'login');
            pautaSelectionContainer.classList.toggle('hidden', screenName !== 'pautaSelection');
            appContainer.classList.toggle('hidden', screenName !== 'app');
        };

        const switchTab = (tabName) => {
            const tabAgendamento = document.getElementById('tab-agendamento');
            const tabAvulso = document.getElementById('tab-avulso');
            const isScheduledContainer = document.getElementById('is-scheduled-container');
            const formTitle = document.getElementById('form-title');
            const pautaColumn = document.getElementById('pauta-column');
            const emAtendimentoColumn = document.getElementById('em-atendimento-column');
            const formContainer = document.getElementById('form-agendamento');

            formContainer.classList.remove('hidden');

            if (tabName === 'agendamento') {
                tabAgendamento.classList.add('tab-active');
                tabAvulso.classList.remove('tab-active', 'text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.remove('hidden');
                pautaColumn.classList.remove('hidden');
                if (currentPautaData?.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                }
                formTitle.textContent = "Adicionar Novo Agendamento";
                document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
                document.querySelector('input[name="has-arrived"][value="no"]').checked = true;
                document.getElementById('scheduled-time-wrapper').classList.add('hidden');
                document.getElementById('arrival-time-wrapper').classList.add('hidden');
                document.getElementById('manual-room-wrapper').classList.add('hidden'); // Ocultar sele√ß√£o de sala manual
            } else { // avulso
                tabAvulso.classList.add('tab-active');
                tabAgendamento.classList.remove('tab-active');
                tabAgendamento.classList.add('text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.add('hidden');
                pautaColumn.classList.add('hidden');
                 if (currentPautaData?.useDelegationFlow) {
                    emAtendimentoColumn.classList.remove('hidden');
                } else {
                    emAtendimentoColumn.classList.add('hidden');
                }
                formTitle.textContent = "Adicionar Atendimento Avulso";

                document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
                document.querySelector('input[name="has-arrived"][value="yes"]').checked = true;
                document.getElementById('scheduled-time-wrapper').classList.add('hidden');
                document.getElementById('arrival-time-wrapper').classList.remove('hidden');
                document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);

                // L√≥gica para mostrar/esconder o seletor de sala manual
                const manualRoomWrapper = document.getElementById('manual-room-wrapper');
                const manualRoomSelect = document.getElementById('manual-room-select');
                
                if (currentPautaData?.type === 'multisala' && currentPautaData.rooms) {
                    manualRoomWrapper.classList.remove('hidden');
                    manualRoomSelect.innerHTML = '';
                    currentPautaData.rooms.forEach(room => {
                        const opt = document.createElement('option');
                        opt.value = room;
                        opt.textContent = room;
                        manualRoomSelect.appendChild(opt);
                    });
                } else {
                    manualRoomWrapper.classList.add('hidden');
                }
            }
            renderAssistedList();
        };


        let sortableInstance = null;

        const initSortable = () => {
            const el = document.getElementById('aguardando-list');
            const pautaOrder = currentPautaData?.ordemAtendimento || 'padrao';
        
            // S√≥ habilita o "arrastar" se a pauta estiver em modo manual e n√£o estiver fechada
            if (pautaOrder === 'manual' && !isPautaClosed) {
                if (sortableInstance) sortableInstance.destroy(); // Limpa inst√¢ncia anterior
        
                sortableInstance = new Sortable(el, {
                    animation: 150,
                    ghostClass: 'bg-green-100', // Cor de fundo enquanto arrasta
                    onEnd: async function () {
                        const items = el.querySelectorAll('[data-id]');
                        const batch = writeBatch(db);
                        
                        // Percorre a lista na nova ordem visual e atualiza o banco
                        items.forEach((item, index) => {
                            const docId = item.getAttribute('data-id');
                            const docRef = doc(db, "pautas", currentPautaId, "attendances", docId);
                            batch.update(docRef, { indexManual: index });
                        });
        
                        try {
                            await batch.commit();
                            showNotification("Ordem atualizada!");
                        } catch (e) {
                            console.error("Erro ao salvar ordem:", e);
                        }
                    },
                });
            } else {
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
            }
        };
        
        const main = () => {
            try {
                const app = initializeApp(firebaseConfig);
                
                // Inicializa√ß√£o do App Check para seguran√ßa
                const appCheck = initializeAppCheck(app, {
                  provider: new ReCaptchaV3Provider('6LeWfTgsAAAAAHy1y3TFZ1EH-L3btwHsult6Rgy4'),
                  isTokenAutoRefreshEnabled: true
                });

                db = getFirestore(app);

                // --- IN√çCIO DO C√ìDIGO OFFLINE ---
                try {
                    enableIndexedDbPersistence(db).catch((err) => {
                        if (err.code == 'failed-precondition') {
                            console.warn('Persist√™ncia falhou: M√∫ltiplas abas abertas.');
                        } else if (err.code == 'unimplemented') {
                            console.warn('Persist√™ncia falhou: Navegador n√£o suportado.');
                        }
                    });
                    console.log("Persist√™ncia Offline Ativada!");
                } catch (e) {
                    console.log("Erro ao ativar persist√™ncia:", e);
                }

                // Monitores de Conex√£o (Para mostrar a barra vermelha)
                window.addEventListener('offline', () => {
                    const indicator = document.getElementById('offline-indicator');
                    if(indicator) indicator.classList.remove('hidden');
                });

                window.addEventListener('online', () => {
                    const indicator = document.getElementById('offline-indicator');
                    if(indicator) indicator.classList.add('hidden');
                    // Tenta exibir notifica√ß√£o se a fun√ß√£o existir
                    if (typeof showNotification === 'function') {
                        showNotification("Conex√£o restabelecida! Sincronizando...", "success");
                    }
                });
                // --- FIM DO C√ìDIGO OFFLINE ---

                auth = getAuth(app);
                handleAuthState();
            } catch (error) {
                console.error("Erro ao inicializar o Firebase: ", error);
                if(loadingText) loadingText.textContent = 'Erro na configura√ß√£o do Firebase.';
            }
        };
        
        // --- CONFIGURA√á√ÉO DE LOGOUT POR INATIVIDADE ---
        const INACTIVITY_TIME = 30 * 60 * 1000; // 30 minutos em milissegundos
        let inactivityTimer;
        
        const resetInactivityTimer = () => {
            // Se o timer j√° estiver rodando, cancela e come√ßa de novo
            if (inactivityTimer) clearTimeout(inactivityTimer);
        
            inactivityTimer = setTimeout(() => {
                if (auth.currentUser) {
                    console.log("Sess√£o expirada por inatividade.");
                    signOut(auth).then(() => {
                        showNotification("Sess√£o encerrada por inatividade para sua seguran√ßa.", "info");
                    });
                }
            }, INACTIVITY_TIME);
        };
        
        // Eventos que indicam que o usu√°rio est√° ativo
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        
        // Inicia o monitoramento
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });
        
        // Come√ßa a contar assim que a p√°gina carrega
        resetInactivityTimer();
        
        // FUN√á√ÉO PARA MOSTRAR ESTAT√çSTICAS (AGORA CHAMA O SCRIPT EXTERNO)
        const showStatisticsModal = () => {
            // Chama a fun√ß√£o do arquivo estatisticas.js
            renderStatisticsModal(
                allAssisted,
                currentPautaData?.useDelegationFlow,
                document.getElementById('pauta-title').textContent
            );
        };
        document.addEventListener('DOMContentLoaded', () => {
            main();
            setupModalClosers();
            setupDetailsModal({ db,getChecklistHTML, getUpdatePayload, showNotification }); // <--- ADICIONE AQUI

            const actionsToggle = document.getElementById('actions-toggle');
            const actionsPanel = document.getElementById('actions-panel');
            const actionsArrow = document.getElementById('actions-arrow');
            // Refer√™ncias
            const shareModal = document.getElementById('share-modal');
            const shareToggle = document.getElementById('share-toggle');
            const shareStatusText = document.getElementById('share-status-text');
            const shareLinkContainer = document.getElementById('share-link-container');
            const shareLinkInput = document.getElementById('share-link-input');
            const maskNamesCheck = document.getElementById('mask-names-check');
            
            // 1. Abrir Modal
            document.getElementById('share-pauta-btn').addEventListener('click', () => {
                if (!currentPautaData) return;
                
                shareModal.classList.remove('hidden');
                
                // Carregar estado atual
                const isPublic = currentPautaData.isPublic || false;
                const maskNames = currentPautaData.maskNames || false;
                
                shareToggle.checked = isPublic;
                maskNamesCheck.checked = maskNames;
                updateShareUI(isPublic);
            });
            
            // 2. Fun√ß√£o Visual
            function updateShareUI(isPublic) {
                shareStatusText.textContent = isPublic ? "P√∫blico" : "Privado";
                if (isPublic) {
                    shareLinkContainer.classList.remove('hidden');
                    // Gera o link para o arquivo acompanhamento.html
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                    const link = `${baseUrl}/acompanhamento.html?id=${currentPautaId}`;
                    shareLinkInput.value = link;
                    document.getElementById('open-external-btn').href = link;
                } else {
                    shareLinkContainer.classList.add('hidden');
                }
            }
            
            // 3. Alternar P√∫blico/Privado
            shareToggle.addEventListener('change', async (e) => {
                const isPublic = e.target.checked;
                updateShareUI(isPublic);
                
                try {
                    const pautaRef = doc(db, "pautas", currentPautaId);
                    await updateDoc(pautaRef, { isPublic: isPublic });
                    
                    // Atualiza a vari√°vel local
                    currentPautaData.isPublic = isPublic;
                    
                    showNotification(isPublic ? "Link p√∫blico ativado." : "Link p√∫blico desativado.");
                } catch (error) {
                    console.error(error);
                    showNotification("Erro ao atualizar status.", "error");
                    // Reverte visualmente se der erro
                    e.target.checked = !isPublic;
                    updateShareUI(!isPublic);
                }
            });
            
            // 4. Alternar Mascara de Nomes (LGPD)
            maskNamesCheck.addEventListener('change', async (e) => {
                const mask = e.target.checked;
                try {
                    const pautaRef = doc(db, "pautas", currentPautaId);
                    await updateDoc(pautaRef, { maskNames: mask });
                    currentPautaData.maskNames = mask;
                    showNotification("Configura√ß√£o de privacidade atualizada.");
                } catch (error) {
                    showNotification("Erro ao salvar configura√ß√£o.", "error");
                }
            });
            
            // 5. Copiar Link
            document.getElementById('copy-share-link-btn').addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                showNotification("Link copiado!", "info");
            });
            
            document.getElementById('close-share-modal-btn').addEventListener('click', () => {
                shareModal.classList.add('hidden');
            });
            
            function showPanel() {
                if(actionsPanel && actionsArrow) {
                    actionsPanel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                    actionsArrow.classList.add('rotate-180');
                }
            }

            function hidePanel() {
                if(actionsPanel && actionsArrow) {
                    actionsPanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                    actionsArrow.classList.remove('rotate-180');
                }
            }

            if(actionsToggle) {
                actionsToggle.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (actionsPanel && actionsPanel.classList.contains('opacity-0')) {
                        showPanel();
                    } else {
                        hidePanel();
                    }
                });
            }

            window.addEventListener('click', (event) => {
                if (actionsPanel && !actionsPanel.contains(event.target) && actionsToggle && !actionsToggle.contains(event.target)) {
                    hidePanel();
                }
            });
            
            const datalist = document.getElementById('subjects-list');
            flatSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.value;
                datalist.appendChild(option);
            });

            const subjectInput = document.getElementById('assisted-subject');
            const descriptionBox = document.getElementById('subject-description');
            const infoButton = document.getElementById('subject-info-btn');

            const updateDatalist = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                const filteredSubjects = flatSubjects.filter(item =>
                    item.value.toLowerCase().includes(lowerCaseQuery) ||
                    item.description.toLowerCase().includes(lowerCaseQuery)
                );

                while (datalist.firstChild) {
                    datalist.removeChild(datalist.firstChild);
                }
                filteredSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.value;
                    datalist.appendChild(option);
                });
            };

            const findSubjectByInputValue = (inputValue) => {
                return flatSubjects.find(subject => {
                    const lastPart = subject.value.split(' > ').pop();
                    return lastPart === inputValue || subject.value === inputValue;
                });
            };

            subjectInput.addEventListener('input', (e) => {
                updateDatalist(e.target.value);
            });

            subjectInput.addEventListener('change', () => {
                const originalValue = subjectInput.value;
                let selectedText = originalValue;

                if (selectedText.includes(' > ')) {
                    const parts = selectedText.split(' > ');
                    selectedText = parts[parts.length - 1];
                }

                subjectInput.value = selectedText;

                const foundSubject = findSubjectByInputValue(selectedText);
                if (foundSubject && foundSubject.description) {
                    descriptionBox.textContent = foundSubject.description;
                    descriptionBox.classList.remove('hidden');
                } else {
                    descriptionBox.textContent = '';
                    descriptionBox.classList.add('hidden');
                }
            });

            infoButton.addEventListener('click', () => {
                const currentValue = subjectInput.value;
                const foundSubject = findSubjectByInputValue(currentValue);

                if (foundSubject && foundSubject.description) {
                    descriptionBox.textContent = foundSubject.description;
                    descriptionBox.classList.toggle('hidden');
                } else {
                    descriptionBox.textContent = 'Por favor, selecione um assunto v√°lido para ver a descri√ß√£o.';
                    descriptionBox.classList.remove('hidden');
                }
            });

            // --- L√ìGICA DE LOGIN/CADASTRO ---
            // --- L√ìGICA DE LOGIN/CADASTRO ---
            const loginTabBtn = document.getElementById('login-tab-btn');
            const registerTabBtn = document.getElementById('register-tab-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            loginTabBtn.addEventListener('click', () => {
                loginTabBtn.classList.add('border-green-600', 'text-green-600');
                loginTabBtn.classList.remove('text-gray-500');
                registerTabBtn.classList.remove('border-green-600', 'text-green-600');
                registerTabBtn.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            });

            registerTabBtn.addEventListener('click', () => {
                registerTabBtn.classList.add('border-green-600', 'text-green-600');
                registerTabBtn.classList.remove('text-gray-500');
                loginTabBtn.classList.remove('border-green-600', 'text-green-600');
                loginTabBtn.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('auth-error');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    errorDiv.classList.add('hidden');
                } catch (error) {
                    console.error("Login failed:", error);
                    errorDiv.textContent = 'Email ou senha inv√°lidos.';
                    errorDiv.classList.remove('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const errorDiv = document.getElementById('auth-error');

                if (password.length < 6) {
                    errorDiv.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: email,
                        uid: user.uid,
                        status: 'pending',
                        role: 'admin',
                        createdAt: new Date().toISOString()
                    });

                    errorDiv.classList.add('hidden');
                    showNotification('Conta criada com sucesso! Agora voc√™ pode fazer o login.', 'success');
                    loginTabBtn.click();

                } catch (error) {
                    console.error("Registration failed:", error);
                    errorDiv.textContent = error.code === 'auth/email-already-in-use' ? 'Este email j√° est√° em uso.' : 'Ocorreu um erro ao criar a conta.';
                    errorDiv.classList.remove('hidden');
                }
            });

            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                const email = prompt("Por favor, digite seu email para redefinir a senha:");
                if (email) {
                    sendPasswordResetEmail(auth, email)
                        .then(() => showNotification("Email de redefini√ß√£o de senha enviado!", "success"))
                        .catch((error) => {
                            console.error("Password reset error:", error);
                            showNotification("Erro ao enviar email. Verifique se o email est√° correto.", "error");
                        });
                }
            });

            // --- L√ìGICA DE SALAS PERSONALIZADAS ---
            const customRoomInput = document.getElementById('custom-room-input');
            const customRoomsListEl = document.getElementById('custom-rooms-list');
            const noRoomsMsg = document.getElementById('no-rooms-msg');

            // Fun√ß√£o para desenhar a lista de salas
            const renderCustomRooms = () => {
                customRoomsListEl.innerHTML = '';
                if (customRoomsList.length === 0) {
                    noRoomsMsg.classList.remove('hidden');
                } else {
                    noRoomsMsg.classList.add('hidden');
                    customRoomsList.forEach((roomName, index) => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between items-center bg-white border border-gray-200 p-2 rounded shadow-sm";
                        li.innerHTML = `
                            <span class="font-medium text-gray-700">üè¢ ${escapeHTML(roomName)}</span>
                            <button type="button" class="remove-room-btn text-red-500 hover:text-red-700 text-sm font-bold px-2" data-index="${index}">Remover</button>
                        `;
                        customRoomsListEl.appendChild(li);
                    });
                }
            };
            
            // Bot√£o Adicionar Sala
            document.getElementById('add-custom-room-btn').addEventListener('click', (e) => {
                e.preventDefault(); // Evita recarregar a p√°gina
                const name = customRoomInput.value.trim();
                if (name) {
                    // Evita duplicatas
                    if (!customRoomsList.includes(name)) {
                        customRoomsList.push(name);
                        renderCustomRooms();
                        customRoomInput.value = '';
                        customRoomInput.focus();
                    } else {
                        showNotification("Este local j√° foi adicionado.", "error");
                    }
                }
            });

            // Bot√£o Remover Sala (Delega√ß√£o de evento)
            customRoomsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-room-btn')) {
                    const index = e.target.dataset.index;
                    customRoomsList.splice(index, 1);
                    renderCustomRooms();
                }
            });

            // --- NOVO FLUXO DE CRIA√á√ÉO DE PAUTA COM ORDEM DE ATENDIMENTO E DELEGA√á√ÉO ---
            document.getElementById('create-pauta-btn').addEventListener('click', () => {
                document.getElementById('pauta-type-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-pauta-type-btn').addEventListener('click', () => {
                document.getElementById('pauta-type-modal').classList.add('hidden');
            });

            document.querySelectorAll('.pauta-type-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    document.getElementById('pauta-type-modal').classList.add('hidden');
                    
                    const createModal = document.getElementById('create-pauta-modal');
                    createModal.dataset.pautaType = type;
                    
                    const roomConfig = document.getElementById('room-config-container');
                    if (type === 'multisala') {
                        roomConfig.classList.remove('hidden');
                        customRoomsList = []; // Zera a lista
                        renderCustomRooms(); // Atualiza visualmente
                        document.getElementById('custom-room-input').value = '';
                    } else {
                        roomConfig.classList.add('hidden');
                    }
                    
                    createModal.classList.remove('hidden');
                });
            });

            document.getElementById('cancel-create-pauta-btn').addEventListener('click', () => {
                document.getElementById('create-pauta-modal').classList.add('hidden');
            });
            
            document.getElementById('next-to-ordem-btn').addEventListener('click', () => {
                const pautaName = document.getElementById('create-pauta-name-input').value.trim();
                if (!pautaName) {
                    showNotification("O nome da pauta n√£o pode ser vazio.", "error");
                    return;
                }
                document.getElementById('create-pauta-modal').classList.add('hidden');
                document.getElementById('ordem-atendimento-modal').classList.remove('hidden');
            });
            
            document.getElementById('cancel-ordem-btn').addEventListener('click', () => {
                document.getElementById('ordem-atendimento-modal').classList.add('hidden');
                document.getElementById('create-pauta-modal').classList.remove('hidden');
            });

            // Adicionado: Bot√£o para ir para o modal de delega√ß√£o
            document.getElementById('next-to-delegation-btn').addEventListener('click', () => {
                document.getElementById('ordem-atendimento-modal').classList.add('hidden');
                document.getElementById('delegation-flow-modal').classList.remove('hidden');
            });

            // Adicionado: Bot√£o de voltar do modal de delega√ß√£o
            document.getElementById('cancel-delegation-flow-btn').addEventListener('click', () => {
                document.getElementById('delegation-flow-modal').classList.add('hidden');
                document.getElementById('ordem-atendimento-modal').classList.remove('hidden');
            });
            
            // L√≥gica final de cria√ß√£o da pauta, agora no modal de delega√ß√£o
            document.getElementById('confirm-create-pauta-final-btn').addEventListener('click', async () => {
                const pautaName = document.getElementById('create-pauta-name-input').value.trim();
                const pautaType = document.getElementById('create-pauta-modal').dataset.pautaType;
                const ordemAtendimento = document.querySelector('input[name="ordemAtendimento"]:checked').value;
                const useDelegationFlow = document.querySelector('input[name="useDelegationFlow"]:checked').value === 'true'; // Novo campo
                const user = auth.currentUser;
                
                if (!user) {
                    showNotification("Voc√™ precisa estar logado para criar uma pauta.", "error");
                    return;
                }
                
                // L√≥gica para salas
                let pautaRooms = [];
                if (pautaType === 'multisala') {
                    if (customRoomsList.length === 0) {
                        showNotification("Por favor, adicione pelo menos um local/sala.", "error");
                        return;
                    }
                    pautaRooms = [...customRoomsList];
                }

                try {
                    await addDoc(collection(db, "pautas"), {
                        name: pautaName,
                        type: pautaType,
                        ordemAtendimento: ordemAtendimento,
                        useDelegationFlow: useDelegationFlow, // Salva a escolha
                        owner: user.uid,
                        ownerEmail: user.email,
                        members: [user.uid],
                        memberEmails: [user.email],
                        isClosed: false,
                        createdAt: new Date().toISOString(),
                        rooms: pautaRooms // Salva as salas
                    });
                    logAction('CREATE_PAUTA', `Criou a pauta "${pautaName}" do tipo ${pautaType}`); //Logs de cria√ß√£o
                    showNotification("Pauta criada com sucesso!");
                    document.getElementById('create-pauta-name-input').value = '';
                    document.getElementById('delegation-flow-modal').classList.add('hidden'); // Fecha o modal final
                } catch (error) {
                    console.error("Error creating pauta:", error);
                    showNotification("Erro ao criar pauta.", "error");
                }
            });

            // --- L√ìGICA DE EVENTOS GERAIS E MODAIS ---
            document.getElementById('privacy-policy-link').addEventListener('click', e => {
                e.preventDefault();
                document.getElementById('privacy-policy-modal').classList.remove('hidden');
            });

            const privacyModal = document.getElementById('privacy-policy-modal');
            if (privacyModal) {
                const closePolicyModal = () => privacyModal.classList.add('hidden');
                privacyModal.querySelector('#close-policy-modal-btn-x')?.addEventListener('click', closePolicyModal);
                privacyModal.querySelector('#close-policy-modal-btn')?.addEventListener('click', closePolicyModal);
            }

            document.getElementById('format-help-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('format-help-modal').classList.remove('hidden');
            });

            document.getElementById('format-help-modal').addEventListener('click', e => {
                const buttonId = e.target.id;
                if (buttonId === 'copy-csv-format-btn') {
                    const text = document.getElementById('csv-format-code').innerText;
                    copyToClipboard(text, 'Formato copiado!');
                } else if (buttonId === 'copy-csv-example-btn') {
                    const text = document.getElementById('csv-example-code').innerText;
                    copyToClipboard(text, 'Exemplo copiado!');
                } else if (buttonId === 'copy-ai-prompt-btn') {
                    const text = document.getElementById('ai-prompt-code').innerText;
                    copyToClipboard(text, 'Prompt para IA copiado!');
                }
            });

            document.getElementById('tab-agendamento').addEventListener('click', () => switchTab('agendamento'));
            document.getElementById('tab-avulso').addEventListener('click', () => switchTab('avulso'));

            const handleLogout = () => {
                signOut(auth).catch(error => {
                    console.error("Logout error", error);
                    showNotification("Erro ao tentar sair.", "error");
                });
            };
            document.getElementById('logout-btn-main').addEventListener('click', handleLogout);
            document.getElementById('logout-btn-app').addEventListener('click', handleLogout);

            ['pauta-search', 'aguardando-search', 'em-atendimento-search', 'atendidos-search', 'faltosos-search'].forEach(id => {
                document.getElementById(id).addEventListener('input', renderAssistedList);
            });

            document.getElementById('file-upload').addEventListener('change', async (event) => {
            const file = event.target.files[0];
                if (!file) return;
            
                try {
                    // 1. Processa o arquivo usando o m√≥dulo externo
                    const assistidosValidados = await parsePautaCSV(file);
                    
                    // 2. Salva no banco de dados (usando a fun√ß√£o do pauta.js que criamos antes)
                    await saveImportedPauta(db, currentPautaId, assistidosValidados, currentUserName);
                    
                    showNotification(`${assistidosValidados.length} registros importados com sucesso!`);
                } catch (error) {
                    showNotification(error, "error");
                } finally {
                    event.target.value = ''; // Limpa o campo
                }
        });
            
             });
            document.getElementById('toggle-faltosos-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const pautaColumn = document.getElementById('pauta-column');
                const faltososColumn = document.getElementById('faltosos-column');

                pautaColumn.classList.toggle('hidden');
                faltososColumn.classList.toggle('hidden');

                if (faltososColumn.classList.contains('hidden')) {
                    btn.textContent = 'Ver Faltosos';
                    btn.classList.replace('bg-blue-600', 'bg-purple-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-purple-700');
                } else {
                    btn.textContent = 'Ver Pauta';
                    btn.classList.replace('bg-purple-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-purple-700', 'hover:bg-blue-700');
                }
            });

            document.querySelectorAll('input[name="is-scheduled"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('scheduled-time-wrapper').classList.toggle('hidden', e.target.value === 'no');
                });
            });
             document.querySelectorAll('input[name="has-arrived"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const wrapper = document.getElementById('arrival-time-wrapper');
                    wrapper.classList.toggle('hidden', e.target.value === 'no');
                    if (e.target.value === 'yes') {
                         document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);
                    }
                });
            });

            const showDemandsModal = (assistedId) => {
                const modal = document.getElementById('demands-modal');
                const assisted = allAssisted.find(a => a.id === assistedId);
                if (!assisted) return;

                document.getElementById('demands-assisted-name-modal').textContent = assisted.name;
                const demandsListContainer = document.getElementById('demands-modal-list-container');
                demandsListContainer.innerHTML = '';

                const demands = assisted.demandas?.descricoes || [];
                if (demands.length === 0) {
                    demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
                } else {
                    demands.forEach(demandText => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 bg-white rounded-md';
                        li.textContent = demandText;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs';
                        removeBtn.textContent = 'Remover';
                        li.appendChild(removeBtn);
                        demandsListContainer.appendChild(li);
                    });
                }
                modal.classList.remove('hidden');
            };

            document.body.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                
                // --- NOVO: Bot√£o de Renomear Sala ---
                const editRoomBtn = e.target.closest('.edit-room-name-btn');
                if (editRoomBtn) {
                    if (isPautaClosed) {
                        showNotification("A pauta est√° fechada.", "error");
                        return;
                    }
                    const oldName = editRoomBtn.dataset.room;
                    const newName = prompt(`Renomear "${oldName}" para:`, oldName);
                    
                    if (newName && newName.trim() !== "" && newName !== oldName) {
                        await renamePautaRoom(oldName, newName.trim());
                    }
                    return; // Para n√£o processar outros cliques
                }
                // ------------------------------------

                if (!button) return;

                // Adiciona o listener para o bot√£o de estat√≠sticas
                if (button.id === 'view-stats-btn') {
                    showStatisticsModal();
                    return; // Retorna para n√£o processar outros cliques
                }
                
                const id = button.dataset.id;
                const collectionRef = currentPautaId ? collection(db, "pautas", currentPautaId, "attendances") : null;

                if (id && collectionRef) {
                    const docRef = doc(collectionRef, id);

                    if(isPautaClosed) {
                        showNotification("Esta pauta est√° fechada. A√ß√µes n√£o podem ser realizadas.", "error");
                        return;
                    }

                    if (button.classList.contains('check-in-btn')) { 
                        assistedIdToHandle = id; 
                        document.getElementById('arrival-modal').classList.remove('hidden'); 
                        document.getElementById('arrival-time-input').value = new Date().toTimeString().slice(0,5); 
                        
                        // L√≥gica NOVA: Salas
                        const roomContainer = document.getElementById('arrival-room-container');
                        const roomSelect = document.getElementById('arrival-room-select');
                        
                        if (currentPautaData?.type === 'multisala' && currentPautaData.rooms) {
                            roomContainer.classList.remove('hidden');
                            roomSelect.innerHTML = '';
                            currentPautaData.rooms.forEach(room => {
                                const opt = document.createElement('option');
                                opt.value = room;
                                opt.textContent = room;
                                roomSelect.appendChild(opt);
                            });
                        } else {
                            roomContainer.classList.add('hidden');
                        }
                    }
                    
                    // L√≥gica para o bot√£o "Atender" na coluna "Aguardando"
                    if (button.classList.contains('select-collaborator-btn')) { // Fluxo de delega√ß√£o ativado
                        assistedIdToHandle = id;
                        assistedNameToHandle = button.dataset.name;
                        document.getElementById('assisted-to-attend-name').textContent = assistedNameToHandle;
                        
                        const collaboratorSelectionList = document.getElementById('collaborator-selection-list');
                        collaboratorSelectionList.innerHTML = '';
                        // Adiciona uma op√ß√£o "N√£o atribuir"
                        const noAssignLabel = document.createElement('label');
                        noAssignLabel.className = 'flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                        noAssignLabel.innerHTML = `
                            <input type="radio" name="selectedCollaborator" value="null" data-name="N√£o atribu√≠do" class="h-5 w-5 text-gray-600 focus:ring-gray-500" checked>
                            <span class="ml-3 font-semibold text-gray-800">N√£o atribuir colaborador</span>
                        `;
                        collaboratorSelectionList.appendChild(noAssignLabel);

                        if (colaboradores.length === 0) {
                            const noCollabMessage = document.createElement('p');
                            noCollabMessage.className = 'text-gray-500 text-center mt-2';
                            noCollabMessage.textContent = 'Nenhum colaborador registrado. Adicione um na se√ß√£o "Colaboradores" para atribuir.';
                            collaboratorSelectionList.appendChild(noCollabMessage);
                        } else {
                            colaboradores.forEach(collab => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50';
                                label.innerHTML = `
                                    <input type="radio" name="selectedCollaborator" value="${collab.id}" data-name="${collab.nome}" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-3 font-semibold text-gray-800">${collab.nome}</span>
                                `;
                                collaboratorSelectionList.appendChild(label);
                            });
                        }
                        document.getElementById('select-collaborator-modal').classList.remove('hidden');
                    }

                    // Bot√£o "Atender" para o fluxo antigo (sem delega√ß√£o)
                    if (button.classList.contains('attend-directly-from-aguardando-btn')) { // Fluxo de delega√ß√£o desativado
                        assistedIdToHandle = id;
                        const attendantInput = document.getElementById('attendant-name');
                        attendantInput.value = ''; // Limpar o campo para nova atribui√ß√£o
                        const datalist = document.getElementById('collaborators-list');
                        datalist.innerHTML = '';
                        colaboradores.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.nome;
                            datalist.appendChild(option);
                        });
                        document.getElementById('attendant-modal').classList.remove('hidden');
                    }
                    
                    // L√≥gica para o bot√£o 'Delegar Finaliza√ß√£o' na coluna 'Em Atendimento'
                    if (button.classList.contains('delegate-finalization-btn')) {
                        assistedIdForDelegation = id;
                        assistedNameForDelegation = button.dataset.name;
                        collaboratorNameForDelegation = button.dataset.collaboratorName; // Get collaborator name
                        document.getElementById('delegate-assisted-name').textContent = assistedNameForDelegation;
                        
                        // Tenta preencher o e-mail do colaborador atribu√≠do
                        const assignedCollabId = button.dataset.collaboratorId;
                        const assignedCollab = colaboradores.find(c => c.id === assignedCollabId);
                        document.getElementById('collaborator-email-input').value = assignedCollab?.email || ''; // Preenche se encontrar, sen√£o vazio

                        document.getElementById('delegate-email-modal').classList.remove('hidden');
                    }

                    // L√≥gica para o bot√£o 'Finalizar Diretamente' na coluna 'Em Atendimento'
                    if (button.classList.contains('attend-directly-btn')) {
                        const attendantInput = document.getElementById('attendant-name');
                        attendantInput.value = button.dataset.collaboratorName || ''; // Preenche com o nome do colaborador j√° atribu√≠do
                        const datalist = document.getElementById('collaborators-list');
                        datalist.innerHTML = '';
                        colaboradores.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.nome;
                            datalist.appendChild(option);
                        });
                        assistedIdToHandle = id;
                        document.getElementById('attendant-modal').classList.remove('hidden');
                    }

                    if (button.classList.contains('faltou-btn')) { const assisted = allAssisted.find(a => a.id === id); logAction('MARK_FALTOSO', `Marcou ${assisted.name} como faltoso`, id); await updateDoc(docRef, getUpdatePayload({ status: 'faltoso' })); showNotification("Marcado como faltoso."); }
                    if (button.classList.contains('return-to-pauta-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta', arrivalTime: null, priority: null, assignedCollaborator: null, inAttendanceTime: null, room: null })); showNotification("Retornado para a pauta."); }
                    if (button.classList.contains('return-to-pauta-from-faltoso-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta' })); showNotification("Revertido para a pauta."); }
                    if (button.classList.contains('return-to-aguardando-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'aguardando', attendant: null, attendedTime: null, assignedCollaborator: null, inAttendanceTime: null })); showNotification("Retornado para aguardando."); }
                    if (button.classList.contains('return-to-aguardando-from-emAtendimento-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'aguardando', assignedCollaborator: null, inAttendanceTime: null })); showNotification("Retornado para aguardando."); }
                    if (button.classList.contains('delete-btn')) { if(confirm("Tem certeza que deseja apagar este registro permanentemente?")) { const assisted = allAssisted.find(a => a.id === id); const name = assisted ? assisted.name : 'Desconhecido'; logAction('DELETE_ASSISTED', `Apagou o assistido: ${name}`, id); await deleteDoc(docRef); showNotification("Registro apagado."); }}
                    if (button.classList.contains('priority-btn')) { assistedIdToHandle = id; document.getElementById('priority-reason-modal').classList.remove('hidden'); }
                    if (button.classList.contains('unpriority-btn')) { 
                        if(confirm("Tem certeza que deseja remover o status de Prioridade Urgente? A prioridade ser√° recalculada.")) {
                            await updateDoc(docRef, getUpdatePayload({ priority: null, priorityReason: null })); 
                            showNotification("Prioridade Urgente removida. Recalculando prioridade."); 
                        }
                    }
                    if (button.classList.contains('edit-assisted-btn')) { 
                        assistedIdToHandle = id; 
                        const assisted = allAssisted.find(a => a.id === id); 
                        if(assisted){ 
                            document.getElementById('edit-assisted-name').value = assisted.name; 
                            document.getElementById('edit-assisted-cpf').value = assisted.cpf || ''; 
                            document.getElementById('edit-assisted-subject').value = assisted.subject; 
                            document.getElementById('edit-scheduled-time').value = assisted.scheduledTime || '';
                            document.getElementById('edit-assisted-modal').classList.remove('hidden');
                        } 
                    }
                    if (button.classList.contains('edit-attendant-btn')) {
                        assistedIdToHandle = id;
                        const assisted = allAssisted.find(a => a.id === id);
                        if (assisted) {
                            document.getElementById('edit-attendant-name').value = assisted.attendant || '';
                            document.getElementById('edit-attendant-modal').classList.remove('hidden');
                        }
                    }
                   // NOVO C√ìDIGO
                    if (button.classList.contains('view-details-btn')) {
                        openDetailsModal({
                            assistedId: id,
                            pautaId: currentPautaId,
                            allAssisted: allAssisted
                        });
                    }
                    if (button.classList.contains('manage-demands-btn')) {
                        assistedIdToHandle = id;
                        showDemandsModal(id);
                    }

                    // L√≥gica para os novos bot√µes de "Confirmado"
                    if (button.classList.contains('toggle-confirmed-atendido') || button.classList.contains('toggle-confirmed-faltoso')) {
                        const currentAssisted = allAssisted.find(a => a.id === id);
                        const newConfirmedState = !(currentAssisted.isConfirmed || false); // Inverte o estado

                        await updateDoc(docRef, getUpdatePayload({
                            isConfirmed: newConfirmedState,
                            confirmationDetails: newConfirmedState ? { confirmedBy: currentUserName, confirmedAt: new Date().toISOString() } : null
                        }));
                        showNotification(`Status de Marcado Presen√ßa no Verde atualizado para ${newConfirmedState ? 'Confirmado' : 'N√£o Confirmado'}.`, 'info');
                    }

                    // NOVO: L√≥gica para "Voltar p/ Em Atendimento" de "Atendidos"
                    if (button.classList.contains('return-from-atendido-btn')) {
                        const currentAssisted = allAssisted.find(a => a.id === id);
                        let updateData = {
                            status: 'aguardando', // Padr√£o se n√£o for fluxo de delega√ß√£o
                            attendant: null,
                            attendedTime: null,
                            finalizadoPeloColaborador: false,
                            isConfirmed: false,
                            confirmationDetails: null
                        };

                        if (currentPautaData?.useDelegationFlow) {
                            // Se o fluxo de delega√ß√£o est√° ativo, volta para "Em Atendimento"
                            updateData.status = 'emAtendimento';
                            // Mant√©m o assignedCollaborator e inAttendanceTime que j√° estavam
                            updateData.attendant = currentAssisted.attendant; // Mant√©m o atendente que finalizou
                        }
                        
                        await updateDoc(docRef, getUpdatePayload(updateData));
                        showNotification(`Atendimento de ${currentAssisted.name} revertido para ${currentPautaData?.useDelegationFlow ? 'Em Atendimento' : 'Aguardando'}.`, 'info');
                    }

                }

                if (button.id === 'back-to-pautas-btn') {
                    if (unsubscribeFromAttendances) unsubscribeFromAttendances();
                    if (unsubscribeFromCollaborators) unsubscribeFromCollaborators();
                    currentPautaId = null;
                    allAssisted = [];
                    colaboradores = [];
                    showPautaSelectionScreen(auth.currentUser.uid);
                }
                if (button.id === 'reset-all-btn') {
                    document.getElementById('reset-confirm-modal').classList.remove('hidden');
                }
                if (button.id === 'edit-pauta-name-btn') {
                    const currentName = document.getElementById('pauta-title').textContent;
                    document.getElementById('edit-pauta-name-input').value = currentName;
                    document.getElementById('edit-pauta-modal').classList.remove('hidden');
                }
                if (button.id === 'manage-members-btn') {
                    await showMembersModal(); // Abre o modal de "Gerenciar Membros da Pauta"
                }

                // L√≥gica para abrir o modal de "Lista de Presen√ßa de Colaboradores"
               // L√≥gica para abrir o modal de "Lista de Presen√ßa de Colaboradores"
                if (btn.id === 'manage-collaborators-btn') {
                    // 1. Inicia o motor de escuta passando o DB e o que fazer com os dados
                    setupCollaboratorsListener(db, currentPautaId, (dados) => {
                        colaboradores = dados;
                        renderColaboradores(); // Fun√ß√£o que desenha a tabela no HTML
                    });
                
                    // 2. Limpa o formul√°rio para n√£o vir com dados de uma edi√ß√£o anterior
                    resetCollaboratorFormModal(); 
                
                    // 3. Abre o modal removendo o 'hidden'
                    const modalColab = document.getElementById('collaborators-modal');
                    if (modalColab) modalColab.classList.remove('hidden');
                }

              if (button.id === 'add-assisted-btn') {
    const name = document.getElementById('assisted-name').value.trim();
    if (!name) {
        showNotification("O nome √© obrigat√≥rio.", "error");
        return;
    }
    
    const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
    let isScheduled, hasArrived, scheduledTimeValue;

    if (currentMode === 'agendamento') {
        isScheduled = document.querySelector('input[name="is-scheduled"]:checked').value === 'yes';
        hasArrived = document.querySelector('input[name="has-arrived"]:checked').value === 'yes';
        scheduledTimeValue = isScheduled ? document.getElementById('scheduled-time').value : null;

        // Adicionada valida√ß√£o para o hor√°rio agendado.
        if (isScheduled && !scheduledTimeValue && !hasArrived) { // S√≥ √© obrigat√≥rio se for agendado e AINDA n√£o chegou
            showNotification("Por favor, informe o hor√°rio agendado.", "error");
            return;
        }
    } else { 
        isScheduled = false;
        hasArrived = true;
        scheduledTimeValue = null;
    }

    let arrivalDate = null;
    if (hasArrived) {
        const timeInput = document.getElementById('arrival-time').value;
        const [hours, minutes] = timeInput.split(':');
        arrivalDate = new Date();
        arrivalDate.setHours(hours, minutes);
    }
    
    // Captura a sala se for avulso e multi-sala
    let assignedRoom = null;
    if (currentMode !== 'agendamento' && currentPautaData?.type === 'multisala') {
        assignedRoom = document.getElementById('manual-room-select').value;
    }

    const newAssisted = getUpdatePayload({
        name,
        cpf: document.getElementById('assisted-cpf').value.trim(),
        subject: document.getElementById('assisted-subject').value.trim(),
        type: currentMode,
        status: hasArrived ? 'aguardando' : 'pauta',
        scheduledTime: scheduledTimeValue,
        arrivalTime: hasArrived ? arrivalDate.toISOString() : null,
        assignedCollaborator: null, // Novo campo
        inAttendanceTime: null, // Novo campo
        finalizadoPeloColaborador: false, // Novo campo
        isConfirmed: false, // Novo campo
        confirmationDetails: null, // Novo campo
        room: assignedRoom, // Salva a sala se for avulso
        indexManual: allAssisted.length, // Coloca no final da fila por padr√£o
        createdAt: new Date().toISOString()
    });

    await addDoc(collectionRef, newAssisted);
    showNotification("Assistido adicionado com sucesso!");
    document.getElementById('form-agendamento').reset();
    document.getElementById('scheduled-time-wrapper').classList.add('hidden');
    document.getElementById('arrival-time-wrapper').classList.add('hidden');
}

                if (button.id === 'confirm-arrival-btn') {
                    const arrivalTimeInput = document.getElementById('arrival-time-input').value;
                    if (!arrivalTimeInput) { showNotification("Por favor, informe o hor√°rio.", "error"); return; }
                    const [hours, minutes] = arrivalTimeInput.split(':');
                    const arrivalDate = new Date();
                    arrivalDate.setHours(hours, minutes, 0, 0);

                    // --- IN√çCIO DA CORRE√á√ÉO ---
                    let roomData = null;
                    // Se for pauta multi-salas, pega o valor do select
                    if (currentPautaData?.type === 'multisala') {
                        roomData = document.getElementById('arrival-room-select').value;
                    }

                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        status: 'aguardando', 
                        arrivalTime: arrivalDate.toISOString(),
                        room: roomData // <--- ADICIONADO: Agora salva a sala no banco
                    }));
                    // --- FIM DA CORRE√á√ÉO ---

                    button.closest('.fixed').classList.add('hidden');
                }
                
                // L√≥gica do novo modal de sele√ß√£o de colaborador
                if (button.id === 'confirm-select-collaborator-btn') {
                    const selectedCollaboratorRadio = document.querySelector('#collaborator-selection-list input[name="selectedCollaborator"]:checked');
                    let collaboratorData = null; // Default to null

                    if (selectedCollaboratorRadio && selectedCollaboratorRadio.value !== 'null') {
                        const collaboratorId = selectedCollaboratorRadio.value;
                        const collaboratorName = selectedCollaboratorRadio.dataset.name;
                        collaboratorData = { id: collaboratorId, name: collaboratorName };
                        showNotification(`${assistedNameToHandle} atribu√≠do a ${collaboratorName}.`);
                    } else {
                        showNotification(`${assistedNameToHandle} movido para 'Em Atendimento' sem colaborador atribu√≠do.`);
                    }

                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({
                        status: 'emAtendimento',
                        assignedCollaborator: collaboratorData, // Assign null or the selected collaborator
                        inAttendanceTime: new Date().toISOString()
                    }));
                    document.getElementById('select-collaborator-modal').classList.add('hidden');
                }

                // A√ß√£o de confirmar atendimento (antiga, agora para "Finalizar Diretamente")
                // NOVO C√ìDIGO SUGERIDO (Linha 1845)
                if (button.id === 'confirm-attendant-btn') {
                    const attendantName = document.getElementById('attendant-name').value.trim();
                    
                    // 1. Tenta encontrar o colaborador completo na lista (incluindo cargo e equipe)
                    const selectedCollab = colaboradores.find(c => c.nome === attendantName);
                    
                    let attendantData;
                
                    if (selectedCollab) {
                        // Se encontrado, usa o objeto completo
                        attendantData = { nome: selectedCollab.nome, cargo: selectedCollab.cargo, equipe: selectedCollab.equipe };
                    } else {
                        // Se n√£o encontrado, usa o nome como string (cair√° em 'Sem Grupo' se for o caso)
                        attendantData = attendantName;
                    }
                
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        status: 'atendido', 
                        // ATUALIZA√á√ÉO: Salva o objeto completo se encontrado, sen√£o salva o nome string.
                        attendant: attendantData, 
                        attendedTime: new Date().toISOString() 
                    }));
                    
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-priority-reason-btn') {
                    const reason = document.getElementById('priority-reason-input').value.trim();
                    if (!reason) { showNotification("O motivo √© obrigat√≥rio.", "error"); return; }
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ priority: 'URGENTE', priorityReason: reason }));
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-edit-assisted-btn') {
                    const name = document.getElementById('edit-assisted-name').value.trim();
                    if (!name) { showNotification("O nome n√£o pode ficar em branco.", "error"); return; }
                    const updatedData = {
                        name,
                        cpf: document.getElementById('edit-assisted-cpf').value.trim(),
                        subject: document.getElementById('edit-assisted-subject').value.trim(),
                        scheduledTime: document.getElementById('edit-scheduled-time').value || null,
                    };
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload(updatedData));
                    button.closest('.fixed').classList.add('hidden');
                }
                // NOVO C√ìDIGO SUGERIDO (Linha 1897)
                if (button.id === 'confirm-edit-attendant-btn') {
                    const attendantName = document.getElementById('edit-attendant-name').value.trim();
                    
                    // 1. Tenta encontrar o colaborador completo na lista
                    const selectedCollab = colaboradores.find(c => c.nome === attendantName);
                    
                    let attendantData;
                
                    if (selectedCollab) {
                        attendantData = { nome: selectedCollab.nome, cargo: selectedCollab.cargo, equipe: selectedCollab.equipe };
                    } else {
                        attendantData = attendantName;
                    }
                
                    await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ 
                        // ATUALIZA√á√ÉO: Salva o objeto completo se encontrado
                        attendant: attendantData 
                    }));
                    
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-reset-btn') {
                    const attendanceCollectionRef = collection(db, "pautas", currentPautaId, "attendances");
                    const snapshot = await getDocs(attendanceCollectionRef);
                    if(snapshot.empty) {
                        showNotification("A pauta j√° est√° vazia.", "info");
                        button.closest('.fixed').classList.add('hidden');
                        return;
                    }
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showNotification("Pauta zerada com sucesso.", "success");
                    button.closest('.fixed').classList.add('hidden');
                }
                if (button.id === 'confirm-edit-pauta-btn') {
                    const newName = document.getElementById('edit-pauta-name-input').value.trim();
                    if (newName && currentPautaId) {
                        await updateDoc(doc(db, "pautas", currentPautaId), { name: newName });
                        document.getElementById('pauta-title').textContent = newName;
                        showNotification("Nome da pauta atualizado.");
                        button.closest('.fixed').classList.add('hidden');
                    } else {
                        showNotification("O nome n√£o pode ser vazio.", "error");
                    }
                }
                if(button.id === 'invite-member-btn') {
                    const email = document.getElementById('invite-email-input').value.trim().toLowerCase();
                    const statusDiv = document.getElementById('invite-status');
                    if (!email) { statusDiv.textContent = 'Por favor, insira um email.'; return; }
                    
                    statusDiv.textContent = 'Verificando...';
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        inviteStatus.textContent = 'Usu√°rio n√£o encontrado.';
                        return;
                    }
                    
                    const userDoc = querySnapshot.docs[0];
                    const pautaRef = doc(db, "pautas", currentPautaId);

                    await updateDoc(pautaRef, {
                        members: arrayUnion(userDoc.id),
                        memberEmails: arrayUnion(email)
                    });
                    
                    inviteStatus.textContent = `Usu√°rio ${email} convidado!`;
                    document.getElementById('invite-email-input').value = '';
                    showMembersModal(); // Atualiza a lista no modal
                }
                if(button.classList.contains('remove-member-btn')) {
                    const email = button.dataset.email;
                    if (confirm(`Tem certeza que deseja remover ${email} desta pauta?`)) {
                        const usersRef = collection(db, "users");
                        const q = query(usersRef, where("email", "==", email));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            const userIdToRemove = querySnapshot.docs[0].id;
                            const pautaRef = doc(db, "pautas", currentPautaId);
                            try {
                                await updateDoc(pautaRef, {
                                    members: arrayRemove(userIdToRemove),
                                    memberEmails: arrayRemove(email)
                                });
                                showNotification(`Membro ${email} removido da pauta.`);
                                showMembersModal(); // Atualiza a lista no modal
                            } catch (error) {
                                console.error("Erro ao remover membro:", error);
                                showNotification("Erro ao remover membro.", "error");
                            }
                        }
                    }
                }
                
                // Usar os IDs atualizados para o modal de demandas
                if (button.id === 'demands-modal-add-demand-btn') {
                    const input = document.getElementById('demands-modal-new-demand-input');
                    const text = input.value.trim();
                    if(text) {
                        const demandsListContainer = document.getElementById('demands-modal-list-container');
                        if(demandsListContainer.querySelector('p.text-gray-500')) { // Verifica se √© a mensagem de "Nenhuma demanda"
                            demandsListContainer.innerHTML = '';
                        }
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 bg-white rounded-md text-sm';
                        li.textContent = text;
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs font-semibold ml-2';
                        removeBtn.textContent = 'Remover';
                        li.appendChild(removeBtn);
                        demandsListContainer.appendChild(li);
                        input.value = '';
                    }
                }
                if (button.classList.contains('remove-demand-item-btn')) {
                    const li = button.parentElement;
                    li.remove();
                    const demandsListContainer = document.getElementById('demands-modal-list-container'); // Usar ID atualizado
                    if (demandsListContainer.children.length === 0) {
                         demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
                    }
                }
                if (button.id === 'save-demands-btn') {
                    const demandsListContainer = document.getElementById('demands-modal-list-container'); // Usar ID atualizado
                    const items = demandsListContainer.querySelectorAll('li');
                    const descricoes = Array.from(items).map(li => li.firstChild.textContent);
                    const demandsData = {
                        quantidade: descricoes.length,
                        descricoes: descricoes
                    };
                    const docRef = doc(collectionRef, assistedIdToHandle);
                    await updateDoc(docRef, getUpdatePayload({ demandas: demandsData }));
                    showNotification("Demandas salvas com sucesso!", "success");
                    document.getElementById('demands-modal').classList.add('hidden');
                }

                if (button.id.startsWith('cancel-') || button.id.startsWith('close-')) {
                    const modal = button.closest('.fixed');
                    if (modal) {
                       modal.classList.add('hidden');
                    }
                }
                if (button.id === 'close-documents-modal-btn' || button.id === 'cancel-checklist-btn') {
                     document.getElementById('documents-modal').classList.add('hidden');
                }
                // Adicionado: Bot√µes de cancelamento para o novo modal de sele√ß√£o de colaborador
                if (button.id === 'cancel-select-collaborator-btn') {
                    document.getElementById('select-collaborator-modal').classList.add('hidden');
                }
                // Adicionado: Bot√µes de cancelamento para o novo modal de delega√ß√£o por e-mail
                if (button.id === 'cancel-delegate-email-btn') {
                    document.getElementById('delegate-email-modal').classList.add('hidden');
                }


                if (button.classList.contains('toggle-details-btn')) {
                    const card = button.closest('div.p-4');
                    const details = card.querySelector('.card-details');
                    const icon = button.querySelector('svg');
                    details.classList.toggle('hidden');
                    icon.style.transform = details.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                }
                
                if (button.id === 'close-pauta-btn') {
                    document.getElementById('close-modal-title').textContent = 'Fechar Pauta';
                    document.getElementById('close-modal-message').textContent = 'Para fechar esta pauta, confirme sua senha. Nenhum membro poder√° fazer altera√ß√µes at√© que voc√™ a reabra.';
                    document.getElementById('close-pauta-password').value = '';
                    document.getElementById('confirm-close-pauta-btn').textContent = 'Confirmar';
                    document.getElementById('close-pauta-modal').classList.remove('hidden');
                }

                if (button.id === 'reopen-pauta-btn') {
                    document.getElementById('close-modal-title').textContent = 'Reabrir Pauta';
                    document.getElementById('close-modal-message').textContent = 'Para reabrir esta pauta, confirme sua senha.';
                    document.getElementById('close-pauta-password').value = '';
                    document.getElementById('confirm-close-pauta-btn').textContent = 'Reabrir';
                    document.getElementById('close-pauta-modal').classList.remove('hidden');
                }

                if (button.id === 'confirm-close-pauta-btn') {
                    const password = document.getElementById('close-pauta-password').value;
                    const errorDiv = document.getElementById('close-auth-error');
                    errorDiv.classList.add('hidden');

                    const isReopen = button.textContent.includes('Reabrir');
                    const user = auth.currentUser;
                    if (!user || user.uid !== currentPautaOwnerId) {
                         showNotification("Voc√™ n√£o tem permiss√£o para esta a√ß√£o.", "error");
                         document.getElementById('close-pauta-modal').classList.add('hidden');
                         return;
                    }

                    try {
                        const credential = EmailAuthProvider.credential(user.email, password);
                        await reauthenticateWithCredential(user, credential);
                        
                        const pautaRef = doc(db, "pautas", currentPautaId);
                        await updateDoc(pautaRef, { isClosed: !isReopen });
                        isPautaClosed = !isReopen;
                        togglePautaLock(isPautaClosed);

                        const action = isReopen ? 'REOPEN_PAUTA' : 'CLOSE_PAUTA'; //LOG DE VERIFICA√á√ÉO PT1
                        logAction(action, `${isReopen ? 'Reabriu' : 'Fechou'} a pauta ${currentPautaId}`, currentPautaId); //LOG DE VERIFICA√á√ÉO PT2
                        
                        showNotification(`Pauta ${isReopen ? 'reaberta' : 'fechada'} com sucesso.`);
                        document.getElementById('close-pauta-modal').classList.add('hidden');
                    } catch (error) {
                         console.error("Authentication failed:", error);
                         errorDiv.textContent = 'Senha incorreta. Tente novamente.';
                         errorDiv.classList.remove('hidden');
                    }
                }
            });

            document.getElementById('checklist-search').addEventListener('input', (e) => {
                const searchTerm = normalizeText(e.target.value);
                const allDocs = checklistContainer.querySelectorAll('li');
                allDocs.forEach(li => {
                    const labelText = normalizeText(li.textContent);
                    if (labelText.includes(searchTerm)) {
                        li.style.display = 'block';
                    } else {
                        li.style.display = 'none';
                    }
                });
            });

            // Adiciona a l√≥gica de autocompletar e formata√ß√£o ao campo de assunto na modal de edi√ß√£o
            const editSubjectInput = document.getElementById('edit-assisted-subject');
            editSubjectInput.addEventListener('change', () => {
                const originalValue = editSubjectInput.value;
                let selectedText = originalValue;
                
                if (selectedText.includes(' > ')) {
                    const parts = selectedText.split(' > ');
                    selectedText = parts[parts.length - 1];
                }
                
                editSubjectInput.value = selectedText;
            });
    </script>

<!-- Modal de Anota√ß√µes -->
<div id="notes-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
  <div class="bg-white rounded-xl p-6 w-96 shadow-lg">
    <h2 class="text-lg font-semibold text-gray-700 mb-3">Minhas Anota√ß√µes</h2>
    <textarea id="notes-text" class="w-full h-40 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500"></textarea>
    <div class="mt-4 flex justify-end gap-2">
      <button id="save-notes-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Salvar</button>
      <button id="close-notes-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirma√ß√£o (necess√°rio para as novas funcionalidades) -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Confirma√ß√£o</h2>
        <p id="modal-text" class="mb-6 text-gray-600">Tem certeza que deseja realizar esta a√ß√£o?</p>
        <div class="flex justify-end space-x-4">
            <button id="cancel-action" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
            <button id="confirm-action" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>

  const notesBtn = document.getElementById("notes-btn");
  const notesModal = document.getElementById("notes-modal");
  const closeNotesBtn = document.getElementById("close-notes-btn");
  const saveNotesBtn = document.getElementById("save-notes-btn");
  const notesText = document.getElementById("notes-text");

  const confirmModal = document.getElementById('confirm-modal');
  const modalText = document.getElementById('modal-text');
  const confirmActionBtn = document.getElementById('confirm-action');
  const cancelActionBtn = document.getElementById('cancel-action');
  let actionToConfirm = null;

  function showConfirmModal(callback, message) {
    modalText.innerHTML = message;
    confirmModal.classList.remove('hidden'); // Use classList.remove para Tailwind CSS
    actionToConfirm = callback;
  }

  if (confirmActionBtn) {
    confirmActionBtn.addEventListener('click', () => {
        if (actionToConfirm) {
            actionToConfirm();
        }
        confirmModal.classList.add('hidden');
        actionToConfirm = null;
    });
  }

  if (cancelActionBtn) {
    cancelActionBtn.addEventListener('click', () => {
        confirmModal.classList.add('hidden');
        actionToConfirm = null;
    });
  }


  notesBtn.addEventListener("click", () => {
    const saved = localStorage.getItem("pauta_notes") || "";
    notesText.value = saved;
    notesModal.classList.remove("hidden");
  });

  closeNotesBtn.addEventListener("click", () => {
    notesModal.classList.add("hidden");
  });

  saveNotesBtn.addEventListener("click", () => {
    localStorage.setItem("pauta_notes", notesText.value);
    alert("Anota√ß√£o salva!");
    notesModal.classList.add("hidden");
  });

// Envio de E-mail de Delega√ß√£o (Modular)
document.getElementById('send-delegate-email-btn').addEventListener('click', async () => {
    const collaboratorEmail = document.getElementById('collaborator-email-input').value.trim();
    if (!collaboratorEmail) return showNotification("Insira o e-mail.", "error");

    try {
        await sendDelegationEmail({
            toEmail: collaboratorEmail,
            assistedName: assistedNameForDelegation,
            collaboratorName: collaboratorNameForDelegation,
            pautaId: currentPautaId,
            assistedId: assistedIdForDelegation,
            senderName: currentUserName,
            senderEmail: auth.currentUser?.email
        });
        showNotification("Link enviado por e-mail!");
        document.getElementById('delegate-email-modal').classList.add('hidden');
    } catch (error) {
        showNotification("Erro ao enviar e-mail.", "error");
    }
});

  // C. Envio autom√°tico de anota√ß√µes ao fechar a pauta (Modular)
const closePautaBtn = document.getElementById("close-pauta-btn");
if (closePautaBtn) {
    closePautaBtn.addEventListener("click", async () => {
        // Aguarda um tempo para verificar se o modal de senha fechou (sucesso no fechamento)
        setTimeout(async () => {
            const isPasswordModalHidden = document.getElementById('close-pauta-modal').classList.contains('hidden');
            
            if (isPasswordModalHidden) { 
                // Busca as anota√ß√µes do localStorage (chave original: pauta_notes)
                const notes = localStorage.getItem("pauta_notes") || "";
                
                if (notes.trim() !== "") {
                    try {
                        // Chama a fun√ß√£o do arquivo js/emailService.js
                        await sendNotesByEmail(notes, currentUserName, auth.currentUser?.email);
                        showNotification("Anota√ß√µes enviadas para seu e-mail por seguran√ßa!", "info");
                    } catch (err) {
                        console.error("Falha ao enviar backup das notas:", err);
                    }
                }
            }
        }, 1000); // 1 segundo de delay para garantir que o banco atualizou antes
    });
}
</script>
</html>











