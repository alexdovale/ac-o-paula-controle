<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pauta - SIGAP</title>
    
    <link rel="icon" type="image/png" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">

    <meta name="theme-color" content="#16a34a"/>
    <link rel="apple-touch-icon" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .priority-urgente { border-left: 5px solid #ef4444; }
        .priority-maxima { border-left: 5px solid #22c55e; }
        .priority-media { border-left: 5px solid #f97316; }
        .priority-minima { border-left: 5px solid #6b7280; }
        .column-content::-webkit-scrollbar, .scrollable-content::-webkit-scrollbar, #policy-content::-webkit-scrollbar, #checklist-container::-webkit-scrollbar, #members-list-container::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-track, .scrollable-content::-webkit-scrollbar-track, #policy-content::-webkit-scrollbar-track, #checklist-container::-webkit-scrollbar-track, #members-list-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .column-content::-webkit-scrollbar-thumb, .scrollable-content::-webkit-scrollbar-thumb, #policy-content::-webkit-scrollbar-thumb, #checklist-container::-webkit-scrollbar-thumb, #members-list-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; }
        .tab-active { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; font-weight: 600; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-container" class="loading-container"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-700 font-semibold text-center">Conectando...</p></div>

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <img src="https://alexdovale.github.io/ac-o-paula-controle/imagem.png" alt="Logo SIGAP" class="mx-auto h-24 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Sistema de Gerenciamento de Pauta</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 text-center font-semibold text-green-600 border-b-2 border-green-600">Login</button>
                <button id="register-tab-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">Cadastrar</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div class="text-right">
                    <a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Entrar</button>
            </form>
            <form id="register-form" class="hidden space-y-4">
                <div><label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Criar Conta</button>
            </form>
            <a href="#" id="privacy-policy-link" class="block mt-4 text-center text-sm text-gray-500 hover:underline">
                    Política de Privacidade
            </a>
        </div>
    </div>

    <div id="pauta-selection-container" class="hidden max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Gerenciamento de Pauta - SIGAP</h1>
        </div>
        <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">Minhas Pautas</h2>
              <div>
                  <button id="admin-btn-main" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Painel do Admin</button>
                  <button id="logout-btn-main" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Sair</button>
              </div>
        </div>
        <div id="install-container" class="hidden my-4 p-3 bg-green-100 border border-green-200 rounded-lg text-center">
            <p class="text-sm text-green-800">Leve o gerenciador de pautas com você!</p>
            <button id="install-button" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 text-sm rounded-lg shadow-md hover:shadow-lg transition-all">
                Instalar App
            </button>
        </div>
        
        <div id="invitations-container" class="hidden mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Convites Pendentes</h2>
            <div id="pending-invitations-list" class="space-y-4"></div>
        </div>
        <div id="pautas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6"><button id="create-pauta-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Criar Nova Pauta</button></div>
    </div>
    
    <div id="app-container" class="max-w-full mx-auto hidden">
        <header class="mb-6 space-y-4">
            <div class="flex justify-center items-center w-full relative">
                 <h1 class="text-xl font-semibold text-gray-600 text-center">Sistema de Gerenciamento de Pauta - SIGAP</h1>
                 <button id="logout-btn-app" title="Sair" class="absolute top-0 right-0 bg-gray-600 text-white font-bold p-2 rounded-lg hover:bg-gray-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                             <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                             <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                         </svg>
                 </button>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                <div class="relative flex justify-center items-center border-b pb-4">
                    <h2 id="pauta-title" class="text-2xl md:text-3xl font-bold text-gray-800 text-center px-8 truncate"></h2>
                    <button id="edit-pauta-name-btn" title="Editar nome da pauta" class="hidden absolute right-0 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 transition flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5h6a.5.5 0 0 0 0-1h-6A1.5 1.5 0 0 0 1 2.5v11z"/>
                        </svg>
                   </button>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center w-full gap-4 pt-4">
                    <div class="flex-shrink-0">
                        <button id="back-to-pautas-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <button id="manage-members-btn" class="bg-lime-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-lime-700">Membros</button>
                        <button id="reset-all-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Zerar</button>
                    </div>
                </div>
            </div>
        </header>
        <div id="app-content">
              <div class="mb-6">
                  <div class="border-b border-gray-200">
                      <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                          <button id="tab-agendamento" class="tab-active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Agendado</button>
                          <button id="tab-avulso" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Avulso</button>
                      </nav>
                  </div>
              </div>
            <form id="form-agendamento" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 id="form-title" class="text-xl font-semibold text-gray-700">Adicionar Novo Agendamento</h2>
                    <div id="agendamento-actions" class="flex items-center gap-4">
                        <a href="#" id="format-help-link" class="text-sm text-green-600 hover:text-green-800 hover:underline transition-colors duration-300 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.95-11.05a.9.9 0 0 1 .023 1.272l-.2.204a.9.9 0 0 1-1.273-.226L6.451 4.95a.9.9 0 0 1 1.273-.023l.204.2zM8 8.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                            <span>Como converter minha pauta?</span>
                        </a>
                        <label for="file-upload" class="cursor-pointer bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition text-sm inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Carregar Pauta (CSV)
                        </label>
                        <input type="file" id="file-upload" class="hidden" accept=".csv">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col lg:col-span-2">
                            <label for="assisted-name" class="mb-1 font-medium text-gray-600">Nome do Assistido</label>
                            <input type="text" id="assisted-name" placeholder="Ex: João da Silva" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                        </div>
                        <div class="flex flex-col"><label for="assisted-cpf" class="mb-1 font-medium text-gray-600">CPF (Opcional)</label><input type="text" id="assisted-cpf" placeholder="___.___.___-__" maxlength="14" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                        <div class="flex flex-col lg:col-span-4"><label for="assisted-subject" class="mb-1 font-medium text-gray-600">Matéria - Assunto</label><input type="text" id="assisted-subject" placeholder="Ex: Divórcio" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                    </div>

                    <div id="form-options-container" class="border-t mt-4 pt-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div id="is-scheduled-container">
                            <label class="font-medium text-gray-700">Possui horário agendado?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="is-scheduled" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="is-scheduled" value="no" class="mr-1" checked> Não</label>
                            </div>
                            <div id="scheduled-time-wrapper" class="hidden mt-2">
                                <label for="scheduled-time" class="block mb-1 font-medium text-gray-600">Horário Agendado</label>
                                <input type="time" id="scheduled-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Assistido já chegou?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="has-arrived" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="has-arrived" value="no" class="mr-1" checked> Não</label>
                            </div>
                            <div id="arrival-time-wrapper" class="hidden mt-2">
                                <label for="arrival-time" class="block mb-1 font-medium text-gray-600">Horário de Chegada</label>
                                <input type="time" id="arrival-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                    </div>
                     <button type="button" id="add-assisted-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md w-full lg:w-auto">Adicionar</button>
                </div>
            </form>
            <main id="main-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="pauta-column" class="bg-white rounded-lg shadow-md flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>📋 Pauta</span>
                            <span id="pauta-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="pauta-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="pauta-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                           <span>⏳ Aguardando Atendimento</span>
                           <span id="aguardando-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="aguardando-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="aguardando-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                             <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center w-full">
                                <span>✅ Atendidos</span>
                                <span id="atendidos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                            <button id="download-pdf-btn" class="ml-4 flex-shrink-0 bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm">Baixar PDF</button>
                        </div>
                        <input type="search" id="atendidos-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="atendidos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                 <div id="faltosos-column" class="bg-white rounded-lg shadow-md flex-col hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                🚫 Faltosos
                                <span id="faltosos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                        </div>
                        <input type="search" id="faltosos-search" placeholder="Pesquisar..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="faltosos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
            </main>
            <div class="mt-8 flex justify-center">
                <button id="toggle-faltosos-btn" class="w-full sm:w-auto bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Ver Faltosos</button>
            </div>
              <footer class="mt-12 bg-white p-6 rounded-lg shadow-md">
                  <h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Entenda a Ordem de Atendimento</h3>
                  <div class="text-center mb-4">
                      <button id="toggle-logic-btn" class="text-green-600 hover:text-green-800 text-sm hover:underline transition-colors duration-300">Por que esta ordem é justa? (Clique para expandir)</button>
                  </div>
                  <div id="logic-explanation" class="hidden mt-4 text-left p-4 bg-gray-50 rounded-lg border space-y-3">
                      <p>A lógica foi pensada para balancear a <strong>pontualidade</strong> com a <strong>realidade</strong> do dia a dia, criando um sistema justo para todos.</p>
                      <ul class="list-disc list-inside space-y-2 text-gray-700">
                          <li><strong>Recompensa a Pontualidade:</strong> Valoriza quem chega no horário, atendendo-os primeiro. Para assistidos que chegam adiantados, a ordem de atendimento respeita o horário original do agendamento.</li>
                          <li><strong>Oferece Tolerância:</strong> Reconhece que imprevistos acontecem, com uma janela de 20 minutos para pequenos atrasos.</li>
                          <li><strong>Gerencia Atrasos Maiores:</strong> Coloca quem se atrasou muito no fim da fila para não prejudicar os outros.</li>
                          <li><strong>Permite Flexibilidade:</strong> O botão "Prioridade" garante que casos graves sejam atendidos imediatamente.</li>
                          <li><strong>Critério de Desempate:</strong> Para assistidos com a mesma prioridade, a ordem é definida pelo <strong>horário de chegada informado</strong> (quem chegou mais cedo é atendido primeiro). Se dois ou mais assistidos chegarem exatamente no mesmo horário, a preferência é de quem teve a chegada <strong>registrada primeiro</strong> no sistema.</li>
                      </ul>
                      <p class="font-semibold text-gray-800 pt-2">O resultado é uma fila transparente, previsível e justa tanto para os assistidos quanto para a equipe.</p>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center mt-4">
                      <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500"><p class="font-bold text-red-700">Prioridade Urgente</p><p class="text-sm text-gray-600 mt-1">Definida manualmente para casos que necessitam de atendimento imediato.</p></div>
                      <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"><p class="font-bold text-green-700">Prioridade Máxima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram no horário agendado ou adiantados.</p></div>
                      <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500"><p class="font-bold text-orange-700">Prioridade Média</p><p class="text-sm text-gray-600 mt-1">Assistidos agendados com até 20 min de atraso ou atendimentos avulsos.</p></div>
                      <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500"><p class="font-bold text-gray-700">Prioridade Mínima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram com 30 minutos ou mais de atraso.</p></div>
                  </div>
                  <p class="text-center text-sm text-gray-500 mt-8">Desenvolvido por Alex do Vale e o Gemini</p>
              </footer>
        </div>
    </div>

    <!-- MODAIS -->
    <div id="create-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Criar Nova Pauta</h2>
            <label for="create-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nome da Pauta</label>
            <input type="text" id="create-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-create-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-create-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Criar</button>
            </div>
        </div>
    </div>
    <div id="members-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg" style="max-height: 90vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Membros</h2>
                <button id="close-members-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700">Convidar Novo Membro</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="invite-email-input" placeholder="email@exemplo.com" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="invite-member-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex-shrink-0">Convidar</button>
                    </div>
                    <div id="invite-status" class="text-sm h-4"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Membros Atuais</h3>
                    <div id="members-list-container" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Member list will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="arrival-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Confirmar Horário de Chegada</h2><p class="mb-4 text-gray-600">Por favor, informe o horário de chegada do assistido.</p><input type="time" id="arrival-time-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-arrival-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-arrival-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Finalizar Atendimento</h2><p class="mb-4 text-gray-600">Insira o nome do profissional que realizou o atendimento (opcional).</p><input type="text" id="attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg space-y-4"><h2 class="text-2xl font-bold text-gray-800">Zerar Pauta</h2><p class="text-gray-600">Tem certeza de que deseja apagar permanentemente todos os dados desta pauta?</p><div class="flex justify-end space-x-4 pt-4"><button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-reset-btn" class="bg-red-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-800">Zerar Pauta</button></div></div>
    </div>
    <div id="edit-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Nome da Pauta</h2>
            <label for="edit-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Novo nome</label>
            <input type="text" id="edit-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="format-help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl relative flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0">
                <button id="close-format-help-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                <h2 class="text-2xl font-bold mb-4">Como Preparar sua Pauta para Importação</h2>
            </div>
            <div class="flex-grow overflow-y-auto scrollable-content pr-4">
                <p class="mb-4 text-gray-600">Para importar seus agendamentos de uma vez, crie um arquivo <strong>.csv</strong> (Valores Separados por Vírgula). Você pode criar este arquivo usando o Bloco de Notas, Excel, Google Sheets ou similar.</p>
                
                <div class="flex justify-between items-center mb-2">
                     <p class="font-semibold">O arquivo deve seguir o formato abaixo, com 4 colunas, nesta ordem:</p>
                     <button id="copy-csv-format-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Formato</button>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg text-sm mb-4">
                    <code id="csv-format-code">Nome Completo do Assistido;HH:MM;Matéria do Assunto;CPF(opcional)</code>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">Exemplo:</h3>
                    <button id="copy-csv-example-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Exemplo</button>
                </div>
                <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="csv-example-code">Maria Joaquina de Amaral Pereira;09:00;Divórcio Consensual;111.222.333-44
João da Silva;09:30;Ação de Alimentos;
Fulano de Tal;10:00;Curatela;444.555.666-77</code></pre>
                <ul class="list-disc list-inside mt-4 space-y-2 text-gray-700">
                    <li>A primeira linha (cabeçalho) é <strong>opcional</strong>. O sistema a ignorará se presente.</li>
                    <li>O campo <strong>CPF</strong> é opcional. Se não houver CPF, deixe o espaço em branco (ou não coloque nada após o último ponto e vírgula).</li>
                    <li>O <strong>horário</strong> deve estar no formato <strong>HH:MM</strong> (Ex: 09:00, 14:30).</li>
                    <li>Salve o arquivo com a extensão <strong>.csv</strong>.</li>
                </ul>

                <div class="mt-6 pt-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Prompt para IA (Ex: ChatGPT, Gemini):</h3>
                        <button id="copy-ai-prompt-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Prompt</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">Se sua pauta está em um PDF, copie o texto abaixo e cole junto com o conteúdo do seu PDF em uma IA para formatá-lo corretamente.</p>
                    <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="ai-prompt-code">Olá! Por favor, converta o conteúdo do arquivo PDF que estou enviando para o formato CSV, usando ponto e vírgula (;) como separador. O resultado deve seguir este padrão:

Nome Completo do Assistido;HH:MM;Matéria do Assunto;CPF(opcional)

Por favor, me entregue o texto pronto para que eu possa salvar em um arquivo .csv.</code></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Atendente</h2>
            <input type="text" id="edit-attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="demands-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Demandas Adicionais</h2>
                <button id="close-demands-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <p class="mb-4">Assistido: <strong id="demands-assisted-name-modal" class="text-green-600"></strong></p>
                <div class="space-y-2">
                    <label for="new-demand-input" class="block text-sm font-medium text-gray-700">Adicionar nova demanda:</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-demand-input" placeholder="Ex: Ação de Partilha de Bens" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="add-demand-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex-shrink-0">Adicionar</button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Demandas Adicionais Registradas:</h3>
                    <div id="demands-list-container" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6 flex-shrink-0 border-t pt-4">
                <button id="cancel-demands-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                <button id="save-demands-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Alterações</button>
            </div>
        </div>
    </div>
    <div id="edit-assisted-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
         <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Editar Dados do Assistido</h2>
            <div class="space-y-4">
                <div><label for="edit-assisted-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit-assisted-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-cpf" class="block text-sm font-medium text-gray-700">CPF</label><input type="text" id="edit-assisted-cpf" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-subject" class="block text-sm font-medium text-gray-700">Assunto</label><input type="text" id="edit-assisted-subject" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-scheduled-time" class="block text-sm font-medium text-gray-700">Horário Agendado</label><input type="time" id="edit-scheduled-time" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-edit-assisted-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-assisted-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Alterações</button>
            </div>
        </div>
    </div>
    <div id="priority-reason-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Atendimento Prioritário</h2>
            <p class="mb-4 text-gray-600">Por favor, informe o motivo da prioridade.</p>
            <textarea id="priority-reason-input" placeholder="Motivo..." class="w-full p-3 border border-gray-300 rounded-lg mb-6 h-24"></textarea>
            <div class="flex justify-end space-x-4">
                <button id="cancel-priority-reason-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-priority-reason-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar Prioridade</button>
            </div>
        </div>
    </div>
     <div id="privacy-policy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 80vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Política de Privacidade</h2>
                <button id="close-policy-modal-btn-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="policy-content" class="text-gray-700 space-y-4 overflow-y-auto pr-2">
                <p><strong>1. Natureza do Sistema e Ciclo de Vida dos Dados</strong></p>
                <p>O Sistema de Gerenciamento de Pauta (SIGAP) é uma interface de controle para a gestão de atendimentos. Ele coleta e armazena os dados pessoais de assistidos, como nome, CPF (opcional), assunto e demanda, por um período de sete dias após a finalização da ação. Após esse prazo, os dados são permanentemente excluídos do SIGAP.</p>
                <p>Para o armazenamento permanente, todos os dados são enviados e salvos no sistema Verde, que é de responsabilidade da Defensoria Pública do Estado do Rio de Janeiro (DPERJ) e está em total conformidade com a LGPD.</p>
                
                <p><strong>2. Dados Coletados pelo SIGAP</strong></p>
                <p>Para permitir o uso da interface, o SIGAP coleta apenas os dados de autenticação dos usuários (profissionais): e-mail e senha.</p>
                
                <p><strong>3. Tratamento e Proteção de Dados (dentro do SIGAP)</strong></p>
                <p>Os dados de autenticação são utilizados para garantir o acesso restrito e seguro ao sistema. Os dados de assistidos são armazenados por apenas sete dias, tempo necessário para a conclusão da ação, e são protegidos por medidas de segurança para evitar acesso não autorizado.</p>
                
                <p><strong>4. Direitos dos Titulares dos Dados</strong></p>
                <p>Os direitos dos assistidos, como acesso, correção e exclusão de dados, são garantidos e exercidos diretamente por meio do sistema Verde, que é o responsável pelo armazenamento final. Os usuários do SIGAP podem gerenciar a pauta e solicitar alterações no sistema Verde conforme as normas da DPERJ.</p>

                <p><strong>5. Origem e Transferência de Dados dos Assistidos</strong></p>
                <p>Os dados dos assistidos gerenciados no SIGAP podem ter duas origens:</p>
                <p><strong>Importação do Sistema Verde:</strong> A maior parte dos dados (nome, horário, assunto) é transferida manualmente do sistema oficial Verde (DPERJ) através de um processo de exportação e importação. Neste fluxo, o CPF do assistido não é transferido.</p>
                <p><strong>Cadastro Direto no SIGAP:</strong> Novos atendimentos, como os avulsos, podem ser registrados diretamente na plataforma. Nesses casos, o campo CPF é opcional e pode ser preenchido pelo profissional responsável pelo cadastro (criador ou membro da pauta).</p>
                <p>O processo de transferência manual consiste na exportação da pauta do sistema Verde, quando houver pauta previamente cadastrada, sua conversão para um formato compatível e a importação do arquivo final no SIGAP. Cabe ao usuário responsável pela transferência garantir a segurança dos dados durante este processo, incluindo a exclusão segura dos arquivos intermediários (como PDFs e CSVs) de seus dispositivos locais após a importação bem-sucedida. O SIGAP não se responsabiliza pelo manuseio dos dados fora de sua plataforma, mas orienta todos os usuários a seguirem as melhores práticas de segurança para proteger a privacidade dos assistidos.</p>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button id="close-policy-modal-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Fechar</button>
            </div>
        </div>
    </div>

    <div id="documents-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">
                    Detalhes para <span id="documents-assisted-name" class="text-green-600"></span>
                </h2>
                <button id="close-documents-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div id="document-action-selection" class="flex-grow overflow-y-auto scrollable-content pr-2">
                <p class="text-gray-600 mb-4">Selecione o tipo de ação para ver a lista de documentos necessários:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button data-action="alimentos_fixacao" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">1. Ação de Alimentos (Fixação)</span>
                    </button>
                    <button data-action="alimentos_oferta" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">2. Ação de Oferta de Alimentos</span>
                    </button>
                    <button data-action="alimentos_exoneracao" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">3. Exoneração de Alimentos</span>
                    </button>
                    <button data-action="alimentos_revisional" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">4. Revisional de Alimentos</span>
                    </button>
                    <button data-action="divorcio_litigioso" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">5. Ação de Divórcio Litigioso</span>
                    </button>
                    <button data-action="divorcio_consensual" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">6. Ação de Divórcio Consensual</span>
                    </button>
                     <button data-action="guarda_visitas" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">7. Guarda e Regul. de Visitas</span>
                    </button>
                    <button data-action="paternidade" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">8. Investigação de Paternidade</span>
                    </button>
                    <button data-action="uniao_estavel" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">9. União Estável (Rec./Diss.)</span>
                    </button>
                </div>
            </div>

            <div id="document-checklist-view" class="hidden flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <button id="back-to-action-selection-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                        <h3 id="checklist-title" class="text-xl font-bold text-gray-800"></h3>
                    </div>
                    <div class="flex space-x-4">
                        <button id="cancel-checklist-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                        <button id="save-checklist-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </div>
                 <div class="mb-4 flex-shrink-0">
                    <input type="search" id="checklist-search" placeholder="Pesquisar documento..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                </div>
                <div id="checklist-container" class="space-y-4 overflow-y-auto pr-2 flex-grow border rounded-lg p-4 bg-gray-50" style="max-height: 55vh;">
                    <!-- O checklist será renderizado aqui -->
                </div>
            </div>
        </div>
    </div>


    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, getDoc, setDoc, query, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Variáveis Globais
let db, auth, allAssisted = [], currentPautaId = null, unsubscribeFromAttendances = () => {}, currentUserName = '', currentPautaOwnerId = null;
let assistedIdToHandle = null;
let currentChecklistAction = null;

const loadingContainer = document.getElementById('loading-container');
const loginContainer = document.getElementById('login-container');
const pautaSelectionContainer = document.getElementById('pauta-selection-container');
const appContainer = document.getElementById('app-container');
const loadingText = document.getElementById('loading-text');

const normalizeText = (str) => {
    if (!str) return '';
    return str.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
};

const getPriorityClass = (priority) => ({'URGENTE':'priority-urgente','Máxima':'priority-maxima','Média':'priority-media','Mínima':'priority-minima'}[priority]||'');

const getUpdatePayload = (data) => {
    return {
        ...data,
        lastActionBy: currentUserName,
        lastActionTimestamp: new Date().toISOString()
    };
};

const getPriorityLevel = (assisted) => {
    if (!assisted || assisted.status !== 'aguardando') return 'N/A';
    if (assisted.priority === 'URGENTE') return 'URGENTE';

    if (assisted.type === 'avulso') return 'Média';

    if (!assisted.scheduledTime || !assisted.arrivalTime) return 'Média';

    const scheduled = new Date(`1970-01-01T${assisted.scheduledTime}`);
    const arrival = new Date(assisted.arrivalTime);
    const arrivalTime = new Date(`1970-01-01T${arrival.toTimeString().slice(0, 5)}`);

    const diffMinutes = (arrivalTime - scheduled) / (1000 * 60);

    if (diffMinutes <= 0) return 'Máxima'; 
    if (diffMinutes <= 20) return 'Média';
    return 'Mínima';
};

const renderAssistedList = () => {
    allAssisted.forEach(a => {
        if (a.status === 'aguardando' && a.priority !== 'URGENTE') {
            a.priority = getPriorityLevel(a);
        }
    });

    const pautaList = document.getElementById('pauta-list');
    const aguardandoList = document.getElementById('aguardando-list');
    const atendidosList = document.getElementById('atendidos-list');
    const faltososList = document.getElementById('faltosos-list');
    [pautaList, aguardandoList, atendidosList, faltososList].forEach(el => el.innerHTML = '');

    const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
    
    const pautaSearchTerm = normalizeText(document.getElementById('pauta-search').value);
    const aguardandoSearchTerm = normalizeText(document.getElementById('aguardando-search').value);
    const atendidosSearchTerm = normalizeText(document.getElementById('atendidos-search').value);
    const faltososSearchTerm = normalizeText(document.getElementById('faltosos-search').value);
    
    const searchFilter = (assisted, term) => !term || normalizeText(assisted.name).includes(term) || (assisted.cpf && normalizeText(assisted.cpf).includes(term)) || normalizeText(assisted.subject).includes(term);

    const pauta = allAssisted.filter(a => a.status === 'pauta' && a.type === 'agendamento' && searchFilter(a, pautaSearchTerm));
    const aguardando = allAssisted.filter(a => a.status === 'aguardando' && a.type === currentMode && searchFilter(a, aguardandoSearchTerm));
    const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === currentMode && searchFilter(a, atendidosSearchTerm));
    const faltosos = allAssisted.filter(a => a.status === 'faltoso' && a.type === 'agendamento' && searchFilter(a, faltososSearchTerm));

    pauta.sort((a, b) => (a.scheduledTime || '23:59').localeCompare(b.scheduledTime || '23:59'));
    atendidos.sort((a, b) => new Date(b.attendedTime) - new Date(a.attendedTime));
    faltosos.sort((a, b) => (a.scheduledTime || '00:00').localeCompare(b.scheduledTime || '00:00'));
    
    aguardando.sort((a, b) => {
        const order = { 'URGENTE': 0, 'Máxima': 1, 'Média': 2, 'Mínima': 3 };
        const priorityDiff = order[a.priority] - order[b.priority];
        if (priorityDiff !== 0) return priorityDiff;

        if (a.priority === 'Máxima' && a.type === 'agendamento') {
            const scheduledA = a.scheduledTime || '23:59';
            const scheduledB = b.scheduledTime || '23:59';
            if (scheduledA.localeCompare(scheduledB) !== 0) return scheduledA.localeCompare(scheduledB);
        }

        const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
        const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
        if (arrivalA !== arrivalB) return arrivalA - arrivalB;
        
        return (a.createdAt || 0) - (b.createdAt || 0);
    });
    
    document.getElementById('pauta-count').textContent = pauta.length;
    document.getElementById('aguardando-count').textContent = aguardando.length;
    document.getElementById('faltosos-count').textContent = faltosos.length;
    document.getElementById('atendidos-count').textContent = atendidos.length;

    const render = (el, data, generator) => {
        if(data.length === 0) el.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
        else data.forEach((item, index) => el.appendChild(generator(item, index)));
    };
    
    render(pautaList, pauta, a => {
        const card = document.createElement('div');
        card.className = 'relative bg-gray-50 p-4 rounded-lg shadow-sm border';
        card.innerHTML = `
            <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
            <p class="font-bold text-lg">${a.name}</p>
            ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${a.cpf}</strong></p>` : ''}
            <p>Assunto: <strong>${a.subject}</strong></p>
            <p>Agendado: <strong>${a.scheduledTime}</strong></p>
            <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                <button data-id="${a.id}" class="check-in-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Marcar Chegada</button>
                <button data-id="${a.id}" class="faltou-btn bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600">Faltou</button>
                <button data-id="${a.id}" class="edit-assisted-btn col-span-2 bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600">Editar Dados</button>
            </div>
            ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : ''}
        `;
        return card;
    });
    
    render(aguardandoList, aguardando, (a, index) => {
        const card = document.createElement('div');
        card.className = `relative bg-white p-4 rounded-lg shadow-sm ${getPriorityClass(a.priority)}`;
        const arrival = a.type === 'agendamento' && a.scheduledTime ? `Agendado: ${a.scheduledTime} | Chegou: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` : `Chegada: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
        const returnToPautaBtn = a.type === 'agendamento' ? `<button data-id="${a.id}" class="return-to-pauta-btn w-full bg-gray-400 text-white font-semibold py-1 rounded-lg hover:bg-gray-500 text-xs mt-1">Voltar p/ Pauta</button>` : '';
        card.innerHTML = `
            <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-lg">${index + 1}. ${a.name}</p>
                    <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                    <p class="text-sm text-gray-500">${arrival}</p>
                    <button data-id="${a.id}" class="view-details-btn text-indigo-600 hover:text-indigo-800 text-sm hover:underline font-semibold py-1">Ver Detalhes</button>
                </div>
            </div>
            <div class="mt-3 grid grid-cols-2 lg:grid-cols-3 gap-2">
                <button data-id="${a.id}" class="attend-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>
                ${a.priority !== 'URGENTE' ? `<button data-id="${a.id}" class="priority-btn bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 text-sm">Prioridade</button>` : ''}
                <button data-id="${a.id}" class="edit-assisted-btn bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600 text-sm">Editar</button>
            </div>
            ${returnToPautaBtn ? `<div class="mt-2">${returnToPautaBtn}</div>` : ''}
            ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : ''}
            `;
        return card;
    });
    
    render(atendidosList, atendidos, a => {
        const card = document.createElement('div');
        card.className = 'relative bg-green-50 p-4 rounded-lg shadow-sm border-green-200';
        const totalAssuntos = 1 + (a.demandas?.quantidade ? Number(a.demandas.quantidade) : 0);
        const demandasInfo = a.demandas?.descricoes?.length > 0 ? `<div class="mt-2 text-xs bg-gray-100 p-2 rounded"><strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong><ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${d}</li>`).join('')}</ul></div>` : '';
        card.innerHTML = `
            <div class="flex justify-between items-start">
                <p class="font-bold text-lg">${a.name} ${totalAssuntos > 1 ? `<span class="text-sm font-medium text-green-600">(${totalAssuntos} assuntos)</span>` : ''}</p>
            </div>
            <div class="card-details mt-2 space-y-2">
                ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                <p class="text-sm">Assunto Principal: <strong>${a.subject}</strong></p>
                <div class="text-xs text-gray-600 grid grid-cols-3 gap-2 text-center border-y py-2">
                    <div><strong>Agendado:</strong><br>${a.scheduledTime || 'N/A'}</div>
                    <div><strong>Chegou:</strong><br>${a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                    <div><strong>Finalizado:</strong><br>${a.attendedTime ? new Date(a.attendedTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                </div>
                ${demandasInfo}
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm">Por: <strong>${a.attendant || 'Não informado'}</strong></p>
                    <div class="flex items-center gap-1 flex-wrap">
                        <button data-id="${a.id}" class="manage-demands-btn text-blue-600 hover:text-blue-800 font-semibold text-xs py-1 px-2 rounded hover:bg-blue-100">Demandas</button>
                        <button data-id="${a.id}" class="edit-assisted-btn text-gray-600 hover:text-gray-800 font-semibold text-xs py-1 px-2 rounded hover:bg-gray-100">Dados</button>
                        <button data-id="${a.id}" class="edit-attendant-btn text-green-600 hover:text-green-800 font-semibold text-xs py-1 px-2 rounded hover:bg-green-100">Atendente</button>
                        <button data-id="${a.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold text-xs py-1 px-2 rounded hover:bg-red-100">Deletar</button>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t flex justify-between items-center">
                    ${a.lastActionBy ? `<p class="text-xs text-gray-500">Última ação por: <strong>${a.lastActionBy}</strong></p>` : '<div></div>'}
                    <button data-id="${a.id}" class="return-to-aguardando-btn bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600 text-xs">Voltar p/ Aguardando</button>
                </div>
            </div>
            <div class="text-right mt-1">
                 <button class="toggle-details-btn text-gray-500 hover:text-gray-800 p-1">
                     <svg class="pointer-events-none" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                 </button>
            </div>`;
        return card;
    });

    render(faltososList, faltosos, a => {
        const card = document.createElement('div');
        card.className = 'relative bg-red-50 p-4 rounded-lg shadow-sm border-red-200';
        card.innerHTML = `
            <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5zM6 6.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm-5 1a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1h-6z"/></svg></button>
            <p class="font-bold text-lg">${a.name}</p>
            <div class="mt-2 space-y-2">
                ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                <p class="text-sm">Agendado: <strong>${a.scheduledTime}</strong></p>
                <div class="mt-3">
                    <button data-id="${a.id}" class="return-to-pauta-from-faltoso-btn w-full bg-gray-500 text-white font-semibold py-1 rounded-lg hover:bg-gray-600 text-xs">Reverter para Pauta</button>
                </div>
            </div>
            ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : ''}
        `;
        return card;
    });
};

const showNotification = (message, type = 'success') => {
    const colors = { info: 'blue', error: 'red', success: 'green' };
    const notification = document.createElement('div');
    notification.className = `fixed top-5 right-5 bg-${colors[type]}-500 text-white py-3 px-6 rounded-lg shadow-lg z-[100] transition-transform transform translate-x-full`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    requestAnimationFrame(() => {
        notification.classList.remove('translate-x-full');
    });

    setTimeout(() => {
        notification.classList.add('translate-x-full');
        notification.addEventListener('transitionend', () => notification.remove());
    }, 3000);
};

const setupRealtimeListener = (pautaId) => {
    if (unsubscribeFromAttendances) unsubscribeFromAttendances();
    const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
    unsubscribeFromAttendances = onSnapshot(attendanceCollectionRef, (snapshot) => {
        allAssisted = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAssistedList();
    }, (error) => console.error("Erro no listener do Firestore: ", error));
};

const loadPauta = async (pautaId, pautaName) => {
    currentPautaId = pautaId;
    document.getElementById('pauta-title').textContent = pautaName;
    const pautaDoc = await getDoc(doc(db, "pautas", pautaId));
    if (pautaDoc.exists()) {
        const pautaData = pautaDoc.data();
        currentPautaOwnerId = pautaData.owner;
        if (pautaData.owner === auth.currentUser.uid) {
            document.getElementById('edit-pauta-name-btn').classList.remove('hidden');
        } else {
            document.getElementById('edit-pauta-name-btn').classList.add('hidden');
        }
    }
    setupRealtimeListener(pautaId);
    showScreen('app');
};

c/**
 * Exclui uma pauta do Firestore.
 * Em uma aplicação real, seria ideal ter um modal de confirmação customizado
 * antes de executar a exclusão.
 * @param {string} pautaId - O ID do documento da pauta a ser excluída.
 */
const deletePauta = async (pautaId) => {
    try {
        // As funções 'doc' e 'deleteDoc' devem ser importadas do Firestore.
        await deleteDoc(doc(db, "pautas", pautaId));
        // A UI será atualizada automaticamente pelo onSnapshot.
    } catch (error) {
        console.error("Erro ao excluir a pauta:", error);
        // Aqui, seria bom notificar o usuário sobre o erro com um componente de UI.
    }
};

/**
 * Cria um elemento de card para uma pauta específica.
 * Esta função previne vulnerabilidades de Cross-Site Scripting (XSS)
 * ao usar `textContent` em vez de `innerHTML` para dados dinâmicos.
 * @param {import("firebase/firestore").QueryDocumentSnapshot} docSnap - O snapshot do documento da pauta.
 * @returns {HTMLDivElement} O elemento do card da pauta.
 */
const createPautaCard = (docSnap) => {
    const pauta = docSnap.data();
    const card = document.createElement('div');
    card.className = "relative bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col justify-between h-full";

    // --- Botão de Excluir ---
    const deleteButton = document.createElement('button');
    deleteButton.className = "absolute top-3 right-3 p-1 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500";
    deleteButton.setAttribute('aria-label', 'Excluir pauta');
    // SVG do ícone de lixeira
    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

    deleteButton.addEventListener('click', (event) => {
        event.stopPropagation(); // Impede que o clique no botão ative o clique no card
        deletePauta(docSnap.id);
    });

    card.appendChild(deleteButton); // Adiciona o botão ao card

    // --- Cálculo de Datas ---
    const creationDate = pauta.createdAt?.toDate ? pauta.createdAt.toDate() : new Date();
    const expirationDate = new Date(creationDate);
    expirationDate.setDate(creationDate.getDate() + 7); // Adiciona 7 dias para a data de expiração

    const formattedCreationDate = creationDate.toLocaleDateString('pt-BR');
    const formattedExpirationDate = expirationDate.toLocaleDateString('pt-BR');

    // --- Criação de Elementos (Seguro contra XSS) ---
    const contentDiv = document.createElement('div');

    const title = document.createElement('h3');
    title.className = "font-bold text-xl mb-2";
    title.textContent = pauta.name; // Usar textContent é crucial para segurança

    const members = document.createElement('p');
    members.className = "text-gray-600";
    members.textContent = `Membros: ${pauta.memberEmails?.length || 1}`;

    contentDiv.appendChild(title);
    contentDiv.appendChild(members);

    const footerDiv = document.createElement('div');
    footerDiv.className = "mt-4 pt-2 border-t border-gray-200";

    const createdP = document.createElement('p');
    createdP.className = "text-xs text-gray-500";
    createdP.innerHTML = `Criada em: <strong>${formattedCreationDate}</strong>`;

    const expiresP = document.createElement('p');
    expiresP.className = "text-xs text-red-600";
    expiresP.innerHTML = `Será eliminada em: <strong>${formattedExpirationDate}</strong>`;

    footerDiv.appendChild(createdP);
    footerDiv.appendChild(expiresP);

    card.appendChild(contentDiv);
    card.appendChild(footerDiv);

    // Adiciona o evento de clique para carregar a pauta selecionada
    card.addEventListener('click', () => loadPauta(docSnap.id, pauta.name));
    return card;
};


/**
 * Exibe a tela de seleção de pautas, buscando e renderizando as pautas do usuário.
 * @param {string} userId - O ID do usuário logado.
 */
const showPautaSelectionScreen = (userId) => {
    const pautasList = document.getElementById('pautas-list');
    pautasList.innerHTML = '<p class="col-span-full text-center">Carregando pautas...</p>';

    const q = query(collection(db, "pautas"), where("members", "array-contains", userId));

    // 'onSnapshot' ouve por atualizações em tempo real.
    onSnapshot(q, (snapshot) => {
        pautasList.innerHTML = ''; // Limpa a lista antes de adicionar os novos itens

        if (snapshot.empty) {
            pautasList.innerHTML = '<p class="col-span-full text-center text-gray-500">Você ainda não tem pautas. Crie uma para começar.</p>';
            return;
        }

        // Usar um DocumentFragment melhora a performance ao adicionar muitos elementos ao DOM
        const fragment = document.createDocumentFragment();
        snapshot.docs.forEach((docSnap) => {
            const card = createPautaCard(docSnap);
            fragment.appendChild(card);
        });
        pautasList.appendChild(fragment);

    }, (error) => { // Adicionado tratamento de erro para a consulta
        console.error("Erro ao buscar pautas:", error);
        pautasList.innerHTML = '<p class="col-span-full text-center text-red-500">Ocorreu um erro ao carregar as pautas. Tente novamente mais tarde.</p>';
    });

    showScreen('pautaSelection');
};




const handleAuthState = () => {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().status === 'approved') {
                currentUserName = userDoc.data().name || user.email;
                showPautaSelectionScreen(user.uid);
            } else {
                 loadingText.innerHTML = 'Sua conta está pendente de aprovação. <br> Por favor, aguarde.';
                 document.querySelector('.loader').style.display = 'none';
            }
        } else {
            showScreen('login');
        }
    });
};

const showScreen = (screenName) => {
    loadingContainer.classList.toggle('hidden', screenName !== 'loading');
    loginContainer.classList.toggle('hidden', screenName !== 'login');
    pautaSelectionContainer.classList.toggle('hidden', screenName !== 'pautaSelection');
    appContainer.classList.toggle('hidden', screenName !== 'app');
};

const switchTab = (tabName) => {
    const tabAgendamento = document.getElementById('tab-agendamento');
    const tabAvulso = document.getElementById('tab-avulso');
    const isScheduledContainer = document.getElementById('is-scheduled-container');
    const formTitle = document.getElementById('form-title');
    const pautaColumn = document.getElementById('pauta-column');

    if (tabName === 'agendamento') {
        tabAgendamento.classList.add('tab-active');
        tabAvulso.classList.remove('tab-active', 'text-gray-500', 'hover:text-gray-700');
        isScheduledContainer.classList.remove('hidden');
        pautaColumn.classList.remove('hidden');
        formTitle.textContent = "Adicionar Novo Agendamento";
    } else { // avulso
        tabAvulso.classList.add('tab-active');
        tabAgendamento.classList.remove('tab-active');
        tabAgendamento.classList.add('text-gray-500', 'hover:text-gray-700');
        isScheduledContainer.classList.add('hidden');
        pautaColumn.classList.add('hidden');
        formTitle.textContent = "Adicionar Atendimento Avulso";
        
        document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
        document.querySelector('input[name="has-arrived"][value="yes"]').checked = true;
        document.getElementById('scheduled-time-wrapper').classList.add('hidden');
        document.getElementById('arrival-time-wrapper').classList.remove('hidden');
    }
    renderAssistedList();
};

const main = () => {
    try {
        const firebaseConfig = { apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.appspot.com", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25" };
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        handleAuthState();
    } catch (error) {
        console.error("Erro ao inicializar o Firebase: ", error);
        loadingText.textContent = 'Erro na configuração do Firebase.';
    }
};

const copyToClipboard = (text, message) => {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
        document.execCommand('copy');
        showNotification(message, 'info');
    } catch (err) {
        showNotification('Erro ao copiar.', 'error');
    }
    document.body.removeChild(textArea);
};

const setupModalClosers = () => {
    document.querySelectorAll('.fixed.inset-0').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });
};

document.addEventListener('DOMContentLoaded', () => {
    main();
    setupModalClosers();
    
    // --- LÓGICA DE LOGIN/CADASTRO ---
    const loginTabBtn = document.getElementById('login-tab-btn');
    const registerTabBtn = document.getElementById('register-tab-btn');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    loginTabBtn.addEventListener('click', () => {
        loginTabBtn.classList.add('border-green-600', 'text-green-600');
        loginTabBtn.classList.remove('text-gray-500');
        registerTabBtn.classList.remove('border-green-600', 'text-green-600');
        registerTabBtn.classList.add('text-gray-500');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
    });

    registerTabBtn.addEventListener('click', () => {
        registerTabBtn.classList.add('border-green-600', 'text-green-600');
        registerTabBtn.classList.remove('text-gray-500');
        loginTabBtn.classList.remove('border-green-600', 'text-green-600');
        loginTabBtn.classList.add('text-gray-500');
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('auth-error');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            errorDiv.classList.add('hidden');
        } catch (error) {
            console.error("Login failed:", error);
            errorDiv.textContent = 'Email ou senha inválidos.';
            errorDiv.classList.remove('hidden');
        }
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorDiv = document.getElementById('auth-error');

        if (password.length < 6) {
            errorDiv.textContent = 'A senha deve ter pelo menos 6 caracteres.';
            errorDiv.classList.remove('hidden');
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            await setDoc(doc(db, "users", user.uid), {
                name: name,
                email: email,
                uid: user.uid,
                status: 'approved',
                createdAt: new Date().toISOString()
            });
            
            errorDiv.classList.add('hidden');
            showNotification('Conta criada com sucesso! Agora você pode fazer o login.', 'success');
            loginTabBtn.click();
            
        } catch (error) {
            console.error("Registration failed:", error);
            errorDiv.textContent = error.code === 'auth/email-already-in-use' ? 'Este email já está em uso.' : 'Ocorreu um erro ao criar a conta.';
            errorDiv.classList.remove('hidden');
        }
    });

    document.getElementById('forgot-password-link').addEventListener('click', (e) => {
        e.preventDefault();
        const email = prompt("Por favor, digite seu email para redefinir a senha:");
        if (email) {
            sendPasswordResetEmail(auth, email)
                .then(() => showNotification("Email de redefinição de senha enviado!", "success"))
                .catch((error) => {
                    console.error("Password reset error:", error);
                    showNotification("Erro ao enviar email. Verifique se o email está correto.", "error");
                });
        }
    });

    document.getElementById('create-pauta-btn').addEventListener('click', () => {
        document.getElementById('create-pauta-modal').classList.remove('hidden');
    });
    document.getElementById('cancel-create-pauta-btn').addEventListener('click', () => {
        document.getElementById('create-pauta-modal').classList.add('hidden');
    });
    document.getElementById('confirm-create-pauta-btn').addEventListener('click', async () => {
        const pautaName = document.getElementById('create-pauta-name-input').value.trim();
        if (!pautaName) {
            showNotification("O nome da pauta não pode ser vazio.", "error");
            return;
        }
        const user = auth.currentUser;
        if (!user) {
             showNotification("Você precisa estar logado para criar uma pauta.", "error");
            return;
        }
        try {
            await addDoc(collection(db, "pautas"), {
                name: pautaName,
                owner: user.uid,
                ownerEmail: user.email,
                members: [user.uid],
                memberEmails: [user.email],
                createdAt: new Date().toISOString()
            });
            showNotification("Pauta criada com sucesso!");
            document.getElementById('create-pauta-name-input').value = '';
            document.getElementById('create-pauta-modal').classList.add('hidden');
        } catch (error) {
            console.error("Error creating pauta:", error);
            showNotification("Erro ao criar pauta.", "error");
        }
    });

    // --- LÓGICA DE EVENTOS GERAIS E MODAIS ---
    
    document.getElementById('privacy-policy-link').addEventListener('click', e => {
        e.preventDefault();
        document.getElementById('privacy-policy-modal').classList.remove('hidden');
    });

    const privacyModal = document.getElementById('privacy-policy-modal');
    if (privacyModal) {
        const closePolicyModal = () => privacyModal.classList.add('hidden');
        privacyModal.querySelector('#close-policy-modal-btn-x')?.addEventListener('click', closePolicyModal);
        privacyModal.querySelector('#close-policy-modal-btn')?.addEventListener('click', closePolicyModal);
    }

    document.getElementById('pauta-selection-container').addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-pauta-btn');
        if (!deleteBtn) return;
        
        e.stopPropagation(); 
        const pautaId = deleteBtn.dataset.pautaId;
        const pautaName = deleteBtn.dataset.pautaName;

        if (confirm(`Tem certeza que deseja apagar a pauta "${pautaName}" e todos os seus dados? Esta ação não pode ser desfeita.`)) {
            try {
                loadingText.textContent = `Apagando pauta "${pautaName}"...`;
                showScreen('loading');

                const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
                const attendanceSnapshot = await getDocs(attendanceCollectionRef);
                
                if (!attendanceSnapshot.empty) {
                    const batch = writeBatch(db);
                    attendanceSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit(); 
                }
                
                await deleteDoc(doc(db, "pautas", pautaId));
                
                showNotification(`Pauta "${pautaName}" apagada com sucesso.`);
                showScreen('pautaSelection');
            } catch (error) {
                console.error("Error deleting pauta:", error);
                showNotification("Erro ao apagar a pauta.", "error");
                showScreen('pautaSelection');
            }
        }
    });

    document.getElementById('format-help-link').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('format-help-modal').classList.remove('hidden');
    });
    
    document.getElementById('format-help-modal').addEventListener('click', e => {
        const buttonId = e.target.id;
        if (buttonId === 'copy-csv-format-btn') {
            const text = document.getElementById('csv-format-code').innerText;
            copyToClipboard(text, 'Formato copiado!');
        } else if (buttonId === 'copy-csv-example-btn') {
            const text = document.getElementById('csv-example-code').innerText;
            copyToClipboard(text, 'Exemplo copiado!');
        } else if (buttonId === 'copy-ai-prompt-btn') {
            const text = document.getElementById('ai-prompt-code').innerText;
            copyToClipboard(text, 'Prompt para IA copiado!');
        }
    });

    document.getElementById('tab-agendamento').addEventListener('click', () => switchTab('agendamento'));
    document.getElementById('tab-avulso').addEventListener('click', () => switchTab('avulso'));

    const handleLogout = () => {
        signOut(auth).catch(error => {
            console.error("Logout error", error);
            showNotification("Erro ao tentar sair.", "error");
        });
    };
    document.getElementById('logout-btn-main').addEventListener('click', handleLogout);
    document.getElementById('logout-btn-app').addEventListener('click', handleLogout);

    ['pauta-search', 'aguardando-search', 'atendidos-search', 'faltosos-search'].forEach(id => {
        document.getElementById(id).addEventListener('input', renderAssistedList);
    });

    document.getElementById('file-upload').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const text = e.target.result;
            let lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
            if (lines.length === 0) {
                showNotification("Arquivo vazio ou em formato inválido.", "error");
                return;
            }

            const firstLineParts = lines[0].split(';');
            if (firstLineParts.length >= 3) {
                 const potentialTime = firstLineParts[1].trim();
                 if (!/^\d{1,2}:\d{2}$/.test(potentialTime)) {
                    lines.shift();
                 }
            }
           
            if (lines.length === 0) {
                showNotification("O arquivo CSV contém apenas um cabeçalho ou está vazio.", "error");
                return;
            }

            try {
                const batch = writeBatch(db);
                const collectionRef = collection(db, "pautas", currentPautaId, "attendances");
                let processedCount = 0;
                
                lines.forEach(line => {
                    const parts = line.split(';').map(item => item.trim());
                     if (parts.length >= 3) {
                        const name = parts[0];
                        const scheduledTime = parts[1];
                        const subject = parts[2];
                        const cpf = parts.length > 3 ? parts[3] : '';

                        if (name && subject && scheduledTime && /^\d{1,2}:\d{2}$/.test(scheduledTime)) {
                            const newDocRef = doc(collectionRef);
                            batch.set(newDocRef, getUpdatePayload({
                                name,
                                cpf: cpf || null,
                                subject,
                                scheduledTime,
                                status: 'pauta',
                                type: 'agendamento',
                                createdAt: new Date().toISOString()
                            }));
                            processedCount++;
                        }
                    }
                });

                if (processedCount > 0) {
                    await batch.commit();
                    const skippedCount = lines.length - processedCount;
                    showNotification(`${processedCount} registros adicionados.` + (skippedCount > 0 ? ` ${skippedCount} linhas foram ignoradas.` : ''));
                } else {
                    showNotification("Nenhum registro válido encontrado no arquivo. Verifique o formato (Nome;HH:MM;Assunto;CPF).", "error");
                }
            } catch (err) {
                console.error("Erro ao carregar pauta:", err);
                showNotification("Erro ao processar o arquivo.", "error");
            }
        };
        reader.readAsText(file);
        event.target.value = ''; 
    });

    document.getElementById('download-pdf-btn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        
        const pautaName = document.getElementById('pauta-title').textContent;
        const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
        const atendidos = allAssisted
            .filter(a => a.status === 'atendido' && a.type === currentMode)
            .sort((a, b) => new Date(a.attendedTime) - new Date(b.attendedTime));

        if (atendidos.length === 0) {
            showNotification("Não há atendidos para gerar o relatório.", "info");
            return;
        }

        docPDF.setFontSize(18);
        docPDF.text(`Relatório de Atendidos - ${pautaName}`, 14, 22);
        docPDF.setFontSize(11);
        docPDF.setTextColor(100);

        const totalSubjects = atendidos.reduce((acc, a) => acc + 1 + (a.demandas?.quantidade || 0), 0);
        docPDF.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 30);
        docPDF.text(`Total de Atendidos: ${atendidos.length}`, 14, 36);
        docPDF.text(`Total de Assuntos: ${totalSubjects}`, 100, 36);


        const tableColumn = ["#", "Nome", "CPF", "Assunto Principal", "Atendente", "Finalizado", "Duração"];
        const tableRows = [];

        atendidos.forEach((item, index) => {
            let duration = 'N/A';
            if (item.arrivalTime && item.attendedTime) {
                const diffMs = new Date(item.attendedTime) - new Date(item.arrivalTime);
                const diffMins = Math.round(diffMs / 60000);
                 if (!isNaN(diffMins) && diffMins >= 0) {
                    duration = `${diffMins} min`;
                }
            }
            
            const cleanString = (str) => String(str || '').replace(/"/g, '');

            const rowData = [
                index + 1,
                cleanString(item.name),
                cleanString(item.cpf),
                cleanString(item.subject),
                cleanString(item.attendant) || 'N/A',
                new Date(item.attendedTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                duration
            ];
            tableRows.push(rowData);
        });

        docPDF.autoTable(tableColumn, tableRows, { startY: 42 });
        docPDF.save(`relatorio_${pautaName.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
    });

    document.getElementById('toggle-faltosos-btn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const pautaColumn = document.getElementById('pauta-column');
        const faltososColumn = document.getElementById('faltosos-column');

        pautaColumn.classList.toggle('hidden');
        faltososColumn.classList.toggle('hidden');
        
        if (faltososColumn.classList.contains('hidden')) {
            btn.textContent = 'Ver Faltosos';
            btn.classList.replace('bg-blue-600', 'bg-purple-600');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-purple-700');
        } else {
            btn.textContent = 'Ver Pauta';
            btn.classList.replace('bg-purple-600', 'bg-blue-600');
            btn.classList.replace('hover:bg-purple-700', 'hover:bg-blue-700');
        }
    });
    
    document.getElementById('toggle-logic-btn').addEventListener('click', (e) => {
        const explanationDiv = document.getElementById('logic-explanation');
        const isHidden = explanationDiv.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'Por que esta ordem é justa? (Clique para expandir)' : 'Ocultar explicação';
    });

    document.querySelectorAll('input[name="is-scheduled"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.getElementById('scheduled-time-wrapper').classList.toggle('hidden', e.target.value === 'no');
        });
    });
     document.querySelectorAll('input[name="has-arrived"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const wrapper = document.getElementById('arrival-time-wrapper');
            wrapper.classList.toggle('hidden', e.target.value === 'no');
            if (e.target.value === 'yes') {
                 document.getElementById('arrival-time').value = new Date().toTimeString().slice(0, 5);
            }
        });
    });
    
    const showMembersModal = async () => {
        if (!currentPautaId) return;
        const modal = document.getElementById('members-modal');
        const container = document.getElementById('members-list-container');
        container.innerHTML = 'Carregando...';
        modal.classList.remove('hidden');

        const pautaRef = doc(db, "pautas", currentPautaId);
        const pautaSnap = await getDoc(pautaRef);
        if (pautaSnap.exists()) {
            const pautaData = pautaSnap.data();
            currentPautaOwnerId = pautaData.owner;
            container.innerHTML = '';
            pautaData.memberEmails.forEach(email => {
                const isOwner = pautaData.ownerEmail === email;
                const memberEl = document.createElement('div');
                memberEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                memberEl.innerHTML = `
                    <span>${email} ${isOwner ? '<span class="text-xs text-yellow-600 font-bold">(dono)</span>' : ''}</span>
                    ${!isOwner ? `<button data-email="${email}" class="remove-member-btn text-red-500 hover:text-red-700 text-sm font-semibold">Remover</button>` : ''}
                `;
                container.appendChild(memberEl);
            });
        }
    };
    
    const showDemandsModal = (assistedId) => {
        const modal = document.getElementById('demands-modal');
        const assisted = allAssisted.find(a => a.id === assistedId);
        if (!assisted) return;

        document.getElementById('demands-assisted-name-modal').textContent = assisted.name;
        const demandsListContainer = document.getElementById('demands-list-container');
        demandsListContainer.innerHTML = ''; 

        const demands = assisted.demandas?.descricoes || [];
        if (demands.length === 0) {
            demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
        } else {
            demands.forEach(demandText => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-white rounded-md';
                li.textContent = demandText;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs';
                removeBtn.textContent = 'Remover';
                li.appendChild(removeBtn);
                demandsListContainer.appendChild(li);
            });
        }
        modal.classList.remove('hidden');
    };

    document.body.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;

        const id = button.dataset.id;
        const collectionRef = currentPautaId ? collection(db, "pautas", currentPautaId, "attendances") : null;
        
        if (id && collectionRef) {
            const docRef = doc(collectionRef, id);
            if (button.classList.contains('check-in-btn')) { assistedIdToHandle = id; document.getElementById('arrival-modal').classList.remove('hidden'); document.getElementById('arrival-time-input').value = new Date().toTimeString().slice(0,5); }
            if (button.classList.contains('attend-btn')) { assistedIdToHandle = id; document.getElementById('attendant-modal').classList.remove('hidden'); }
            if (button.classList.contains('faltou-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'faltoso' })); showNotification("Marcado como faltoso."); }
            if (button.classList.contains('return-to-pauta-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta', arrivalTime: null, priority: null })); showNotification("Retornado para a pauta."); }
            if (button.classList.contains('return-to-pauta-from-faltoso-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'pauta' })); showNotification("Revertido para a pauta."); }
            if (button.classList.contains('return-to-aguardando-btn')) { await updateDoc(docRef, getUpdatePayload({ status: 'aguardando', attendant: null, attendedTime: null })); showNotification("Retornado para aguardando."); }
            if (button.classList.contains('delete-btn')) { if(confirm("Tem certeza que deseja apagar este registro permanentemente?")) { await deleteDoc(docRef); showNotification("Registro apagado."); }}
            if (button.classList.contains('priority-btn')) { assistedIdToHandle = id; document.getElementById('priority-reason-modal').classList.remove('hidden'); }
            if (button.classList.contains('edit-assisted-btn')) { 
                assistedIdToHandle = id; 
                const assisted = allAssisted.find(a => a.id === id); 
                if(assisted){ 
                    document.getElementById('edit-assisted-name').value = assisted.name; 
                    document.getElementById('edit-assisted-cpf').value = assisted.cpf || ''; 
                    document.getElementById('edit-assisted-subject').value = assisted.subject; 
                    document.getElementById('edit-scheduled-time').value = assisted.scheduledTime || '';
                    document.getElementById('edit-assisted-modal').classList.remove('hidden');
                } 
            }
            if (button.classList.contains('edit-attendant-btn')) {
                assistedIdToHandle = id;
                const assisted = allAssisted.find(a => a.id === id);
                if (assisted) {
                    document.getElementById('edit-attendant-name').value = assisted.attendant || '';
                    document.getElementById('edit-attendant-modal').classList.remove('hidden');
                }
            }
            if (button.classList.contains('view-details-btn')) {
                assistedIdToHandle = id;
                const assisted = allAssisted.find(a => a.id === id);
                if (assisted) {
                    document.getElementById('documents-assisted-name').textContent = assisted.name;
                    document.getElementById('document-checklist-view').classList.add('hidden');
                    document.getElementById('document-action-selection').classList.remove('hidden');
                    document.getElementById('documents-modal').classList.remove('hidden');
                }
            }
            if (button.classList.contains('manage-demands-btn')) {
                assistedIdToHandle = id;
                showDemandsModal(id);
            }
        }

        if (button.id === 'back-to-pautas-btn') {
            if (unsubscribeFromAttendances) unsubscribeFromAttendances();
            currentPautaId = null;
            allAssisted = [];
            showPautaSelectionScreen(auth.currentUser.uid);
        }
        if (button.id === 'reset-all-btn') {
            document.getElementById('reset-confirm-modal').classList.remove('hidden');
        }
        if (button.id === 'edit-pauta-name-btn') {
            const currentName = document.getElementById('pauta-title').textContent;
            document.getElementById('edit-pauta-name-input').value = currentName;
            document.getElementById('edit-pauta-modal').classList.remove('hidden');
        }
        if (button.id === 'manage-members-btn') {
            await showMembersModal();
        }

        if (button.id === 'add-assisted-btn') {
            const name = document.getElementById('assisted-name').value.trim();
            if (!name) { showNotification("O nome é obrigatório.", "error"); return; }
            
            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
            let isScheduled, hasArrived, scheduledTimeValue;

            if (currentMode === 'agendamento') {
                isScheduled = document.querySelector('input[name="is-scheduled"]:checked').value === 'yes';
                hasArrived = document.querySelector('input[name="has-arrived"]:checked').value === 'yes';
                scheduledTimeValue = isScheduled ? document.getElementById('scheduled-time').value : null;
            } else { 
                isScheduled = false;
                hasArrived = true;
                scheduledTimeValue = null;
            }

            let arrivalDate = null;
            if (hasArrived) {
                const timeInput = document.getElementById('arrival-time').value;
                const [hours, minutes] = timeInput.split(':');
                arrivalDate = new Date();
                arrivalDate.setHours(hours, minutes, 0, 0);
            }
            
            const newAssisted = getUpdatePayload({
                name,
                cpf: document.getElementById('assisted-cpf').value.trim(),
                subject: document.getElementById('assisted-subject').value.trim(),
                type: currentMode,
                status: hasArrived ? 'aguardando' : 'pauta',
                scheduledTime: scheduledTimeValue,
                arrivalTime: hasArrived ? arrivalDate.toISOString() : null,
                createdAt: new Date().toISOString()
            });

            await addDoc(collectionRef, newAssisted);
            showNotification("Assistido adicionado com sucesso!");
            document.getElementById('form-agendamento').reset();
            document.getElementById('scheduled-time-wrapper').classList.add('hidden');
            document.getElementById('arrival-time-wrapper').classList.add('hidden');
        }

        if (button.id === 'confirm-arrival-btn') {
            const arrivalTimeInput = document.getElementById('arrival-time-input').value;
            if (!arrivalTimeInput) { showNotification("Por favor, informe o horário.", "error"); return; }
            const [hours, minutes] = arrivalTimeInput.split(':');
            const arrivalDate = new Date();
            arrivalDate.setHours(hours, minutes, 0, 0);

            await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ status: 'aguardando', arrivalTime: arrivalDate.toISOString() }));
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-attendant-btn') {
            const attendantName = document.getElementById('attendant-name').value.trim();
            await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ status: 'atendido', attendant: attendantName, attendedTime: new Date().toISOString() }));
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-priority-reason-btn') {
            const reason = document.getElementById('priority-reason-input').value.trim();
            if (!reason) { showNotification("O motivo é obrigatório.", "error"); return; }
            await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ priority: 'URGENTE', priorityReason: reason }));
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-edit-assisted-btn') {
            const name = document.getElementById('edit-assisted-name').value.trim();
            if (!name) { showNotification("O nome não pode ficar em branco.", "error"); return; }
            const updatedData = {
                name,
                cpf: document.getElementById('edit-assisted-cpf').value.trim(),
                subject: document.getElementById('edit-assisted-subject').value.trim(),
                scheduledTime: document.getElementById('edit-scheduled-time').value || null,
            };
            await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload(updatedData));
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-edit-attendant-btn') {
            const attendantName = document.getElementById('edit-attendant-name').value.trim();
            await updateDoc(doc(collectionRef, assistedIdToHandle), getUpdatePayload({ attendant: attendantName }));
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-reset-btn') {
            const attendanceCollectionRef = collection(db, "pautas", currentPautaId, "attendances");
            const snapshot = await getDocs(attendanceCollectionRef);
            if(snapshot.empty) {
                showNotification("A pauta já está vazia.", "info");
                button.closest('.fixed').classList.add('hidden');
                return;
            }
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            showNotification("Pauta zerada com sucesso.", "success");
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'confirm-edit-pauta-btn') {
            const newName = document.getElementById('edit-pauta-name-input').value.trim();
            if (newName && currentPautaId) {
                await updateDoc(doc(db, "pautas", currentPautaId), { name: newName });
                document.getElementById('pauta-title').textContent = newName;
                showNotification("Nome da pauta atualizado.");
                button.closest('.fixed').classList.add('hidden');
            } else {
                showNotification("O nome não pode ser vazio.", "error");
            }
        }
        if(button.id === 'invite-member-btn') {
            const email = document.getElementById('invite-email-input').value.trim().toLowerCase();
            const statusDiv = document.getElementById('invite-status');
            if (!email) { statusDiv.textContent = 'Por favor, insira um email.'; return; }
            
            statusDiv.textContent = 'Verificando...';
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                statusDiv.textContent = 'Usuário não encontrado.';
                return;
            }
            
            const userDoc = querySnapshot.docs[0];
            const pautaRef = doc(db, "pautas", currentPautaId);

            await updateDoc(pautaRef, {
                members: arrayUnion(userDoc.id),
                memberEmails: arrayUnion(email)
            });
            
            statusDiv.textContent = `Usuário ${email} convidado!`;
            document.getElementById('invite-email-input').value = '';
            await showMembersModal();
        }
        if(button.classList.contains('remove-member-btn')) {
            const email = button.dataset.email;
            if (confirm(`Tem certeza que deseja remover ${email}?`)) {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const userId = querySnapshot.docs[0].id;
                    const pautaRef = doc(db, "pautas", currentPautaId);
                    await updateDoc(pautaRef, {
                        members: arrayRemove(userId),
                        memberEmails: arrayRemove(email)
                    });
                    showNotification(`Membro ${email} removido.`);
                    await showMembersModal();
                }
            }
        }
        
        if (button.id === 'add-demand-btn') {
            const input = document.getElementById('new-demand-input');
            const text = input.value.trim();
            if(text) {
                const demandsListContainer = document.getElementById('demands-list-container');
                if(demandsListContainer.querySelector('p')) {
                    demandsListContainer.innerHTML = '';
                }
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 bg-white rounded-md text-sm';
                li.textContent = text;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-demand-item-btn text-red-500 hover:text-red-700 text-xs font-semibold ml-2';
                removeBtn.textContent = 'Remover';
                li.appendChild(removeBtn);
                demandsListContainer.appendChild(li);
                input.value = '';
            }
        }
        if (button.classList.contains('remove-demand-item-btn')) {
            const li = button.parentElement;
            li.remove();
            const demandsListContainer = document.getElementById('demands-list-container');
            if (demandsListContainer.children.length === 0) {
                 demandsListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>';
            }
        }
        if (button.id === 'save-demands-btn') {
            const demandsListContainer = document.getElementById('demands-list-container');
            const items = demandsListContainer.querySelectorAll('li');
            const descricoes = Array.from(items).map(li => li.firstChild.textContent);
            const demandsData = {
                quantidade: descricoes.length,
                descricoes: descricoes
            };
            const docRef = doc(collectionRef, assistedIdToHandle);
            await updateDoc(docRef, getUpdatePayload({ demandas: demandsData }));
            showNotification("Demandas salvas com sucesso!");
            document.getElementById('demands-modal').classList.add('hidden');
        }

        if (button.id.startsWith('cancel-') || button.id.startsWith('close-')) {
            button.closest('.fixed').classList.add('hidden');
        }
        if (button.id === 'close-documents-modal-btn' || button.id === 'cancel-checklist-btn') {
             document.getElementById('documents-modal').classList.add('hidden');
        }

        if (button.classList.contains('toggle-details-btn')) {
            const card = button.closest('div.p-4');
            const details = card.querySelector('.card-details');
            const icon = button.querySelector('svg');
            details.classList.toggle('hidden');
            icon.style.transform = details.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    });

    const documentsData = {
        alimentos_fixacao: {
            title: 'Ação de Alimentos (Fixação)',
            sections: [
                { title: 'Do Representante Legal:', docs: ['ID e CPF', 'Comprovante de residência', 'Certidão de nascimento/casamento', 'Comprovante de renda', 'Dados bancários'] },
                { title: 'Do Filho(a):', docs: ['Certidão de Nascimento', 'Comprovantes de despesas (escola, saúde)'] },
                { title: 'Sobre o Réu:', docs: ['Endereço completo', 'Local de trabalho (se souber)'] }
            ]
        },
        alimentos_oferta: {
            title: 'Oferta de Alimentos',
            sections: [
                { title: 'Do Ofertante:', docs: ['ID e CPF', 'Comprovante de residência', 'Comprovante de renda'] },
                { title: 'Do Filho(a):', docs: ['Certidão de Nascimento'] },
                { title: 'Sobre o Representante Legal:', docs: ['Nome e endereço completo', 'Dados bancários (se souber)'] }
            ]
        },
        alimentos_exoneracao: {
            title: 'Exoneração de Alimentos',
            sections: [
                { title: 'Do Requerente (quem paga):', docs: ['ID e CPF', 'Comprovante de residência', 'Sentença que fixou os alimentos'] },
                { title: 'Do Filho(a) (maior de idade):', docs: ['Nome e endereço completo', 'Comprovante de que não estuda mais ou pode se sustentar (se houver)'] }
            ]
        },
        alimentos_revisional: {
            title: 'Revisional de Alimentos',
            sections: [
                { title: 'Do Requerente:', docs: ['ID e CPF', 'Comprovante de residência', 'Sentença que fixou os alimentos', 'Prova da mudança da situação financeira (desemprego, nova prole, etc.)'] },
                { title: 'Da Outra Parte:', docs: ['Nome e endereço completo'] }
            ]
        },
        divorcio_litigioso: {
            title: 'Divórcio Litigioso',
            sections: [
                { title: 'Do Requerente:', docs: ['ID e CPF', 'Comprovante de residência', 'Certidão de Casamento atualizada'] },
                { title: 'Dos Filhos (se houver):', docs: ['Certidão de Nascimento dos filhos'] },
                { title: 'Dos Bens (se houver):', docs: ['Documentos de propriedade de imóveis, veículos, etc.'] },
                { title: 'Do Cônjuge:', docs: ['Endereço completo para citação'] }
            ]
        },
        divorcio_consensual: {
            title: 'Divórcio Consensual',
            sections: [
                { title: 'De Ambos os Cônjuges:', docs: ['ID e CPF de ambos', 'Comprovante de residência de ambos', 'Certidão de Casamento atualizada', 'Pacto antenupcial (se houver)'] },
                { title: 'Acordo:', docs: ['Definição sobre partilha de bens', 'Definição sobre pensão (se houver)', 'Definição sobre guarda dos filhos (se houver)'] }
            ]
        },
        guarda_visitas: {
            title: 'Guarda e Regul. de Visitas',
            sections: [
                { title: 'Do Requerente:', docs: ['ID e CPF', 'Comprovante de residência'] },
                { title: 'Do Filho(a):', docs: ['Certidão de Nascimento'] },
                { title: 'Da Outra Parte:', docs: ['Nome e endereço completo'] }
            ]
        },
        paternidade: {
            title: 'Investigação de Paternidade',
            sections: [
                { title: 'Do Representante Legal:', docs: ['ID e CPF', 'Comprovante de residência'] },
                { title: 'Do Filho(a):', docs: ['Certidão de Nascimento'] },
                { title: 'Do Suposto Pai:', docs: ['Nome e endereço completo', 'Qualquer prova que indique a paternidade (fotos, mensagens, etc.)'] }
            ]
        },
        uniao_estavel: {
            title: 'União Estável (Rec./Diss.)',
            sections: [
                { title: 'De Ambos os Companheiros:', docs: ['ID e CPF de ambos', 'Comprovante de residência'] },
                { title: 'Provas da União:', docs: ['Fotos do casal', 'Declaração de testemunhas', 'Contas conjuntas', 'Filhos em comum (Certidão de Nascimento)'] }
            ]
        }
    };

    const actionSelectionView = document.getElementById('document-action-selection');
    const checklistView = document.getElementById('document-checklist-view');
    const checklistContainer = document.getElementById('checklist-container');
    const checklistTitle = document.getElementById('checklist-title');

    actionSelectionView.addEventListener('click', (e) => {
        const actionButton = e.target.closest('button[data-action]');
        if (!actionButton) return;

        const actionKey = actionButton.dataset.action;
        currentChecklistAction = actionKey;
        const data = documentsData[actionKey];
        const assisted = allAssisted.find(a => a.id === assistedIdToHandle);
        const savedChecklist = assisted?.documentChecklist;

        checklistTitle.textContent = data.title;
        checklistContainer.innerHTML = '';

        data.sections.forEach((section, sectionIndex) => {
            const sectionDiv = document.createElement('div');
            const sectionTitleEl = document.createElement('h4');
            sectionTitleEl.className = 'font-bold text-md text-gray-700 mb-2 mt-3 border-b pb-1';
            sectionTitleEl.textContent = section.title;
            sectionDiv.appendChild(sectionTitleEl);

            const list = document.createElement('ul');
            list.className = 'space-y-2';
            section.docs.forEach((docText, docIndex) => {
                const listItem = document.createElement('li');
                const label = document.createElement('label');
                label.className = 'flex items-center text-gray-800 cursor-pointer';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const checkboxId = `doc-${actionKey}-${sectionIndex}-${docIndex}`;
                checkbox.id = checkboxId;
                checkbox.className = 'h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3';
                
                if(savedChecklist && savedChecklist.action === actionKey && savedChecklist.checkedIds?.includes(checkboxId)){
                    checkbox.checked = true;
                }

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(docText));
                listItem.appendChild(label);
                list.appendChild(listItem);
            });
            sectionDiv.appendChild(list);
            checklistContainer.appendChild(sectionDiv);
        });

        actionSelectionView.classList.add('hidden');
        checklistView.classList.remove('hidden');
        checklistView.classList.add('flex');
    });

    document.getElementById('back-to-action-selection-btn').addEventListener('click', () => {
        checklistView.classList.add('hidden');
        checklistView.classList.remove('flex');
        actionSelectionView.classList.remove('hidden');
    });

    document.getElementById('save-checklist-btn').addEventListener('click', async () => {
        if (!assistedIdToHandle || !currentChecklistAction) return;

        const checkedCheckboxes = checklistContainer.querySelectorAll('input[type="checkbox"]:checked');
        const checkedIds = Array.from(checkedCheckboxes).map(cb => cb.id);

        const checklistData = {
            action: currentChecklistAction,
            checkedIds: checkedIds
        };

        try {
            const docRef = doc(db, "pautas", currentPautaId, "attendances", assistedIdToHandle);
            await updateDoc(docRef, getUpdatePayload({ documentChecklist: checklistData }));
            showNotification("Checklist salvo com sucesso!", "success");
            document.getElementById('documents-modal').classList.add('hidden');
        } catch (error) {
            console.error("Erro ao salvar o checklist: ", error);
            showNotification("Erro ao salvar o checklist.", "error");
        }
    });

    document.getElementById('checklist-search').addEventListener('input', (e) => {
        const searchTerm = normalizeText(e.target.value);
        const allDocs = checklistContainer.querySelectorAll('li');
        allDocs.forEach(li => {
            const labelText = normalizeText(li.textContent);
            if (labelText.includes(searchTerm)) {
                li.style.display = 'block';
            } else {
                li.style.display = 'none';
            }
        });
    });

});

</script>

</body>
</html>



