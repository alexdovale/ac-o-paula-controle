<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pauta - SIGAP</title>
    
    <link rel="icon" type="image/png" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">

    <meta name="theme-color" content="#16a34a"/>
    <link rel="apple-touch-icon" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .priority-urgente { border-left: 5px solid #ef4444; }
        .priority-maxima { border-left: 5px solid #22c55e; }
        .priority-media { border-left: 5px solid #f97316; }
        .priority-minima { border-left: 5px solid #6b7280; }
        .column-content::-webkit-scrollbar, .scrollable-content::-webkit-scrollbar, #policy-content::-webkit-scrollbar, #checklist-container::-webkit-scrollbar, #members-list-container::-webkit-scrollbar, .list-container table::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-track, .scrollable-content::-webkit-scrollbar-track, #policy-content::-webkit-scrollbar-track, #checklist-container::-webkit-scrollbar-track, #members-list-container::-webkit-scrollbar-track, .list-container table::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .column-content::-webkit-scrollbar-thumb, .scrollable-content::-webkit-scrollbar-thumb, #policy-content::-webkit-scrollbar-thumb, #checklist-container::-webkit-scrollbar-thumb, #members-list-container::-webkit-scrollbar-thumb, .list-container table::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; }
        .tab-active { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; font-weight: 600; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos do gerenciar.html */
        .page-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
            flex-direction: column;
            width: 100%;
        }
        .header-gerenciar {
            width: 100%;
            max-width: 1140px;
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-start;
        }
        .content-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            flex-wrap: wrap;
            width: 100%;
        }
        .container-gerenciar, .list-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        .list-container {
            max-width: 600px;
        }
        .form-group-gerenciar {
            margin-bottom: 20px;
        }
        .options-group label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }
        .back-button-gerenciar {
            display: inline-block;
            padding: 10px 20px;
            background-color: #6c757d;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .back-button-gerenciar:hover {
            background-color: #5a6268;
        }
        .whatsapp-link {
            display: inline-block;
            padding: 8px 12px;
            background-color: #25D366;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .whatsapp-link:hover {
            background-color: #128C7E;
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin: 0 2px;
        }
        .action-buttons svg {
            width: 18px;
            height: 18px;
            vertical-align: middle;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        #confirm-action {
            background-color: #dc3545;
            color: #fff;
        }
        #cancel-action {
            background-color: #6c757d;
            color: #fff;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-container" class="loading-container"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-700 font-semibold text-center">Conectando...</p></div>

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <img src="https://alexdovale.github.io/ac-o-paula-controle/imagem.png" alt="Logo SIGAP" class="mx-auto h-24 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Sistema de Gerenciamento de Pauta</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 text-center font-semibold text-green-600 border-b-2 border-green-600">Login</button>
                <button id="register-tab-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">Cadastrar</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div class="text-right">
                    <a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Entrar</button>
            </form>
            <form id="register-form" class="hidden space-y-4">
                <div><label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-password" class="block text-sm font-medium text-gray-700">Senha (m√≠nimo 6 caracteres)</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Criar Conta</button>
            </form>
            <a href="#" id="privacy-policy-link" class="block mt-4 text-center text-sm text-gray-500 hover:underline">
                    Pol√≠tica de Privacidade
            </a>
        </div>
    </div>

    <div id="pauta-selection-container" class="hidden max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Gerenciamento de Pauta - SIGAP</h1>
        </div>
        <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">Minhas Pautas</h2>
              <div>
                  <button id="admin-btn-main" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Painel do Admin</button>
                  <button id="logout-btn-main" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Sair</button>
              </div>
        </div>
        <div id="install-container" class="hidden my-4 p-3 bg-green-100 border border-green-200 rounded-lg text-center">
            <p class="text-sm text-green-800">Leve o gerenciador de pautas com voc√™!</p>
            <button id="install-button" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 text-sm rounded-lg shadow-md hover:shadow-lg transition-all">
                Instalar App
            </button>
        </div>
        
        <div id="invitations-container" class="hidden mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Convites Pendentes</h2>
            <div id="pending-invitations-list" class="space-y-4"></div>
        </div>
        <div id="pautas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6"><button id="create-pauta-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Criar Nova Pauta</button></div>
    </div>
    
    <div id="app-container" class="max-w-full mx-auto hidden">
        <header class="mb-6 space-y-4">
            <div class="flex justify-center items-center w-full relative">
                 <h1 class="text-xl font-semibold text-gray-600 text-center">Sistema de Gerenciamento de Pauta - SIGAP</h1>
                 <button id="logout-btn-app" title="Sair" class="absolute top-0 right-0 bg-gray-600 text-white font-bold p-2 rounded-lg hover:bg-gray-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                             <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                             <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                         </svg>
                 </button>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                <div class="relative flex justify-center items-center border-b pb-4">
                    <h2 id="pauta-title" class="text-2xl md:text-3xl font-bold text-gray-800 text-center px-8 truncate"></h2>
                    <button id="edit-pauta-name-btn" title="Editar nome da pauta" class="hidden absolute right-0 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 transition flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5h6a.5.5 0 0 0 0-1h-6A1.5 1.5 0 0 0 1 2.5v11z"/>
                        </svg>
                   </button>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center w-full gap-4 pt-4">
                    <div class="flex-shrink-0">
                        <button id="back-to-pautas-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-center">
                        <button id="manage-members-btn" class="bg-lime-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-lime-700">Membros</button>
                        <button id="manage-collaborators-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Gerenciar Colaboradores</button>
                        <button id="reset-all-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Zerar</button>
                    </div>
                </div>
            </div>
        </header>
        <div id="app-content">
              <div class="mb-6">
                  <div class="border-b border-gray-200">
                      <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                          <button id="tab-agendamento" class="tab-active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Agendado</button>
                          <button id="tab-avulso" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Avulso</button>
                      </nav>
                  </div>
              </div>
            <form id="form-agendamento" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 id="form-title" class="text-xl font-semibold text-gray-700">Adicionar Novo Agendamento</h2>
                    <div id="agendamento-actions" class="flex items-center gap-4">
                        <a href="#" id="format-help-link" class="text-sm text-green-600 hover:text-green-800 hover:underline transition-colors duration-300 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.95-11.05a.9.9 0 0 1 .023 1.272l-.2.204a.9.9 0 0 1-1.273-.226L6.451 4.95a.9.9 0 0 1 1.273-.023l.204.2zM8 8.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                            <span>Como converter minha pauta?</span>
                        </a>
                        <label for="file-upload" class="cursor-pointer bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition text-sm inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Carregar Pauta (CSV)
                        </label>
                        <input type="file" id="file-upload" class="hidden" accept=".csv">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col lg:col-span-2">
                            <label for="assisted-name" class="mb-1 font-medium text-gray-600">Nome do Assistido</label>
                            <input type="text" id="assisted-name" placeholder="Ex: Jo√£o da Silva" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                        </div>
                        <div class="flex flex-col"><label for="assisted-cpf" class="mb-1 font-medium text-gray-600">CPF (Opcional)</label><input type="text" id="assisted-cpf" placeholder="___.___.___-__" maxlength="14" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                        <div class="flex flex-col lg:col-span-4">
                            <div class="flex items-center gap-2 mb-1">
                                <label for="assisted-subject" class="font-medium text-gray-600">Mat√©ria - Assunto</label>
                                <button type="button" id="subject-info-btn" class="font-bold text-lg text-blue-500 cursor-help rounded-full disabled:text-gray-300 disabled:cursor-not-allowed">!</button>
                            </div>
        
                            <input list="subjects-list" id="assisted-subject" name="assisted-subject" placeholder="Digite ou selecione um assunto" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition w-full">
                            <datalist id="subjects-list"></datalist>
        
                            <div id="subject-description" class="hidden mt-2 p-4 bg-blue-50 border border-blue-200 text-gray-800 rounded-lg text-sm transition-all duration-300">
                                </div>
                        </div>
                    </div>

                    <div id="form-options-container" class="border-t mt-4 pt-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div id="is-scheduled-container">
                            <label class="font-medium text-gray-700">Possui hor√°rio agendado?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="is-scheduled" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="is-scheduled" value="no" class="mr-1" checked> N√£o</label>
                            </div>
                            <div id="scheduled-time-wrapper" class="hidden mt-2">
                                <label for="scheduled-time" class="block mb-1 font-medium text-gray-600">Hor√°rio Agendado</label>
                                <input type="time" id="scheduled-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Assistido j√° chegou?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="has-arrived" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="has-arrived" value="no" class="mr-1" checked> N√£o</label>
                            </div>
                            <div id="arrival-time-wrapper" class="hidden mt-2">
                                <label for="arrival-time" class="block mb-1 font-medium text-gray-600">Hor√°rio de Chegada</label>
                                <input type="time" id="arrival-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                    </div>
                     <button type="button" id="add-assisted-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md w-full lg:w-auto">Adicionar</button>
                </div>
            </form>
            <main id="main-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="pauta-column" class="bg-white rounded-lg shadow-md flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>üìã Pauta</span>
                            <span id="pauta-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="pauta-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="pauta-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                           <span>‚è≥ Aguardando Atendimento</span>
                           <span id="aguardando-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="aguardando-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="aguardando-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                             <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center w-full">
                                <span>‚úÖ Atendidos</span>
                                <span id="atendidos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                            <button id="download-pdf-btn" class="ml-4 flex-shrink-0 bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm">Baixar PDF</button>
                        </div>
                        <input type="search" id="atendidos-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="atendidos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                 <div id="faltosos-column" class="bg-white rounded-lg shadow-md flex-col hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                üö´ Faltosos
                                <span id="faltosos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                        </div>
                        <input type="search" id="faltosos-search" placeholder="Pesquisar..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="faltosos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
            </main>
            <div class="mt-8 flex justify-center">
                <button id="toggle-faltosos-btn" class="w-full sm:w-auto bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Ver Faltosos</button>
            </div>
              <footer class="mt-12 bg-white p-6 rounded-lg shadow-md">
                  <h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Entenda a Ordem de Atendimento</h3>
                  <div class="text-center mb-4">
                      <button id="toggle-logic-btn" class="text-green-600 hover:text-green-800 text-sm hover:underline transition-colors duration-300">Por que esta ordem √© justa? (Clique para expandir)</button>
                  </div>
                  <div id="logic-explanation" class="hidden mt-4 text-left p-4 bg-gray-50 rounded-lg border space-y-3">
                      <p>A l√≥gica foi pensada para balancear a <strong>pontualidade</strong> com a <strong>realidade</strong> do dia a dia, criando um sistema justo para todos.</p>
                      <ul class="list-disc list-inside space-y-2 text-gray-700">
                          <li><strong>Recompensa a Pontualidade:</strong> Valoriza quem chega no hor√°rio, atendendo-os primeiro. Para assistidos que chegam adiantados, a ordem de atendimento respeita o hor√°rio original do agendamento.</li>
                          <li><strong>Oferece Toler√¢ncia:</strong> Reconhece que imprevistos acontecem, com uma janela de 20 minutos para pequenos atrasos.</li>
                          <li><strong>Gerencia Atrasos Maiores:</strong> Coloca quem se atrasou muito no fim da fila para n√£o prejudicar os outros.</li>
                          <li><strong>Permite Flexibilidade:</strong> O bot√£o "Prioridade" garante que casos graves sejam atendidos imediatamente.</li>
                          <li><strong>Crit√©rio de Desempate:</strong> Para assistidos com a mesma prioridade, a ordem √© definida pelo <strong>hor√°rio de chegada informado</strong> (quem chegou mais cedo √© atendido primeiro). Se dois ou mais assistidos chegarem exatamente no mesmo hor√°rio, a prefer√™ncia √© de quem teve a chegada <strong>registrada primeiro</strong> no sistema.</li>
                      </ul>
                      <p class="font-semibold text-gray-800 pt-2">O resultado √© uma fila transparente, previs√≠vel e justa tanto para os assistidos quanto para a equipe.</p>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center mt-4">
                      <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500"><p class="font-bold text-red-700">Prioridade Urgente</p><p class="text-sm text-gray-600 mt-1">Definida manualmente para casos que necessitam de atendimento imediato.</p></div>
                      <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"><p class="font-bold text-green-700">Prioridade M√°xima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram no hor√°rio agendado ou adiantados.</p></div>
                      <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500"><p class="font-bold text-orange-700">Prioridade M√©dia</p><p class="text-sm text-gray-600 mt-1">Assistidos agendados com at√© 20 min de atraso ou atendimentos avulsos.</p></div>
                      <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500"><p class="font-bold text-gray-700">Prioridade M√≠nima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram com 30 minutos ou mais de atraso.</p></div>
                  </div>
                  <p class="text-center text-sm text-gray-500 mt-8">Desenvolvido por Alex do Vale e o Gemini</p>
              </footer>
        </div>
    </div>

    <div id="gerenciar-container" class="hidden page-container">
        <div class="header-gerenciar">
            <button id="back-from-gerenciar-btn" class="back-button-gerenciar">‚Üê Voltar para a Pauta</button>
        </div>
        <div class="content-wrapper">
            <div class="container-gerenciar">
                <h1 id="form-title">Gerenciar Colaboradores</h1>
                <form id="colaborador-form">
                    <div class="form-group-gerenciar">
                        <label for="nome">Nome do Colaborador:</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>
                    <div class="form-group-gerenciar">
                        <label for="telefone">Telefone (com DDD):</label>
                        <input type="tel" id="telefone" name="telefone" placeholder="Ex: 21999998888" required>
                    </div>
                    <div class="form-group-gerenciar">
                        <label>Como vai se deslocar?</label>
                        <div class="options-group">
                            <input type="radio" id="nao-confirmado" name="transporte" value="N√£o Confirmado" checked required>
                            <label for="nao-confirmado">N√£o Confirmado</label>
                            
                            <input type="radio" id="meios-proprios" name="transporte" value="Meios Pr√≥prios">
                            <label for="meios-proprios">Meios Pr√≥prios</label>
                            
                            <input type="radio" id="com-empresa" name="transporte" value="Com a Empresa">
                            <label for="com-empresa">Com a Empresa</label>
                        </div>
                    </div>
                    <div class="form-group-gerenciar hidden" id="local-encontro-group">
                        <label>Ponto de Encontro:</label>
                        <div class="options-group">
                            <input type="radio" id="sede" name="localEncontro" value="Sede">
                            <label for="sede">Sede</label>
                            
                            <input type="radio" id="meio-caminho" name="localEncontro" value="Meio do Caminho">
                            <label for="meio-caminho">No meio do caminho</label>
                        </div>
                    </div>
                    <div class="form-group-gerenciar hidden" id="observacao-group">
                        <label for="observacao">Observa√ß√£o:</label>
                        <textarea id="observacao" name="observacao" rows="3"></textarea>
                    </div>
                    <button type="submit" id="submit-button">Adicionar Colaborador</button>
                </form>
            </div>
            <div class="list-container">
                <h2>Lista de Presen√ßa</h2>
                <div class="overflow-x-auto">
                    <table id="colaboradores-list" class="min-w-full">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Deslocamento</th>
                                <th>Presen√ßa</th>
                                <th>Hor√°rio</th>
                                <th>WhatsApp</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="list-actions">
                    <button id="download-pdf">Baixar PDF da Lista</button>
                    <button id="clear-list">Limpar Lista</button>
                </div>
            </div>
        </div>
    </div>
    <div id="create-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Criar Nova Pauta</h2>
            <label for="create-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nome da Pauta</label>
            <input type="text" id="create-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-create-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-create-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Criar</button>
            </div>
        </div>
    </div>
    <div id="members-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg" style="max-height: 90vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Membros</h2>
                <button id="close-members-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-700">Convidar Novo Membro</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="email" id="invite-email-input" placeholder="email@exemplo.com" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="invite-member-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex-shrink-0">Convidar</button>
                    </div>
                    <div id="invite-status" class="text-sm h-4"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Membros Atuais</h3>
                    <div id="members-list-container" class="space-y-2 max-h-64 overflow-y-auto">
                        </div>
                </div>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="arrival-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Confirmar Hor√°rio de Chegada</h2><p class="mb-4 text-gray-600">Por favor, informe o hor√°rio de chegada do assistido.</p><input type="time" id="arrival-time-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-arrival-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-arrival-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Finalizar Atendimento</h2><p class="mb-4 text-gray-600">Insira o nome do profissional que realizou o atendimento (opcional).</p><input type="text" id="attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg space-y-4"><h2 class="text-2xl font-bold text-gray-800">Zerar Pauta</h2><p class="text-gray-600">Tem certeza de que deseja apagar permanentemente todos os dados desta pauta?</p><div class="flex justify-end space-x-4 pt-4"><button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-reset-btn" class="bg-red-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-800">Zerar Pauta</button></div></div>
    </div>
    <div id="edit-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Nome da Pauta</h2>
            <label for="edit-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Novo nome</label>
            <input type="text" id="edit-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="format-help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl relative flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0">
                <button id="close-format-help-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                <h2 class="text-2xl font-bold mb-4">Como Preparar sua Pauta para Importa√ß√£o</h2>
            </div>
            <div class="flex-grow overflow-y-auto scrollable-content pr-4">
                <p class="mb-4 text-gray-600">Para importar seus agendamentos de uma vez, crie um arquivo <strong>.csv</strong> (Valores Separados por V√≠rgula). Voc√™ pode criar este arquivo usando o Bloco de Notas, Excel, Google Sheets ou similar.</p>
                
                <div class="flex justify-between items-center mb-2">
                     <p class="font-semibold">O arquivo deve seguir o formato abaixo, com 4 colunas, nesta ordem:</p>
                     <button id="copy-csv-format-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Formato</button>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg text-sm mb-4">
                    <code id="csv-format-code">Nome Completo do Assistido;HH:MM;Mat√©ria do Assunto;CPF(opcional)</code>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">Exemplo:</h3>
                    <button id="copy-csv-example-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Exemplo</button>
                </div>
                <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="csv-example-code">Maria Joaquina de Amaral Pereira;09:00;Div√≥rcio Consensual;111.222.333-44
Jo√£o da Silva;09:30;A√ß√£o de Alimentos;
Fulano de Tal;10:00;Curatela;444.555.666-77</code></pre>
                <ul class="list-disc list-inside mt-4 space-y-2 text-gray-700">
                    <li>A primeira linha (cabe√ßalho) √© <strong>opcional</strong>. O sistema a ignorar√° se presente.</li>
                    <li>O campo <strong>CPF</strong> √© opcional. Se n√£o houver CPF, deixe o espa√ßo em branco (ou n√£o coloque nada ap√≥s o √∫ltimo ponto e v√≠rgula).</li>
                    <li>O <strong>hor√°rio</strong> deve estar no formato <strong>HH:MM</strong> (Ex: 09:00, 14:30).</li>
                    <li>Salve o arquivo com a extens√£o <strong>.csv</strong>.</li>
                </ul>

                <div class="mt-6 pt-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Prompt para IA (Ex: ChatGPT, Gemini):</h3>
                        <button id="copy-ai-prompt-btn" class="bg-gray-200 text-gray-800 text-xs font-semibold py-1 px-3 rounded-lg hover:bg-gray-300">Copiar Prompt</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">Se sua pauta est√° em um PDF, copie o texto abaixo e cole junto com o conte√∫do do seu PDF em uma IA para format√°-lo corretamente.</p>
                    <pre class="bg-gray-100 p-4 rounded-lg text-sm" style="white-space: pre-wrap; word-break: break-all;"><code id="ai-prompt-code">Ol√°! Por favor, converta o conte√∫do do arquivo PDF que estou enviando para o formato CSV, usando ponto e v√≠rgula (;) como separador. O resultado deve seguir este padr√£o:

Nome Completo do Assistido;HH:MM;Mat√©ria do Assunto;CPF(opcional)

Por favor, me entregue o texto pronto para que eu possa salvar em um arquivo .csv.</code></pre>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Atendente</h2>
            <input type="text" id="edit-attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="demands-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Gerenciar Demandas Adicionais</h2>
                <button id="close-demands-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <p class="mb-4">Assistido: <strong id="demands-assisted-name-modal" class="text-green-600"></strong></p>
                <div class="space-y-2">
                    <label for="new-demand-input" class="block text-sm font-medium text-gray-700">Adicionar nova demanda:</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-demand-input" placeholder="Ex: A√ß√£o de Partilha de Bens" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="add-demand-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex-shrink-0">Adicionar</button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Demandas Adicionais Registradas:</h3>
                    <div id="demands-list-container" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-lg border">
                        <p class="text-gray-500 text-center">Nenhuma demanda adicional.</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6 flex-shrink-0 border-t pt-4">
                <button id="cancel-demands-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                <button id="save-demands-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <div id="edit-assisted-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
         <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Editar Dados do Assistido</h2>
            <div class="space-y-4">
                <div><label for="edit-assisted-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="edit-assisted-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-cpf" class="block text-sm font-medium text-gray-700">CPF</label><input type="text" id="edit-assisted-cpf" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-assisted-subject" class="block text-sm font-medium text-gray-700">Assunto</label><input list="subjects-list" type="text" id="edit-assisted-subject" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label for="edit-scheduled-time" class="block text-sm font-medium text-gray-700">Hor√°rio Agendado</label><input type="time" id="edit-scheduled-time" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-edit-assisted-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-assisted-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
    <div id="priority-reason-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Atendimento Priorit√°rio</h2>
            <p class="mb-4 text-gray-600">Por favor, informe o motivo da prioridade.</p>
            <textarea id="priority-reason-input" placeholder="Motivo..." class="w-full p-3 border border-gray-300 rounded-lg mb-6 h-24"></textarea>
            <div class="flex justify-end space-x-4">
                <button id="cancel-priority-reason-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-priority-reason-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar Prioridade</button>
            </div>
        </div>
    </div>
     <div id="privacy-policy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 80vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">Pol√≠tica de Privacidade</h2>
                <button id="close-policy-modal-btn-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="policy-content" class="text-gray-700 space-y-4 overflow-y-auto pr-2">
                <p><strong>1. Natureza do Sistema e Ciclo de Vida dos Dados</strong></p>
                <p>O Sistema de Gerenciamento de Pauta (SIGAP) √© uma interface de controle para a gest√£o de atendimentos. Ele coleta e armazena os dados pessoais de assistidos, como nome, CPF (opcional), assunto e demanda, por um per√≠odo de sete dias ap√≥s a finaliza√ß√£o da a√ß√£o. Ap√≥s esse prazo, os dados s√£o permanentemente exclu√≠dos do SIGAP.</p>
                <p>Para o armazenamento permanente, todos os dados s√£o enviados e salvos no sistema Verde, que √© de responsabilidade da Defensoria P√∫blica do Estado do Rio de Janeiro (DPERJ) e est√° em total conformidade com a LGPD.</p>
                
                <p><strong>2. Dados Coletados pelo SIGAP</strong></p>
                <p>Para permitir o uso da interface, o SIGAP coleta apenas os dados de autentica√ß√£o dos usu√°rios (profissionais): e-mail e senha.</p>
                
                <p><strong>3. Tratamento e Prote√ß√£o de Dados (dentro do SIGAP)</strong></p>
                <p>Os dados de autentica√ß√£o s√£o utilizados para garantir o acesso restrito e seguro ao sistema. Os dados de assistidos s√£o armazenados por apenas sete dias, tempo necess√°rio para a conclus√£o da a√ß√£o, e s√£o protegidos por medidas de seguran√ßa para evitar acesso n√£o autorizado.</p>
                
                <p><strong>4. Direitos dos Titulares dos Dados</strong></p>
                <p>Os direitos dos assistidos, como acesso, corre√ß√£o e exclus√£o de dados, s√£o garantidos e exercidos diretamente por meio do sistema Verde, que √© o respons√°vel pelo armazenamento final. Os usu√°rios do SIGAP podem gerenciar a pauta e solicitar altera√ß√µes no sistema Verde conforme as normas da DPERJ.</p>

                <p><strong>5. Origem e Transfer√™ncia de Dados dos Assistidos</strong></p>
                <p>Os dados dos assistidos gerenciados no SIGAP podem ter duas origens:</p>
                <p><strong>Importa√ß√£o do Sistema Verde:</strong> A maior parte dos dados (nome, hor√°rio, assunto) √© transferida manualmente do sistema oficial Verde (DPERJ) atrav√©s de um processo de exporta√ß√£o e importa√ß√£o. Neste fluxo, o CPF do assistido n√£o √© transferido.</p>
                <p><strong>Cadastro Direto no SIGAP:</strong> Novos atendimentos, como os avulsos, podem ser registrados diretamente na plataforma. Nesses casos, o campo CPF √© opcional e pode ser preenchido pelo profissional respons√°vel pelo cadastro (criador ou membro da pauta).</p>
                <p>O processo de transfer√™ncia manual consiste na exporta√ß√£o da pauta do sistema Verde, quando houver pauta previamente cadastrada, sua convers√£o para um formato compat√≠vel e a importa√ß√£o do arquivo final no SIGAP. Cabe ao usu√°rio respons√°vel pela transfer√™ncia garantir a seguran√ßa dos dados durante este processo, incluindo a exclus√£o segura dos arquivos intermedi√°rios (como PDFs e CSVs) de seus dispositivos locais ap√≥s a importa√ß√£o bem-sucedida. O SIGAP n√£o se responsabiliza pelo manuseio dos dados fora de sua plataforma, mas orienta todos os usu√°rios a seguirem as melhores pr√°ticas de seguran√ßa para proteger a privacidade dos assistidos.</p>
            </div>
            <div class="flex justify-end mt-6 flex-shrink-0">
                <button id="close-policy-modal-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Fechar</button>
            </div>
        </div>
    </div>

    <div id="documents-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">
                    Detalhes para <span id="documents-assisted-name" class="text-green-600"></span>
                </h2>
                <button id="close-documents-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div id="document-action-selection" class="flex-grow overflow-y-auto scrollable-content pr-2">
                <p class="text-gray-600 mb-4">Selecione o tipo de a√ß√£o para ver a lista de documentos necess√°rios:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button data-action="alimentos_fixacao" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">1. A√ß√£o de Alimentos (Fixa√ß√£o)</span>
                    </button>
                    <button data-action="alimentos_oferta" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">2. A√ß√£o de Oferta de Alimentos</span>
                    </button>
                    <button data-action="alimentos_exoneracao" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">3. Exonera√ß√£o de Alimentos</span>
                    </button>
                    <button data-action="alimentos_revisional" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">4. Revisional de Alimentos</span>
                    </button>
                    <button data-action="divorcio_litigioso" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">5. A√ß√£o de Div√≥rcio Litigioso</span>
                    </button>
                    <button data-action="divorcio_consensual" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">6. A√ß√£o de Div√≥rcio Consensual</span>
                    </button>
                     <button data-action="guarda_visitas" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">7. Guarda e Regul. de Visitas</span>
                    </button>
                    <button data-action="paternidade" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">8. Investiga√ß√£o de Paternidade</span>
                    </button>
                    <button data-action="uniao_estavel" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">9. Uni√£o Est√°vel (Rec./Diss.)</span>
                    </button>
                </div>
            </div>

            <div id="document-checklist-view" class="hidden flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <button id="back-to-action-selection-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                        <h3 id="checklist-title" class="text-xl font-bold text-gray-800"></h3>
                    </div>
                    <div class="flex space-x-4">
                        <button id="cancel-checklist-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
                        <button id="save-checklist-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </div>
                 <div class="mb-4 flex-shrink-0">
                    <input type="search" id="checklist-search" placeholder="Pesquisar documento..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                </div>
                <div id="checklist-container" class="space-y-4 overflow-y-auto pr-2 flex-grow border rounded-lg p-4 bg-gray-50" style="max-height: 55vh;">
                    </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, getDoc, setDoc, query, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IN√çCIO DA L√ìGICA DE ASSUNTOS (ANTIGO assuntos.js) ---
        const subjectTree = [
            { text: "Orienta√ß√£o Jur√≠dica", description: "Presta√ß√£o de informa√ß√µes e esclarecimentos gerais sobre direitos, deveres e as leis, auxiliando o cidad√£o a entender sua situa√ß√£o e as poss√≠veis solu√ß√µes legais." },
            { text: "Atendimento Jur√≠dico Integral e Gratuito", description: "O servi√ßo principal da Defensoria, oferecido a pessoas que n√£o possuem condi√ß√µes financeiras para contratar um advogado, abrangendo todas as etapas e necessidades legais." },
            { text: "Ajuizamento e Acompanhamento de A√ß√µes Judiciais", description: "In√≠cio de processos legais perante o Poder Judici√°rio e o monitoramento de seu andamento at√© a decis√£o final." },
            { text: "Consultas Processuais", description: "Fornecimento de informa√ß√µes sobre o status e o andamento de processos judiciais ou administrativos em que o assistido √© parte." },
            {
                text: "Processos C√≠veis (gerais)",
                description: "Atua√ß√£o em demandas judiciais que n√£o se enquadram em √°reas especializadas, como disputas de vizinhan√ßa, regulariza√ß√£o de im√≥veis, quest√µes condominiais, aluguel, despejo, indeniza√ß√µes diversas e problemas de posse.",
                children: [
                    { text: "A√ß√£o de Obriga√ß√£o de Fazer", description: "A√ß√£o para exigir que algu√©m (ou uma empresa/√≥rg√£o) cumpra uma determinada tarefa ou realize um servi√ßo." },
                    { text: "A√ß√£o Declarat√≥ria de Nulidade", description: "A√ß√£o para pedir que a justi√ßa declare a invalidade de um ato jur√≠dico (ex: contrato, multa, cobran√ßa)." },
                    { text: "A√ß√£o de Indeniza√ß√£o (Danos Morais e Materiais)", description: "A√ß√£o para buscar compensa√ß√£o financeira por preju√≠zos sofridos (perdas materiais) e/ou por abalos psicol√≥gicos, honra ou dignidade (danos morais)." },
                    { text: "A√ß√£o Revisional de D√©bito", description: "A√ß√£o para contestar e pedir a altera√ß√£o de valores de d√≠vidas ou cobran√ßas consideradas abusivas ou indevidas." },
                    { text: "A√ß√£o de Exigir Contas", description: "A√ß√£o para solicitar que uma pessoa (ex: antigo curador, administrador) apresente detalhes e comprovantes de como administrou valores ou bens de outra." }
                ]
            },
            {
                text: "Processos de Fam√≠lia",
                description: "Atua√ß√£o em quest√µes jur√≠dicas que envolvem rela√ß√µes familiares.",
                children: [
                    { text: "Alimentos", description: "A√ß√£o para solicitar ou ajustar a pens√£o aliment√≠cia.", children: [
                        { text: "A√ß√£o de Fixa√ß√£o de Alimentos", description: "Para determinar, pela primeira vez, o valor da pens√£o aliment√≠cia." },
                        { text: "A√ß√£o de Majora√ß√£o de Alimentos", description: "Para pedir o aumento do valor da pens√£o aliment√≠cia." },
                        { text: "A√ß√£o de Oferta de Alimentos", description: "Para que o devedor ofere√ßa formalmente um valor de pens√£o, buscando regularizar a situa√ß√£o." },
                        { text: "A√ß√£o de Alimentos Grav√≠dicos", description: "Para que o futuro pai preste aux√≠lio financeiro √† gestante para cobrir despesas da gravidez." },
                        { text: "A√ß√£o de Alimentos Avoengos (contra av√≥s)", description: "Para pedir pens√£o aliment√≠cia aos av√≥s, em car√°ter subsidi√°rio e complementar, quando os pais n√£o podem ou n√£o conseguem arcar." }
                    ]},
                    { text: "Div√≥rcio", description: "A√ß√£o para dissolver o v√≠nculo matrimonial.", children: [
                        { text: "Div√≥rcio Consensual", description: "Quando ambos os c√¥njuges concordam com todos os termos da separa√ß√£o (partilha, guarda, etc.)." },
                        { text: "Div√≥rcio Litigioso", description: "Quando os c√¥njuges n√£o chegam a um acordo sobre um ou mais termos da separa√ß√£o." }
                    ]},
                    { text: "Uni√£o Est√°vel", description: "A√ß√£o para reconhecer ou dissolver a uni√£o est√°vel.", children: [
                        { text: "Reconhecimento e Dissolu√ß√£o de Uni√£o Est√°vel", description: "Para formalizar judicialmente o in√≠cio e o fim de uma uni√£o est√°vel." },
                        { text: "Reconhecimento / Dissolu√ß√£o de Uni√£o Est√°vel Post Mortem", description: "Para reconhecer e/ou dissolver uma uni√£o est√°vel ap√≥s o falecimento de um dos companheiros." },
                        { text: "Convers√£o de Uni√£o Est√°vel Homoafetiva em Casamento", description: "Para formalizar o casamento a partir de uma uni√£o est√°vel entre pessoas do mesmo sexo." }
                    ]},
                    { text: "Guarda", description: "A√ß√£o para definir quem ser√° respons√°vel pelos cuidados e decis√µes sobre uma crian√ßa ou adolescente.", children: [
                        { text: "Guarda (pedida pelos pais)", description: "Quando os pr√≥prios genitores buscam a formaliza√ß√£o da guarda." },
                        { text: "Guarda (pedida por outra pessoa que n√£o o pai ou a m√£e)", description: "Quando um terceiro (ex: av√≥, tio) busca a guarda de uma crian√ßa/adolescente, geralmente em situa√ß√µes excepcionais de incapacidade ou risco com os pais." },
                        { text: "Guarda Compartilhada", description: "Modalidade em que ambos os pais exercem a autoridade parental, mesmo separados, tomando decis√µes conjuntas sobre os filhos." }
                    ]},
                    { text: "Regulamenta√ß√£o de Conviv√™ncia Familiar (Visitas)", description: "A√ß√£o para definir judicialmente os dias e hor√°rios em que o pai/m√£e (ou av√≥s/terceiros) ter√° contato com a crian√ßa/adolescente."},
                    { text: "Investiga√ß√£o de Paternidade (DNA)", description: "A√ß√£o para buscar o reconhecimento judicial da paternidade biol√≥gica.", children: [
                        { text: "Investiga√ß√£o de Paternidade Cumulada com Alimentos", description: "A√ß√£o que, al√©m de buscar o reconhecimento, j√° pede a fixa√ß√£o de pens√£o aliment√≠cia." },
                        { text: "Investiga√ß√£o de Paternidade P√≥s Morte", description: "A√ß√£o de reconhecimento de paternidade ap√≥s o falecimento do suposto pai." }
                    ]},
                    { text: "Curatela", description: "Medida judicial que nomeia um curador para gerir atos negociais e patrimoniais de um adulto que n√£o pode exprimir sua vontade.", children: [
                        { text: "Procedimento de Fixa√ß√£o dos Limites da Curatela (antiga interdi√ß√£o)", description: "Processo para instituir a curatela, definindo os atos para os quais a pessoa precisar√° de assist√™ncia." },
                        { text: "Levantamento de Curatela", description: "A√ß√£o para encerrar a curatela quando a causa da incapacidade cessa ou a pessoa recupera a autonomia." }
                    ]},
                    { text: "Tutela", description: "Medida judicial que nomeia um tutor para cuidar de um menor que n√£o tem pais ou cujos pais perderam o poder familiar." },
                    { text: "Ado√ß√£o", description: "Processo judicial para estabelecer um novo v√≠nculo de filia√ß√£o, em que uma crian√ßa ou adolescente se torna filho legal de pais adotivos." }
                ]
            },
            {
                text: "Processos Criminais",
                description: "Atua√ß√£o jur√≠dica relacionada a crimes.",
                children: [
                    { text: "Defesa de Acusados em Processo Criminal", description: "Representa√ß√£o legal de pessoas que respondem a acusa√ß√µes criminais." },
                    { text: "Acompanhamento do Cumprimento da Pena (Execu√ß√£o Penal)", description: "Atua√ß√£o em favor de pessoas condenadas, para garantir seus direitos durante o cumprimento da pena (regime, progress√£o, benef√≠cios)." },
                    { text: "Atua√ß√£o em Audi√™ncia de Cust√≥dia", description: "Assist√™ncia a pessoas presas em flagrante, avaliando a legalidade da pris√£o e buscando medidas alternativas." }
                ]
            },
            {
                text: "Processos de Fazenda P√∫blica",
                description: "Demandas contra o Estado (Uni√£o, Estados, Munic√≠pios) e seus √≥rg√£os.",
                children: [
                    { text: "Fornecimento de Medicamentos", description: "A√ß√£o para compelir o Poder P√∫blico a fornecer medicamentos essenciais." },
                    { text: "Indeniza√ß√µes contra o Poder P√∫blico", description: "A√ß√µes para buscar compensa√ß√£o por danos causados por atos ou omiss√µes do Estado." },
                    { text: "Previd√™ncia Social (estadual e municipal)", description: "Atua√ß√£o em quest√µes relacionadas a benef√≠cios previdenci√°rios de regimes pr√≥prios." },
                    { text: "Questionamentos em Cobran√ßas de Impostos, Taxas e Multas", description: "A√ß√µes para contestar cobran√ßas indevidas de tributos ou multas por entes p√∫blicos." }
                ]
            },
            {
                text: "Processos de Inf√¢ncia e Juventude",
                description: "A√ß√µes focadas nos direitos de crian√ßas e adolescentes.",
                children: [
                    { text: "Vaga em Escolas e Creches", description: "A√ß√£o para garantir o acesso √† educa√ß√£o, pleiteando matr√≠cula em creches ou escolas p√∫blicas/conveniadas." },
                    { text: "Profissionais de Apoio Escolar", description: "A√ß√£o para garantir a presen√ßa de mediadores ou outros profissionais de apoio para alunos com defici√™ncia na escola." },
                    { text: "Obriga√ß√£o de Fazer (gen√©rica)", description: "A√ß√£o para exigir que um √≥rg√£o cumpra uma obriga√ß√£o espec√≠fica em favor da crian√ßa/adolescente." },
                    { text: "Transporte (demanda de transporte gratuito)", description: "A√ß√£o para garantir o direito de transporte gratuito para crian√ßas/adolescentes com defici√™ncia ou necessidades espec√≠ficas." }
                ]
            },
            { text: "Processos Relacionados a Direitos Humanos", description: "Atua√ß√£o em casos de viola√ß√£o de direitos fundamentais." },
            { text: "Media√ß√£o e Concilia√ß√£o", description: "M√©todos de resolu√ß√£o de conflitos em que um terceiro imparcial auxilia as partes a chegarem a um acordo, evitando ou encerrando o processo judicial." },
            {
                text: "Facilita√ß√£o de Acesso √† Documenta√ß√£o B√°sica",
                description: "Aux√≠lio na obten√ß√£o de documentos essenciais para o exerc√≠cio da cidadania.",
                children: [
                    { text: "Emiss√£o de Carteira de Identidade (1¬™ e 2¬™ via)", description: "Apoio no processo para obter ou renovar o RG, incluindo gratuidade se necess√°rio." },
                    { text: "Emiss√£o de Certid√µes (Nascimento, Casamento, √ìbito - 1¬™ e 2¬™ via)", description: "Aux√≠lio na obten√ß√£o de certid√µes, com foco na gratuidade para hipossuficientes." },
                    { text: "Obten√ß√£o de 'Nada Consta'", description: "Apoio para obter certid√µes que atestam a inexist√™ncia de pend√™ncias legais." }
                ]
            },
            {
                text: "Atendimento em Demandas de Sa√∫de (CRLS)",
                description: "Atua√ß√£o na C√¢mara de Resolu√ß√£o de Lit√≠gios de Sa√∫de, buscando solu√ß√µes administrativas para acesso a medicamentos e procedimentos.",
                children: [
                    { text: "Acesso a Medicamentos", description: "Conseguir o fornecimento de medicamentos pelo SUS ou plano de sa√∫de." },
                    { text: "Agendamento de Procedimentos Cir√∫rgicos ou Exames", description: "Agilizar a realiza√ß√£o de procedimentos m√©dicos." }
                ]
            },
            {
                text: "Orienta√ß√£o sobre Execu√ß√£o Penal",
                description: "Esclarecimentos sobre os direitos de pessoas que cumprem pena.",
                children: [
                    { text: "Progress√£o de Regime", description: "Orienta√ß√£o sobre a mudan√ßa para regimes de pena menos rigorosos (Fechado, Semiaberto, Aberto)." },
                    { text: "Visita Peri√≥dica ao Lar (VPL)", description: "Orienta√ß√£o sobre o direito a sa√≠das tempor√°rias para conviv√™ncia familiar." },
                    { text: "Trabalho/Estudo Extramuros", description: "Orienta√ß√£o sobre a possibilidade de trabalhar ou estudar fora do estabelecimento prisional." },
                    { text: "Livramento Condicional", description: "Orienta√ß√£o sobre a liberdade antecipada sob condi√ß√µes." },
                    { text: "Indulto", description: "Orienta√ß√£o sobre o perd√£o da pena concedido por decreto presidencial." }
                ]
            },
            {
                text: "Retifica√ß√£o de Registro Civil",
                description: "A√ß√µes para corrigir informa√ß√µes em documentos civis.",
                children: [
                    { text: "Retifica√ß√£o de Dados Registrais (Nascimento, Casamento, √ìbito)", description: "Corre√ß√£o de erros ou omiss√µes em certid√µes." },
                    { text: "Altera√ß√£o de G√™nero e Nome", description: "Processo para pessoas transg√™nero alterarem o nome e/ou g√™nero em seus documentos." }
                ]
            },
            {
                text: "Alvar√° Judicial",
                description: "Medida judicial simplificada para fins espec√≠ficos.",
                children: [
                    { text: "Alvar√° para Levantamento de Valores (FGTS, PIS/PASEP)", description: "Para autorizar o saque de valores espec√≠ficos." },
                    { text: "Alvar√° para Autoriza√ß√£o de Viagem ao Exterior (para menor)", description: "Para suprir o consentimento de um dos pais em viagens internacionais de menores." }
                ]
            },
            { text: "Apoio Psicossocial", description: "Presta√ß√£o de suporte que considera os aspectos psicol√≥gicos e sociais do assistido, integrando-o ao atendimento jur√≠dico." },
            { text: "Defesa de Direitos Homoafetivos", description: "Atua√ß√£o espec√≠fica para a promo√ß√£o e defesa dos direitos de pessoas LGBT." }
        ];

        function flattenTreeWithObjects(nodes, parentPrefix = '') {
            let flatList = [];
            nodes.forEach(node => {
                const currentValue = parentPrefix ? `${parentPrefix} > ${node.text}` : node.text;
                flatList.push({ value: currentValue, description: node.description });

                if (node.children) {
                    flatList = flatList.concat(flattenTreeWithObjects(node.children, currentValue));
                }
            });
            return flatList;
        }

        const flatSubjects = flattenTreeWithObjects(subjectTree);
        // --- FIM DA L√ìGICA DE ASSUNTOS ---

        // Vari√°veis Globais (existentes)
        let db, auth, allAssisted = [], currentPautaId = null, unsubscribeFromAttendances = () => {}, currentUserName = '', currentPautaOwnerId = null;
        let assistedIdToHandle = null;
        let currentChecklistAction = null;
        let unsubscribeFromColaboradores = () => {};

        const loadingContainer = document.getElementById('loading-container');
        const loginContainer = document.getElementById('login-container');
        const pautaSelectionContainer = document.getElementById('pauta-selection-container');
        const appContainer = document.getElementById('app-container');
        const loadingText = document.getElementById('loading-text');
        
        // Elementos da p√°gina de gerenciamento de colaboradores
        const gerenciarContainer = document.getElementById('gerenciar-container');
        const backFromGerenciarBtn = document.getElementById('back-from-gerenciar-btn');
        const colaboradorForm = document.getElementById('colaborador-form');
        const nomeInput = document.getElementById('nome');
        const telefoneInput = document.getElementById('telefone');
        const transporteOptions = document.querySelectorAll('input[name="transporte"]');
        const localEncontroGroup = document.getElementById('local-encontro-group');
        const observacaoGroup = document.getElementById('observacao-group');
        const colaboradoresListBody = document.querySelector('#colaboradores-list tbody');
        const downloadPdfBtn = document.getElementById('download-pdf');
        const clearListBtn = document.getElementById('clear-list');
        const formTitleGerenciar = document.getElementById('form-title');
        const submitButtonGerenciar = document.getElementById('submit-button');

        const normalizeText = (str) => {
            if (!str) return '';
            return str.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        };

        const getPriorityClass = (priority) => ({'URGENTE':'priority-urgente','M√°xima':'priority-maxima','M√©dia':'priority-media','M√≠nima':'priority-minima'}[priority]||'');

        const getUpdatePayload = (data) => {
            return {
                ...data,
                lastActionBy: currentUserName,
                lastActionTimestamp: new Date().toISOString()
            };
        };

        const getPriorityLevel = (assisted) => {
            if (!assisted || assisted.status !== 'aguardando') return 'N/A';
            if (assisted.priority === 'URGENTE') return 'URGENTE';

            if (assisted.type === 'avulso') return 'M√©dia';

            if (!assisted.scheduledTime || !assisted.arrivalTime) return 'M√©dia';

            const scheduled = new Date(`1970-01-01T${assisted.scheduledTime}`);
            const arrival = new Date(assisted.arrivalTime);
            const arrivalTime = new Date(`1970-01-01T${arrival.toTimeString().slice(0, 5)}`);

            const diffMinutes = (arrivalTime - scheduled) / (1000 * 60);

            if (diffMinutes <= 0) return 'M√°xima'; 
            if (diffMinutes <= 20) return 'M√©dia';
            return 'M√≠nima';
        };

        const renderAssistedList = () => {
            allAssisted.forEach(a => {
                if (a.status === 'aguardando' && a.priority !== 'URGENTE') {
                    a.priority = getPriorityLevel(a);
                }
            });

            const pautaList = document.getElementById('pauta-list');
            const aguardandoList = document.getElementById('aguardando-list');
            const atendidosList = document.getElementById('atendidos-list');
            const faltososList = document.getElementById('faltosos-list');
            [pautaList, aguardandoList, atendidosList, faltososList].forEach(el => el.innerHTML = '');

            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
            
            const pautaSearchTerm = normalizeText(document.getElementById('pauta-search').value);
            const aguardandoSearchTerm = normalizeText(document.getElementById('aguardando-search').value);
            const atendidosSearchTerm = normalizeText(document.getElementById('atendidos-search').value);
            const faltososSearchTerm = normalizeText(document.getElementById('faltosos-search').value);
            
            const searchFilter = (assisted, term) => !term || normalizeText(assisted.name).includes(term) || (assisted.cpf && normalizeText(assisted.cpf).includes(term)) || normalizeText(assisted.subject).includes(term);

            const pauta = allAssisted.filter(a => a.status === 'pauta' && a.type === 'agendamento' && searchFilter(a, pautaSearchTerm));
            const aguardando = allAssisted.filter(a => a.status === 'aguardando' && a.type === currentMode && searchFilter(a, aguardandoSearchTerm));
            const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === currentMode && searchFilter(a, atendidosSearchTerm));
            const faltosos = allAssisted.filter(a => a.status === 'faltoso' && a.type === 'agendamento' && searchFilter(a, faltososSearchTerm));

            pauta.sort((a, b) => (a.scheduledTime || '23:59').localeCompare(b.scheduledTime || '23:59'));
            atendidos.sort((a, b) => new Date(b.attendedTime) - new Date(a.attendedTime));
            faltosos.sort((a, b) => (a.scheduledTime || '00:00').localeCompare(b.scheduledTime || '00:00'));
            
            aguardando.sort((a, b) => {
                const order = { 'URGENTE': 0, 'M√°xima': 1, 'M√©dia': 2, 'M√≠nima': 3 };
                const priorityDiff = order[a.priority] - order[b.priority];
                if (priorityDiff !== 0) return priorityDiff;

                if (a.priority === 'M√°xima' && a.type === 'agendamento') {
                    const scheduledA = a.scheduledTime || '23:59';
                    const scheduledB = b.scheduledTime || '23:59';
                    if (scheduledA.localeCompare(scheduledB) !== 0) return scheduledA.localeCompare(scheduledB);
                }

                const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                if (arrivalA !== arrivalB) return arrivalA - arrivalB;
                
                return (a.createdAt || 0) - (b.createdAt || 0);
            });
            
            document.getElementById('pauta-count').textContent = pauta.length;
            document.getElementById('aguardando-count').textContent = aguardando.length;
            document.getElementById('faltosos-count').textContent = faltosos.length;
            document.getElementById('atendidos-count').textContent = atendidos.length;

            const render = (el, data, generator) => {
                if(data.length === 0) el.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado.</p>`;
                else data.forEach((item, index) => el.appendChild(generator(item, index)));
            };
            
            render(pautaList, pauta, a => {
                const card = document.createElement('div');
                card.className = 'relative bg-gray-50 p-4 rounded-lg shadow-sm border';
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <p class="font-bold text-lg">${a.name}</p>
                    ${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${a.cpf}</strong></p>` : ''}
                    <p>Assunto: <strong>${a.subject}</strong></p>
                    <p>Agendado: <strong>${a.scheduledTime}</strong></p>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                        <button data-id="${a.id}" class="check-in-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Marcar Chegada</button>
                        <button data-id="${a.id}" class="faltou-btn bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600">Faltou</button>
                        <button data-id="${a.id}" class="edit-assisted-btn col-span-2 bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600">Editar Dados</button>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${a.lastActionBy}</strong></div>` : ''}
                `;
                return card;
            });
            
            render(aguardandoList, aguardando, (a, index) => {
                const card = document.createElement('div');
                card.className = `relative bg-white p-4 rounded-lg shadow-sm ${getPriorityClass(a.priority)}`;
                const arrival = a.type === 'agendamento' && a.scheduledTime ? `Agendado: ${a.scheduledTime} | Chegou: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` : `Chegada: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                const returnToPautaBtn = a.type === 'agendamento' ? `<button data-id="${a.id}" class="return-to-pauta-btn w-full bg-gray-400 text-white font-semibold py-1 rounded-lg hover:bg-gray-500 text-xs mt-1">Voltar p/ Pauta</button>` : '';
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 0l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm3 .5a.5.5 0 0 0-1 0v8.5a.5.5 0 0 0 1 0v-8.5Z"/></svg></button>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${index + 1}. ${a.name}</p>
                            <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                            <p class="text-sm text-gray-500">${arrival}</p>
                            <button data-id="${a.id}" class="view-details-btn text-indigo-600 hover:text-indigo-800 text-sm hover:underline font-semibold py-1">Ver Detalhes</button>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-2 lg:grid-cols-3 gap-2">
                        <button data-id="${a.id}" class="attend-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>
                        ${a.priority !== 'URGENTE' ? `<button data-id="${a.id}" class="priority-btn bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 text-sm">Prioridade</button>` : ''}
                        <button data-id="${a.id}" class="edit-assisted-btn bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600 text-sm">Editar</button>
                    </div>
                    ${returnToPautaBtn ? `<div class="mt-2">${returnToPautaBtn}</div>` : ''}
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${a.lastActionBy}</strong></div>` : ''}
                    `;
                return card;
            });
            
            render(atendidosList, atendidos, a => {
                const card = document.createElement('div');
                card.className = 'relative bg-green-50 p-4 rounded-lg shadow-sm border-green-200';
                const totalAssuntos = 1 + (a.demandas?.quantidade ? Number(a.demandas.quantidade) : 0);
                const demandasInfo = a.demandas?.descricoes?.length > 0 ? `<div class="mt-2 text-xs bg-gray-100 p-2 rounded"><strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong><ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${d}</li>`).join('')}</ul></div>` : '';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-lg">${a.name} ${totalAssuntos > 1 ? `<span class="text-sm font-medium text-green-600">(${totalAssuntos} assuntos)</span>` : ''}</p>
                    </div>
                    <div class="card-details mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                        <p class="text-sm">Assunto Principal: <strong>${a.subject}</strong></p>
                        <div class="text-xs text-gray-600 grid grid-cols-3 gap-2 text-center border-y py-2">
                            <div><strong>Agendado:</strong><br>${a.scheduledTime || 'N/A'}</div>
                            <div><strong>Chegou:</strong><br>${a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                            <div><strong>Finalizado:</strong><br>${a.attendedTime ? new Date(a.attendedTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                        </div>
                        ${demandasInfo}
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-sm">Por: <strong>${a.attendant || 'N√£o informado'}</strong></p>
                            <div class="flex items-center gap-1 flex-wrap">
                                <button data-id="${a.id}" class="manage-demands-btn text-blue-600 hover:text-blue-800 font-semibold text-xs py-1 px-2 rounded hover:bg-blue-100">Demandas</button>
                                <button data-id="${a.id}" class="edit-assisted-btn text-gray-600 hover:text-gray-800 font-semibold text-xs py-1 px-2 rounded hover:bg-gray-100">Dados</button>
                                <button data-id="${a.id}" class="edit-attendant-btn text-green-600 hover:text-green-800 font-semibold text-xs py-1 px-2 rounded hover:bg-green-100">Atendente</button>
                                <button data-id="${a.id}" class="delete-btn text-red-600 hover:text-red-800 font-semibold text-xs py-1 px-2 rounded hover:bg-red-100">Deletar</button>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t flex justify-between items-center">
                            ${a.lastActionBy ? `<p class="text-xs text-gray-500">√öltima a√ß√£o por: <strong>${a.lastActionBy}</strong></p>` : '<div></div>'}
                            <button data-id="${a.id}" class="return-to-aguardando-btn bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600 text-xs">Voltar p/ Aguardando</button>
                        </div>
                    </div>
                    <div class="text-right mt-1">
                         <button class="toggle-details-btn text-gray-500 hover:text-gray-800 p-1">
                              <svg class="pointer-events-none" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                         </button>
                    </div>`;
                return card;
            });

            render(faltososList, faltosos, a => {
                const card = document.createElement('div');
                card.className = 'relative bg-red-50 p-4 rounded-lg shadow-sm border-red-200';
                const totalAssuntos = 1 + (a.demandas?.quantidade ? Number(a.demandas.quantidade) : 0);
                const demandasInfo = a.demandas?.descricoes?.length > 0 ? `<div class="mt-2 text-xs bg-gray-100 p-2 rounded"><strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong><ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${d}</li>`).join('')}</ul></div>` : '';
                card.innerHTML = `
                    <button data-id="${a.id}" class="delete-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5zM6 6.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm-5 1a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1h-6z"/></svg></button>
                    <p class="font-bold text-lg">${a.name}</p>
                    <div class="mt-2 space-y-2">
                        ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                        <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                        <p class="text-sm">Agendado: <strong>${a.scheduledTime}</strong></p>
                        <div class="mt-3">
                            <button data-id="${a.id}" class="return-to-pauta-from-faltoso-btn w-full bg-gray-500 text-white font-semibold py-1 rounded-lg hover:bg-gray-600 text-xs">Revertido para Pauta</button>
                        </div>
                    </div>
                    ${a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">√öltima a√ß√£o por: <strong>${a.lastActionBy}</strong></div>` : ''}
                `;
                return card;
            });
        };

        const showNotification = (message, type = 'success') => {
            const colors = { info: 'blue', error: 'red', success: 'green' };
            const notification = document.createElement('div');
            notification.className = `fixed top-5 right-5 bg-${colors[type]}-500 text-white py-3 px-6 rounded-lg shadow-lg z-[100] transition-transform transform translate-x-full`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            requestAnimationFrame(() => {
                notification.classList.remove('translate-x-full');
            });

            setTimeout(() => {
                notification.classList.add('translate-x-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        };

        const setupRealtimeListener = (pautaId) => {
            if (unsubscribeFromAttendances) unsubscribeFromAttendances();
            const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
            unsubscribeFromAttendances = onSnapshot(attendanceCollectionRef, (snapshot) => {
                allAssisted = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssistedList();
            }, (error) => console.error("Erro no listener do Firestore: ", error));
        };

    const loadPauta = async (pautaId, pautaName) => {
        currentPautaId = pautaId;
        document.getElementById('pauta-title').textContent = pautaName;
        
        const manageCollaboratorsBtn = document.getElementById('manage-collaborators-btn');
        if (manageCollaboratorsBtn) {
            manageCollaboratorsBtn.addEventListener('click', () => showGerenciarScreen());
        }

        const pautaDoc = await getDoc(doc(db, "pautas", pautaId));
        if (pautaDoc.exists()) {
            const pautaData = pautaDoc.data();
            currentPautaOwnerId = pautaData.owner;
            if (pautaData.owner === auth.currentUser.uid) {
                document.getElementById('edit-pauta-name-btn').classList.remove('hidden');
            } else {
                document.getElementById('edit-pauta-name-btn').classList.add('hidden');
            }
        }
        setupRealtimeListener(pautaId);
        showScreen('app');
    };

    const showGerenciarScreen = () => {
        if (!currentPautaId) {
            showNotification("Nenhuma pauta selecionada.", "error");
            return;
        }
        showScreen('gerenciar');
        loadColaboradores();
    };

    const showAppScreen = () => {
        showScreen('app');
        loadPauta(currentPautaId, document.getElementById('pauta-title').textContent);
    };

         /**
         * Exclui uma pauta do Firestore.
         * Em uma aplica√ß√£o real, seria ideal ter um modal de confirma√ß√£o customizado
         * antes de executar a exclus√£o.
         * @param {string} pautaId - O ID do documento da pauta a ser exclu√≠da.
         */
        const deletePauta = async (pautaId) => {
            try {
                // As fun√ß√µes 'doc' e 'deleteDoc' devem ser importadas do Firestore.
                await deleteDoc(doc(db, "pautas", pautaId));
                // A UI ser√° atualizada automaticamente pelo onSnapshot.
            } catch (error) {
                console.error("Erro ao excluir a pauta:", error);
                // Aqui, seria bom notificar o usu√°rio sobre o erro com um componente de UI.
            }
        };

        /**
         * Cria um elemento de card para uma pauta espec√≠fica.
         * Esta fun√ß√£o previne vulnerabilidades de Cross-Site Scripting (XSS)
         * ao usar `textContent` em vez de `innerHTML` para dados din√¢micos.
         * @param {import("firebase/firestore").QueryDocumentSnapshot} docSnap - O snapshot do documento da pauta.
         * @returns {HTMLDivElement} O elemento do card da pauta.
         */
        const createPautaCard = (docSnap) => {
            const pauta = docSnap.data();
            const card = document.createElement('div');
            card.className = "relative bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer flex flex-col justify-between h-full";

            // --- Bot√£o de Excluir ---
            const deleteButton = document.createElement('button');
            deleteButton.className = "absolute top-3 right-3 p-1 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500";
            deleteButton.setAttribute('aria-label', 'Excluir pauta');
            // SVG do √≠cone de lixeira
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;

            deleteButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Impede que o clique no bot√£o ative o clique no card
                deletePauta(docSnap.id);
            });

            card.appendChild(deleteButton); // Adiciona o bot√£o ao card

            // --- C√°lculo de Datas ---
            const creationDate = pauta.createdAt?.toDate ? pauta.createdAt.toDate() : new Date();
            const expirationDate = new Date(creationDate);
            expirationDate.setDate(creationDate.getDate() + 7); // Adiciona 7 dias para a data de expira√ß√£o

            const formattedCreationDate = creationDate.toLocaleDateString('pt-BR');
            const formattedExpirationDate = expirationDate.toLocaleDateString('pt-BR');

            // --- Cria√ß√£o de Elementos (Seguro contra XSS) ---
            const contentDiv = document.createElement('div');

            const title = document.createElement('h3');
            title.className = "font-bold text-xl mb-2";
            title.textContent = pauta.name; // Usar textContent √© crucial para seguran√ßa

            const members = document.createElement('p');
            members.className = "text-gray-600";
            members.textContent = `Membros: ${pauta.memberEmails?.length || 1}`;

            contentDiv.appendChild(title);
            contentDiv.appendChild(members);

            const footerDiv = document.createElement('div');
            footerDiv.className = "mt-4 pt-2 border-t border-gray-200";

            const createdP = document.createElement('p');
            createdP.className = "text-xs text-gray-500";
            createdP.innerHTML = `Criada em: <strong>${formattedCreationDate}</strong>`;

            const expiresP = document.createElement('p');
            expiresP.className = "text-xs text-red-600";
            expiresP.innerHTML = `Ser√° eliminada em: <strong>${formattedExpirationDate}</strong>`;

            footerDiv.appendChild(createdP);
            footerDiv.appendChild(expiresP);

            card.appendChild(contentDiv);
            card.appendChild(footerDiv);

            // Adiciona o evento de clique para carregar a pauta selecionada
            card.addEventListener('click', () => loadPauta(docSnap.id, pauta.name));
            return card;
        };


        /**
         * Exibe a tela de sele√ß√£o de pautas, buscando e renderizando as pautas do usu√°rio.
         * @param {string} userId - O ID do usu√°rio logado.
         */
        const showPautaSelectionScreen = (userId) => {
            const pautasList = document.getElementById('pautas-list');
            pautasList.innerHTML = '<p class="col-span-full text-center">Carregando pautas...</p>';

            const q = query(collection(db, "pautas"), where("members", "array-contains", userId));

            // 'onSnapshot' ouve por atualiza√ß√µes em tempo real.
            onSnapshot(q, (snapshot) => {
                pautasList.innerHTML = ''; // Limpa a lista antes de adicionar os novos itens

                if (snapshot.empty) {
                    pautasList.innerHTML = '<p class="col-span-full text-center text-gray-500">Voc√™ ainda n√£o tem pautas. Crie uma para come√ßar.</p>';
                    return;
                }

                // Usar um DocumentFragment melhora a performance ao adicionar muitos elementos ao DOM
                const fragment = document.createDocumentFragment();
                snapshot.docs.forEach((docSnap) => {
                    const card = createPautaCard(docSnap);
                    fragment.appendChild(card);
                });
                pautasList.appendChild(fragment);

            }, (error) => { // Adicionado tratamento de erro para a consulta
                console.error("Erro ao buscar pautas:", error);
                pautasList.innerHTML = '<p class="col-span-full text-center text-red-500">Ocorreu um erro ao carregar as pautas. Tente novamente mais tarde.</p>';
            });

            showScreen('pautaSelection');
        };




        const handleAuthState = () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().status === 'approved') {
                        currentUserName = userDoc.data().name || user.email;
                        showPautaSelectionScreen(user.uid);
                    } else {
                        loadingText.innerHTML = 'Sua conta est√° pendente de aprova√ß√£o. <br> Por favor, aguarde.';
                        document.querySelector('.loader').style.display = 'none';
                    }
                } else {
                    showScreen('login');
                }
            });
        };

        const showScreen = (screenName) => {
            loadingContainer.classList.toggle('hidden', screenName !== 'loading');
            loginContainer.classList.toggle('hidden', screenName !== 'login');
            pautaSelectionContainer.classList.toggle('hidden', screenName !== 'pautaSelection');
            appContainer.classList.toggle('hidden', screenName !== 'app');
            gerenciarContainer.classList.toggle('hidden', screenName !== 'gerenciar');
        };

        const switchTab = (tabName) => {
            const tabAgendamento = document.getElementById('tab-agendamento');
            const tabAvulso = document.getElementById('tab-avulso');
            const isScheduledContainer = document.getElementById('is-scheduled-container');
            const formTitle = document.getElementById('form-title');
            const pautaColumn = document.getElementById('pauta-column');

            if (tabName === 'agendamento') {
                tabAgendamento.classList.add('tab-active');
                tabAvulso.classList.remove('tab-active', 'text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.remove('hidden');
                pautaColumn.classList.remove('hidden');
                formTitle.textContent = "Adicionar Novo Agendamento";
            } else { // avulso
                tabAvulso.classList.add('tab-active');
                tabAgendamento.classList.remove('tab-active');
                tabAgendamento.classList.add('text-gray-500', 'hover:text-gray-700');
                isScheduledContainer.classList.add('hidden');
                pautaColumn.classList.add('hidden');
                formTitle.textContent = "Adicionar Atendimento Avulso";
                
                document.querySelector('input[name="is-scheduled"][value="no"]').checked = true;
                document.querySelector('input[name="has-arrived"][value="yes"]').checked = true;
                document.getElementById('scheduled-time-wrapper').classList.add('hidden');
                document.getElementById('arrival-time-wrapper').classList.remove('hidden');
            }
            renderAssistedList();
        };

        const main = () => {
            try {
                const firebaseConfig = { apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.appspot.com", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25" };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthState();
            } catch (error) {
                console.error("Erro ao inicializar o Firebase: ", error);
                loadingText.textContent = 'Erro na configura√ß√£o do Firebase.';
            }
        };

        const copyToClipboard = (text, message) => {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification(message, 'info');
            } catch (err) {
                showNotification('Erro ao copiar.', 'error');
            }
            document.body.removeChild(textArea);
        };

        const setupModalClosers = () => {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        };

        // --- IN√çCIO DA L√ìGICA DE GERENCIAR COLABORADORES ---
        let editColaboradorId = null;
        let colaboradoresCollectionRef = null;

        const loadColaboradores = () => {
            colaboradoresCollectionRef = collection(db, "pautas", currentPautaId, "attendances");
            unsubscribeFromColaboradores = onSnapshot(colaboradoresCollectionRef, (snapshot) => {
                const colaboradores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderColaboradoresList(colabor
