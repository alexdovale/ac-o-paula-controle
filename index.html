<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Pauta - SIGAP</title>
    
    <link rel="icon" type="image/png" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">

    <meta name="theme-color" content="#16a34a"/>
    <link rel="apple-touch-icon" href="https://alexdovale.github.io/ac-o-paula-controle/imagem.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .priority-urgente { border-left: 5px solid #ef4444; }
        .priority-maxima { border-left: 5px solid #22c55e; }
        .priority-media { border-left: 5px solid #f97316; }
        .priority-minima { border-left: 5px solid #6b7280; }
        .column-content::-webkit-scrollbar, .scrollable-content::-webkit-scrollbar, #policy-content::-webkit-scrollbar, #checklist-container::-webkit-scrollbar { width: 8px; }
        .column-content::-webkit-scrollbar-track, .scrollable-content::-webkit-scrollbar-track, #policy-content::-webkit-scrollbar-track, #checklist-container::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .column-content::-webkit-scrollbar-thumb, .scrollable-content::-webkit-scrollbar-thumb, #policy-content::-webkit-scrollbar-thumb, #checklist-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; }
        .tab-active { border-color: #16a34a; background-color: #f0fdf4; color: #16a34a; font-weight: 600; }
        .loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #16a34a; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-container" class="loading-container"><div class="loader"></div><p id="loading-text" class="mt-4 text-gray-700 font-semibold text-center">Conectando...</p></div>

    <div id="login-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <img src="https://alexdovale.github.io/ac-o-paula-controle/imagem.png" alt="Logo SIGAP" class="mx-auto h-24 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Sistema de Gerenciamento de Pauta</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="flex border-b mb-6">
                <button id="login-tab-btn" class="flex-1 py-2 text-center font-semibold text-green-600 border-b-2 border-green-600">Login</button>
                <button id="register-tab-btn" class="flex-1 py-2 text-center font-semibold text-gray-500">Cadastrar</button>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div class="text-right">
                    <a href="#" id="forgot-password-link" class="text-sm text-green-600 hover:underline">Esqueci minha senha</a>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Entrar</button>
            </form>
            <form id="register-form" class="hidden space-y-4">
                <div><label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="register-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="register-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <div><label for="register-password" class="block text-sm font-medium text-gray-700">Senha (mínimo 6 caracteres)</label><input type="password" id="register-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Criar Conta</button>
            </form>
            <a href="#" id="privacy-policy-link" class="block mt-4 text-center text-sm text-gray-500 hover:underline">
                    Política de Privacidade
            </a>
        </div>
    </div>

    <div id="pauta-selection-container" class="hidden max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Gerenciamento de Pauta - SIGAP</h1>
        </div>
        <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-800">Minhas Pautas</h2>
              <div>
                  <button id="admin-btn-main" class="hidden bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600">Painel do Admin</button>
                  <button id="logout-btn-main" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Sair</button>
              </div>
        </div>
        <div id="install-container" class="hidden my-4 p-3 bg-green-100 border border-green-200 rounded-lg text-center">
            <p class="text-sm text-green-800">Leve o gerenciador de pautas com você!</p>
            <button id="install-button" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 text-sm rounded-lg shadow-md hover:shadow-lg transition-all">
                Instalar App
            </button>
        </div>
        
        <div id="invitations-container" class="hidden mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Convites Pendentes</h2>
            <div id="pending-invitations-list" class="space-y-4"></div>
        </div>
        <div id="pautas-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div class="mt-6"><button id="create-pauta-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Criar Nova Pauta</button></div>
    </div>
    
    <div id="app-container" class="max-w-full mx-auto hidden">
        <header class="mb-6 space-y-4">
            <div class="flex justify-center items-center w-full relative">
                 <h1 class="text-xl font-semibold text-gray-600 text-center">Sistema de Gerenciamento de Pauta - SIGAP</h1>
                 <button id="logout-btn-app" title="Sair" class="absolute top-0 right-0 bg-gray-600 text-white font-bold p-2 rounded-lg hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                       <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                       <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                     </svg>
                 </button>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-4">
                 <div class="flex justify-center items-center border-b pb-4">
                     <h2 id="pauta-title" class="text-2xl md:text-3xl font-bold text-gray-800"></h2>
                      <button id="edit-pauta-name-btn" title="Editar nome da pauta" class="hidden ml-3 p-2 rounded-full hover:bg-gray-200 transition flex-shrink-0">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                              <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                              <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5h6a.5.5 0 0 0 0-1h-6A1.5 1.5 0 0 0 1 2.5v11z"/>
                          </svg>
                     </button>
                 </div>
                 <div class="flex justify-between items-center w-full gap-4 pt-4">
                     <div class="flex-shrink-0">
                         <button id="back-to-pautas-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">&larr; Voltar</button>
                     </div>
                     <div class="flex items-center gap-2 flex-shrink-0">
                         <button id="manage-members-btn" class="bg-lime-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-lime-700">Membros</button>
                         <button id="reset-all-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Zerar</button>
                         <button id="toggle-faltosos-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700" style="display: none;">Mostrar Faltosos</button>
                     </div>
                 </div>
            </div>
        </header>
        <div id="app-content">
              <div class="mb-6">
                  <div class="border-b border-gray-200">
                      <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                          <button id="tab-agendamento" class="tab-active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Agendado</button>
                          <button id="tab-avulso" class="text-gray-500 hover:text-gray-700 hover:bg-gray-100 whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg">Atendimento Avulso</button>
                      </nav>
                  </div>
              </div>
            <div id="form-agendamento" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 id="form-title" class="text-xl font-semibold text-gray-700">Adicionar Novo Agendamento</h2>
                    <div id="agendamento-actions" class="flex items-center gap-4">
                        <a href="#" id="format-help-link" class="text-sm text-green-600 hover:text-green-800 hover:underline transition-colors duration-300 flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM6.95 4.95a.9.9 0 1 1 1.272.023l.2.204a.9.9 0 0 1-.226 1.273L6.95 6.451a.9.9 0 0 1-.023-1.273l.204-.2zM8 8.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                            <span>Como converter minha pauta?</span>
                        </a>
                        <label for="file-upload" class="cursor-pointer bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition text-sm inline-flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            Carregar Pauta (CSV)
                        </label>
                        <input type="file" id="file-upload" class="hidden" accept=".csv">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="flex flex-col lg:col-span-2">
                            <label for="assisted-name" class="mb-1 font-medium text-gray-600">Nome do Assistido</label>
                            <input type="text" id="assisted-name" placeholder="Ex: João da Silva" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                        </div>
                        <div class="flex flex-col"><label for="assisted-cpf" class="mb-1 font-medium text-gray-600">CPF (Opcional)</label><input type="text" id="assisted-cpf" placeholder="___.___.___-__" maxlength="14" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                        <div class="flex flex-col lg:col-span-4"><label for="assisted-subject" class="mb-1 font-medium text-gray-600">Matéria - Assunto</label><input type="text" id="assisted-subject" placeholder="Ex: Divórcio" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition"></div>
                    </div>

                    <div id="form-options-container" class="border-t mt-4 pt-4 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <label class="font-medium text-gray-700">Possui horário agendado?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="is-scheduled" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="is-scheduled" value="no" class="mr-1" checked> Não</label>
                            </div>
                            <div id="scheduled-time-wrapper" class="hidden mt-2">
                                <label for="scheduled-time" class="block mb-1 font-medium text-gray-600">Horário Agendado</label>
                                <input type="time" id="scheduled-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Assistido já chegou?</label>
                            <div class="flex items-center gap-x-4 mt-1">
                                <label><input type="radio" name="has-arrived" value="yes" class="mr-1"> Sim</label>
                                <label><input type="radio" name="has-arrived" value="no" class="mr-1" checked> Não</label>
                            </div>
                            <div id="arrival-time-wrapper" class="hidden mt-2">
                                <label for="arrival-time" class="block mb-1 font-medium text-gray-600">Horário de Chegada</label>
                                <input type="time" id="arrival-time" class="p-3 w-full md:w-1/2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                            </div>
                        </div>
                    </div>
                     <button id="add-assisted-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-md w-full lg:w-auto">Adicionar</button>
                </div>
            </div>
            <main id="main-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="pauta-column" class="bg-white rounded-lg shadow-md flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                            <span>📋 Pauta</span>
                            <span id="pauta-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="pauta-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="pauta-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <h3 class="text-xl font-semibold text-gray-800 flex justify-between items-center">
                           <span>⏳ Aguardando Atendimento</span>
                           <span id="aguardando-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                        </h3>
                        <input type="search" id="aguardando-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="aguardando-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                ✅ Atendidos
                                <span id="atendidos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                            <button id="download-pdf-btn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm">Baixar PDF</button>
                        </div>
                        <input type="search" id="atendidos-search" placeholder="Pesquisar por nome, CPF, assunto..." class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="atendidos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
                 <div id="faltosos-column" class="bg-white rounded-lg shadow-md flex-col hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                🚫 Faltosos
                                <span id="faltosos-count" class="text-base font-normal bg-gray-200 text-gray-700 px-2 rounded-full"></span>
                            </h3>
                        </div>
                        <input type="search" id="faltosos-search" placeholder="Pesquisar..." class="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div id="faltosos-list" class="p-4 space-y-4 overflow-y-auto column-content" style="max-height: 60vh;"></div>
                </div>
            </main>
              <footer class="mt-12 bg-white p-6 rounded-lg shadow-md">
                  <h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">Entenda a Ordem de Atendimento</h3>
                  <div class="text-center mb-4">
                      <button id="toggle-logic-btn" class="text-green-600 hover:text-green-800 text-sm hover:underline transition-colors duration-300">Por que esta ordem é justa? (Clique para expandir)</button>
                  </div>
                  <div id="logic-explanation" class="hidden mt-4 text-left p-4 bg-gray-50 rounded-lg border space-y-3">
                      <p>A lógica foi pensada para balancear a <strong>pontualidade</strong> com a <strong>realidade</strong> do dia a dia, criando um sistema justo para todos.</p>
                      <ul class="list-disc list-inside space-y-2 text-gray-700">
                          <li><strong>Recompensa a Pontualidade:</strong> Valoriza quem chega no horário, atendendo-os primeiro. Para assistidos que chegam adiantados, a ordem de atendimento respeita o horário original do agendamento.</li>
                          <li><strong>Oferece Tolerância:</strong> Reconhece que imprevistos acontecem, com uma janela de 20 minutos para pequenos atrasos.</li>
                          <li><strong>Gerencia Atrasos Maiores:</strong> Coloca quem se atrasou muito no fim da fila para não prejudicar os outros.</li>
                          <li><strong>Permite Flexibilidade:</strong> O botão "Prioridade" garante que casos graves sejam atendidos imediatamente.</li>
                          <li><strong>Critério de Desempate:</strong> Para assistidos com a mesma prioridade, a ordem é definida pelo <strong>horário de chegada informado</strong> (quem chegou mais cedo é atendido primeiro). Se dois ou mais assistidos chegarem exatamente no mesmo horário, a preferência é de quem teve a chegada <strong>registrada primeiro</strong> no sistema.</li>
                      </ul>
                      <p class="font-semibold text-gray-800 pt-2">O resultado é uma fila transparente, previsível e justa tanto para os assistidos quanto para a equipe.</p>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center mt-4">
                      <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500"><p class="font-bold text-red-700">Prioridade Urgente</p><p class="text-sm text-gray-600 mt-1">Definida manualmente para casos que necessitam de atendimento imediato.</p></div>
                      <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500"><p class="font-bold text-green-700">Prioridade Máxima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram no horário agendado ou adiantados.</p></div>
                      <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500"><p class="font-bold text-orange-700">Prioridade Média</p><p class="text-sm text-gray-600 mt-1">Assistidos agendados com até 20 min de atraso ou atendimentos avulsos.</p></div>
                      <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-gray-500"><p class="font-bold text-gray-700">Prioridade Mínima</p><p class="text-sm text-gray-600 mt-1">Assistidos que chegaram com 30 minutos ou mais de atraso.</p></div>
                  </div>
                  <p class="text-center text-sm text-gray-500 mt-8">Desenvolvido por Alex do Vale e o Gemini</p>
              </footer>
        </div>
    </div>

    <div id="create-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        </div>
    
    <div id="members-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Membros</h2>
            <div id="invite-container" class="space-y-4 mb-6">
                 <div class="space-y-2">
                     <label for="invite-email-input" class="block text-sm font-medium text-gray-700">Convidar por email (caso não esteja na lista abaixo)</label>
                     <div class="flex gap-2">
                         <input type="email" id="invite-email-input" class="flex-1 p-2 border border-gray-300 rounded-lg" placeholder="email@exemplo.com">
                         <button id="invite-member-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Convidar</button>
                     </div>
                 </div>
                 <div class="mt-4">
                     <h3 class="font-semibold text-gray-800 mb-2">Usuários cadastrados no SIGAP</h3>
                     <div id="registered-users-list" class="space-y-2 max-h-48 overflow-y-auto border p-3 rounded-lg bg-gray-50 scrollable-content"></div>
                 </div>
            </div>
            <h3 class="font-semibold mt-6 mb-2">Membros Atuais da Pauta</h3>
            <div id="current-members-list" class="space-y-2 max-h-40 overflow-y-auto border p-3 rounded-lg bg-gray-50 scrollable-content"></div>
             <h3 class="font-semibold mt-6 mb-2">Convites Pendentes</h3>
            <div id="pending-invites-members-modal-list" class="space-y-2 max-h-40 overflow-y-auto border p-3 rounded-lg bg-gray-100 scrollable-content"></div>
            <div class="flex justify-end mt-6">
                <button id="close-members-modal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Fechar</button>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Painel do Administrador</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto scrollable-content pr-4 flex-grow">
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Aprovar Novos Usuários</h3>
                    <div id="pending-users-list" class="space-y-4"></div>
                </div>
                <div>
                    <h3 id="pautas-report-title" class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Relatório de Pautas do Sistema</h3>
                    <div id="pauta-stats-container" class="space-y-3"></div>
                </div>
            </div>
            <div class="flex justify-end mt-6 border-t pt-4">
                <button id="close-admin-modal-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition">Fechar</button>
            </div>
        </div>
    </div>
    <div id="arrival-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Confirmar Horário de Chegada</h2><p class="mb-4 text-gray-600">Por favor, informe o horário de chegada do assistido.</p><input type="time" id="arrival-time-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-arrival-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-arrival-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">Finalizar Atendimento</h2><p class="mb-4 text-gray-600">Insira o nome do profissional que realizou o atendimento (opcional).</p><input type="text" id="attendant-name" placeholder="Nome do Defensor/Servidor" class="w-full p-3 border border-gray-300 rounded-lg mb-6"><div class="flex justify-end space-x-4"><button id="cancel-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button></div></div>
    </div>
    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg space-y-4"><h2 class="text-2xl font-bold text-gray-800">Zerar Pauta</h2><p class="text-gray-600">Tem certeza de que deseja apagar permanentemente todos os dados desta pauta?</p><div class="flex justify-end space-x-4 pt-4"><button id="cancel-reset-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button><button id="confirm-reset-btn" class="bg-red-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-800">Zerar Pauta</button></div></div>
    </div>
    <div id="edit-pauta-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Nome da Pauta</h2>
            <label for="edit-pauta-name-input" class="block text-sm font-medium text-gray-700 mb-2">Novo nome</label>
            <input type="text" id="edit-pauta-name-input" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-pauta-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-pauta-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
      <div id="format-help-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
          <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
              <div class="flex justify-between items-center mb-4">
                  <h2 class="text-2xl font-bold text-gray-800">Como Converter sua Pauta</h2>
                  <button id="close-format-help-btn-x" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
              </div>
              <p class="mb-4 text-gray-600">Para converter uma pauta em PDF para o formato CSV, você pode me pedir diretamente. Use o texto abaixo e envie seu arquivo PDF.</p>
              <h3 class="font-semibold text-lg mb-2 text-gray-700">Texto para usar na IA:</h3>
              <pre id="instruction-text" class="bg-gray-100 p-4 rounded-md text-gray-800 mb-4 max-h-40 overflow-y-auto scrollable-content"><code>Olá! Por favor, converta o conteúdo do arquivo PDF que estou enviando para o formato CSV, usando ponto e vírgula (;) como separador. O resultado deve seguir este padrão:

Nome Completo do Assistido;HH:MM;Matéria do Assunto;CPF(opcional)

Por favor, me entregue o texto pronto para que eu possa salvar em um arquivo .csv.</code></pre>
              <p class="mb-4 text-gray-600 mt-4">Após a conversão, salve o texto recebido em um arquivo com a extensão <code class="bg-gray-200 text-sm p-1 rounded">.csv</code> e carregue-o no sistema.</p>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="copy-instruction-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Copiar Texto</button>
                <button id="close-format-help-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Entendi</button>
            </div>
          </div>
     </div>
    <div id="edit-attendant-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Editar Atendente</h2>
            <input type="text" id="edit-attendant-name" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-edit-attendant-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-attendant-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="demands-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Editar Demandas para <span id="demands-assisted-name" class="text-green-600"></span></h2>
            <div class="space-y-4">
                <div>
                    <label for="demands-quantity" class="block text-sm font-medium text-gray-700">Quantidade de Demandas <strong class="font-semibold">Adicionais</strong></label>
                    <p class="text-xs text-gray-500 -mt-1 mb-1">O assunto principal (<span id="demands-main-subject" class="font-semibold"></span>) já está contado.</p>
                    <input type="number" id="demands-quantity" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div id="demands-descriptions-container" class="space-y-2 max-h-60 overflow-y-auto scrollable-content pr-2">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-demands-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-demands-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Demandas</button>
            </div>
        </div>
    </div>
    <div id="edit-assisted-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Editar Dados do Assistido</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label for="edit-assisted-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="edit-assisted-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label for="edit-assisted-cpf" class="block text-sm font-medium text-gray-700">CPF (Opcional)</label>
                    <input type="text" id="edit-assisted-cpf" placeholder="___.___.___-__" maxlength="14" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div id="edit-scheduled-time-wrapper">
                    <label for="edit-scheduled-time" class="block text-sm font-medium text-gray-700">Horário Agendado</label>
                    <input type="time" id="edit-scheduled-time" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <label for="edit-assisted-subject" class="block text-sm font-medium text-gray-700">Matéria - Assunto</label>
                    <input type="text" id="edit-assisted-subject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button id="cancel-edit-assisted-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-edit-assisted-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar Alterações</button>
            </div>
        </div>
    </div>
    <div id="priority-reason-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Definir como Prioritário</h2>
            <p class="mb-4 text-gray-600">Por favor, informe o motivo para dar prioridade a este atendimento.</p>
            <textarea id="priority-reason-input" placeholder="Motivo da prioridade..." class="w-full p-3 border border-gray-300 rounded-lg mb-6" rows="3"></textarea>
            <div class="flex justify-end space-x-4">
                <button id="cancel-priority-reason-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-priority-reason-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="forgot-password-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Redefinir Senha</h2>
            <p class="mb-4 text-gray-600">Digite seu e-mail para enviarmos um link de redefinição de senha.</p>
            <input type="email" id="reset-email-input" placeholder="seu-email@exemplo.com" class="w-full p-3 border border-gray-300 rounded-lg mb-6">
            <div class="flex justify-end space-x-4">
                <button id="cancel-reset-password-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="confirm-reset-password-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Enviar Link</button>
            </div>
        </div>
    </div>
    <div id="privacy-policy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        </div>
    
    <div id="documents-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">
                    Documentos para <span id="documents-assisted-name" class="text-green-600"></span>
                </h2>
                <button id="close-documents-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div id="document-action-selection" class="flex-grow">
                <p class="text-gray-600 mb-4">Selecione o tipo de ação para ver a lista de documentos necessários:</p>
                <div class="space-y-3">
                    <button data-action="alimentos_fixacao" class="document-action-btn w-full text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">1. Ação de Alimentos (Fixação ou Pedido de Pensão)</span>
                    </button>
                    <button data-action="alimentos_oferta" class="document-action-btn w-full text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">2. Ação de Oferta de Alimentos</span>
                    </button>
                    <button data-action="divorcio_litigioso" class="document-action-btn w-full text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">3. Ação de Divórcio Litigioso</span>
                    </button>
                    <button data-action="divorcio_consensual" class="document-action-btn w-full text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">4. Ação de Divórcio Consensual</span>
                    </button>
                    <button data-action="outros" class="document-action-btn w-full text-left p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border transition">
                        <span class="font-semibold text-gray-800">5. Outros (Personalizado)</span>
                    </button>
                </div>
            </div>

            <div id="document-checklist-view" class="hidden flex-grow flex-col">
                <div class="flex justify-between items-center gap-4 mb-4 flex-shrink-0">
                    <h3 id="checklist-title" class="text-xl font-bold text-gray-800"></h3>
                    <button id="change-action-btn" class="text-sm bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600">Trocar Ação</button>
                </div>
                <div id="custom-doc-adder" class="hidden flex gap-2 mb-4 p-3 bg-gray-100 rounded-lg border">
                    <input type="text" id="custom-doc-input" placeholder="Digite o nome do documento" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition">
                    <button id="add-custom-doc-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Adicionar</button>
                </div>
                <div id="checklist-container" class="space-y-4 overflow-y-auto pr-2 flex-grow max-h-[60vh]">
                </div>
                 <div class="flex justify-center space-x-4 mt-6 pt-4 border-t flex-shrink-0">
                    <button id="cancel-checklist-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button id="save-checklist-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Salvar</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, getDoc, setDoc, query, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, allAssisted = [], currentPautaId = null, unsubscribeFromAttendances = () => {}, currentUserName = '';
        let assistedIdToHandle = null;
        let currentChecklistAction = null; 
        
        const loadingContainer = document.getElementById('loading-container');
        const loginContainer = document.getElementById('login-container');
        const pautaSelectionContainer = document.getElementById('pauta-selection-container');
        const appContainer = document.getElementById('app-container');
        const loadingText = document.getElementById('loading-text');

        const normalizeText = (str) => {
            if (!str) return '';
            return str.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        };

        const isValidCPF = (cpf) => {
            if (typeof cpf !== 'string') return false;
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) return false;
            const cpfDigits = cpf.split('').map(el => +el);
            const getVerifier = (digits) => {
                const sum = digits.reduce((acc, val, i) => acc + val * (digits.length + 1 - i), 0);
                const rest = (sum * 10) % 11;
                return rest === 10 ? 0 : rest;
            };
            const verifier1 = getVerifier(cpfDigits.slice(0, 9));
            if (verifier1 !== cpfDigits[9]) return false;
            const verifier2 = getVerifier(cpfDigits.slice(0, 10));
            return (verifier2 === cpfDigits[10]);
        }
        
        const isValidEmail = (email) => {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        const main = () => {
            try {
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config !== '{}') {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    firebaseConfig = {
                        apiKey:"AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.firebasestorage.app", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25"
                    };
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthState();
            } catch (error) {
                console.error("Erro ao inicializar o Firebase: ", error);
                loadingText.textContent = 'Erro na configuração do Firebase.';
            }
        };

        const handleAuthState = () => {
            onAuthStateChanged(auth, async (user) => {
                try {
                    unsubscribeFromAttendances();
                    if (user) {
                        if (!user.emailVerified) {
                             loadingText.innerHTML = `Sua conta foi criada, mas seu e-mail ainda não foi verificado.<br>Por favor, verifique sua caixa de entrada para ativar sua conta.`;
                             document.querySelector('.loader').style.display = 'none';
                             
                             const logoutBtn = document.createElement('button');
                             logoutBtn.textContent = 'Sair';
                             logoutBtn.className = 'mt-4 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700';
                             logoutBtn.onclick = () => signOut(auth);
                             
                             const existingBtn = loadingContainer.querySelector('#logout-pending-btn');
                             if (existingBtn) existingBtn.remove();
                             loadingContainer.appendChild(logoutBtn);
                             showScreen('loading');
                             return;
                        }

                        loadingText.textContent = 'Verificando sua conta...';
                        showScreen('loading');

                        const userDoc = await getDoc(doc(db, "users", user.uid));

                        if (!userDoc.exists() || userDoc.data().status !== 'approved') {
                            loadingText.innerHTML = `Olá! Sua conta está pendente de aprovação.<br>Por favor, aguarde.`;
                            document.querySelector('.loader').style.display = 'none';
                            const logoutBtn = document.createElement('button');
                            logoutBtn.id = 'logout-pending-btn';
                            logoutBtn.textContent = 'Sair';
                            logoutBtn.className = 'mt-4 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700';
                            logoutBtn.onclick = () => signOut(auth);
                            
                            const existingBtn = loadingContainer.querySelector('#logout-pending-btn');
                            if (existingBtn) existingBtn.remove();
                            loadingContainer.appendChild(logoutBtn);
                            
                            showScreen('loading');
                            currentUserName = '';
                            return;
                        }

                        document.querySelector('.loader').style.display = 'block';
                        const pendingLogoutBtn = loadingContainer.querySelector('#logout-pending-btn');
                        if (pendingLogoutBtn) pendingLogoutBtn.remove();
                        
                        currentUserName = userDoc.data().name || '';
                        
                        const isAdmin = userDoc.data().role === 'admin';
                        document.getElementById('admin-btn-main').classList.toggle('hidden', !isAdmin);

                        showPautaSelectionScreen(user.uid);
                    } else {
                        currentUserName = '';
                        showScreen('login');
                    }
                } catch (error) {
                    console.error("Erro na verificação de autenticação:", error);
                    loadingText.textContent = 'Ocorreu um erro ao verificar sua conta. Verifique sua conexão e tente novamente.';
                    document.querySelector('.loader').style.display = 'none';
                    const reloadBtn = document.createElement('button');
                    reloadBtn.textContent = 'Tentar Novamente';
                    reloadBtn.className = 'mt-4 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700';
                    reloadBtn.onclick = () => window.location.reload();
                    
                    const existingBtn = loadingContainer.querySelector('button');
                    if(existingBtn) existingBtn.remove();
                    loadingContainer.appendChild(reloadBtn);
                }
            });
        };
        
        const showScreen = (screenName) => {
            loadingContainer.classList.toggle('hidden', screenName !== 'loading');
            loginContainer.classList.toggle('hidden', screenName !== 'login');
            pautaSelectionContainer.classList.toggle('hidden', screenName !== 'pautaSelection');
            appContainer.classList.toggle('hidden', screenName !== 'app');
        };

        const showPautaSelectionScreen = async (userId) => {
            const invitationsList = document.getElementById('pending-invitations-list');
            const invitationsContainer = document.getElementById('invitations-container');
            invitationsContainer.classList.add('hidden');
            invitationsList.innerHTML = '';

            if (auth.currentUser) {
                const invQuery = query(collection(db, "pautas"), where("pendingInvites", "array-contains", auth.currentUser.email));
                const invSnapshot = await getDocs(invQuery);

                if (!invSnapshot.empty) {
                    invitationsContainer.classList.remove('hidden');
                    const ownerIds = [...new Set(invSnapshot.docs.map(doc => doc.data().owner).filter(id => id))];
                    const ownerNames = {};

                    if (ownerIds.length > 0) {
                         const ownerDocs = await Promise.all(ownerIds.map(id => getDoc(doc(db, "users", id))));
                         ownerDocs.forEach(doc => { if (doc.exists()) ownerNames[doc.id] = doc.data().name; });
                    }

                    invSnapshot.forEach(pautaDoc => {
                        const pauta = pautaDoc.data();
                        const ownerName = ownerNames[pauta.owner] || 'Desconhecido';
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
                        card.innerHTML = `
                            <div>
                                <h4 class="font-bold">${pauta.name}</h4>
                                <p class="text-sm text-gray-600">Convidado por: ${ownerName}</p>
                            </div>
                            <div class="flex gap-2">
                                <button data-pauta-id="${pautaDoc.id}" class="accept-invite-btn bg-green-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-green-600 text-sm">Aceitar</button>
                                <button data-pauta-id="${pautaDoc.id}" class="decline-invite-btn bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Recusar</button>
                            </div>
                        `;
                        invitationsList.appendChild(card);
                    });
                }
            }

            const pautasList = document.getElementById('pautas-list');
            pautasList.innerHTML = '<p class="col-span-full text-center">Carregando pautas...</p>';
            const q = query(collection(db, "pautas"), where("members", "array-contains", userId));
            onSnapshot(q, (snapshot) => {
                pautasList.innerHTML = '';
                if (snapshot.empty) pautasList.innerHTML = '<p class="col-span-full text-center text-gray-500">Você ainda não faz parte de nenhuma pauta. Crie uma para começar!</p>';
                snapshot.forEach((doc) => {
                    const pauta = doc.data();
                    const card = document.createElement('div');
                    card.className = "relative bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow";
                    
                    const dataPauta = pauta.dataDaPauta ? new Date(pauta.dataDaPauta).toLocaleDateString('pt-BR') : 'N/A';
                    const dataEliminacao = pauta.dataDeEliminacao ? new Date(pauta.dataDeEliminacao).toLocaleDateString('pt-BR') : 'N/A';
                    
                    let cardContent = `
                        <div class="cursor-pointer">
                            <h3 class="font-bold text-xl mb-2">${pauta.name}</h3>
                            <p class="text-gray-600">Membros: ${pauta.memberEmails.length}</p>
                            <p class="text-sm text-gray-500 mt-2"><strong>Data da Pauta:</strong> ${dataPauta}</p>
                            <p class="text-sm text-gray-500"><strong>Dados serão eliminados em:</strong> ${dataEliminacao}</p>
                        </div>
                    `;

                    if (pauta.owner === userId) {
                        cardContent += `<button data-id="${doc.id}" class="delete-pauta-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                            </svg>
                        </button>`;
                    }

                    card.innerHTML = cardContent;
                    card.querySelector('div.cursor-pointer').addEventListener('click', () => loadPauta(doc.id, pauta.name));
                    pautasList.appendChild(card);
                });
            });
            showScreen('pautaSelection');
        };

        const loadPauta = async (pautaId, pautaName) => {
            currentPautaId = pautaId;
            document.getElementById('pauta-title').textContent = pautaName;

            const editBtn = document.getElementById('edit-pauta-name-btn');
            const pautaDoc = await getDoc(doc(db, "pautas", pautaId));
            if (pautaDoc.exists() && pautaDoc.data().owner === auth.currentUser.uid) {
                editBtn.classList.remove('hidden');
            } else {
                editBtn.classList.add('hidden');
            }

            setupRealtimeListener(pautaId);
            showScreen('app');
        };
        
        const setupRealtimeListener = (pautaId) => {
            const attendanceCollectionRef = collection(db, "pautas", pautaId, "attendances");
            unsubscribeFromAttendances = onSnapshot(attendanceCollectionRef, (snapshot) => {
                allAssisted = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssistedList();
            });
        };
        
        const getPriorityClass = (priority) => ({'URGENTE':'priority-urgente','Máxima':'priority-maxima','Média':'priority-media','Mínima':'priority-minima'}[priority]||'');
        const getPriorityLabel = (priority) => ({'URGENTE':'<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">PRIORIDADE</span>','Máxima':'<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">Máxima</span>','Média':'<span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">Média</span>','Mínima':'<span class="text-xs font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded-full">Mínima</span>'}[priority]||'');

        const renderAssistedList = () => {
            const pautaList = document.getElementById('pauta-list');
            const aguardandoList = document.getElementById('aguardando-list');
            const atendidosList = document.getElementById('atendidos-list');
            const faltososList = document.getElementById('faltosos-list');
            [pautaList, aguardandoList, atendidosList, faltososList].forEach(el => el.innerHTML = '');

            const currentMode = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'agendamento' : 'avulso';
            
            const pautaSearchTerm = normalizeText(document.getElementById('pauta-search').value);
            const aguardandoSearchTerm = normalizeText(document.getElementById('aguardando-search').value);
            const atendidosSearchTerm = normalizeText(document.getElementById('atendidos-search').value);
            const faltososSearchTerm = normalizeText(document.getElementById('faltosos-search').value);

            
            const searchFilter = (assisted, term) => {
                if (!term) return true;
                return normalizeText(assisted.name).includes(term) ||
                       (assisted.cpf && normalizeText(assisted.cpf).includes(term)) ||
                       normalizeText(assisted.subject).includes(term);
            };

            const pauta = allAssisted.filter(a => a.status === 'pauta' && a.type === 'agendamento' && searchFilter(a, pautaSearchTerm));
            const aguardando = allAssisted.filter(a => a.status === 'aguardando' && a.type === currentMode && searchFilter(a, aguardandoSearchTerm));
            const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === currentMode && searchFilter(a, atendidosSearchTerm));
            const faltosos = allAssisted.filter(a => a.status === 'faltoso' && a.type === 'agendamento' && searchFilter(a, faltososSearchTerm));

            pauta.sort((a, b) => (a.order || 0) - (b.order || 0));
            atendidos.sort((a, b) => new Date(a.attendedTime) - new Date(b.attendedTime));
            faltosos.sort((a, b) => (a.scheduledTime || '00:00').localeCompare(b.scheduledTime || '00:00'));
            
            aguardando.sort((a, b) => {
                const order = { 'URGENTE': 0, 'Máxima': 1, 'Média': 2, 'Mínima': 3 };
                const priorityDiff = order[a.priority] - order[b.priority];
                if (priorityDiff !== 0) return priorityDiff;

                if (a.priority === 'Máxima' && a.type === 'agendamento') {
                    const scheduledA = a.scheduledTime || '23:59';
                    const scheduledB = b.scheduledTime || '23:59';
                    if (scheduledA.localeCompare(scheduledB) !== 0) return scheduledA.localeCompare(scheduledB);
                }

                const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : 0;
                const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : 0;
                if (arrivalA !== arrivalB) return arrivalA - arrivalB;

                const checkInA = a.checkInTimestamp ? new Date(a.checkInTimestamp).getTime() : 0;
                const checkInB = b.checkInTimestamp ? new Date(b.checkInTimestamp).getTime() : 0;
                return checkInA - checkInB;
            });
            
            document.getElementById('pauta-count').textContent = pauta.length;
            document.getElementById('aguardando-count').textContent = aguardando.length;
            document.getElementById('atendidos-count').textContent = atendidos.length;
            document.getElementById('faltosos-count').textContent = faltosos.length;


            const render = (el, data, generator) => {
                if(data.length === 0) el.innerHTML = `<p class="text-gray-500 text-center p-4">Nenhum resultado encontrado.</p>`;
                else data.forEach((item, index) => el.appendChild(generator(item, index)));
            };
            
            render(pautaList, pauta, a => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border';
                const lastActionInfo = a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : '';
                card.innerHTML = `<p class="font-bold text-lg">${a.name}</p>${a.cpf ? `<p class="text-sm text-gray-500">CPF: <strong>${a.cpf}</strong></p>` : ''}<p>Assunto: <strong>${a.subject}</strong></p><p>Agendado: <strong>${a.scheduledTime}</strong></p>
                <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                    <button data-id="${a.id}" class="check-in-btn bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600">Marcar Chegada</button>
                    <button data-id="${a.id}" class="faltou-btn bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600">Faltou</button>
                    <button data-id="${a.id}" class="edit-assisted-btn col-span-2 bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600">Editar Dados</button>
                </div>
                ${lastActionInfo}`;
                return card;
            });
            
            render(aguardandoList, aguardando, (a, index) => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow-sm ${getPriorityClass(a.priority)}`;
                const arrival = a.type === 'agendamento' && a.scheduledTime ? `Agendado: ${a.scheduledTime} | Chegou: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` : `Chegada: ${new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                const lastActionInfo = a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : '';
                const priorityReasonInfo = a.priority === 'URGENTE' && a.priorityReason ? `<p class="text-xs text-red-600 mt-1 italic"><strong>Motivo:</strong> ${a.priorityReason}</p>` : '';
                const returnToPautaBtn = a.type === 'agendamento' ? `<button data-id="${a.id}" class="return-to-pauta-btn w-full bg-gray-400 text-white font-semibold py-1 rounded-lg hover:bg-gray-500 text-xs mt-1">Voltar p/ Pauta</button>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${index + 1}. ${a.name}</p>
                            ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                            <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                            <p class="text-sm text-gray-500">${arrival}</p>
                        </div>
                        ${getPriorityLabel(a.priority)}
                    </div>
                    ${priorityReasonInfo}
                    <div class="mt-2">
                        <button data-id="${a.id}" class="view-details-btn text-indigo-600 hover:text-indigo-800 text-sm hover:underline font-semibold py-1">Ver Detalhes</button>
                    </div>
                    <div class="mt-3 grid grid-cols-2 lg:grid-cols-3 gap-2">
                        <button data-id="${a.id}" class="attend-btn bg-blue-500 text-white font-semibold py-2 rounded-lg hover:bg-blue-600 text-sm">Atender</button>
                        ${a.priority !== 'URGENTE' ? `<button data-id="${a.id}" class="priority-btn bg-red-500 text-white font-semibold py-2 rounded-lg hover:bg-red-600 text-sm">Prioridade</button>` : ''}
                        <button data-id="${a.id}" class="edit-assisted-btn bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600 text-sm">Editar</button>
                    </div>
                    ${returnToPautaBtn ? `<div class="mt-2">${returnToPautaBtn}</div>` : ''}
                    ${lastActionInfo}`;
                return card;
            });
            
            render(atendidosList, atendidos, a => {
                const card = document.createElement('div');
                card.className = 'bg-green-50 p-4 rounded-lg shadow-sm border-green-200';
                
                const totalAssuntos = 1 + (a.demandas && a.demandas.quantidade ? Number(a.demandas.quantidade) : 0);
                const demandasInfo = a.demandas && a.demandas.descricoes && a.demandas.descricoes.length > 0 ?
                    `<div class="mt-2 text-xs bg-gray-100 p-2 rounded">
                        <strong class="text-gray-700">Demandas Adicionais (${a.demandas.quantidade || 0}):</strong>
                        <ul class="list-disc list-inside pl-2 text-gray-600">${a.demandas.descricoes.map(d => `<li>${d}</li>`).join('')}</ul>
                    </div>` : '';
                
                const lastActionInfo = a.lastActionBy ? `<p class="text-xs text-gray-500">Última ação por: <strong>${a.lastActionBy}</strong></p>` : '';

                card.innerHTML = `<p class="font-bold text-lg">${a.name} ${totalAssuntos > 1 ? `<span class="text-sm font-medium text-green-600">(${totalAssuntos} assuntos)</span>` : ''}</p>
                    ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                    <p class="text-sm">Assunto Principal: <strong>${a.subject}</strong></p>
                     <div class="text-xs text-gray-600 mt-2 grid grid-cols-3 gap-2 text-center border-y py-2">
                        <div><strong>Agendado:</strong><br>${a.scheduledTime || 'N/A'}</div>
                        <div><strong>Chegou:</strong><br>${a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                        <div><strong>Finalizado:</strong><br>${a.attendedTime ? new Date(a.attendedTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</div>
                     </div>
                    ${demandasInfo}
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-sm">Por: <strong>${a.attendant || 'Não informado'}</strong></p>
                        <div class="flex items-center gap-1">
                            <button data-id="${a.id}" class="edit-assisted-btn text-gray-600 hover:text-gray-800 font-semibold text-xs py-1 px-2 rounded hover:bg-gray-100">Dados</button>
                            <button data-id="${a.id}" class="edit-demands-btn text-lime-600 hover:text-lime-800 font-semibold text-xs py-1 px-2 rounded hover:bg-lime-100">Demandas</button>
                            <button data-id="${a.id}" class="edit-attendant-btn text-green-600 hover:text-green-800 font-semibold text-xs py-1 px-2 rounded hover:bg-green-100">Atendente</button>
                            <button data-id="${a.id}" class="delete-attended-btn text-red-600 hover:text-red-800 font-semibold text-xs py-1 px-2 rounded hover:bg-red-100">Deletar</button>
                        </div>
                    </div>
                     <div class="mt-2 pt-2 border-t flex justify-between items-center">
                        ${lastActionInfo}
                        <button data-id="${a.id}" class="return-to-aguardando-btn bg-yellow-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-600 text-xs">Voltar p/ Aguardando</button>
                     </div>`;
                return card;
            });

            render(faltososList, faltosos, a => {
                const card = document.createElement('div');
                card.className = 'bg-red-50 p-4 rounded-lg shadow-sm border-red-200';
                const lastActionInfo = a.lastActionBy ? `<div class="text-xs text-right text-gray-400 mt-2 pt-2 border-t">Última ação por: <strong>${a.lastActionBy}</strong></div>` : '';
                card.innerHTML = `<p class="font-bold text-lg">${a.name}</p>
                    ${a.cpf ? `<p class="text-sm">CPF: <strong>${a.cpf}</strong></p>` : ''}
                    <p class="text-sm">Assunto: <strong>${a.subject}</strong></p>
                    <p class="text-sm">Agendado: <strong>${a.scheduledTime}</strong></p>
                    <div class="mt-3">
                        <button data-id="${a.id}" class="return-to-pauta-from-faltoso-btn w-full bg-gray-500 text-white font-semibold py-1 rounded-lg hover:bg-gray-600 text-xs">Reverter para Pauta</button>
                    </div>
                    ${lastActionInfo}`;
                return card;
            });
        };

        const showNotification = (message, type = 'info') => {
            const colors = { info: 'green', error: 'red', success: 'green' };
            const color = colors[type];
            const notification = document.createElement('div');
            notification.className = `fixed top-5 right-5 bg-${color}-500 text-white py-3 px-6 rounded-lg shadow-lg animate-pulse`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        };
        
        const updateDemandDescriptions = (quantity, descriptions = []) => {
            const container = document.getElementById('demands-descriptions-container');
            container.innerHTML = '';
            for (let i = 0; i < quantity; i++) {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = `Descrição da Demanda Adicional ${i + 1}`;
                label.className = "block text-sm font-medium text-gray-600 mb-1";
                const textarea = document.createElement('textarea');
                textarea.className = "demand-description-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500";
                textarea.rows = 2;
                textarea.value = descriptions[i] || '';
                div.appendChild(label);
                div.appendChild(textarea);
                container.appendChild(div);
            }
        };

        const formatMinutesDuration = (ms) => {
            if (ms < 0 || isNaN(ms) || ms === null) return 'N/A';
            const minutes = Math.floor(ms / 60000);
            return `${minutes} min`;
        };
        
        const applyCpfMaskAndValidation = (cpfField) => {
            let value = cpfField.value.replace(/\D/g, '');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            cpfField.value = value;
            
            const cleanCpf = value.replace(/\D/g, '');
            
            if (cleanCpf.length === 0) {
                cpfField.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500');
                cpfField.classList.add('border-gray-300', 'focus:ring-green-500');
                return;
            }
            
            if (cleanCpf.length === 11) {
                if (isValidCPF(cleanCpf)) {
                    cpfField.classList.remove('border-red-500', 'focus:ring-red-500', 'border-gray-300');
                    cpfField.classList.add('border-green-500', 'focus:ring-green-500');
                } else {
                    cpfField.classList.remove('border-green-500', 'focus:ring-green-500', 'border-gray-300');
                    cpfField.classList.add('border-red-500', 'focus:ring-red-500');
                }
            } else {
                cpfField.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500');
                cpfField.classList.add('border-gray-300', 'focus:ring-green-500');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            main();

            // LÓGICA DO MODAL DE DOCUMENTOS
            const documentsData = {
                alimentos_fixacao: {
                    title: 'Ação de Alimentos (Fixação)',
                    sections: [ { title: 'Do(a) Representante Legal (quem pede a pensão):', docs: ['Carteira de Identidade e CPF.','Comprovante de residência.','Certidão de nascimento ou casamento.','Carteira de Trabalho ou contracheque.','Extratos bancários dos últimos três meses ou a última declaração de Imposto de Renda (se houver).','Dados bancários para o depósito da pensão.'] }, { title: 'Do(a) Filho(a) (Alimentando):', docs: ['Certidão de Nascimento.','Comprovantes de despesas da criança/adolescente (escola, saúde, lazer, etc.) e de eventuais necessidades especiais.'] }, { title: 'Informações sobre o Réu (quem vai pagar):', docs: ['Endereço completo para citação.','Nome e endereço do local de trabalho (se souber).','Dados da empregadora (se souber).'] } ]
                },
                alimentos_oferta: {
                    title: 'Ação de Oferta de Alimentos',
                    sections: [ { title: 'Do Requerente (quem oferece a pensão):', docs: ['Carteira de Identidade e CPF.','Comprovante de residência.','Carteira de Trabalho, contracheque, extratos bancários dos últimos três meses ou a última declaração de Imposto de Renda para comprovar os rendimentos.'] }, { title: 'Do(a) Filho(a) (Beneficiário):', docs: ['Certidão de Nascimento.'] }, { title: 'Informações sobre a Representante Legal (a outra parte):', docs: ['Nome completo e endereço para citação.','Dados bancários para o depósito da pensão (se souber).'] } ]
                },
                divorcio_litigioso: {
                    title: 'Ação de Divórcio Litigioso',
                    sections: [ { title: 'Do Requerente (quem entra com a ação):', docs: ['Carteira de Identidade e CPF.','Comprovante de residência.','Certidão de Casamento atualizada.','Carteira de Trabalho, contracheque ou extratos bancários dos últimos três meses.'] }, { title: 'Dos Filhos (se houver):', docs: ['Certidão de Nascimento ou Casamento dos filhos.'] }, { title: 'Dos Bens (se houver partilha):', docs: ['Documentos relacionados aos bens adquiridos durante o casamento (ex: registro de imóveis, documento de veículos, extratos de contas).','Informar o valor de mercado dos bens a partilhar.'] }, { title: 'Informações sobre o Réu (a outra parte):', docs: ['Endereço completo para citação.'] } ]
                },
                divorcio_consensual: {
                    title: 'Ação de Divórcio Consensual',
                    sections: [ { title: 'De Ambos os Cônjuges (Requerentes) - Atenção: Documentos de AMBOS:', docs: ['Carteira de Identidade e CPF de ambos.','Comprovante de residência de ambos.','Certidão de Casamento atualizada.','Carteira de Trabalho, contracheque ou extratos bancários dos últimos três meses de ambos.'] }, { title: 'Dos Filhos (se houver):', docs: ['Certidão de Nascimento ou Casamento dos filhos.'] }, { title: 'Dos Bens (se houver partilha):', docs: ['Documentos relacionados aos bens adquiridos durante o casamento (ex: registro de imóveis, documento de veículos, extratos de contas).','Informar o valor de mercado dos bens a partilhar.','Apresentar um esboço de como será feita a divisão dos bens.'] } ]
                },
                outros: {
                    title: 'Outros Documentos (Personalizado)',
                    sections: []
                }
            };
            
            const documentsModal = document.getElementById('documents-modal');
            const actionSelectionView = document.getElementById('document-action-selection');
            const checklistView = document.getElementById('document-checklist-view');
            const checklistContainer = document.getElementById('checklist-container');
            const checklistTitle = document.getElementById('checklist-title');
            const customDocAdder = document.getElementById('custom-doc-adder');
            
            const renderCustomDocItem = (docText, isChecked = false) => {
                const listItem = document.createElement('li');
                listItem.className = 'custom-doc-item flex items-center justify-between p-2 bg-white rounded-lg border';
                const escapedDocText = docText.replace(/"/g, '&quot;');
                listItem.innerHTML = `
                    <label class="flex items-center text-gray-800 cursor-pointer flex-grow break-all">
                        <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3 flex-shrink-0" value="${escapedDocText}" ${isChecked ? 'checked' : ''}>
                        <span class="doc-text">${docText}</span>
                    </label>
                    <button class="remove-custom-doc-btn text-gray-400 hover:text-red-500 ml-2 p-1 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                    </button>`;
                return listItem;
            };

            const generateChecklist = (actionKey, savedData = {}) => {
                const data = documentsData[actionKey];
                currentChecklistAction = actionKey;
                checklistTitle.textContent = data.title;
                checklistContainer.innerHTML = '';
                customDocAdder.classList.add('hidden');
                if (actionKey === 'outros') {
                    customDocAdder.classList.remove('hidden');
                    const customDocs = savedData.customDocs || [];
                    const checkedDocs = savedData.checkedDocs || [];
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    customDocs.forEach(docText => {
                        const isChecked = checkedDocs.includes(docText);
                        list.appendChild(renderCustomDocItem(docText, isChecked));
                    });
                    checklistContainer.appendChild(list);
                } else {
                    const checkedDocs = savedData.checkedDocs || [];
                    data.sections.forEach(section => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.innerHTML = `<h4 class="font-bold text-md text-gray-700 mb-2 mt-3 border-b pb-1">${section.title}</h4>`;
                        const list = document.createElement('ul');
                        list.className = 'space-y-2';
                        section.docs.forEach((docText) => {
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `<label class="flex items-center text-gray-800 cursor-pointer">
                                <input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500 mr-3 flex-shrink-0" value="${docText.replace(/"/g, '&quot;')}" ${checkedDocs.includes(docText) ? 'checked' : ''}>
                                ${docText}
                            </label>`;
                            list.appendChild(listItem);
                        });
                        sectionDiv.appendChild(list);
                        checklistContainer.appendChild(sectionDiv);
                    });
                }
            };
            
            // LISTENER DE CLIQUE PRINCIPAL (CORRIGIDO E COMPLETO)
            document.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const id = button.dataset.id;
                const collectionRef = currentPautaId ? collection(db, "pautas", currentPautaId, "attendances") : null;
                
                if (button.classList.contains('view-details-btn') && id) {
                    assistedIdToHandle = id;
                    const assisted = allAssisted.find(a => a.id === id);
                    if (assisted) {
                        document.getElementById('documents-assisted-name').textContent = assisted.name;
                        if (assisted.documentChecklist && assisted.documentChecklist.actionType) {
                            generateChecklist(assisted.documentChecklist.actionType, assisted.documentChecklist);
                            actionSelectionView.classList.add('hidden');
                            checklistView.classList.remove('hidden');
                            checklistView.classList.add('flex');
                        } else {
                            actionSelectionView.classList.remove('hidden');
                            checklistView.classList.add('hidden');
                            checklistView.classList.remove('flex');
                        }
                        documentsModal.classList.remove('hidden');
                    }
                }

                if(button.id === 'download-pdf-btn') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pautaTitle = document.getElementById('pauta-title').textContent;
                    const currentModeText = document.getElementById('tab-agendamento').classList.contains('tab-active') ? 'Agendado' : 'Avulso';

                    doc.setFontSize(18);
                    doc.text(`Relatório de Atendidos - ${pautaTitle}`, 14, 22);
                    doc.setFontSize(12);
                    doc.text(`Modo: ${currentModeText}`, 14, 30);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 36);

                    const atendidos = allAssisted.filter(a => a.status === 'atendido' && a.type === (currentModeText === 'Agendado' ? 'agendamento' : 'avulso'))
                                               .sort((a, b) => new Date(a.attendedTime) - new Date(b.attendedTime));

                    if (atendidos.length === 0) {
                        showNotification("Não há atendidos para gerar o PDF.", "error");
                        return;
                    }

                    const head = [['#', 'Nome', 'CPF', 'Assunto Principal', 'Atendente', 'Chegada', 'Finalizado']];
                    const body = atendidos.map((a, index) => [
                        index + 1,
                        a.name,
                        a.cpf || 'N/A',
                        a.subject,
                        a.attendant || 'N/I',
                        a.arrivalTime ? new Date(a.arrivalTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A',
                        a.attendedTime ? new Date(a.attendedTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'
                    ]);

                    doc.autoTable({
                        startY: 42,
                        head: head,
                        body: body,
                        theme: 'striped',
                        headStyles: { fillColor: [22, 163, 74] } 
                    });

                    doc.save(`relatorio_${pautaTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
                }

                if (id && collectionRef) {
                    if (button.classList.contains('check-in-btn')) { assistedIdToHandle = id; document.getElementById('arrival-modal').classList.remove('hidden'); document.getElementById('arrival-time-input').value = new Date().toTimeString().slice(0,5); }
                    if (button.classList.contains('attend-btn')) { assistedIdToHandle = id; document.getElementById('attendant-name').value = ''; document.getElementById('attendant-modal').classList.remove('hidden'); }
                    if (button.classList.contains('faltou-btn')) { await updateDoc(doc(collectionRef, id), { status: 'faltoso', lastActionBy: currentUserName }); showNotification("Assistido marcado como faltoso.", "info"); }
                    if (button.classList.contains('return-to-pauta-btn')) { await updateDoc(doc(collectionRef, id), { status: 'pauta', arrivalTime: null, checkInTimestamp: null, priority: null, lastActionBy: currentUserName }); showNotification("Assistido retornado para a pauta.", "info");}
                    if (button.classList.contains('return-to-pauta-from-faltoso-btn')) { await updateDoc(doc(collectionRef, id), { status: 'pauta', lastActionBy: currentUserName }); showNotification("Status de 'faltoso' revertido.", "info"); }
                    if (button.classList.contains('return-to-aguardando-btn')) { await updateDoc(doc(collectionRef, id), { status: 'aguardando', attendant: null, attendedTime: null, lastActionBy: currentUserName }); showNotification("Assistido retornado para 'Aguardando Atendimento'.", "info"); }
                    if (button.classList.contains('delete-attended-btn')) { if(confirm("Tem certeza que deseja apagar este registro de atendimento?")) { await deleteDoc(doc(collectionRef, id)); showNotification("Registro apagado.", "success"); } }
                    if (button.classList.contains('priority-btn')) { assistedIdToHandle = id; document.getElementById('priority-reason-modal').classList.remove('hidden'); }
                    if (button.classList.contains('edit-attendant-btn')) { assistedIdToHandle = id; const assisted = allAssisted.find(a => a.id === id); if(assisted) { document.getElementById('edit-attendant-name').value = assisted.attendant || ''; document.getElementById('edit-attendant-modal').classList.remove('hidden'); } }
                    if (button.classList.contains('edit-demands-btn')) { assistedIdToHandle = id; const assisted = allAssisted.find(a => a.id === id); if(assisted) { document.getElementById('demands-assisted-name').textContent = assisted.name; document.getElementById('demands-main-subject').textContent = assisted.subject; const qty = assisted.demandas?.quantidade || 0; document.getElementById('demands-quantity').value = qty; updateDemandDescriptions(qty, assisted.demandas?.descricoes); document.getElementById('demands-modal').classList.remove('hidden'); } }
                    if (button.classList.contains('edit-assisted-btn')) { assistedIdToHandle = id; const assisted = allAssisted.find(a => a.id === id); if(assisted) { document.getElementById('edit-assisted-name').value = assisted.name; document.getElementById('edit-assisted-cpf').value = assisted.cpf || ''; document.getElementById('edit-assisted-subject').value = assisted.subject; document.getElementById('edit-scheduled-time-wrapper').style.display = assisted.type === 'agendamento' ? 'block' : 'none'; if(assisted.type === 'agendamento') document.getElementById('edit-scheduled-time').value = assisted.scheduledTime || ''; document.getElementById('edit-assisted-modal').classList.remove('hidden'); } }
                }
            });

            // Listener específico para o modal de documentos
            documentsModal.addEventListener('click', async (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                if (button.classList.contains('document-action-btn')) {
                    const actionKey = button.dataset.action;
                    const assisted = allAssisted.find(a => a.id === assistedIdToHandle);
                    const savedData = (assisted && assisted.documentChecklist && assisted.documentChecklist.actionType === actionKey) ? assisted.documentChecklist : {};
                    generateChecklist(actionKey, savedData);
                    actionSelectionView.classList.add('hidden');
                    checklistView.classList.remove('hidden');
                    checklistView.classList.add('flex');
                }
                if (button.id === 'add-custom-doc-btn') {
                    const input = document.getElementById('custom-doc-input');
                    const docText = input.value.trim();
                    if (docText) {
                        let list = checklistContainer.querySelector('ul');
                        if (!list) {
                            list = document.createElement('ul');
                            list.className = 'space-y-2';
                            checklistContainer.appendChild(list);
                        }
                        list.appendChild(renderCustomDocItem(docText));
                        input.value = '';
                        input.focus();
                    }
                }
                if (button.classList.contains('remove-custom-doc-btn')) {
                    button.closest('.custom-doc-item').remove();
                }
                if (button.id === 'change-action-btn') {
                    checklistView.classList.add('hidden');
                    checklistView.classList.remove('flex');
                    actionSelectionView.classList.remove('hidden');
                }
                if (button.id === 'save-checklist-btn') {
                    if (assistedIdToHandle && currentChecklistAction) {
                        const checkedInputs = checklistContainer.querySelectorAll('input[type="checkbox"]:checked');
                        const checkedDocs = Array.from(checkedInputs).map(input => input.value);
                        let checklistData = { actionType: currentChecklistAction, checkedDocs: checkedDocs };
                        if (currentChecklistAction === 'outros') {
                            const customDocItems = checklistContainer.querySelectorAll('.doc-text');
                            checklistData.customDocs = Array.from(customDocItems).map(span => span.textContent);
                        }
                        const docRef = doc(db, "pautas", currentPautaId, "attendances", assistedIdToHandle);
                        await updateDoc(docRef, { documentChecklist: checklistData });
                        showNotification("Checklist salvo com sucesso!", "success");
                        documentsModal.classList.add('hidden');
                    }
                }
                if (button.id === 'close-documents-modal-btn' || button.id === 'cancel-checklist-btn') {
                    documentsModal.classList.add('hidden');
                }
            });
        });
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker registrado com sucesso:', registration.scope))
                    .catch(error => console.log('Falha ao registrar o ServiceWorker:', error));
            });
        }
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const installButton = document.getElementById('install-button');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(installContainer) installContainer.classList.remove('hidden');
        });
        if(installButton) {
            installButton.addEventListener('click', async () => {
                if(installContainer) installContainer.classList.add('hidden');
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
            });
        }
        window.addEventListener('appinstalled', () => {
            if(installContainer) installContainer.classList.add('hidden');
            deferredPrompt = null;
            console.log('PWA foi instalado');
        });
        const privacyModal = document.getElementById('privacy-policy-modal');
        if (privacyModal) {
            document.getElementById('privacy-policy-link').addEventListener('click', (e) => {
                e.preventDefault();
                privacyModal.classList.remove('hidden');
            });
            privacyModal.addEventListener('click', (e) => { if (e.target === privacyModal) { privacyModal.classList.add('hidden'); } });
        }
    </script>
</body>
</html>
