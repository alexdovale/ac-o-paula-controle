<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Atendimento Externo - SIGAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <p class="text-gray-500 font-bold animate-pulse">Carregando atendimento...</p>
    </div>

    <div id="main-card" class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden hidden border-t-8 border-cyan-600">
        <div class="p-6">
            <h1 class="text-xl font-bold text-gray-800 text-center border-b pb-4 mb-4">Finalização de Atendimento</h1>
            
            <div class="text-center mb-6">
                <h2 id="assisted-name" class="text-xl font-bold text-cyan-700">...</h2>
                <p id="assisted-subject" class="text-sm text-gray-500 italic">...</p>
            </div>

            <!-- ETAPA 1: ASSINATURA -->
            <div id="step-signature" class="space-y-4 text-center">
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <p class="text-yellow-800 font-bold text-sm">✍️ Assinatura Necessária</p>
                    <p class="text-[10px] text-yellow-600">Confirme que o assistido assinou a petição antes de prosseguir.</p>
                </div>
                <button id="btn-signed" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow uppercase text-sm transition">
                    Confirmar Assinatura e Escolher Destino
                </button>
            </div>

            <!-- ETAPA 2: DECISÃO (SÓ APARECE SE TIVER DISTRIBUIÇÃO ATIVA) -->
            <div id="step-decision" class="hidden space-y-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <p class="text-blue-800 font-bold text-sm">⚠️ Atenção!</p>
                    <p class="text-[11px] text-blue-700">Você está finalizando este atendimento. Se o processo já foi protocolado, escolha <b>Finalizar</b>. Se ainda precisa ser distribuído pela secretaria, escolha <b>Aguardar Distribuição</b>.</p>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <!-- OPÇÃO 1: MANDAR PARA FILA -->
                    <button id="btn-go-to-dist" class="w-full bg-white border-2 border-cyan-600 text-cyan-600 font-bold py-4 rounded-lg hover:bg-cyan-50 transition text-sm">
                        MOVIMENTAR: Aguardar Distribuição ⚖️
                    </button>

                    <!-- OPÇÃO 2: FINALIZAR DIRETAMENTE -->
                    <div class="border-t pt-4">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Ou Finalizar Agora (Já Protocolado):</label>
                        <select id="select-defensor" class="w-full p-2 border rounded-lg mb-2 text-sm">
                            <option value="">Selecione o Defensor Responsável...</option>
                        </select>
                        <input type="text" id="input-process" class="w-full p-2 border rounded-lg mb-2 text-sm" placeholder="Nº do Processo (Ex: 0000.00.00.0000)">
                        <input type="file" id="input-pdf" accept="application/pdf" class="w-full text-xs text-gray-500 mb-4">
                        
                        <button id="btn-finish-now" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 shadow transition text-sm uppercase">
                            Finalizar Atendimento ✅
                        </button>
                    </div>
                </div>
            </div>

            <!-- MENSAGEM DE SUCESSO -->
            <div id="step-done" class="hidden text-center py-10">
                <div class="text-6xl mb-4">✅</div>
                <h3 class="text-xl font-bold text-gray-800">Concluído!</h3>
                <p class="text-gray-500 text-sm">O sistema foi atualizado. Você já pode fechar esta aba.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = { 
            apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", 
            authDomain: "pauta-ce162.firebaseapp.com", 
            projectId: "pauta-ce162", 
            storageBucket: "pauta-ce162.appspot.com", 
            messagingSenderId: "87113750208", 
            appId: "1:87113750208:web:4abba0024f4d4af699bf25" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pautaId = urlParams.get('pautaId');
        const assistidoId = urlParams.get('assistidoId');

        if (!pautaId || !assistidoId) {
            document.getElementById('loading').innerHTML = "<p class='text-red-500'>Erro: Link Inválido.</p>";
        } else {
            const docRef = doc(db, "pautas", pautaId, "attendances", assistidoId);
            const pautaRef = doc(db, "pautas", pautaId);

            // Carregar Defensores
            const loadDefensores = async () => {
                const q = query(collection(db, "pautas", pautaId, "collaborators"), where("cargo", "==", "Defensor(a)"));
                const snap = await getDocs(q);
                const select = document.getElementById('select-defensor');
                snap.forEach(doc => {
                    const d = doc.data();
                    const opt = document.createElement('option');
                    opt.value = d.nome; opt.textContent = d.nome; select.appendChild(opt);
                });
            };
            loadDefensores();

            onSnapshot(docRef, async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const pDoc = await getDoc(pautaRef);
                    const pData = pDoc.data();

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('main-card').classList.remove('hidden');
                    document.getElementById('assisted-name').textContent = data.name;
                    document.getElementById('assisted-subject').textContent = data.subject;

                    if (data.status === 'atendido') {
                        document.getElementById('step-signature').classList.add('hidden');
                        document.getElementById('step-decision').classList.add('hidden');
                        document.getElementById('step-done').classList.remove('hidden');
                    } else if (data.distributionStatus === 'signed') {
                        document.getElementById('step-signature').classList.add('hidden');
                        document.getElementById('step-decision').classList.remove('hidden');
                        
                        // Se a pauta NÃO tiver distribuição, esconde o botão de "Aguardar Distribuição"
                        if (!pData?.useDistributionFlow) {
                            document.getElementById('btn-go-to-dist').classList.add('hidden');
                        }
                    }
                }
            });

            // AÇÃO: Confirmar Assinatura
            document.getElementById('btn-signed').addEventListener('click', async () => {
                await updateDoc(docRef, { distributionStatus: 'signed' });
            });

            // AÇÃO: Mover para Aguardando Distribuição
            document.getElementById('btn-go-to-dist').addEventListener('click', async () => {
                await updateDoc(docRef, { 
                    status: 'aguardandoDistribuicao', 
                    finalizadoPeloColaborador: true,
                    lastActionBy: 'Externo: Encaminhado para Distribuição'
                });
                alert("Encaminhado com sucesso!");
            });

            // AÇÃO: Finalizar Agora
            document.getElementById('btn-finish-now').addEventListener('click', async () => {
                const defensor = document.getElementById('select-defensor').value;
                if (!defensor) return alert("Selecione o Defensor responsável.");

                await updateDoc(docRef, {
                    status: 'atendido',
                    attendant: defensor,
                    processNumber: document.getElementById('input-process').value,
                    nomeArquivoPdf: document.getElementById('input-pdf').files[0]?.name || null,
                    attendedTime: new Date().toISOString(),
                    finalizadoVia: 'Painel Externo'
                });
            });
        }
    </script>
</body>
</html>