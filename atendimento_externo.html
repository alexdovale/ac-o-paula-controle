<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Atendimento - SIGAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="main-container" class="max-w-lg w-full bg-white p-8 rounded-xl shadow-lg text-center">
        
        <!-- Estado de Carregamento -->
        <div id="loading-state">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 font-semibold">Buscando dados do atendimento...</p>
        </div>

        <!-- Estado de Erro -->
        <div id="error-state" class="hidden">
            <h1 class="text-2xl font-bold text-red-600 mb-4">Ocorreu um Erro</h1>
            <p id="error-message" class="text-gray-700">Não foi possível carregar os dados. O link pode ser inválido ou o atendimento já foi finalizado.</p>
        </div>

        <!-- Conteúdo Principal -->
        <div id="content-state" class="hidden">
            <img src="https://alexdovale.github.io/ponto.codoc/imagem.png" alt="Logo SIGAP" class="mx-auto h-20 w-auto mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Finalizar Atendimento</h1>
            <p class="text-gray-600 mb-6">Confirme os detalhes e finalize o atendimento.</p>
            
            <div class="bg-gray-50 p-4 rounded-lg text-left space-y-2 border border-gray-200 mb-6">
                <p><strong>Assistido(a):</strong> <span id="assisted-name" class="font-normal"></span></p>
                <p><strong>Assunto Principal:</strong> <span id="assisted-subject" class="font-normal"></span></p>
                <p><strong>Colaborador(a):</strong> <span id="collaborator-name" class="font-normal"></span></p>
            </div>

            <button id="finalize-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300">
                Confirmar e Finalizar Atendimento
            </button>
        </div>
        
        <!-- Estado de Sucesso -->
        <div id="success-state" class="hidden">
            <h1 class="text-2xl font-bold text-green-600 mb-4">Atendimento Finalizado!</h1>
            <p class="text-gray-700">Obrigado! O registro foi atualizado com sucesso no sistema.</p>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE",
            authDomain: "pauta-ce162.firebaseapp.com",
            projectId: "pauta-ce162",
            storageBucket: "pauta-ce162.appspot.com",
            messagingSenderId: "87113750208",
            appId: "1:87113750208:web:4abba0024f4d4af699bf25"
        };

        // Elementos da UI
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const contentState = document.getElementById('content-state');
        const successState = document.getElementById('success-state');
        const errorMessage = document.getElementById('error-message');
        const finalizeBtn = document.getElementById('finalize-btn');

        let db;
        let pautaId, assistidoId, collaboratorName;

        function showState(state) {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            contentState.classList.add('hidden');
            successState.classList.add('hidden');
            document.getElementById(state + '-state').classList.remove('hidden');
        }

        async function loadAttendanceData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                pautaId = urlParams.get('pautaId');
                assistidoId = urlParams.get('assistidoId');
                collaboratorName = urlParams.get('collaboratorName');

                if (!pautaId || !assistidoId || !collaboratorName) {
                    throw new Error("Parâmetros do link estão ausentes.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                const attendanceRef = doc(db, "pautas", pautaId, "attendances", assistidoId);
                const docSnap = await getDoc(attendanceRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.status === 'atendido') {
                         throw new Error("Este atendimento já foi finalizado anteriormente.");
                    }

                    document.getElementById('assisted-name').textContent = data.name;
                    document.getElementById('assisted-subject').textContent = data.subject;
                    document.getElementById('collaborator-name').textContent = collaboratorName;
                    showState('content');
                } else {
                    throw new Error("Registro de atendimento não encontrado.");
                }
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                errorMessage.textContent = error.message;
                showState('error');
            }
        }

        finalizeBtn.addEventListener('click', async () => {
            finalizeBtn.disabled = true;
            finalizeBtn.textContent = 'Finalizando...';
            finalizeBtn.classList.replace('bg-green-600', 'bg-green-400');

            try {
                const attendanceRef = doc(db, "pautas", pautaId, "attendances", assistidoId);

                // Estes são os campos que a nova regra de segurança vai permitir
                await updateDoc(attendanceRef, {
                    status: 'atendido',
                    attendant: collaboratorName,
                    // ==========================================================
                    // AQUI ESTÁ A CORREÇÃO:
                    // Removemos .toISOString() para enviar um objeto de data,
                    // que o Firebase converterá para o tipo 'timestamp'.
                    // ==========================================================
                    attendedTime: new Date(), 
                    finalizadoPeloColaborador: true
                });
                
                showState('success');

            } catch (error) {
                console.error("Erro detalhado ao finalizar:", error);
                if (error.code === 'permission-denied') {
                    errorMessage.textContent = "A finalização foi bloqueada pelas regras de segurança. Verifique se as regras no Firebase correspondem aos dados enviados.";
                } else {
                    errorMessage.textContent = "Não foi possível finalizar. Verifique sua conexão com a internet ou tente novamente mais tarde.";
                }
                showState('error');
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Confirmar e Finalizar Atendimento';
                finalizeBtn.classList.replace('bg-green-400', 'bg-green-600');
            }
        });

        loadAttendanceData();

    </script>
</body>
</html>


