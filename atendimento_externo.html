<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Atendimento - SIGAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-['Inter'] flex items-center justify-center min-h-screen p-4">

    <div id="loading" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
        <p class="mt-4 text-gray-500 font-bold">Conectando ao sistema...</p>
    </div>

    <div id="error-screen" class="hidden bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center border-t-8 border-red-500">
        <div class="text-5xl mb-4">⚠️</div>
        <h2 class="text-xl font-black text-gray-800 uppercase">Erro de Conexão</h2>
        <p id="error-msg" class="text-gray-500 text-sm my-4">Não foi possível carregar os dados deste atendimento.</p>
        <button onclick="location.reload()" class="bg-gray-800 text-white px-8 py-2 rounded-xl font-bold w-full">Tentar Novamente</button>
    </div>

    <main id="main-card" class="hidden bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
        <header class="bg-green-600 p-6 text-white text-center">
            <h1 class="text-lg font-black uppercase tracking-tighter">Finalizar Atendimento</h1>
        </header>
        
        <div class="p-6 space-y-6">
            <div class="text-center">
                <p class="text-[10px] font-black text-gray-400 uppercase">Assistido(a)</p>
                <h2 id="assisted-name" class="text-xl font-black text-gray-800 uppercase">---</h2>
            </div>

            <div>
                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Seu Nome (Atendente)</label>
                <input type="text" id="attendant-name" class="w-full p-3 bg-gray-50 border rounded-xl font-bold outline-none focus:ring-2 focus:ring-green-500">
            </div>

            <button id="finish-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-2xl shadow-lg transition uppercase tracking-widest active:scale-95">
                Encerrar Atendimento
            </button>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.appspot.com", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('pautaId');
        const aId = urlParams.get('assistidoId');

        if (!pId || !aId) {
            showError("O link está incompleto ou mal formatado.");
        } else {
            const docRef = doc(db, "pautas", pId, "attendances", aId);

            getDoc(docRef).then((snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.finalizadoPeloColaborador) {
                        showError("Este atendimento já foi finalizado anteriormente.");
                        return;
                    }
                    document.getElementById('assisted-name').textContent = data.name;
                    document.getElementById('attendant-name').value = urlParams.get('collaboratorName') || '';
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('main-card').classList.remove('hidden');
                } else {
                    showError("Atendimento não encontrado no banco de dados.");
                }
            }).catch((err) => {
                console.error(err);
                showError("Falha na comunicação com o Firebase. Verifique sua internet.");
            });
        }

        document.getElementById('finish-btn').onclick = async () => {
            const name = document.getElementById('attendant-name').value.trim();
            if (!name) { alert("Informe seu nome para finalizar."); return; }

            try {
                const docRef = doc(db, "pautas", pId, "attendances", aId);
                await updateDoc(docRef, {
                    status: 'atendido',
                    attendant: name,
                    attendedTime: new Date().toISOString(),
                    finalizadoPeloColaborador: true
                });
                alert("Atendimento finalizado com sucesso!");
                window.close(); // Tenta fechar a aba
                document.body.innerHTML = "<div class='text-center mt-20 font-bold text-green-600'>Concluído! Pode fechar esta página.</div>";
            } catch (e) {
                alert("Erro ao salvar. Verifique se o atendimento ainda está ativo.");
            }
        };

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('error-msg').textContent = msg;
        }
    </script>
</body>
</html>
