<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fila ao Vivo - SIGAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .pulse-live { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col">

    <!-- Tela de Carregamento -->
    <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-gray-500 font-bold uppercase text-[10px]">Sincronizando Fila...</p>
    </div>

    <!-- Tela de Erro -->
    <div id="error-screen" class="hidden fixed inset-0 bg-gray-100 flex flex-col items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center border-t-8 border-red-500">
            <div class="text-6xl mb-4">üîí</div>
            <h1 class="text-xl font-black text-gray-800 mb-2 uppercase">Pauta n√£o dispon√≠vel</h1>
            <p class="text-gray-500 text-sm mb-6">Esta pauta pode estar privada ou o link expirou.</p>
            <button onclick="location.reload()" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold w-full">Tentar Novamente</button>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div id="app-content" class="hidden w-full max-w-5xl mx-auto flex-1 flex flex-col h-full">
        <header class="text-center mb-6 bg-white p-6 rounded-3xl shadow-sm border shrink-0">
            <h1 id="pauta-title" class="text-xl md:text-2xl font-black text-gray-800 uppercase tracking-tighter leading-tight">---</h1>
            <div class="flex items-center justify-center gap-2 mt-2">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative rounded-full h-2 w-2 bg-green-500"></span></span>
                <p class="text-[9px] text-green-600 font-bold uppercase tracking-widest pulse-live">Atualiza√ß√£o ao vivo</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
            <!-- AGUARDANDO -->
            <div class="bg-white rounded-3xl shadow-md border overflow-hidden flex flex-col h-[60vh] lg:h-[75vh]">
                <div class="bg-amber-500 p-4 text-white flex justify-between items-center shrink-0 shadow-md">
                    <h2 class="text-sm font-black uppercase tracking-tighter flex items-center gap-2">‚è≥ Fila de Espera</h2>
                    <span id="count-aguardando" class="bg-white text-amber-600 px-3 py-0.5 rounded-full text-xs font-black">0</span>
                </div>
                <div id="list-aguardando" class="p-4 overflow-y-auto flex-1 space-y-3 bg-gray-50"></div>
            </div>

            <!-- EM ATENDIMENTO -->
            <div id="col-atendimento" class="bg-white rounded-3xl shadow-md border overflow-hidden flex flex-col h-[60vh] lg:h-[75vh]">
                <div class="bg-green-600 p-4 text-white flex justify-between items-center shrink-0 shadow-md">
                    <h2 class="text-sm font-black uppercase tracking-tighter flex items-center gap-2">üë©‚Äçüíª No Guich√™ / Sala</h2>
                    <span id="count-atendimento" class="bg-white text-green-700 px-3 py-0.5 rounded-full text-xs font-black">0</span>
                </div>
                <div id="list-atendimento" class="p-4 overflow-y-auto flex-1 space-y-3 bg-gray-50"></div>
            </div>
        </div>

        <footer class="mt-4 text-center text-[9px] text-gray-400 font-bold uppercase tracking-widest">
            SIGAP ‚Ä¢ Sistema Integrado de Gest√£o ‚Ä¢ <span id="last-sync">...</span>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

        const firebaseConfig = { apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.appspot.com", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // App Check
        try { initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6LeWfTgsAAAAAHy1y3TFZ1EH-L3btwHsult6Rgy4'), isTokenAutoRefreshEnabled: true }); } catch(e) {}

        const pId = new URLSearchParams(window.location.search).get('id');

        if (pId) {
            onSnapshot(doc(db, "pautas", pId), (pSnap) => {
                if (pSnap.exists() && pSnap.data().isPublic === true) {
                    const pData = pSnap.data();
                    document.getElementById('pauta-title').textContent = pData.name;
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');

                    onSnapshot(collection(db, "pautas", pId, "attendances"), (attSnap) => {
                        const items = attSnap.docs.map(d => ({id: d.id, ...d.data()}));
                        
                        // L√ìGICA DE ORDENA√á√ÉO (ESPELHO DO SISTEMA)
                        const aguardando = items.filter(i => i.status === 'aguardando').sort((a,b) => {
                            if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                            if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;
                            
                            if (pData.ordemAtendimento === 'manual') return (a.manualIndex || 0) - (b.manualIndex || 0);
                            
                            const timeA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                            const timeB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                            return timeA - timeB;
                        });

                        const emAtendimento = items.filter(i => i.status === 'emAtendimento' || i.status === 'aguardando_distribuicao');

                        document.getElementById('count-aguardando').textContent = aguardando.length;
                        document.getElementById('count-atendimento').textContent = emAtendimento.length;
                        document.getElementById('last-sync').textContent = `Sincronizado √†s ${new Date().toLocaleTimeString()}`;

                        // RENDER AGUARDANDO
                        document.getElementById('list-aguardando').innerHTML = aguardando.map((a, idx) => `
                            <div class="bg-white p-4 rounded-2xl border-l-8 ${a.priority === 'URGENTE' ? 'border-red-500 bg-red-50' : 'border-amber-400'} shadow-sm flex justify-between items-center">
                                <div class="min-w-0">
                                    <p class="text-[9px] font-black text-gray-400 uppercase tracking-tighter">${idx + 1}¬∫ DA FILA ${a.priority === 'URGENTE' ? '‚Ä¢ URGENTE' : ''}</p>
                                    <p class="font-bold text-gray-700 text-lg uppercase truncate">${pData.maskNames ? a.name.split(' ')[0] + ' ' + (a.name.split(' ')[1] ? a.name.split(' ')[1][0] : '') + '***' : a.name}</p>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <span class="bg-blue-600 text-white text-[8px] font-black px-2 py-1 rounded-full uppercase tracking-tighter shadow-sm">${a.room || 'GERAL'}</span>
                                    ${a.documentState === 'saved' ? '<span class="text-[8px] font-black text-green-600 uppercase tracking-widest bg-green-50 px-1 rounded">Docs OK</span>' : ''}
                                </div>
                            </div>
                        `).join('') || '<div class="text-center py-10 text-gray-300 font-bold uppercase text-xs">Fila Vazia</div>';

                        // RENDER ATENDIMENTO
                        document.getElementById('list-atendimento').innerHTML = emAtendimento.map(a => `
                            <div class="bg-white p-4 rounded-2xl border-l-8 border-green-500 shadow-sm flex justify-between items-center animate-pulse">
                                <div class="min-w-0">
                                    <p class="text-[9px] font-black text-green-600 uppercase tracking-tighter">ATENDIMENTO INICIADO</p>
                                    <p class="font-bold text-gray-700 text-lg uppercase truncate">${pData.maskNames ? a.name.split(' ')[0] + '***' : a.name}</p>
                                </div>
                                <span class="text-xl">üë©‚Äçüíª</span>
                            </div>
                        `).join('') || '<div class="text-center py-10 text-gray-300 font-bold uppercase text-xs">Vazio</div>';
                    });
                } else { showError(); }
            }, () => showError());
        } else { showError(); }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>
