<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento de Fila - SIGAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .scrollable-content::-webkit-scrollbar { width: 4px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col">

    <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-gray-500 font-bold uppercase text-xs">Sincronizando Fila...</p>
    </div>

    <div id="error-screen" class="hidden fixed inset-0 bg-gray-100 flex flex-col items-center justify-center text-center p-4 z-50">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full border-t-8 border-red-500">
            <h1 class="text-2xl font-black text-gray-800 mb-2 uppercase">Acesso Restrito</h1>
            <p id="error-message" class="text-gray-600 mb-6 text-sm">Esta pauta n√£o est√° p√∫blica.</p>
            <button onclick="location.reload()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">Recarregar</button>
        </div>
    </div>

    <div id="app-content" class="hidden w-full max-w-4xl mx-auto flex-1 flex flex-col h-full">
        <header class="text-center mb-6 bg-white p-6 rounded-3xl shadow-sm border shrink-0">
            <h1 id="pauta-title" class="text-xl md:text-2xl font-black text-slate-800 uppercase leading-tight tracking-tighter">---</h1>
            <div class="flex items-center justify-center gap-2 mt-2">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative rounded-full h-2 w-2 bg-green-500"></span></span>
                <p id="last-sync" class="text-[9px] text-gray-400 font-black uppercase tracking-widest">Conectado ao vivo</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1 min-h-0">
            <!-- AGUARDANDO -->
            <div class="bg-white rounded-3xl shadow-md border overflow-hidden flex flex-col h-[60vh] lg:h-[75vh]">
                <div class="bg-amber-500 p-4 text-white flex justify-between items-center shrink-0">
                    <h2 class="text-sm font-black uppercase tracking-tighter">‚è≥ Fila de Espera</h2>
                    <span id="count-aguardando" class="bg-white text-amber-600 px-3 py-0.5 rounded-full text-xs font-black">0</span>
                </div>
                <div id="list-aguardando" class="p-4 overflow-y-auto flex-1 space-y-3 bg-gray-50 scrollable-content"></div>
            </div>

            <!-- EM ATENDIMENTO -->
            <div id="col-atendimento" class="bg-white rounded-3xl shadow-md border overflow-hidden flex flex-col h-[60vh] lg:h-[75vh]">
                <div class="bg-green-600 p-4 text-white flex justify-between items-center shrink-0">
                    <h2 class="text-sm font-black uppercase tracking-tighter">üë©‚Äçüíª No Guich√™</h2>
                    <span id="count-atendimento" class="bg-white text-green-700 px-3 py-0.5 rounded-full text-xs font-black">0</span>
                </div>
                <div id="list-atendimento" class="p-4 overflow-y-auto flex-1 space-y-3 bg-gray-50 scrollable-content"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCrLwXmkxgeVoB8TwRI7pplCVQETGK0zkE", authDomain: "pauta-ce162.firebaseapp.com", projectId: "pauta-ce162", storageBucket: "pauta-ce162.appspot.com", messagingSenderId: "87113750208", appId: "1:87113750208:web:4abba0024f4d4af699bf25" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        try { initializeAppCheck(app, { provider: new ReCaptchaV3Provider('6LeWfTgsAAAAAHy1y3TFZ1EH-L3btwHsult6Rgy4'), isTokenAutoRefreshEnabled: true }); } catch(e) {}

        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('id');

        let pautaConfig = { ordemAtendimento: 'padrao', maskNames: false };

        // --- L√ìGICA DE PRIORIDADE (ID√äNTICA √Ä INTERNA) ---
        const getPriorityLevel = (item) => {
            if (item.priority === 'URGENTE') return 0; // Topo absoluto
            if (item.type === 'avulso') return 2; // M√©dia
            if (!item.scheduledTime || !item.arrivalTime) return 2;

            const scheduled = new Date(`1970-01-01T${item.scheduledTime}`);
            const arrival = new Date(item.arrivalTime);
            const arrivalOnlyTime = new Date(`1970-01-01T${arrival.toTimeString().slice(0, 5)}`);
            const diffMinutes = (arrivalOnlyTime - scheduled) / (1000 * 60);

            if (diffMinutes <= 0) return 1; // M√°xima (No hor√°rio ou adiantado)
            if (diffMinutes <= 20) return 2; // M√©dia (At√© 20min atraso)
            return 3; // M√≠nima (Mais de 20min atraso)
        };

        function sortFila(list, mode) {
            return list.sort((a, b) => {
                // 1. Urg√™ncia sempre primeiro
                if (a.priority === 'URGENTE' && b.priority !== 'URGENTE') return -1;
                if (b.priority === 'URGENTE' && a.priority !== 'URGENTE') return 1;

                if (mode === 'manual') {
                    return (a.manualIndex || 0) - (b.manualIndex || 0);
                }
                
                if (mode === 'chegada') {
                    const timeA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                    const timeB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                    return timeA - timeB;
                }

                // Modo Padr√£o (L√≥gica de Pontualidade)
                const levelA = getPriorityLevel(a);
                const levelB = getPriorityLevel(b);
                if (levelA !== levelB) return levelA - levelB;

                // Desempate por Hor√°rio Agendado
                if (levelA === 1 && a.scheduledTime && b.scheduledTime) {
                    return a.scheduledTime.localeCompare(b.scheduledTime);
                }

                // Desempate Final: Hor√°rio de Chegada
                const arrivalA = a.arrivalTime ? new Date(a.arrivalTime).getTime() : Infinity;
                const arrivalB = b.arrivalTime ? new Date(b.arrivalTime).getTime() : Infinity;
                return arrivalA - arrivalB;
            });
        }

        function formatName(name) {
            if (!name) return "---";
            if (!pautaConfig.maskNames) return name;
            const parts = name.trim().split(' ');
            return parts.length > 1 ? `${parts[0]} ${parts[1][0]}.***` : name;
        }

        if (pId) {
            onSnapshot(doc(db, "pautas", pId), (snap) => {
                if (snap.exists() && snap.data().isPublic) {
                    const data = snap.data();
                    pautaConfig = data;
                    document.getElementById('pauta-title').textContent = data.name;
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');

                    onSnapshot(collection(db, "pautas", pId, "attendances"), (attSnap) => {
                        const all = attSnap.docs.map(d => ({id: d.id, ...d.data()}));
                        
                        const aguardando = all.filter(i => i.status === 'aguardando');
                        const sortedAguardando = sortFila(aguardando, data.ordemAtendimento);
                        const emAtendimento = all.filter(i => i.status === 'emAtendimento' || i.status === 'aguardando_distribuicao')
                                                 .sort((a, b) => new Date(b.inAttendanceTime) - new Date(a.inAttendanceTime));

                        document.getElementById('count-aguardando').textContent = aguardando.length;
                        document.getElementById('count-atendimento').textContent = emAtendimento.length;
                        document.getElementById('last-sync').textContent = `Sincronizado √†s ${new Date().toLocaleTimeString('pt-BR')}`;

                        const listAg = document.getElementById('list-aguardando');
                        listAg.innerHTML = sortedAguardando.map((item, idx) => `
                            <div class="bg-white p-4 rounded-2xl border-l-8 ${item.priority === 'URGENTE' ? 'border-red-500 bg-red-50' : 'border-amber-400'} shadow-sm flex justify-between items-center">
                                <div class="min-w-0">
                                    <p class="text-[9px] font-black text-gray-400 uppercase">${idx + 1}¬∫ DA FILA ${item.priority === 'URGENTE' ? '‚Ä¢ URGENTE' : ''}</p>
                                    <p class="font-bold text-gray-800 text-lg truncate uppercase">${formatName(item.name)}</p>
                                </div>
                                <span class="bg-slate-100 text-slate-600 text-[9px] font-black px-2 py-1 rounded uppercase shrink-0 ml-2">${item.room || 'Geral'}</span>
                            </div>
                        `).join('');

                        const listAt = document.getElementById('list-atendimento');
                        listAt.innerHTML = emAtendimento.map(item => `
                            <div class="bg-white p-4 rounded-2xl border-l-8 border-green-500 shadow-sm flex justify-between items-center animate-pulse">
                                <div class="min-w-0">
                                    <p class="text-[9px] font-black text-green-600 uppercase tracking-widest">No Atendimento</p>
                                    <p class="font-bold text-gray-800 text-lg truncate uppercase">${formatName(item.name)}</p>
                                </div>
                                <span class="text-xl">üë©‚Äçüíª</span>
                            </div>
                        `).join('');
                    });
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error-screen').classList.remove('hidden');
                }
            });
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('error-message').textContent = msg;
        }
    </script>
</body>
</html>
